const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/supabaseClient-D8oTKsok.js","assets/vendor-supabase-BFiW0B7-.js","assets/vendor-react-DrD-X_hS.js","assets/pitched-data-service-B2hvT42s.js","assets/weekUtils-CtleeXto.js","assets/index-QIbWiZAM.js","assets/vendor-ui-CuB_UNaH.js","assets/vendor-router-JN-2l_OL.js","assets/index-DB_f044c.css"])))=>i.map(i=>d[i]);
import{j as e}from"./vendor-ui-CuB_UNaH.js";import{r as l}from"./vendor-router-JN-2l_OL.js";import{M as he,S as oe,u as ue,a as fe,V as ge,b as pe}from"./index-QIbWiZAM.js";import{u as xe,N as ke}from"./Navbar-BDefkf3s.js";import{_ as X}from"./vendor-supabase-BFiW0B7-.js";import{getHistoricalWeekAnalysis as ce,getAvailableWeeks as ye,getAllPitchedItems as be,removeManyPitchedItems as se,getYearlyPitchedStats as le,purgeAllStatsData as ve,clearCharacterPitchedUI as je,purgePitchedRecords as we,getPitchedResetAuditHistory as Ne,savePitchedItem as de}from"./pitched-data-service-B2hvT42s.js";import{getCurrentWeekKey as A,getWeekOffset as Se,getWeekKeyOffset as te,parseWeekKey as Ce,getWeekDateRange as me,getWeekLabel as We,getCurrentYearKey as ae}from"./weekUtils-CtleeXto.js";import{C as De}from"./CustomCheckbox-PR03PWHK.js";import"./vendor-react-DrD-X_hS.js";function Q(t){if(t===0)return"0";if(t<1e9){const i=t/1e6;if(i<1){const u=t/1e3;return u<1?t.toString():`${u.toFixed(1)}K`}return`${i.toFixed(1)}M`}return`${(t/1e9).toFixed(1)}B`}function Pe({selectedWeekKey:t,onWeekChange:n,characterBossSelections:i=[],checked:u={},selectedCharIdx:f=0,totalMeso:P=0,obtainableMeso:D=0,historicalAnalysis:o={hasHistoricalData:!1,oldestHistoricalWeek:null,userType:"new",adaptiveWeekLimit:8},charSummaries:L}){const v=A(),d=l.useMemo(()=>{const C=(o==null?void 0:o.adaptiveWeekLimit)||8;return{min:-C,max:0,current:0,adaptiveLimit:C}},[o]),j=Se(t),W=l.useCallback(r=>{r!==t&&n(r)},[t,n]),N=()=>{const r=j-1;if(r>=d.min){const C=te(r);W(C)}},m=()=>{const r=j+1;if(r<=d.max){const C=te(r);W(C)}},x=l.useCallback(()=>{if(console.log("ðŸ” goToOldestOrFallback called with analysis:",{hasHistoricalData:o==null?void 0:o.hasHistoricalData,oldestHistoricalWeek:o==null?void 0:o.oldestHistoricalWeek,userType:o==null?void 0:o.userType,adaptiveLimit:d.adaptiveLimit}),o!=null&&o.hasHistoricalData&&(o!=null&&o.oldestHistoricalWeek))console.log(`ðŸŽ¯ Jumping to oldest historical data: ${o.oldestHistoricalWeek} (${o.userType} user)`),W(o.oldestHistoricalWeek);else{const r=te(-d.adaptiveLimit);console.log(`ðŸŽ¯ No historical data found, jumping to ${d.adaptiveLimit} weeks back: ${r}`),W(r)}},[o,d.adaptiveLimit,W]),O=()=>{W(v)},M=()=>{o!=null&&o.hasHistoricalData&&(o!=null&&o.oldestHistoricalWeek)&&W(o.oldestHistoricalWeek)},p=j>d.min,c=j<d.max,g=(o==null?void 0:o.hasHistoricalData)||j>-d.adaptiveLimit,h=t===v,k=o==null?void 0:o.hasHistoricalData,s=l.useMemo(()=>{const r=Ce(t),C=me(t);return{label:We(t),parsed:r,dateRange:C,isCurrentWeek:h,offset:j}},[t,h,j]),a=i[f],y=(a==null?void 0:a.bosses)||[],S=`${(a==null?void 0:a.name)||""}-${f}`;y.filter(r=>{var C;return(C=u[S])==null?void 0:C[`${r.name}-${r.difficulty}`]}).length,y.length;let T=0;a&&(T=y.reduce((r,C)=>{const U=C.price||0,H=C.partySize||1;return r+Math.ceil(U/H)},0));let I=0;return a&&(I=y.reduce((r,C)=>{var H;const U=`${C.name}-${C.difficulty}`;if((H=u[S])!=null&&H[U]){const K=C.price||0,_=C.partySize||1;return r+Math.ceil(K/_)}return r},0)),e.jsxs("div",{className:"week-navigator-container",children:[e.jsx("div",{className:"week-navigator-header",children:e.jsxs("div",{className:`week-navigator-title ${h?"current-week":"historical-week"}`,children:[s.label.replace(/\s*\(Current\)/i,""),h&&e.jsx("span",{className:"week-navigator-current-dot",children:e.jsx("span",{className:"week-navigator-current-dot-inner"})})]})}),e.jsxs("div",{className:"week-navigator-navigation",children:[e.jsx("div",{className:"week-navigator-arrow-container",children:e.jsx("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",onClick:p?N:void 0,className:`week-navigator-arrow arrow-left ${p?"enabled":"disabled"}`,title:p?"Previous Week":`Already at oldest week (${d.adaptiveLimit} weeks back)`,children:e.jsx("path",{d:"M20.3284 11.0001V13.0001L7.50011 13.0001L10.7426 16.2426L9.32842 17.6568L3.67157 12L9.32842 6.34314L10.7426 7.75735L7.49988 11.0001L20.3284 11.0001Z",fill:"currentColor"})})}),s.dateRange&&e.jsxs("div",{className:"week-navigator-date-range",children:[s.dateRange.start.toLocaleDateString()," - ",s.dateRange.end.toLocaleDateString()]}),e.jsx("div",{className:"week-navigator-arrow-container",children:e.jsx("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",onClick:h?g?x:void 0:c?m:void 0,className:`week-navigator-arrow arrow-right ${(h?g:c)?"enabled":"disabled"}`,title:h?g?o!=null&&o.hasHistoricalData?`Jump to oldest data (${o==null?void 0:o.oldestHistoricalWeek})`:`Jump to ${d.adaptiveLimit} weeks back`:"No historical data available":c?"Next Week":"Already at current week",children:e.jsx("path",{d:"M15.0378 6.34317L13.6269 7.76069L16.8972 11.0157L3.29211 11.0293L3.29413 13.0293L16.8619 13.0157L13.6467 16.2459L15.0643 17.6568L20.7079 11.9868L15.0378 6.34317Z",fill:"currentColor"})})})]}),e.jsx("div",{className:"week-navigator-content",children:h&&e.jsx("div",{className:"week-navigator-progress",children:e.jsxs("div",{className:"week-navigator-progress-meso",children:[e.jsx("div",{className:"sidebar-progress-track week-navigator-progress-bar-container",children:e.jsx("div",{className:"sidebar-progress-fill week-navigator-progress-bar",style:{width:`${T>0?Math.min(I/T*100,100):0}%`},children:T>0&&I>0&&e.jsx("div",{className:"week-navigator-progress-shimmer"})})}),e.jsxs("div",{className:"sidebar-progress-numbers",children:[e.jsx("span",{children:Q(I)}),e.jsx("span",{children:Q(T)})]})]})})}),e.jsx("div",{className:"week-navigator-buttons",children:h?e.jsx("div",{className:"week-navigator-spacer"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:O,className:"week-navigator-button current-week-btn",title:"Jump to current week",children:"Current Week"}),k&&e.jsx("button",{onClick:M,className:"week-navigator-button oldest-data-btn",title:`Jump to oldest data (${o.oldestHistoricalWeek})`,children:"Oldest Data"})]})})]},t)}function Te({data:t,characterBossSelections:n,onClose:i,onConfirm:u}){const[f,P]=l.useState(""),[D,o]=l.useState(""),[L,v]=l.useState(!1),d=l.useMemo(()=>t.weekKey?me(t.weekKey):{start:null,end:null},[t.weekKey]),j=l.useCallback(m=>m.toISOString().split("T")[0],[]),W=l.useMemo(()=>{if(!d.start||!d.end)return[];const m=[],x=new Date(d.start),O=new Date(d.end);for(;x<=O;)m.push(new Date(x)),x.setDate(x.getDate()+1);return m},[d]);l.useEffect(()=>{W.length>0&&!f&&P(j(W[0])),n.length>0&&!D&&o(n[0].name)},[W,f,n,D,j]);const N=async()=>{if(!f||!D)return;v(!0);const m=new Date(f+"T12:00:00.000Z").toISOString();await u(m,D),v(!1)};return e.jsxs("div",{className:"historical-modal-container",onClick:m=>m.stopPropagation(),children:[e.jsx("div",{className:"historical-modal-header",children:e.jsx("img",{src:t.itemImage,alt:t.itemName,className:"historical-modal-header-image"})}),e.jsx("h2",{className:"historical-modal-title",children:"Log Historical Pitched Item"}),e.jsxs("div",{className:"historical-modal-info-box",children:[e.jsxs("div",{className:"historical-modal-info-item",children:[e.jsx("span",{className:"historical-modal-info-label",children:"Character:"})," ",D||t.character]}),e.jsxs("div",{className:"historical-modal-info-item",children:[e.jsx("span",{className:"historical-modal-info-label",children:"Boss:"})," ",t.bossName]}),e.jsxs("div",{className:"historical-modal-info-item",children:[e.jsx("span",{className:"historical-modal-info-label",children:"Item:"})," ",t.itemName]}),e.jsxs("div",{className:"historical-modal-info-item",children:[e.jsx("span",{className:"historical-modal-info-label",children:"Week:"})," ",t.weekKey]})]}),e.jsxs("div",{className:"historical-modal-form-section",children:[e.jsx("label",{className:"historical-modal-label",children:"Select Character:"}),e.jsx("select",{value:D,onChange:m=>o(m.target.value),className:"historical-modal-select",children:n.map(m=>e.jsx("option",{value:m.name,children:m.name},m.name))})]}),e.jsxs("div",{className:"historical-modal-form-section",children:[e.jsx("label",{className:"historical-modal-label",children:"Select Date:"}),e.jsx("input",{type:"date",value:f,onChange:m=>P(m.target.value),min:d.start?j(d.start):"",max:d.end?j(d.end):"",className:"historical-modal-date-input"}),d.start&&d.end&&e.jsxs("div",{className:"historical-modal-helper-text",children:["Valid range: ",j(d.start)," to ",j(d.end)]})]}),e.jsxs("div",{className:"historical-modal-buttons",children:[e.jsx("button",{onClick:i,disabled:L,className:"historical-modal-button historical-modal-button-cancel",children:"Cancel"}),e.jsxs("button",{onClick:N,disabled:L||!f||!D,className:"historical-modal-button historical-modal-button-confirm",children:[L&&e.jsx("div",{className:"historical-modal-spinner"}),L?"Logging...":"Log Item"]})]})]})}function Le({startPosition:t,endPosition:n,onComplete:i}){const[u,f]=l.useState(t),[P,D]=l.useState(1);return l.useEffect(()=>{const o=Date.now(),L=1e3,v=()=>{const d=Date.now()-o,j=Math.min(d/L,1),W=1-Math.pow(1-j,3),N=t.x+(n.x-t.x)*W,m=t.y+(n.y-t.y)*W;f({x:N,y:m}),D(1-j),j<1?requestAnimationFrame(v):i()};requestAnimationFrame(v)},[t,n,i]),e.jsx("div",{style:{position:"fixed",left:u.x,top:u.y,transform:"translate(-50%, -50%)",opacity:P,pointerEvents:"none",zIndex:1e3,transition:"transform 0.1s ease"},children:e.jsx("img",{src:"/bosses/crystal.png",alt:"Crystal",style:{width:24,height:24,transform:`rotate(${u.x*.1}deg)`,filter:"drop-shadow(0 0 4px rgba(162, 89, 247, 0.6))"}})})}function Ie({sidebarVisible:t,isHistoricalWeek:n,totalMeso:i,obtainableMeso:u,selectedWeekKey:f,hideCompleted:P,setHideCompleted:D,visibleCharSummaries:o,selectedCharIdx:L,setSelectedCharIdx:v,setPurgeTargetCharacter:d,setShowCharacterPurgeConfirm:j}){const[W,N]=l.useState(!1),[m,x]=l.useState(!1),O=l.useRef(null),M=l.useRef(null);return l.useEffect(()=>{const p=()=>{const h=O.current;if(h){const k=h.scrollHeight>h.clientHeight,s=h.scrollTop+h.clientHeight>=h.scrollHeight-5;N(k&&!s&&!m)}},c=()=>{x(!0),N(!1),M.current&&clearTimeout(M.current),M.current=setTimeout(()=>{x(!1),p()},1e3)};p();const g=O.current;if(g)return g.addEventListener("scroll",c),()=>{g.removeEventListener("scroll",c),M.current&&clearTimeout(M.current)}},[o,m,O,M]),l.useEffect(()=>{t&&setTimeout(()=>{const p=O.current;if(p){const c=p.scrollHeight>p.clientHeight,g=p.scrollTop+p.clientHeight>=p.scrollHeight-5;N(c&&!g&&!m)}},100)},[t,m]),e.jsx(e.Fragment,{children:e.jsx("div",{className:`sidebar-scroll fade-in-no-slide ${t?"visible":"hidden"}`,children:e.jsxs("div",{className:"sidebar-content",children:[e.jsx("div",{className:"sidebar-header",children:e.jsx("h3",{className:"sidebar-title",children:"Characters"})}),!n&&e.jsxs("div",{className:"sidebar-progress-section",children:[e.jsx("div",{className:"sidebar-progress-title",children:"Weekly Progress"}),e.jsx("div",{className:"sidebar-progress-track week-navigator-progress-bar-container",children:e.jsx("div",{className:"sidebar-progress-fill week-navigator-progress-bar",style:{width:`${u>0?Math.min(i/u*100,100):0}%`},children:u>0&&i>0&&e.jsx("div",{className:"week-navigator-progress-shimmer"})})}),e.jsxs("div",{className:"sidebar-progress-numbers",children:[e.jsx("span",{children:Q(i)}),e.jsx("span",{children:Q(u)})]})]}),n&&e.jsxs("div",{className:"sidebar-historical-section",children:[e.jsxs("div",{className:"sidebar-historical-title",children:["Week ",f.split("-").slice(1).join("-")]}),e.jsx("div",{className:"sidebar-historical-subtitle",children:"Historical Data"})]}),e.jsxs("div",{className:"sidebar-character-list-container",children:[e.jsx("div",{className:"sidebar-character-list",ref:O,children:o.length===0?e.jsx("div",{className:"sidebar-empty-state",children:P?"No characters with bosses left to clear.":"No characters found."}):o.map(p=>e.jsxs("div",{onClick:()=>{v(p.idx)},onContextMenu:c=>{c.preventDefault(),d({name:p.name,idx:p.idx}),j(!0)},className:`sidebar-character-card ${L===p.idx?`selected ${n?"historical-week":"current-week"}`:"default"}`,children:[e.jsxs("div",{className:"sidebar-character-header",children:[e.jsx("span",{className:`sidebar-character-name ${L===p.idx?"selected":"default"}`,children:p.name}),p.allCleared&&e.jsxs("svg",{className:"sidebar-character-checkmark",width:"16",height:"16",viewBox:"0 0 22 22",children:[e.jsx("circle",{cx:"11",cy:"11",r:"11",fill:"#38a169"}),e.jsx("polyline",{points:"6,12 10,16 16,7",fill:"none",stroke:"#fff",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})]})]}),e.jsx("div",{className:"sidebar-character-stats",children:p.total===0?e.jsx("div",{className:"sidebar-character-no-bosses",children:"No bosses configured"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sidebar-character-completion",children:[p.cleared," / ",p.total," bosses cleared"]}),e.jsxs("div",{className:"sidebar-character-meso",children:[Q(p.totalMeso)," meso"]})]})})]},p.name+"-"+p.idx))}),W&&e.jsx("div",{className:"sidebar-scroll-indicator",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M11.0001 3.67157L13.0001 3.67157L13.0001 16.4999L16.2426 13.2574L17.6568 14.6716L12 20.3284L6.34314 14.6716L7.75735 13.2574L11.0001 16.5001L11.0001 3.67157Z",fill:"currentColor"})})})]})]})})})}function $e({sidebarVisible:t,setSidebarVisible:n}){return e.jsx("div",{className:`sidebar-toggle ${t?"visible":"hidden"}`,onClick:()=>n(!t),title:t?"Hide sidebar":"Show sidebar",children:t?e.jsxs("svg",{className:"sidebar-toggle-close-icon",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"crossGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#ffffff"}),e.jsx("stop",{offset:"50%",stopColor:"#e6e0ff"}),e.jsx("stop",{offset:"100%",stopColor:"#d6b4ff"})]})}),e.jsx("path",{d:"M6.2253 4.81108C5.83477 4.42056 5.20161 4.42056 4.81108 4.81108C4.42056 5.20161 4.42056 5.83477 4.81108 6.2253L10.5858 12L4.81114 17.7747C4.42062 18.1652 4.42062 18.7984 4.81114 19.1889C5.20167 19.5794 5.83483 19.5794 6.22535 19.1889L12 13.4142L17.7747 19.1889C18.1652 19.5794 18.7984 19.5794 19.1889 19.1889C19.5794 18.7984 19.5794 18.1652 19.1889 17.7747L13.4142 12L19.189 6.2253C19.5795 5.83477 19.5795 5.20161 19.189 4.81108C18.7985 4.42056 18.1653 4.42056 17.7748 4.81108L12 10.5858L6.2253 4.81108Z",fill:"url(#crossGradient)"})]}):e.jsx("div",{className:"sidebar-toggle-hamburger",children:[0,1,2].map(i=>e.jsx("span",{className:"sidebar-toggle-hamburger-line"},i))})})}function He({selectedWeekKey:t,showTickAll:n,onTickAll:i,allTicked:u}){const f=A(),P=t===f;return e.jsxs("div",{className:"mode-indicator-container purple",children:[e.jsx("div",{className:"mode-indicator-content",children:e.jsxs("div",{className:"mode-indicator-text",children:[e.jsx("div",{className:"mode-indicator-title",children:P?"Active Week Tracking":"Historical Week Review"}),e.jsx("div",{className:"mode-indicator-description",children:P?"Track your boss clears and pitched item  for the current week":"Track you pitched items you have collected this week"})]})}),n&&P&&e.jsx("button",{onClick:i,className:"mode-indicator-tick-all-button",title:u?"Clear all boss completions":"Mark all bosses as completed",children:u?"Clear All":"Complete All"})]})}function J(t,n,i,u,f){return`${t}-${n}__${i}__${u}__${f}`}const Re=Object.freeze(Object.defineProperty({__proto__:null,getPitchedKey:J},Symbol.toStringTag,{value:"Module"}));function Ee({isHistoricalWeek:t,characterBossSelections:n,selectedCharIdx:i,sortedBosses:u,bossData:f,checked:P,charKey:D,getBossPrice:o,pitchedChecked:L,weekKey:v,handleCheck:d,userInteractionRef:j,userCode:W,savePitchedItem:N,setPitchedChecked:m,setError:x,startStatsTrackingIfNeeded:O,setHistoricalPitchedData:M,setShowHistoricalPitchedModal:p,loadingPitchedItems:c,setLoadingPitchedItems:g,refreshPitchedItems:h,refreshHistoricalAnalysis:k}){if(t){const s=new Map;return n.forEach(a=>{var y;(y=a.bosses)==null||y.forEach(S=>{const T=f.find(I=>I.name===S.name);T&&T.pitchedItems&&T.pitchedItems.length>0&&s.set(S.name,T)})}),e.jsx("div",{className:"historical-week-cards-container",children:Array.from(s.values()).map(a=>e.jsxs("div",{className:"historical-boss-card",children:[e.jsxs("div",{className:"historical-boss-header",children:[e.jsx("img",{src:a.image,alt:a.name,className:"historical-boss-image"}),e.jsx("div",{className:"historical-boss-info",children:e.jsx("div",{className:"historical-boss-name",children:a.name})})]}),e.jsxs("div",{className:"historical-pitched-section",children:[e.jsx("div",{className:"historical-pitched-label",children:"Pitched Items"}),(a.pitchedItems||[]).length>0?e.jsx("div",{className:"historical-pitched-grid",children:(a.pitchedItems||[]).map(y=>{const S=J(n[i].name,i,a.name,y.name,v),T=!!L[S],I=T?n[i].name:null;return e.jsxs("div",{className:`historical-pitched-item ${T?"obtained":""}`,title:T?`Click to remove: ${y.name} (obtained by ${I})`:`Click to track: ${y.name}`,onClick:async r=>{if(r.stopPropagation(),T)try{const C=await N(W,{character:I,characterIdx:n.findIndex(U=>U.name===I),bossName:a.name,bossDifficulty:"Unknown",itemName:y.name,itemImage:y.image,date:new Date().toISOString()},!0,v);C.success?(await h(W),k&&await k()):x("Failed to remove historical pitched item: "+(C.error||"Unknown error"))}catch(C){x("Error removing historical pitched item: "+C.message)}else M({character:"",characterIdx:-1,bossName:a.name,itemName:y.name,itemImage:y.image,weekKey:v}),p(!0)},children:[e.jsx("img",{src:y.image,alt:y.name,className:`historical-pitched-item-image ${T?"obtained":"not-obtained"}`}),T&&e.jsx("span",{className:"historical-pitched-checkmark",children:"âœ“"})]},y.name)})}):e.jsx("div",{className:"historical-no-pitched",children:"No pitched items available"})]})]},a.name))})}return e.jsx("div",{className:"boss-table-scroll",children:e.jsxs("table",{className:`boss-table ${t?"historical-week":""}`,children:[e.jsx("thead",{children:e.jsxs("tr",{className:"boss-table-header-row",children:[e.jsx("th",{className:"boss-table-header-cell",children:"Boss"}),e.jsx("th",{className:"boss-table-header-cell-difficulty",children:"Difficulty"}),e.jsx("th",{className:"boss-table-header-cell-mesos",children:"Mesos"}),e.jsx("th",{className:"boss-table-header-cell-cleared",children:"Cleared"})]})}),e.jsx("tbody",{children:u.map((s,a)=>{var I;const y=f.find(r=>r.name===s.name),S=!!((I=P[D])!=null&&I[s.name+"-"+s.difficulty]),T=(y==null?void 0:y.pitchedItems)||[];return e.jsxs("tr",{className:`boss-table-row ${a%2===0?"even":"odd"}`,onClick:r=>{!r.target.closest(".checkbox-wrapper")&&!r.target.closest(".pitched-item-icon")&&d(s,!S,r)},children:[e.jsxs("td",{className:"boss-table-cell-boss",children:[(y==null?void 0:y.image)&&e.jsx("img",{src:y.image,alt:s.name,className:"boss-table-boss-image"}),e.jsx("span",{className:"boss-table-boss-name",children:s.name}),T.length>0&&e.jsx("div",{className:"boss-table-pitched-container inline",children:T.map(r=>{if((s.name==="Watcher Kalos"||s.name==="Kaling")&&r.name==="Grindstone of Life"){const H=J(n[i].name,i,s.name,r.name,v),K=!!L[H];return e.jsxs("span",{className:`pitched-item-icon inline ${K?"obtained":""}`,title:K?`Click to remove: ${r.name}`:`Click to track: ${r.name}`,onClick:async _=>{var z;if(_.stopPropagation(),t){M({character:"",characterIdx:-1,bossName:s.name,itemName:r.name,itemImage:r.image,weekKey:v}),p(!0);return}const b=`${n[i].name}-${i}`,w=J(n[i].name,i,s.name,r.name,v),$=!!L[w];j.current=!0,t||(z=P[b])!=null&&z[s.name+"-"+s.difficulty]||d(s,!0,_),g(R=>({...R,[w]:!0}));try{if(!W){x("Please log in to save pitched items to cloud.");return}const R=!$;m(F=>{const E={...F};return R?E[w]=!0:delete E[w],E}),(await N(W,{character:n[i].name,characterIdx:i,bossName:s.name,bossDifficulty:s.difficulty,itemName:r.name,itemImage:r.image,date:new Date().toISOString()},$,v)).success?k&&k().catch(F=>{console.error("Error refreshing historical analysis:",F)}):(x("Failed to save to cloud. Reverting changes."),m(F=>{const E={...F};return $?E[w]=!0:delete E[w],E}))}catch{x("Failed to update pitched item. Please try again."),m(B=>{const F={...B};return $?F[w]=!0:delete F[w],F})}finally{g(R=>{const B={...R};return delete B[w],B}),setTimeout(()=>{j.current=!1},1e3)}O()},children:[c[H]?e.jsx("div",{className:"pitched-item-loading inline",children:e.jsx("div",{className:"pitched-item-spinner inline"})}):e.jsx("img",{src:r.image,alt:r.name,className:`pitched-item-image inline ${K?"obtained":"not-obtained"}`}),K&&!c[H]&&e.jsx("span",{className:"pitched-item-checkmark inline",children:"âœ“"})]},r.name)}if(s.name==="Lotus"&&(r.name==="Total Control"&&s.difficulty!=="Extreme"||(r.name==="Berserked"||r.name==="Black Heart")&&!["Hard","Extreme"].includes(s.difficulty))||s.name==="Chosen Seren"&&r.name==="Gravity Module"&&s.difficulty!=="Extreme"||s.name==="Watcher Kalos"&&r.name==="Mark of Destruction"&&s.difficulty!=="Extreme"||s.name==="Kaling"&&r.name==="Helmet of Loyalty"&&s.difficulty!=="Extreme"||s.name!=="Lotus"&&s.name!=="Watcher Kalos"&&s.name!=="Kaling"&&!["Hard","Chaos","Extreme","Hell"].includes(s.difficulty))return null;const C=J(n[i].name,i,s.name,r.name,v),U=!!L[C];return e.jsxs("span",{className:`pitched-item-icon inline ${U?"obtained":""}`,title:U?`Click to remove: ${r.name}`:`Click to track: ${r.name}`,onClick:async H=>{var w;if(H.stopPropagation(),t){M({character:"",characterIdx:-1,bossName:s.name,itemName:r.name,itemImage:r.image,weekKey:v}),p(!0);return}const K=`${n[i].name}-${i}`,_=J(n[i].name,i,s.name,r.name,v),b=!!L[_];j.current=!0,t||(w=P[K])!=null&&w[s.name+"-"+s.difficulty]||d(s,!0,H),g($=>({...$,[_]:!0}));try{if(!W){x("Please log in to save pitched items to cloud.");return}const $=!b;m(R=>{const B={...R};return $?B[_]=!0:delete B[_],B}),(await N(W,{character:n[i].name,characterIdx:i,bossName:s.name,bossDifficulty:s.difficulty,itemName:r.name,itemImage:r.image,date:new Date().toISOString()},b,v)).success?k&&k().catch(R=>{console.error("Error refreshing historical analysis:",R)}):(x("Failed to save to cloud. Reverting changes."),m(R=>{const B={...R};return b?B[_]=!0:delete B[_],B}))}catch{x("Failed to update pitched item. Please try again."),m(z=>{const R={...z};return b?R[_]=!0:delete R[_],R})}finally{g($=>{const z={...$};return delete z[_],z}),setTimeout(()=>{j.current=!1},1e3)}O()},children:[c[C]?e.jsx("div",{className:"pitched-item-loading inline",children:e.jsx("div",{className:"pitched-item-spinner inline"})}):e.jsx("img",{src:r.image,alt:r.name,className:`pitched-item-image inline ${U?"obtained":"not-obtained"}`}),U&&!c[C]&&e.jsx("span",{className:"pitched-item-checkmark inline",children:"âœ“"})]},r.name)})})]}),e.jsx("td",{className:"boss-table-cell-difficulty",children:e.jsx("span",{children:s.difficulty})}),e.jsx("td",{className:"boss-table-cell-mesos",children:e.jsx("span",{children:Math.floor(o(s.name,s.difficulty)/(s.partySize||1)).toLocaleString()})}),e.jsx("td",{className:"boss-table-cell-cleared",children:e.jsx("span",{onClick:r=>r.stopPropagation(),children:e.jsx(De,{checked:S,onChange:r=>d(s,r.target.checked,r)})})})]},s.name+"-"+s.difficulty)})})]})})}function Me({showStats:t,setShowStats:n,allYears:i,selectedYear:u,setSelectedYear:f,yearlyPitchedSummary:P,isLoadingCloudStats:D,setPitchedModalItem:o,setShowPitchedModal:L,setShowStatsResetConfirm:v}){return t?e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(40,32,74,0.92)",zIndex:5e3,display:"flex",alignItems:"center",justifyContent:"center"},onClick:()=>n(!1),children:e.jsxs("div",{className:"modal-fade",style:{background:"#2d2540",borderRadius:14,padding:"2.5rem 2rem",maxWidth:600,color:"#e6e0ff",boxShadow:"0 4px 24px #0006",position:"relative",minWidth:320,maxHeight:"90vh",overflowY:"auto"},onClick:d=>d.stopPropagation(),children:[e.jsx("button",{onClick:()=>n(!1),style:{position:"absolute",top:16,right:16,background:"transparent",color:"#fff",border:"none",fontSize:"1.5rem",cursor:"pointer"},title:"Close",children:"Ã—"}),e.jsx("h2",{style:{color:"#a259f7",fontWeight:700,marginBottom:18,textAlign:"center"},children:"Yearly Stats"}),e.jsx("div",{style:{marginBottom:18,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsx("select",{value:u,onChange:d=>f(d.target.value),style:{background:"#3a335a",color:"#e6e0ff",border:"1px solid #805ad5",borderRadius:6,padding:"6px 18px",fontWeight:600,fontSize:"1.08em",minWidth:120,textAlign:"center"},children:i.map(d=>e.jsx("option",{value:d,children:d},d))})}),e.jsx("div",{style:{marginBottom:8,textAlign:"center"},children:P.length===0?`No pitched items were found for ${u}`:"Pitched Items Obtained:"}),D?e.jsx("div",{style:{textAlign:"center",padding:"15px",color:"#b39ddb"},children:"Loading cloud stats..."}):P.length===0?e.jsx("div",{style:{textAlign:"center",padding:"2rem",color:"#888",fontSize:"1.1rem"}}):e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:10,marginBottom:8,justifyContent:"center"},children:P.map((d,j)=>e.jsxs("span",{className:"pitched-count-white pitched-hover",style:{display:"inline-flex",alignItems:"center",gap:4,background:"#3a335a",borderRadius:6,padding:"2px 10px",fontSize:"1em",fontWeight:600,cursor:"pointer",boxShadow:"0 0 8px #805ad5",border:"1px solid #805ad5",transition:"transform 0.18s cubic-bezier(.4,2,.6,1), box-shadow 0.18s cubic-bezier(.4,2,.6,1)",position:"relative"},onClick:()=>{o(d),L(!0)},title:"Click for details",onMouseOver:W=>{W.currentTarget.style.transform="scale(1.08)",W.currentTarget.style.boxShadow="0 4px 16px #a259f7cc"},onMouseOut:W=>{W.currentTarget.style.transform="scale(1)",W.currentTarget.style.boxShadow="0 0 8px #805ad5"},children:[e.jsx("img",{src:d.image,alt:d.name,style:{width:22,borderRadius:4,marginRight:2,transition:"box-shadow 0.18s cubic-bezier(.4,2,.6,1)"}}),d.name,e.jsxs("span",{className:"pitched-count-white",style:{color:"#fff",marginLeft:6,fontWeight:700,fontSize:"1.1em"},children:["Ã—",d.count]})]},j))}),e.jsx("div",{style:{textAlign:"center",marginTop:24},children:e.jsx("button",{style:{background:"#e53e3e",color:"#fff",border:"none",borderRadius:8,padding:"0.6rem 1.5rem",fontWeight:700,fontSize:"1.1rem",cursor:"pointer"},onClick:()=>v(!0),children:"Reset Stats"})})]})}):null}function _e({showStatsResetConfirm:t,setShowStatsResetConfirm:n,onConfirm:i}){return t?e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(40,32,74,0.92)",zIndex:6e3,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{className:"modal-fade",style:{background:"#2d2540",borderRadius:14,padding:"2rem 1.5rem",maxWidth:340,color:"#e6e0ff",boxShadow:"0 4px 24px #0006",position:"relative",minWidth:220,textAlign:"center"},children:[e.jsx("h3",{style:{color:"#ffbaba",marginBottom:16},children:"Are you sure?"}),e.jsx("p",{style:{marginBottom:18},children:"This will permanently erase all stats. This cannot be undone."}),e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:[e.jsx("button",{onClick:()=>n(!1),style:{background:"#3a335a",color:"#e6e0ff",border:"none",borderRadius:8,padding:"0.7rem 1.5rem",fontWeight:700,fontSize:"1.1rem",cursor:"pointer",minWidth:100},children:"Cancel"}),e.jsx("button",{onClick:i,style:{background:"#e53e3e",color:"#fff",border:"none",borderRadius:8,padding:"0.7rem 1.5rem",fontWeight:700,fontSize:"1.1rem",cursor:"pointer",minWidth:100},children:"Reset"})]})]})}):null}function ze({showCharacterPurgeConfirm:t,setShowCharacterPurgeConfirm:n,purgeTargetCharacter:i,purgeInProgress:u,onConfirm:f}){return t?e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(40,32,74,0.96)",zIndex:6e3,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{className:"modal-fade",style:{background:"#2d2540",borderRadius:16,padding:"2.5rem",maxWidth:480,color:"#e6e0ff",boxShadow:"0 8px 32px rgba(0,0,0,0.5)",position:"relative",minWidth:360,textAlign:"center",border:"2px solid #ff6b6b"},children:[e.jsx("div",{style:{width:80,height:80,background:"linear-gradient(135deg, #ff6b6b, #ff8e8e)",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 24px",boxShadow:"0 4px 20px rgba(255, 107, 107, 0.4)"},children:e.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z",stroke:"#fff",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})})}),e.jsx("h2",{style:{color:"#ff6b6b",fontWeight:700,marginBottom:20,fontSize:"1.5rem"},children:"Purge Character Data"}),e.jsxs("div",{style:{background:"rgba(255, 107, 107, 0.1)",border:"1px solid rgba(255, 107, 107, 0.3)",borderRadius:12,padding:"20px",marginBottom:28},children:[e.jsx("p",{style:{marginBottom:12,fontSize:"1.1rem",lineHeight:"1.5",color:"#ffbaba"},children:e.jsx("strong",{children:"This will permanently delete all pitched items and boss runs for:"})}),e.jsx("p",{style:{fontSize:"1.2rem",fontWeight:700,color:"#fff",marginBottom:12},children:i==null?void 0:i.name}),e.jsx("p",{style:{fontSize:"0.9rem",color:"#ffbaba",marginBottom:0},children:"This action cannot be undone."})]}),e.jsxs("div",{style:{display:"flex",gap:16,justifyContent:"center"},children:[e.jsx("button",{onClick:()=>n(!1),disabled:u,style:{background:u?"#2a2540":"#3a335a",color:u?"#888":"#e6e0ff",border:u?"1px solid #2a2540":"2px solid #4a4370",borderRadius:12,padding:"0.8rem 2rem",fontWeight:700,fontSize:"1.1rem",cursor:u?"not-allowed":"pointer",minWidth:140,transition:"all 0.2s ease",opacity:u?.5:1},children:"Cancel"}),e.jsxs("button",{onClick:f,disabled:u,style:{background:u?"#cc5555":"linear-gradient(135deg, #ff6b6b, #ff4757)",color:"#fff",border:"2px solid #ff6b6b",borderRadius:12,padding:"0.8rem 2rem",fontWeight:700,fontSize:"1.1rem",cursor:u?"not-allowed":"pointer",opacity:u?.7:1,minWidth:140,transition:"all 0.2s ease",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",boxShadow:u?"none":"0 4px 16px rgba(255, 107, 107, 0.3)"},children:[u&&e.jsx("div",{style:{width:20,height:20,border:"2px solid rgba(255, 255, 255, 0.3)",borderTopColor:"#fff",borderRadius:"50%",animation:"spin 1s linear infinite"}}),u?"Purging...":"Purge Data"]})]})]})}):null}function Fe({resetSuccessVisible:t,closeResetSuccess:n,purgeSuccess:i,setPurgeSuccess:u}){return!t&&!i?null:e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.7)",zIndex:7e3,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{className:"modal-fade",style:{background:"#2d2540",borderRadius:14,padding:"2rem 1.5rem",maxWidth:340,color:"#e6e0ff",boxShadow:"0 4px 24px #0006",position:"relative",minWidth:220,textAlign:"center"},onClick:f=>f.stopPropagation(),children:[e.jsx("h3",{style:{color:"#38a169",marginBottom:16,fontSize:"1.5rem"},children:t?"Stats reset!":"Character purged!"}),e.jsx("p",{style:{marginBottom:24,fontSize:"1.1rem"},children:t?"Your stats have been cleared.":"Character data has been purged."}),e.jsx("button",{onClick:t?n:()=>u(!1),style:{background:"#3a335a",color:"#e6e0ff",border:"none",borderRadius:8,padding:"0.6rem 1.5rem",fontWeight:600,fontSize:"1.1rem",cursor:"pointer",marginTop:10,boxShadow:"0 2px 8px rgba(0,0,0,0.3)"},children:"Close"})]})})}function Ke({showPitchedModal:t,setShowPitchedModal:n,pitchedModalItem:i,pitchedModalDetails:u}){return!t||!i?null:e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(40,32,74,0.92)",zIndex:6e3,display:"flex",alignItems:"center",justifyContent:"center"},onClick:()=>n(!1),children:e.jsxs("div",{className:"modal-fade",style:{background:"#2d2540",borderRadius:14,padding:"2rem 1.5rem",maxWidth:400,color:"#e6e0ff",boxShadow:"0 4px 24px #0006",position:"relative",minWidth:220,textAlign:"center"},onClick:f=>f.stopPropagation(),children:[e.jsx("button",{onClick:()=>n(!1),style:{position:"absolute",top:12,right:12,background:"transparent",color:"#fff",border:"none",fontSize:"1.3rem",cursor:"pointer"},title:"Close",children:"Ã—"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:10,marginBottom:16},children:[e.jsx("img",{src:i.image,alt:i.name,style:{width:32,borderRadius:6}}),e.jsx("span",{style:{fontWeight:700,fontSize:"1.1em",color:"#a259f7"},children:i.name})]}),e.jsx("div",{style:{marginBottom:10,color:"#b39ddb",fontWeight:600},children:"Obtained by:"}),u.length===0?e.jsx("div",{style:{color:"#888",marginBottom:8},children:"None this year."}):e.jsx("div",{style:{maxHeight:220,overflowY:"auto",marginBottom:8},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:"1em",background:"none"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{color:"#b39ddb",background:"none"},children:[e.jsx("th",{style:{padding:"4px 8px",fontWeight:700},children:"Character"}),e.jsx("th",{style:{padding:"4px 8px",fontWeight:700},children:"Date"})]})}),e.jsx("tbody",{children:u.map((f,P)=>e.jsxs("tr",{style:{background:P%2===0?"#23203a":"#201c32"},children:[e.jsx("td",{style:{padding:"4px 8px",fontWeight:600},children:f.char}),e.jsx("td",{style:{padding:"4px 8px",color:"#b39ddb"},children:f.date})]},P))})]})})]})})}function Oe(t){const n=A(),[i,u]=l.useState(n),[f,P]=l.useState([]),[D,o]=l.useState({}),[L,v]=l.useState({hasHistoricalData:!1,oldestHistoricalWeek:null,userType:"new",adaptiveWeekLimit:8,historicalWeeks:[]}),d=i!==n,j=l.useCallback(async()=>{if(t)try{console.log("ðŸ”„ Refreshing historical analysis...");const N=await ce(t);N.success&&(v({hasHistoricalData:N.hasHistoricalData,oldestHistoricalWeek:N.oldestHistoricalWeek,userType:N.userType,adaptiveWeekLimit:N.adaptiveWeekLimit,historicalWeeks:N.historicalWeeks,analysis:N.analysis}),console.log("âœ… Historical analysis refreshed:",{userType:N.userType,hasData:N.hasHistoricalData,oldestWeek:N.oldestHistoricalWeek,adaptiveLimit:N.adaptiveWeekLimit}))}catch(N){console.error("Error refreshing historical analysis:",N)}},[t,v]),W=async(N,m={},x=[],O={})=>{N!==i&&(console.log(`Navigating from week ${i} to ${N}`),i&&!D[i]&&(Object.keys(m).length>0||x.length>0)&&o(M=>({...M,[i]:{checkedState:m,pitchedItems:x,pitchedChecked:O,hasData:Object.keys(m).length>0||x.length>0}})),u(N))};return l.useEffect(()=>{(async()=>{if(t)try{const[m,x]=await Promise.all([ye(t),ce(t)]);m.success&&P(m.weeks),x.success&&(v({hasHistoricalData:x.hasHistoricalData,oldestHistoricalWeek:x.oldestHistoricalWeek,userType:x.userType,adaptiveWeekLimit:x.adaptiveWeekLimit,historicalWeeks:x.historicalWeeks,analysis:x.analysis}),console.log("ðŸ“Š Week navigation updated with historical analysis:",{userType:x.userType,hasData:x.hasHistoricalData,oldestWeek:x.oldestHistoricalWeek,adaptiveLimit:x.adaptiveWeekLimit}))}catch(m){console.error("Error fetching week navigation data:",m)}})()},[t]),{selectedWeekKey:i,availableWeeks:f,weekDataCache:D,setWeekDataCache:o,isHistoricalWeek:d,handleWeekChange:W,historicalAnalysis:L,refreshHistoricalAnalysis:j}}function Be(t,n,i,u,f,P=null){const[D,o]=l.useState({}),[L,v]=l.useState([]),[d,j]=l.useState(!1),[W,N]=l.useState({}),m=l.useRef(!1),x=l.useCallback(M=>{if(!M)return M;const p=M.split("-");if(p.length===3){const c=p[0],g=parseInt(p[1]).toString(),h=parseInt(p[2]).toString();return`${c}-${g}-${h}`}return M},[]),O=async M=>{if(!d)try{j(!0);const p=M||t;if(!p)return;const c=await be(p);if(c.success){if(v(c.items||[]),!m.current){const g=x(f),h=(c.items||[]).filter(s=>x(s.weekKey)===g),k={};h.forEach(s=>{const a=s.characterIdx!==void 0?s.characterIdx:n.findIndex(S=>S.name===s.character),y=n[a];if(y&&y.name===s.character){const S=J(s.character,a,s.boss,s.item,f);k[S]=!0}}),o(k)}}else console.error("Error refreshing pitched items:",c.error)}catch(p){console.error("Error in refreshPitchedItems:",p)}finally{j(!1)}};return l.useEffect(()=>{if(!t)return;(async()=>{try{const{supabase:p}=await X(async()=>{const{supabase:h}=await import("./supabaseClient-D8oTKsok.js");return{supabase:h}},__vite__mapDeps([0,1,2])),{data:c,error:g}=await p.from("user_data").select("pitched_items").eq("id",t).single();if(g){console.error("Error fetching pitched items:",g);return}c&&c.pitched_items&&Array.isArray(c.pitched_items)?v(c.pitched_items):v([])}catch(p){console.error("Error in fetchPitchedItemsFromDatabase:",p)}})()},[t,v]),l.useEffect(()=>{if(L.length===0)return;(async()=>{try{if(m.current)return;const p=x(f),c=A(),g=x(c);if(p!==g)return;const h=L.filter(k=>x(k.weekKey)===p);if(h.length>0){const k={...i},s={};let a=!1;h.forEach(y=>{const S=y.characterIdx!==void 0?y.characterIdx:n.findIndex(H=>H.name===y.character),T=n[S];if(!T||T.name!==y.character)return;const I=`${y.character}-${S}`;k[I]||(k[I]={});const r=T.bosses.find(H=>H.name===y.boss);if(!r)return;const C=`${r.name}-${r.difficulty}`,U=J(y.character,S,y.boss,y.item,f);s[U]=!0,k[I][C]||(k[I][C]=!0,a=!0)}),o(s),a&&(!P||!P.current)&&u(k)}}catch(p){console.error("Error in syncPitchedWithBossChecks:",p)}})()},[L,f,x,m,n,i,u,P]),l.useEffect(()=>{if(!f||!L.length)return;const M=x(f),p=L.filter(g=>x(g.weekKey)===M),c={};p.forEach(g=>{const h=g.characterIdx!==void 0?g.characterIdx:n.findIndex(s=>s.name===g.character),k=n[h];if(k&&k.name===g.character){const s=J(g.character,h,g.boss,g.item,f);c[s]=!0}}),o(c)},[f,L,n,x,o]),{pitchedChecked:D,setPitchedChecked:o,cloudPitchedItems:L,setCloudPitchedItems:v,userInteractionRef:m,refreshPitchedItems:O,loadingPitchedItems:W,setLoadingPitchedItems:N,isRefreshingPitchedItems:d}}function Ye({characterBossSelections:t,selectedCharIdx:n,checked:i,setChecked:u,bossData:f,pitchedChecked:P,setPitchedChecked:D,weekKey:o,selectedWeekKey:L,userCode:v,userInteractionRef:d,setCrystalAnimation:j,setError:W,startStatsTrackingIfNeeded:N,refreshHistoricalAnalysis:m}){const x=A();return{handleCheck:async(c,g,h=null)=>{var k;try{d.current=!0;let s,a,y;if(c&&c.name)s=c,a=g,y=h;else if(c&&c.target)y=c,s=g,a=y.target.checked;else{console.error("Invalid parameters to handleCheck");return}if(y&&y.clientX&&j){const K={x:y.clientX,y:y.clientY},_=document.querySelector(".progress-bar");if(_){const b=_.getBoundingClientRect(),w={x:b.left+b.width/2,y:b.top+b.height/2};j({startPosition:K,endPosition:w})}}const S=((k=t[n])==null?void 0:k.name)||"",T=n,I=`${S}-${T}`,r=s.name,C=s.difficulty,U=`${r}-${C}`,H={...i,[I]:{...i[I]||{},[U]:a}};if(u(H),v&&L===x)try{const{saveBossRun:K}=await X(async()=>{const{saveBossRun:w}=await import("./pitched-data-service-B2hvT42s.js");return{saveBossRun:w}},__vite__mapDeps([3,1,2,4,5,6,7,8])),_={character:S,characterIdx:T,bossName:r,bossDifficulty:C,isCleared:a,date:new Date().toISOString()},b=await K(v,_);b.success?console.log("âœ… Boss run saved successfully"):console.error("Error saving boss run:",b.error)}catch(K){console.error("Error saving boss state to database:",K)}if(!a&&L===x){const K=f.find(_=>_.name===r);if(K&&K.pitchedItems){D(b=>{const w={...b};return K.pitchedItems.forEach($=>{const z=J(S,T,r,$.name,o);w[z]&&delete w[z]}),w});const _=K.pitchedItems.map(b=>({character:S,bossName:r,itemName:b.name,weekKey:o}));_.length>0&&v&&se(v,_).then(async()=>{m&&await m()}).catch(b=>{console.error("Error removing pitched items:",b)})}}N()}catch(s){console.error("Error in handleCheck:",s),W("Failed to update boss status. Please try again.")}finally{setTimeout(()=>{d.current=!1,console.log("ðŸ–±ï¸ USER: Boss interaction flag cleared, sync can resume")},1e3)}},handleTickAll:async()=>{try{const c=t[n],g=(c==null?void 0:c.bosses)||[],h=`${(c==null?void 0:c.name)||""}-${n}`,k=i[h]||{},a=!g.every(S=>k[S.name+"-"+S.difficulty]);d.current=!0;const y={...i,[h]:Object.fromEntries(g.map(S=>[S.name+"-"+S.difficulty,a]))};if(u(y),!a){const S={...P};g.forEach(T=>{const I=f.find(r=>r.name===T.name);I!=null&&I.pitchedItems&&I.pitchedItems.forEach(r=>{const C=J(t[n].name,n,T.name,r.name,o);S[C]&&delete S[C]})}),D(S)}if(v)try{console.log(`ðŸ”„ Batch updating ${g.length} bosses to ${a?"checked":"unchecked"}`);const{saveBatchBossRuns:S}=await X(async()=>{const{saveBatchBossRuns:r}=await import("./pitched-data-service-B2hvT42s.js");return{saveBatchBossRuns:r}},__vite__mapDeps([3,1,2,4,5,6,7,8])),T=g.map(r=>({character:t[n].name,characterIdx:n,bossName:r.name,bossDifficulty:r.difficulty,isCleared:a,date:new Date().toISOString()})),I=await S(v,T);if(I.success?console.log(`âœ… Batch update successful: ${g.length} bosses updated`):(console.error("Batch update failed:",I.error),W("Failed to save all boss updates. Please try again.")),!a){const r=[];g.forEach(C=>{const U=f.find(H=>H.name===C.name);U!=null&&U.pitchedItems&&U.pitchedItems.forEach(H=>{const K=J(t[n].name,n,C.name,H.name,o);P[K]&&r.push({character:t[n].name,bossName:C.name,itemName:H.name,weekKey:o})})}),r.length>0&&(await se(v,r),m&&await m())}}catch(S){console.error("Error in batch boss update:",S),W("Failed to update all bosses. Please try again.")}}catch(c){console.error("Error in handleTickAll:",c),W("Failed to update all bosses. Please try again.")}finally{setTimeout(()=>{d.current=!1},1e3)}},refreshCheckedStateFromDatabase:async()=>{if(v){try{console.log("ðŸ”„ Refreshing checked state from boss runs...");const{supabase:c}=await X(async()=>{const{supabase:k}=await import("./supabaseClient-D8oTKsok.js");return{supabase:k}},__vite__mapDeps([0,1,2])),{data:g,error:h}=await c.from("user_data").select("data").eq("id",v).single();if(!h&&g&&g.data&&g.data.boss_runs){const k={};return g.data.boss_runs.forEach(s=>{if(s.cleared){const a=`${s.character}-${s.characterIdx||0}`,y=`${s.boss}-${s.difficulty}`;k[a]||(k[a]={}),k[a][y]=!0}}),console.log("âœ… Refreshed checked state from boss_runs after boss action"),u(k),k}}catch(c){console.error("Error refreshing checked state from boss runs:",c)}return null}}}}function Ue(t,n){const[i,u]=l.useState(!1),[f,P]=l.useState(!1),[D,o]=l.useState({monthly:[],yearly:[]}),[L,v]=l.useState(!1),[d,j]=l.useState(null),[W,N]=l.useState(!1),[m,x]=l.useState(!1),[O,M]=l.useState([]),[p,c]=l.useState(!1),[g,h]=l.useState({}),[k,s]=l.useState(!1),[a,y]=l.useState(null),[S,T]=l.useState(!1),[I,r]=l.useState(!1),[C,U]=l.useState(null),H=l.useMemo(()=>{const F=ae(),E=new Set([F]);return D!=null&&D.yearly&&Array.isArray(D.yearly)&&D.yearly.forEach(G=>E.add(G.yearKey)),g&&Object.keys(g).forEach(G=>E.add(G)),Array.from(E).sort((G,Y)=>Y.localeCompare(G))},[D==null?void 0:D.yearly,g]),[K,_]=l.useState(()=>ae());l.useEffect(()=>{(H==null?void 0:H.length)>0&&!H.includes(K)&&_(H[0])},[H,K]),l.useEffect(()=>{if(!i||!t)return;(async()=>{try{s(!0);const E=await le(t);E.success&&h(E.data)}catch(E){console.error("Error fetching cloud pitched stats:",E)}finally{s(!1)}})()},[i,t]);const b=l.useMemo(()=>{if(!K||!g)return[];const F=new Map,E=g[K];E!=null&&E.items&&Array.isArray(E.items)&&E.items.forEach(Y=>{if(!(Y!=null&&Y.item)||!(Y!=null&&Y.image))return;const V=Y.item+"|"+Y.image;F.has(V)||F.set(V,{name:Y.item,image:Y.image,count:0,history:[],source:"cloud"});const q=F.get(V);if(q.count+=1,Y.date){const Z=new Date(Y.date),ee=Z.getUTCMonth(),re=Z.getUTCDate();q.history.push({char:Y.character,date:`${he[ee]} ${re}`,cloud:!0,fullDate:Y.date})}});const G=Array.from(F.values());return G.forEach(Y=>{var V;((V=Y.history)==null?void 0:V.length)>0&&Y.history.sort((q,Z)=>q.fullDate&&Z.fullDate?new Date(Z.fullDate)-new Date(q.fullDate):0)}),G.sort((Y,V)=>V.count-Y.count||Y.name.localeCompare(V.name))},[K,g]),w=async(F,E,G,Y,V)=>{if(d)try{N(!0);const{name:q,idx:Z}=d;Y.current=!0;const ee=je(F,q,Z,G);if(E(ee),(await we(t,q,Z)).success){h({}),await n(t);const ie=await le(t);ie.success&&h(ie.data),x(!0),v(!1);const ne=await Ne(t);ne.success&&M(ne.history),setTimeout(()=>{x(!1)},3e3)}else V("Failed to purge character data. Please try again.")}catch(q){console.error("Error in handleCharacterPurge:",q),V("Failed to purge character data. Please try again.")}finally{N(!1),setTimeout(()=>{Y.current=!1},1e3)}},$=async F=>{try{if(o({monthly:[],yearly:[]}),_(ae()),t)if((await ve(t)).success)h({}),await n(t);else{F("Failed to reset stats data. Please try again.");return}P(!1),c(!0),setTimeout(()=>{c(!1),u(!1)},3400)}catch(E){console.error("Error in stats reset:",E),F("Failed to reset stats data. Please try again.")}},z=()=>{c(!1),u(!1)},R=l.useMemo(()=>a?a.history||[]:[],[a]);function B(){console.log("Stats tracking is now cloud-based - no action needed")}return{showStats:i,setShowStats:u,showStatsResetConfirm:f,setShowStatsResetConfirm:P,statsPanel:D,setStatsPanel:o,showCharacterPurgeConfirm:L,setShowCharacterPurgeConfirm:v,purgeTargetCharacter:d,setPurgeTargetCharacter:j,purgeInProgress:W,purgeSuccess:m,setPurgeSuccess:x,auditHistory:O,resetSuccessVisible:p,closeResetSuccess:z,cloudPitchedStats:g,setCloudPitchedStats:h,isLoadingCloudStats:k,pitchedModalItem:a,setPitchedModalItem:y,showPitchedModal:S,setShowPitchedModal:T,pitchedModalDetails:R,showHistoricalPitchedModal:I,setShowHistoricalPitchedModal:r,historicalPitchedData:C,setHistoricalPitchedData:U,allYears:H,selectedYear:K,setSelectedYear:_,yearlyPitchedSummary:b,handleCharacterPurge:w,handleStatsReset:$,startStatsTrackingIfNeeded:B}}function Ge({characterBossSelections:t,bossData:n,checked:i,setChecked:u,userCode:f,preservingCheckedStateRef:P}){function D(b,w){const $=n.find(R=>R.name===b);if(!$)return 0;const z=$.difficulties.find(R=>R.difficulty===w);return z?z.price:0}const[o,L]=l.useState(!0),[v,d]=l.useState(null),[j,W]=l.useState(0),[N,m]=l.useState(null),[x,O]=l.useState(!1),[M,p]=l.useState({weeklyTotal:0,lastReset:new Date().toISOString(),history:[]}),[c,g]=l.useState(()=>{const b=localStorage.getItem(oe.WEEKLY_HIDE_COMPLETED);return b?JSON.parse(b):!1});l.useEffect(()=>{localStorage.setItem(oe.WEEKLY_HIDE_COMPLETED,JSON.stringify(c))},[c]),l.useEffect(()=>{if(t.length)O(!1);else{O(!1);const b=setTimeout(()=>{O(!0)},2e3);return()=>clearTimeout(b)}},[t.length]);const h=Oe(f),k=Be(f,t,i,u,h.selectedWeekKey,P),s=Ye({characterBossSelections:t,selectedCharIdx:j,checked:i,setChecked:u,bossData:n,pitchedChecked:k.pitchedChecked,setPitchedChecked:k.setPitchedChecked,weekKey:h.selectedWeekKey,selectedWeekKey:h.selectedWeekKey,isHistoricalWeek:h.isHistoricalWeek,userCode:f,userInteractionRef:k.userInteractionRef,setCrystalAnimation:d,setError:m,startStatsTrackingIfNeeded:()=>{},refreshHistoricalAnalysis:h.refreshHistoricalAnalysis}),a=Ue(f,k.refreshPitchedItems),y=b=>{try{h.handleWeekChange(b,i,k.cloudPitchedItems,k.pitchedChecked)}catch(w){m(`Failed to change week: ${w.message}`)}};l.useEffect(()=>{j>=t.length&&W(Math.max(0,t.length-1))},[t.length,j]);const S=t[j],T=`${(S==null?void 0:S.name)||""}-${j}`,I=(S==null?void 0:S.bosses)||[],r=[...I].sort((b,w)=>{try{const $=D(b.name,b.difficulty)/(b.partySize||1);return D(w.name,w.difficulty)/(w.partySize||1)-$}catch($){return m(`Error sorting bosses: ${$.message}`),0}}),C=t.reduce((b,w,$)=>{const z=`${(w==null?void 0:w.name)||""}-${$}`;return b+(w.bosses||[]).reduce((R,B)=>{var F;return(F=i[z])!=null&&F[B.name+"-"+B.difficulty]?R+D(B.name,B.difficulty)/(B.partySize||1):R},0)},0),U=t.reduce((b,w)=>b+(w.bosses||[]).reduce(($,z)=>$+D(z.name,z.difficulty)/(z.partySize||1),0),0),H=t.map((b,w)=>{const $=`${(b==null?void 0:b.name)||""}-${w}`,z=(b==null?void 0:b.bosses)||[],R=z.filter(E=>{var G;return(G=i[$])==null?void 0:G[E.name+"-"+E.difficulty]}).length,B=z.length,F=z.reduce((E,G)=>{var Y;return(Y=i[$])!=null&&Y[G.name+"-"+G.difficulty]?E+Math.ceil(D(G.name,G.difficulty)/(G.partySize||1)):E},0);return{name:b.name,cleared:R,total:B,allCleared:B>0&&R===B,left:B-R,idx:w,totalMeso:F}}),K=c?H.filter(b=>!b.allCleared):H,_=I.length>0;return N?e.jsxs("div",{className:"weekly-tracker-error",children:[e.jsx("div",{className:"weekly-tracker-error-message",children:N}),e.jsx("button",{onClick:()=>m(null),children:"Try Again"})]}):t.length?e.jsxs("div",{className:"weekly-tracker",children:[v&&e.jsx(Le,{startPosition:v.startPosition,endPosition:v.endPosition,onComplete:()=>d(null)}),e.jsxs("div",{className:"weekly-tracker-container",children:[e.jsx(Ie,{sidebarVisible:o,isHistoricalWeek:h.isHistoricalWeek,totalMeso:C,obtainableMeso:U,selectedWeekKey:h.selectedWeekKey,hideCompleted:c,setHideCompleted:g,visibleCharSummaries:K,selectedCharIdx:j,setSelectedCharIdx:W,setPurgeTargetCharacter:a.setPurgeTargetCharacter,setShowCharacterPurgeConfirm:a.setShowCharacterPurgeConfirm}),e.jsx($e,{sidebarVisible:o,setSidebarVisible:L}),e.jsx("div",{className:"weekly-tracker-main fade-in",children:e.jsxs("div",{className:"weekly-tracker-content",children:[e.jsx("div",{className:"weekly-tracker-header",children:e.jsx("h2",{className:"weekly-tracker-title",children:"Weekly Boss Tracker"})}),e.jsx("div",{className:"weekly-tracker-navigator-wrapper",children:e.jsx(Pe,{selectedWeekKey:h.selectedWeekKey,onWeekChange:y,availableWeeks:h.availableWeeks,isHistoricalWeek:h.isHistoricalWeek,historicalAnalysis:h.historicalAnalysis,characterBossSelections:t,checked:i,selectedCharIdx:j,totalMeso:C,obtainableMeso:U,charSummaries:H})}),e.jsx(He,{selectedWeekKey:h.selectedWeekKey,showTickAll:_&&!h.isHistoricalWeek,onTickAll:s.handleTickAll,allTicked:I.every(b=>{var w;return(w=i[T])==null?void 0:w[b.name+"-"+b.difficulty]})&&I.length>0}),_&&e.jsx("div",{children:e.jsx(Ee,{isHistoricalWeek:h.isHistoricalWeek,characterBossSelections:t,selectedCharIdx:j,charBosses:I,sortedBosses:r,bossData:n,checked:i,setChecked:u,charKey:T,getBossPrice:D,pitchedChecked:k.pitchedChecked,setPitchedChecked:k.setPitchedChecked,weekKey:h.selectedWeekKey,handleCheck:s.handleCheck,refreshCheckedStateFromDatabase:s.refreshCheckedStateFromDatabase,userInteractionRef:k.userInteractionRef,userCode:f,savePitchedItem:de,removeManyPitchedItems:se,setError:m,startStatsTrackingIfNeeded:a.startStatsTrackingIfNeeded,setHistoricalPitchedData:a.setHistoricalPitchedData,setShowHistoricalPitchedModal:a.setShowHistoricalPitchedModal,loadingPitchedItems:k.loadingPitchedItems,setLoadingPitchedItems:k.setLoadingPitchedItems,refreshPitchedItems:k.refreshPitchedItems,refreshHistoricalAnalysis:h.refreshHistoricalAnalysis})}),e.jsx("div",{className:"weekly-tracker-stats-button-container",children:e.jsx("button",{className:"weekly-tracker-stats-button",onClick:()=>a.setShowStats(!0),children:"View Stats"})})]})}),e.jsx(Me,{showStats:a.showStats,setShowStats:a.setShowStats,allYears:a.allYears,selectedYear:a.selectedYear,setSelectedYear:a.setSelectedYear,yearlyPitchedSummary:a.yearlyPitchedSummary,isLoadingCloudStats:a.isLoadingCloudStats,setPitchedModalItem:a.setPitchedModalItem,setShowPitchedModal:a.setShowPitchedModal,setShowStatsResetConfirm:a.setShowStatsResetConfirm}),e.jsx(_e,{showStatsResetConfirm:a.showStatsResetConfirm,setShowStatsResetConfirm:a.setShowStatsResetConfirm,onConfirm:()=>a.handleStatsReset(m)}),e.jsx(ze,{showCharacterPurgeConfirm:a.showCharacterPurgeConfirm,setShowCharacterPurgeConfirm:a.setShowCharacterPurgeConfirm,purgeTargetCharacter:a.purgeTargetCharacter,purgeInProgress:a.purgeInProgress,onConfirm:()=>a.handleCharacterPurge(k.pitchedChecked,k.setPitchedChecked,h.selectedWeekKey,k.userInteractionRef,m)}),e.jsx(Fe,{resetSuccessVisible:a.resetSuccessVisible,closeResetSuccess:a.closeResetSuccess,purgeSuccess:a.purgeSuccess,setPurgeSuccess:a.setPurgeSuccess}),e.jsx(Ke,{showPitchedModal:a.showPitchedModal,setShowPitchedModal:a.setShowPitchedModal,pitchedModalItem:a.pitchedModalItem,pitchedModalDetails:a.pitchedModalDetails}),a.showHistoricalPitchedModal&&a.historicalPitchedData&&e.jsx("div",{className:"weekly-tracker-modal-backdrop",onClick:()=>a.setShowHistoricalPitchedModal(!1),children:e.jsx(Te,{data:a.historicalPitchedData,characterBossSelections:t,onClose:()=>a.setShowHistoricalPitchedModal(!1),onConfirm:async(b,w)=>{try{console.log("ðŸ›ï¸ Historical pitched item logging:",{character:w,boss:a.historicalPitchedData.bossName,item:a.historicalPitchedData.itemName,date:b,weekKey:a.historicalPitchedData.weekKey});const $=t.findIndex(R=>R.name===w);if($===-1){m("Selected character not found");return}const z=await de(f,{character:w,characterIdx:$,bossName:a.historicalPitchedData.bossName,bossDifficulty:"Unknown",itemName:a.historicalPitchedData.itemName,itemImage:a.historicalPitchedData.itemImage,date:b},!1,a.historicalPitchedData.weekKey);if(z.success){console.log("âœ… Historical pitched item saved successfully");const{getPitchedKey:R}=await X(async()=>{const{getPitchedKey:F}=await Promise.resolve().then(()=>Re);return{getPitchedKey:F}},void 0),B=R(w,$,a.historicalPitchedData.bossName,a.historicalPitchedData.itemName,a.historicalPitchedData.weekKey);k.setPitchedChecked(F=>({...F,[B]:!0})),await k.refreshPitchedItems(f),await h.refreshHistoricalAnalysis(),a.setShowHistoricalPitchedModal(!1)}else console.error("âŒ Failed to save historical pitched item:",z.error),m("Failed to save historical pitched item: "+(z.error||"Unknown error"))}catch($){console.error("âŒ Error in historical pitched item save:",$),m("Error saving historical pitched item: "+$.message)}}})})]})]}):e.jsx("div",{className:"weekly-tracker-no-characters",children:e.jsx("div",{className:`weekly-tracker-no-characters-message ${x?"visible":""}`,children:"No characters found. Go back and add a character first."})})}function at(){const{navigate:t}=xe(),{userCode:n,isLoggedIn:i,handleDeleteAccount:u}=ue(),{characterBossSelections:f,checked:P,setChecked:D,fullUserData:o,weekKey:L,preservingCheckedStateRef:v}=fe(),[d,j]=l.useState(!1),[W,N]=l.useState(!1),[m,x]=l.useState(""),[O,M]=l.useState(!1);if(!i)return t("/login",{replace:!0}),null;const p=async()=>{M(!0),x("");try{const c=await u();c.success?(N(!1),t("/login",{replace:!0})):x(c.error)}catch(c){x("Failed to delete account. Try again."),console.error("Delete error:",c)}finally{M(!1)}};return e.jsxs("div",{className:"page-container",children:[e.jsx(ke,{currentPage:"weeklytracker",onShowHelp:()=>j(!0),onShowDeleteConfirm:()=>N(!0)}),e.jsx(ge,{children:e.jsx(Ge,{characterBossSelections:f,bossData:pe,checked:P,setChecked:D,userCode:n,fullUserData:o,weekKey:L,preservingCheckedStateRef:v})}),d&&e.jsx("div",{className:"modal-backdrop",onClick:()=>j(!1),children:e.jsxs("div",{className:"modal-fade modal-content",onClick:c=>c.stopPropagation(),children:[e.jsx("button",{onClick:()=>j(!1),className:"modal-close-btn",title:"Close",children:"Ã—"}),e.jsx("h2",{className:"modal-title",children:"Help & FAQ"}),e.jsxs("div",{className:"modal-section-content",style:{marginBottom:24},children:[e.jsx("h3",{className:"modal-section-title",children:"Weekly Tracking"}),e.jsx("p",{children:"Track your boss completions and see your weekly mesos progress"}),e.jsx("p",{children:"Check off bosses as you complete them throughout the week"}),e.jsx("p",{children:"Click on pitched item icons to track rare drops from bosses"})]}),e.jsxs("div",{className:"modal-section-content",style:{marginBottom:24},children:[e.jsx("h3",{className:"modal-section-title",children:"Pitched Items & Stats"}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Pitched tracking:"})," Click item icons to track rare boss drops"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Historical data:"})," Navigate between weeks to view past progress"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Stats overview:"})," View detailed statistics of all your pitched items"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Character management:"})," Purge data for specific characters if needed"]})]}),e.jsxs("div",{className:"modal-section-content",style:{marginBottom:24},children:[e.jsx("h3",{className:"modal-section-title",children:"Week Navigation"}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Current week:"})," Full editing capabilities for this week's progress"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Historical weeks:"})," View-only mode for past weeks (toggle edit mode if needed)"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Smart navigation:"})," Only shows weeks where you have data"]})]}),e.jsxs("div",{className:"modal-section-content",children:[e.jsx("h3",{className:"modal-section-title",children:"Quick Tips"}),e.jsx("p",{children:'â€¢ Use "Tick All" to quickly mark all bosses completed for a character'}),e.jsx("p",{children:"â€¢ Hide completed characters to focus on remaining work"}),e.jsx("p",{children:"â€¢ Weekly reset happens every Thursday at 00:00 UTC"}),e.jsx("p",{children:"â€¢ Pitched items are automatically linked to boss completions"})]})]})}),W&&e.jsx("div",{className:"modal-backdrop modal-backdrop-critical",onClick:()=>N(!1),children:e.jsxs("div",{className:"modal-fade modal-content-critical",onClick:c=>c.stopPropagation(),children:[e.jsx("div",{className:"critical-modal-icon",children:e.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z",stroke:"#fff",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})})}),e.jsx("h2",{className:"critical-modal-title",children:"Delete Account"}),e.jsx("div",{className:"critical-modal-warning",children:e.jsxs("p",{children:[e.jsx("strong",{children:"This will permanently delete your account and all associated data."}),e.jsx("br",{}),"This action cannot be undone."]})}),e.jsxs("div",{className:"modal-button-container",children:[e.jsx("button",{onClick:()=>N(!1),disabled:O,className:"modal-btn-cancel",children:"Cancel"}),e.jsxs("button",{onClick:p,disabled:O,className:"modal-btn-critical",children:[O&&e.jsx("div",{className:"loading-spinner"}),O?"Deleting...":"Delete Forever"]})]}),m&&e.jsx("div",{className:"modal-error-message",children:m})]})})]})}export{at as default};
