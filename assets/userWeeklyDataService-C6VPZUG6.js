const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-H-SBb4Tt.js","assets/vendor-ui-aK89YfOw.js","assets/vendor-router-Cg8TMqY4.js","assets/vendor-react-eWEExxYH.js","assets/vendor-supabase-B7S7y5aO.js","assets/index-BW-6mlRk.css"])))=>i.map(i=>d[i]);
import{_ as U}from"./vendor-supabase-B7S7y5aO.js";import{getCurrentMapleWeekStartDate as W}from"./mapleWeekUtils-Bm65Nri8.js";import{l as c}from"./index-H-SBb4Tt.js";import"./vendor-react-eWEExxYH.js";import"./vendor-ui-aK89YfOw.js";import"./vendor-router-Cg8TMqY4.js";async function v(){const{supabase:s}=await U(async()=>{const{supabase:t}=await import("./index-H-SBb4Tt.js").then(r=>r.m);return{supabase:t}},__vite__mapDeps([0,1,2,3,4,5]));return s}async function _(s,t){if(!s||!t)return c.error("fetchUserWeeklyData: Missing required parameters",{userId:s,mapleWeekStart:t}),{success:!1,error:"Missing required parameters."};try{const r=await v();c.info("fetchUserWeeklyData: Querying database",{userId:s,mapleWeekStart:t,queryTable:"user_boss_data",queryColumns:"user_id, maple_week_start"});const{data:e,error:a}=await r.from("user_boss_data").select("*").eq("user_id",s).eq("maple_week_start",t);if(c.info("fetchUserWeeklyData: Database query result",{hasData:!!e,hasError:!!a,errorCode:a==null?void 0:a.code,errorMessage:a==null?void 0:a.message,dataLength:Array.isArray(e)?e.length:e?1:0,rawData:e}),a)return c.error("fetchUserWeeklyData: Database error",a),{success:!1,error:"Failed to fetch weekly data."};const o=Array.isArray(e)?e.length>0?e[0]:null:e;return c.info("fetchUserWeeklyData: Processed result",{hasWeekData:!!o,originalDataType:Array.isArray(e)?"array":typeof e,resultKeys:o?Object.keys(o):null}),{success:!0,data:o}}catch(r){return c.error("fetchUserWeeklyData: Unexpected error",r),{success:!1,error:"Failed to fetch weekly data."}}}async function C(s,t,r){if(!s||!t||!r)return{success:!1,error:"Missing required parameters."};try{const e=await v(),a={user_id:s,maple_week_start:t,...r},o=await e.from("user_boss_data").select("user_id, maple_week_start").eq("user_id",s).eq("maple_week_start",t),i=await e.from("user_boss_data").select("user_id, maple_week_start").eq("user_id",s);o.error&&c.error("saveOrUpdateUserWeeklyData: Error checking existing record",o.error),c.info("saveOrUpdateUserWeeklyData: Record analysis",{targetWeek:t,hasExistingForWeek:o.data&&o.data.length>0,existingForWeekCount:o.data?o.data.length:0,allUserRecordsCount:i.data?i.data.length:0,allUserWeeks:i.data?i.data.map(l=>l.maple_week_start):[],operation:o.data&&o.data.length>0?"update":"insert"});let n;if(o.data&&o.data.length>0)c.info("saveOrUpdateUserWeeklyData: Updating existing record"),n=await e.from("user_boss_data").update(r).eq("user_id",s).eq("maple_week_start",t);else{if(i.data&&i.data.length>0){c.info(`saveOrUpdateUserWeeklyData: Database constraint issue detected - user has ${i.data.length} existing records, deleting and inserting`);const l=await e.from("user_boss_data").delete().eq("user_id",s);if(l.error)return c.error("saveOrUpdateUserWeeklyData: Failed to delete existing records",l.error),{success:!1,error:"Failed to clear existing data."};c.info("saveOrUpdateUserWeeklyData: Deleted existing records, now inserting new record")}c.info("saveOrUpdateUserWeeklyData: Inserting new record"),n=await e.from("user_boss_data").insert(a)}const{error:u}=n;return c.info("saveOrUpdateUserWeeklyData: Operation completed successfully",{operation:o.data&&o.data.length>0?"update":"insert",targetWeek:t,userId:s,charCount:Object.keys(r.char_map||{}).length,bossConfigCount:Object.keys(r.boss_config||{}).length,clearsCount:Object.keys(r.weekly_clears||{}).length}),u?(c.error("saveOrUpdateUserWeeklyData: Operation failed",u),{success:!1,error:"Failed to save weekly data."}):{success:!0}}catch(e){return c.error("Unexpected error saving user weekly data:",e),{success:!1,error:"Failed to save weekly data."}}}async function B(s,t,r){if(!s||!t||!(r!=null&&r.trim()))return{success:!1,error:"Missing required parameters."};try{const e=await _(s,t);if(!e.success)return{success:!1,error:e.error};const a=e.data||{char_map:{},boss_config:{},weekly_clears:{}},o=Object.keys(a.char_map||{}).map(g=>parseInt(g)),i=o.length>0?Math.max(...o)+1:0,n=i.toString();if(Object.values(a.char_map||{}).some(g=>g.toLowerCase()===r.trim().toLowerCase()))return{success:!1,error:`Character name '${r.trim()}' already exists.`};const l={...a.char_map},f={...a.boss_config},d={...a.weekly_clears};l[n]=r.trim(),f[n]="",d[n]="";const p=await C(s,t,{char_map:l,boss_config:f,weekly_clears:d});return p.success?{success:!0,characterIndex:i}:{success:!1,error:p.error}}catch(e){return c.error("Unexpected error adding character:",e),{success:!1,error:"Failed to add character."}}}async function j(s,t,r){if(!s||!t||r===void 0)return{success:!1,error:"Missing required parameters."};try{const e=await _(s,t);if(!e.success)return{success:!1,error:e.error};if(!e.data)return{success:!1,error:"No weekly data found."};const a=e.data,o=r.toString();if(!(o in(a.char_map||{})))return{success:!1,error:"Character not found."};const i={...a.char_map},n={...a.boss_config},u={...a.weekly_clears};delete i[o],delete n[o],delete u[o];const l=await C(s,t,{char_map:i,boss_config:n,weekly_clears:u});return l.success?{success:!0}:{success:!1,error:l.error}}catch(e){return c.error("Unexpected error removing character:",e),{success:!1,error:"Failed to remove character."}}}async function S(s,t,r,e){if(!s||!t||r===void 0||!(e!=null&&e.trim()))return{success:!1,error:"Missing required parameters."};try{const a=await _(s,t);if(!a.success)return{success:!1,error:a.error};if(!a.data)return{success:!1,error:"No weekly data found."};const o=a.data,i=r.toString();if(!(i in(o.char_map||{})))return{success:!1,error:"Character not found."};if(Object.entries(o.char_map||{}).filter(f=>f[0]!==i).map(f=>f[1]).some(f=>f.toLowerCase()===e.trim().toLowerCase()))return{success:!1,error:`Character name '${e.trim()}' already exists.`};const u={...o.char_map};u[i]=e.trim();const l=await C(s,t,{char_map:u,boss_config:o.boss_config||{},weekly_clears:o.weekly_clears||{}});return l.success?{success:!0}:{success:!1,error:l.error}}catch(a){return c.error("Unexpected error updating character name:",a),{success:!1,error:"Failed to update character name."}}}async function T(s,t,r,e){if(!s||!t||r===void 0)return{success:!1,error:"Missing required parameters."};try{if(e&&e.trim()){const l=await x(e);if(!l.success)return{success:!1,error:l.error}}const a=await _(s,t);if(!a.success)return{success:!1,error:a.error};if(!a.data)return{success:!1,error:"No weekly data found."};const o=a.data,i=r.toString();if(!(i in(o.char_map||{})))return{success:!1,error:"Character not found."};const n={...o.boss_config};n[i]=e||"";const u=await C(s,t,{char_map:o.char_map||{},boss_config:n,weekly_clears:o.weekly_clears||{}});return u.success?{success:!0}:{success:!1,error:u.error}}catch(a){return c.error("Unexpected error updating boss config:",a),{success:!1,error:"Failed to update boss configuration."}}}async function x(s){if(!s||typeof s!="string")return{success:!0};try{const t=await v(),{data:r,error:e}=await t.from("boss_registry").select("boss_code, difficulty_code, crystal_value, max_party_size, enabled");if(e)return c.error("Error fetching boss registry:",e),{success:!1,error:"Failed to validate boss configuration."};const a=s.split(",");for(const o of a){const i=o.split(":");if(i.length!==3)return{success:!1,error:`Invalid boss config format: ${o}`};const[n,u,l]=i,f=parseInt(u),d=parseInt(l),p=r.find(g=>`${g.boss_code}-${g.difficulty_code}`===n||g.boss_code===n);if(!p)return{success:!1,error:`Unknown boss code: ${n}`};if(!p.enabled)return{success:!1,error:`Boss ${n} is not enabled.`};if(f!==p.crystal_value&&c.warn(`Crystal value mismatch for ${n}. Expected: ${p.crystal_value}, got: ${f}. Using database value.`),d<1||d>p.max_party_size)return{success:!1,error:`Invalid party size for ${n}. Must be between 1 and ${p.max_party_size}.`}}return{success:!0}}catch(t){return c.error("Unexpected error validating boss config:",t),{success:!1,error:"Failed to validate boss configuration."}}}async function A(s){const t=W();c.info(`fetchCurrentWeekData: Starting for user ${s}, current week start: ${t}`);const r=await _(s,t);if(c.info("fetchCurrentWeekData: Current week query result",{success:r.success,hasData:!!r.data,error:r.error,data:r.data}),!r.success)return c.error("fetchCurrentWeekData: Failed to fetch current week data",r.error),r;if(r.data)return c.info(`fetchCurrentWeekData: Found existing data for current week ${t}`,{charCount:r.data.char_map?Object.keys(r.data.char_map).length:0,charMap:r.data.char_map,bossConfig:r.data.boss_config}),r;try{c.info(`fetchCurrentWeekData: No data found for current week ${t}, checking previous week`);const e=new Date(t+"T00:00:00.000Z"),a=new Date(e);a.setUTCDate(e.getUTCDate()-7);const o=a.getUTCFullYear()+"-"+String(a.getUTCMonth()+1).padStart(2,"0")+"-"+String(a.getUTCDate()).padStart(2,"0");c.info(`fetchCurrentWeekData: Checking previous week ${o} for user ${s}`);const i=await _(s,o);if(!i.success)return c.info(`fetchCurrentWeekData: Failed to fetch previous week data: ${i.error}`),{success:!0,data:null};if(!i.data)return c.info("fetchCurrentWeekData: No previous week data found either"),{success:!0,data:null};const n=i.data;if(!n.char_map||Object.keys(n.char_map).length===0)return c.info("fetchCurrentWeekData: Previous week data exists but has no characters"),{success:!0,data:null};c.info(`fetchCurrentWeekData: Migrating ${Object.keys(n.char_map).length} characters from ${o} to ${t} for user ${s}`,{previousCharMap:n.char_map,previousBossConfig:n.boss_config,previousWeeklyClears:n.weekly_clears});const u={char_map:n.char_map,boss_config:n.boss_config||{},weekly_clears:{}};Object.keys(u.char_map).forEach(d=>{u.weekly_clears[d]=""}),c.info("fetchCurrentWeekData: Prepared migration data",{migratedCharMap:u.char_map,migratedBossConfig:u.boss_config,migratedWeeklyClears:u.weekly_clears});const l=await _(s,t);if(l.success&&l.data)return c.info("fetchCurrentWeekData: Current week data appeared during migration, using existing data"),l;const f=await C(s,t,u);if(!f.success){c.error(`fetchCurrentWeekData: Failed to save migrated data for user ${s}: ${f.error}`);const d=await _(s,t);return d.success&&d.data?(c.info("fetchCurrentWeekData: Found data after failed migration - using existing data"),d):(c.error("fetchCurrentWeekData: Migration completely failed - returning previous week data as fallback"),{success:!0,data:n})}return c.info(`fetchCurrentWeekData: Successfully migrated data for user ${s} from ${o} to ${t}`),{success:!0,data:u}}catch(e){return c.error("fetchCurrentWeekData: Error during weekly data migration:",e),{success:!1,error:"Failed to check for previous week data."}}}async function P(s,t){const r=W();return await C(s,r,t)}async function $(s,t,r,e){try{if(!s||!t||r===void 0)return{success:!1,error:"Missing required parameters: userId, mapleWeekStart, and characterIndex"};if(e&&e.trim()){const f=e.split(",").map(d=>d.trim()).filter(d=>d);if(f.length>0){const d=await v();if(f.every(g=>/^\d+$/.test(g))){const g=f.map(w=>parseInt(w)),{data:y,error:h}=await d.from("boss_registry").select("id").in("id",g);if(h)throw h;const m=new Set(y.map(w=>w.id)),k=g.filter(w=>!m.has(w));if(k.length>0)return{success:!1,error:`Invalid boss registry IDs: ${k.join(", ")}`}}else{const{data:g,error:y}=await d.from("boss_registry").select("id").in("id",f);if(y)throw y;const h=new Set(g.map(k=>k.id)),m=f.filter(k=>!h.has(k));if(m.length>0)return{success:!1,error:`Invalid boss codes: ${m.join(", ")}`}}}}const a=await _(s,t);if(!a.success)return a;const o=a.data;if(!o)return{success:!1,error:"No weekly data found. Please add characters first."};if(!(o.char_map||{})[r])return{success:!1,error:`Character at index ${r} not found`};const u={weekly_clears:{...o.weekly_clears||{},[r]:e||""}};return await C(s,t,u)}catch(a){return c.error("Error updating character weekly clears:",a),{success:!1,error:a.message}}}async function L(s,t,r,e,a){try{if(!s||!t||r===void 0||!e||a===void 0)return{success:!1,error:"Missing required parameters"};const o=await v(),{data:i,error:n}=await o.from("boss_registry").select("id, boss_name, difficulty").eq("id",e).single();if(n){if(n.code==="PGRST116")return{success:!1,error:`Invalid boss registry ID: ${e}`};throw n}const u=await _(s,t);if(!u.success)return u;const l=u.data;if(!l)return{success:!1,error:"No weekly data found. Please add characters first."};if(!(l.char_map||{})[r])return{success:!1,error:`Character at index ${r} not found`};const d=l.weekly_clears||{},g=(d[r]||"").split(",").map(b=>b.trim()).filter(b=>b),y=e.toString();let h;a?g.includes(y)?h=g:h=[...g,y]:h=g.filter(b=>b!==y);const k={weekly_clears:{...d,[r]:h.join(",")}};return await C(s,t,k)}catch(o){return c.error("Error toggling boss clear status:",o),{success:!1,error:o.message}}}async function z(s,t,r){try{return await $(s,t,r,"")}catch(e){return c.error("Error clearing all bosses for character:",e),{success:!1,error:e.message}}}async function V(s,t,r){try{if(!s||!t||r===void 0)return{success:!1,error:"Missing required parameters"};const e=await _(s,t);if(!e.success)return e;const a=e.data;if(!a)return{success:!1,error:"No weekly data found. Please add characters first."};if(!(a.char_map||{})[r])return{success:!1,error:`Character at index ${r} not found`};const n=(a.boss_config||{})[r]||"";if(!n)return{success:!1,error:"No boss configuration found for this character"};const{parseBossConfigString:u}=await U(async()=>{const{parseBossConfigString:h}=await import("./mapleWeekUtils-Bm65Nri8.js");return{parseBossConfigString:h}},[]),l=u(n),f=await v(),{data:d,error:p}=await f.from("boss_registry").select("*");if(p)throw p;const g=[];for(const h of l){const m=h.bossCode.split("-"),k=m[0],w=m[1],b=d.find(D=>D.boss_code===k&&D.difficulty_code===w);b?g.push(b.id):c.warn(`Boss registry entry not found for boss code: ${h.bossCode}`)}const y=g.join(",");return await $(s,t,r,y)}catch(e){return c.error("Error marking all bosses for character:",e),{success:!1,error:e.message}}}export{B as addCharacterToWeeklySetup,z as clearAllBossesForCharacter,A as fetchCurrentWeekData,_ as fetchUserWeeklyData,V as markAllBossesForCharacter,j as removeCharacterFromWeeklySetup,P as saveCurrentWeekData,C as saveOrUpdateUserWeeklyData,L as toggleBossClearStatus,T as updateCharacterBossConfigInWeeklySetup,S as updateCharacterNameInWeeklySetup,$ as updateCharacterWeeklyClearsInWeeklySetup};
