const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-ChAGxcO2.js","assets/vendor-ui-aK89YfOw.js","assets/vendor-router-Cg8TMqY4.js","assets/vendor-react-eWEExxYH.js","assets/vendor-supabase-B7S7y5aO.js","assets/index-cPECv1Lb.css","assets/userWeeklyDataService-CzU74Ypw.js","assets/mapleWeekUtils-Bm65Nri8.js","assets/bossRegistryService-B-8C88KZ.js","assets/bossCodeMapping-8KKKnROO.js"])))=>i.map(i=>d[i]);
import{j as e}from"./vendor-ui-aK89YfOw.js";import{r as o,c as Ae}from"./vendor-router-Cg8TMqY4.js";import{s as le,c as de,g as Ge,d as be,p as ze,e as Pe,f as ke,l as f,h as Ce,i as xe,M as Ye,u as We,b as Ee,S as Se,j as De,a as qe,N as Ie,V as Ue,H as Ve,W as Ze,D as Je}from"./index-ChAGxcO2.js";import{_ as oe}from"./vendor-supabase-B7S7y5aO.js";import{C as Xe}from"./CustomCheckbox-C2-rm8qf.js";import{getBossPitchedItems as je}from"./bossRegistryService-B-8C88KZ.js";import{getCharacterHistoricalWeekAnalysis as Qe,getHistoricalWeekAnalysis as et,purgeAllStatsData as tt,clearCharacterPitchedUI as st,purgePitchedRecords as rt,getPitchedResetAuditHistory as at}from"./utilityService-OetPi0cW.js";import{getBossRegistryId as it}from"./bossCodeMapping-8KKKnROO.js";import{getCurrentMapleWeekStartDate as ot}from"./mapleWeekUtils-Bm65Nri8.js";import{fetchCurrentWeekData as _e,addCharacterToWeeklySetup as ct,removeCharacterFromWeeklySetup as nt,updateCharacterNameInWeeklySetup as lt,updateCharacterBossConfigInWeeklySetup as dt,saveOrUpdateUserWeeklyData as mt,fetchUserWeeklyData as ut}from"./userWeeklyDataService-CzU74Ypw.js";import"./vendor-react-eWEExxYH.js";async function $e(t,a){try{if(!t||!a)return{success:!1,error:"Missing required parameters: userId and pitchedItemData"};const{charId:r,bossName:s,item:m}=a;if(!r||!s||!m)return{success:!1,error:"Missing required fields: charId, bossName, item"};const{data:k,error:j}=await le.from("user_data").select("pitched_items").eq("id",t).single();if(j)return console.error("Error fetching user data for pitched items:",j),{success:!1,error:"Failed to fetch user data"};if(!k)return{success:!1,error:"User not found"};const u={charId:r.trim(),bossName:s.trim(),item:m.trim(),date:a.date||new Date().toISOString().split("T")[0]},l=[...k.pitched_items||[],u],{error:h}=await le.from("user_data").update({pitched_items:l}).eq("id",t);return h?(console.error("Error adding pitched item:",h),{success:!1,error:"Failed to add pitched item"}):{success:!0,pitchedItem:u}}catch(r){return console.error("Error in addPitchedItem:",r),{success:!1,error:r.message}}}async function He(t,a,r,s,m=null){try{if(!t||!a||!r||!s)return{success:!1,error:"Missing required parameters: userId, charId, bossName, and item"};const{data:k,error:j}=await le.from("user_data").select("pitched_items").eq("id",t).single();if(j)return console.error("Error fetching user data for pitched item removal:",j),{success:!1,error:"Failed to fetch user data"};if(!k)return{success:!1,error:"User not found"};const u=k.pitched_items||[];let b;if(m)b=u.filter(h=>!(h.charId===a&&h.bossName===r&&h.item===s&&h.date===m));else{const h=u.findLastIndex(w=>w.charId===a&&w.bossName===r&&w.item===s);if(h===-1)return{success:!1,error:"Pitched item not found"};b=u.filter((w,S)=>S!==h)}if(b.length===u.length)return{success:!1,error:"Pitched item not found"};const{error:l}=await le.from("user_data").update({pitched_items:b}).eq("id",t);return l?(console.error("Error removing pitched item:",l),{success:!1,error:"Failed to remove pitched item"}):{success:!0}}catch(k){return console.error("Error in removePitchedItem:",k),{success:!1,error:k.message}}}async function Me(t,a){try{if(!t||!Array.isArray(a)||a.length===0)return{success:!1,error:"Missing required parameters or empty items array"};const{data:r,error:s}=await le.from("user_data").select("pitched_items").eq("id",t).single();if(s)return console.error("Error fetching user data for bulk removal:",s),{success:!1,error:"Failed to fetch user data"};if(!r)return{success:!1,error:"User not found"};const m=r.pitched_items||[];let k=[...m];a.forEach(({charId:b,item:l,date:h})=>{if(h)k=k.filter(w=>!(w.charId===b&&w.item===l&&w.date===h));else{const w=k.findLastIndex(S=>S.charId===b&&S.item===l);w!==-1&&k.splice(w,1)}});const j=m.length-k.length;if(j===0)return{success:!1,error:"No matching pitched items found"};const{error:u}=await le.from("user_data").update({pitched_items:k}).eq("id",t);return u?(console.error("Error removing multiple pitched items:",u),{success:!1,error:"Failed to remove pitched items"}):{success:!0,removedCount:j}}catch(r){return console.error("Error in removeManyPitchedItems:",r),{success:!1,error:r.message}}}async function ye(t,a={}){try{if(!t)return{success:!1,error:"Missing required parameter: userId"};const{weekKey:r,charId:s,year:m}=a,{data:k,error:j}=await le.from("user_data").select("pitched_items").eq("id",t).single();if(j)return console.error("Error fetching pitched items:",j),{success:!1,error:"Failed to fetch pitched items"};if(!k)return{success:!1,error:"User not found"};let u=k.pitched_items||[];return r&&(u=u.filter(b=>de(b.date)===r)),s&&(u=u.filter(b=>b.charId===s)),m&&(u=u.filter(b=>new Date(b.date).getFullYear()===m)),{success:!0,items:u}}catch(r){return console.error("Error in getPitchedItems:",r),{success:!1,error:r.message}}}async function Te(t,a){try{if(!t||!a)return{success:!1,error:"Missing required parameters: userId and weekKey"};const{data:r,error:s}=await le.from("user_data").select("pitched_items").eq("id",t).single();if(s)return console.error("Error fetching user data for week clear:",s),{success:!1,error:"Failed to fetch user data"};if(!r)return{success:!1,error:"User not found"};const m=r.pitched_items||[],k=m.filter(b=>de(b.date)!==a),j=m.length-k.length;if(j===0)return{success:!0,removedCount:0};const{error:u}=await le.from("user_data").update({pitched_items:k}).eq("id",t);return u?(console.error("Error clearing week pitched items:",u),{success:!1,error:"Failed to clear week pitched items"}):{success:!0,removedCount:j}}catch(r){return console.error("Error in clearPitchedItemsForWeek:",r),{success:!1,error:r.message}}}async function ve(t,a=null){try{if(!t)return{success:!1,error:"Missing required parameter: userId"};const r=a?parseInt(a,10):new Date().getFullYear(),s=await ye(t,{year:r});if(!s.success)return s;const m=s.items,k={total:m.length,characters:new Set,items:[]};return m.forEach(u=>{k.characters.add(u.charId),k.items.push({charId:u.charId,item:u.item,date:u.date})}),{success:!0,stats:{year:r,total:k.total,characters:Array.from(k.characters),items:k.items}}}catch(r){return console.error("Error in getYearlyPitchedStats:",r),{success:!1,error:r.message}}}async function Be(t){try{if(!t)return{success:!1,error:"Missing required parameter: userId"};const a=await ye(t,{});if(!a.success)return a;const r=a.items.length;if(r===0)return{success:!0,removedCount:0};const{error:s}=await le.from("user_data").update({pitched_items:[]}).eq("id",t);return s?(console.error("Error purging all pitched items:",s),{success:!1,error:"Failed to purge pitched items"}):{success:!0,removedCount:r}}catch(a){return console.error("Error in purgeAllPitchedItems:",a),{success:!1,error:a.message}}}const pe=Object.freeze(Object.defineProperty({__proto__:null,addPitchedItem:$e,clearPitchedItemsForWeek:Te,getPitchedItems:ye,getYearlyPitchedStats:ve,purgeAllPitchedItems:Be,removeManyPitchedItems:Me,removePitchedItem:He},Symbol.toStringTag,{value:"Module"}));function ht({appWeekKey:t,selectedWeekKey:a,onWeekChange:r,historicalAnalysis:s={hasHistoricalData:!1,oldestHistoricalWeek:null,userType:"new",adaptiveWeekLimit:8,historicalWeeks:[]}}){const[m,k]=o.useState(!1);o.useEffect(()=>{const i=()=>{k(window.innerWidth<=768)};return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]);const j=o.useMemo(()=>{const c=(s==null?void 0:s.adaptiveWeekLimit)||8;return{min:-c,max:0,current:0,adaptiveLimit:c}},[s,t]),u=o.useMemo(()=>Ge(a,t),[a,t]),b=o.useCallback(i=>{i!==a&&r(i)},[a,r]),l=()=>{const i=u-1;if(i>=j.min){const c=be(i,t);b(c)}},h=()=>{const i=u+1;if(i<=j.max){const c=be(i,t);b(c)}},w=o.useCallback(()=>{if(s!=null&&s.hasHistoricalData&&(s!=null&&s.oldestHistoricalWeek))b(s.oldestHistoricalWeek);else{const i=be(-j.adaptiveLimit,t);b(i)}},[s,j.adaptiveLimit,t,b]),S=()=>{b(t)},C=u>j.min,L=u<j.max,_=(s==null?void 0:s.hasHistoricalData)||u>-j.adaptiveLimit,D=a===t,d=o.useMemo(()=>{const i=ze(a),c=Pe(a);return{label:ke(a,t),parsed:i,dateRange:c,isSelectedWeekTheCurrentAppWeek:D,offset:u}},[a,t,D,u]);return o.useEffect(()=>{const i=!D,c=(s==null?void 0:s.hasHistoricalData)&&(s==null?void 0:s.oldestHistoricalWeek)&&a!==s.oldestHistoricalWeek&&!D;f.debug("WeekNavigator: Button visibility debug",{selectedWeekKey:a,appWeekKey:t,isSelectedWeekTheCurrentAppWeek:D,currentBtnVisible:i,oldestBtnVisible:c,historicalAnalysis:{hasHistoricalData:s==null?void 0:s.hasHistoricalData,oldestHistoricalWeek:s==null?void 0:s.oldestHistoricalWeek,userType:s==null?void 0:s.userType,adaptiveWeekLimit:s==null?void 0:s.adaptiveWeekLimit}})},[a,t,D,s]),e.jsx("div",{className:"week-navigator-wrapper",children:e.jsxs("div",{className:"week-navigator-container",children:[e.jsx("div",{className:"week-navigator-header",children:e.jsxs("div",{className:`week-navigator-title ${D?"current-week":"historical-week"}`,children:[e.jsx("span",{className:"week-title-text",children:d.label.replace(/\s*\(Current\)/i,"")}),D&&e.jsx("span",{className:"week-navigator-current-dot",children:e.jsx("span",{className:"week-navigator-current-dot-inner"})})]})}),e.jsxs("div",{className:"week-navigator-navigation",children:[e.jsx("div",{className:`week-navigator-arrow-container ${C?"enabled arrow-left":"disabled"}`,onClick:C?l:void 0,title:C?"Previous Week":`Already at oldest allowed week (${j.adaptiveLimit} weeks back from current)`,children:e.jsx("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:`week-navigator-arrow arrow-left ${C?"enabled":"disabled"}`,children:e.jsx("path",{d:"M20.3284 11.0001V13.0001L7.50011 13.0001L10.7426 16.2426L9.32842 17.6568L3.67157 12L9.32842 6.34314L10.7426 7.75735L7.49988 11.0001L20.3284 11.0001Z",fill:"currentColor"})})}),e.jsxs("div",{className:"week-navigator-center-content",children:[d.dateRange&&e.jsxs("div",{className:"week-navigator-date-range",children:[d.dateRange.start.toLocaleDateString()," - ",d.dateRange.end.toLocaleDateString()]}),e.jsxs("div",{className:"week-navigator-integrated-buttons",children:[e.jsxs("button",{onClick:S,className:`week-navigator-integrated-btn current-week-btn ${D?"hidden":"visible"}`,title:"Jump to current application week",disabled:D,children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z",fill:"currentColor"})}),"Current"]}),e.jsxs("button",{onClick:w,className:`week-navigator-integrated-btn oldest-data-btn ${s!=null&&s.hasHistoricalData&&(s!=null&&s.oldestHistoricalWeek)&&a!==s.oldestHistoricalWeek&&!D?"visible":"hidden"}`,title:`Jump to oldest recorded data (${s!=null&&s.oldestHistoricalWeek?ke(s.oldestHistoricalWeek,t):"oldest data"})`,disabled:!(s!=null&&s.hasHistoricalData&&(s!=null&&s.oldestHistoricalWeek)&&a!==s.oldestHistoricalWeek&&!D),children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M3 12H21M3 6H21M3 18H21",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})}),"Oldest"]})]})]}),e.jsx("div",{className:`week-navigator-arrow-container ${D?_?"enabled arrow-right":"disabled":L?"enabled arrow-right":"disabled"}`,onClick:D?_?w:void 0:L?h:void 0,title:D?_?s!=null&&s.hasHistoricalData&&(s!=null&&s.oldestHistoricalWeek)?`Jump to oldest data (${ke(s.oldestHistoricalWeek,t)})`:`Jump to ${j.adaptiveLimit} weeks back`:"No older data available to jump to":L?"Next Week":"Already at current application week",children:e.jsx("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:`week-navigator-arrow arrow-right ${D?_?"enabled":"disabled":L?"enabled":"disabled"}`,children:e.jsx("path",{d:"M15.0378 6.34317L13.6269 7.76069L16.8972 11.0157L3.29211 11.0293L3.29413 13.0293L16.8619 13.0157L13.6467 16.2459L15.0643 17.6568L20.7079 11.9868L15.0378 6.34317Z",fill:"currentColor"})})})]}),!D&&e.jsx("div",{className:"week-navigator-floating-actions week-navigator-floating-left",children:e.jsx("button",{onClick:S,className:"week-navigator-floating-btn",title:"Jump to current week",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z",fill:"currentColor"})})})}),(s==null?void 0:s.hasHistoricalData)&&(s==null?void 0:s.oldestHistoricalWeek)&&a!==s.oldestHistoricalWeek&&e.jsx("div",{className:"week-navigator-floating-actions week-navigator-floating-right",children:e.jsx("button",{onClick:w,className:"week-navigator-floating-btn",title:`Jump to oldest data (${ke(s.oldestHistoricalWeek,t)})`,children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M3 12H21M3 6H21M3 18H21",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})})})]},a)})}function ft({startPosition:t,endPosition:a,onComplete:r}){const[s,m]=o.useState(t),[k,j]=o.useState(1);return o.useEffect(()=>{const u=Date.now(),b=1e3,l=()=>{const h=Date.now()-u,w=Math.min(h/b,1),S=1-Math.pow(1-w,3),C=t.x+(a.x-t.x)*S,L=t.y+(a.y-t.y)*S;m({x:C,y:L}),j(1-w),w<1?requestAnimationFrame(l):r()};requestAnimationFrame(l)},[t,a,r]),e.jsx("div",{style:{position:"fixed",left:s.x,top:s.y,transform:"translate(-50%, -50%)",opacity:k,pointerEvents:"none",zIndex:1e3,transition:"transform 0.1s ease"},children:e.jsx("img",{src:"/bosses/crystal.png",alt:"Crystal",style:{width:24,height:24,transform:`rotate(${s.x*.1}deg)`,filter:"drop-shadow(0 0 4px rgba(162, 89, 247, 0.6))"}})})}function ge(t){if(t===0)return"0";if(t<1e9){const r=t/1e6;if(r<1){const s=t/1e3;return s<1?t.toString():`${s.toFixed(1)}K`}return`${r.toFixed(1)}M`}return`${(t/1e9).toFixed(1)}B`}const gt=Ae.memo(function({sidebarVisible:a,setSidebarVisible:r,isHistoricalWeek:s,totalMeso:m,obtainableMeso:k,selectedWeekKey:j,hideCompleted:u,setHideCompleted:b,visibleCharSummaries:l,selectedCharIdx:h,setSelectedCharIdx:w,setPurgeTargetCharacter:S,setShowCharacterPurgeConfirm:C,setShowCharacterPitchedModal:L,onShowTreasureAnalytics:_,characterBossSelections:D}){const[d,i]=o.useState(!1),[c,v]=o.useState(!1),[g,n]=o.useState(!1),[x,p]=o.useState(!1),[N,R]=o.useState(!1),Z=o.useRef(null),W=o.useRef(null);o.useEffect(()=>{const y=()=>{const $=window.innerWidth;n($<=768),p($<=480)};return y(),window.addEventListener("resize",y),()=>window.removeEventListener("resize",y)},[]),o.useEffect(()=>{const y=()=>{const P=Z.current;if(P){const I=P.scrollHeight>P.clientHeight,re=P.scrollTop+P.clientHeight>=P.scrollHeight-5;i(I&&!re&&!c)}},$=()=>{v(!0),i(!1),W.current&&clearTimeout(W.current),W.current=setTimeout(()=>{v(!1),y()},1e3)};y();const K=Z.current;if(K)return K.addEventListener("scroll",$),()=>{K.removeEventListener("scroll",$),W.current&&clearTimeout(W.current)}},[l,c]),o.useEffect(()=>{a&&setTimeout(()=>{const y=Z.current;if(y){const $=y.scrollHeight>y.clientHeight,K=y.scrollTop+y.clientHeight>=y.scrollHeight-5;i($&&!K&&!c)}},100)},[a,c]),o.useEffect(()=>{if(!g)return;const y=$=>{a&&!$.target.closest(".sidebar-scroll")&&!$.target.closest(".sidebar-toggle")&&!$.target.closest(".sidebar-mobile-fab")&&r&&r(!1)};return document.addEventListener("click",y),()=>document.removeEventListener("click",y)},[g,a,r]);const B=o.useCallback((y,$)=>{y.stopPropagation(),w($.idx),L&&L(!0)},[w,L]),E=o.useCallback(y=>{w(y),x&&a&&r&&setTimeout(()=>r(!1),300)},[w,x,a,r]),H=o.useCallback((y,$)=>{y.preventDefault(),S({name:$.name,idx:$.idx}),C(!0)},[S,C]),te=o.useCallback(()=>{R(y=>!y)},[]);return e.jsxs(e.Fragment,{children:[g&&a&&e.jsx("div",{className:"sidebar-mobile-overlay",onClick:()=>r&&r(!1)}),x&&!a&&e.jsxs("button",{className:"sidebar-mobile-fab",onClick:()=>r&&r(!0),title:"Open character sidebar",children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7.75735 13.2574L2 9.27L8.91 8.26L12 2Z",fill:"currentColor"})}),e.jsx("span",{className:"sidebar-mobile-fab-badge",children:l.length})]}),e.jsx("div",{className:`sidebar-scroll fade-in-no-slide ${a?"visible":"hidden"} ${g?"mobile":"desktop"} ${x?"very-small":""}`,children:e.jsxs("div",{className:"sidebar-content",children:[g&&e.jsx("button",{className:"sidebar-mobile-close",onClick:()=>r&&r(!1),title:"Close sidebar",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M6 18L18 6M6 6L18 18",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})}),e.jsx("div",{className:"sidebar-header",children:e.jsx("h3",{className:"sidebar-title",onClick:_,title:"View logged item analytics across all characters",children:"Characters"})}),!s&&e.jsx("div",{className:"sidebar-progress-section premium-progress",onClick:te,children:N?l[h]&&e.jsxs("div",{className:"sidebar-progress-container sidebar-progress-character",children:[e.jsxs("div",{className:"sidebar-progress-title",children:[l[h].name,"'s Weekly"]}),e.jsx("div",{className:"sidebar-progress-track week-navigator-progress-bar-container",children:e.jsx("div",{className:"sidebar-progress-fill week-navigator-progress-bar",style:{width:`${(()=>{const y=l[h];if(!y)return 0;`${y.name}${y.idx}`;const $=D[y.idx];if(!$)return 0;const K=$.bosses.reduce((P,I)=>P+Math.ceil((I.price||0)/(I.partySize||1)),0);return K>0?Math.min(y.totalMeso/K*100,100):0})()}%`},children:l[h].totalMeso>0&&e.jsx("div",{className:"week-navigator-progress-shimmer"})})}),e.jsxs("div",{className:"sidebar-progress-numbers",children:[e.jsx("span",{children:ge(l[h].totalMeso)}),e.jsx("span",{children:ge((()=>{const y=l[h];if(!y)return 0;const $=D[y.idx];return $?$.bosses.reduce((K,P)=>K+Math.ceil((P.price||0)/(P.partySize||1)),0):0})())})]})]}):e.jsxs("div",{className:"sidebar-progress-container sidebar-progress-weekly",children:[e.jsx("div",{className:"sidebar-progress-title",children:"Weekly Progress"}),e.jsx("div",{className:"sidebar-progress-track week-navigator-progress-bar-container",children:e.jsx("div",{className:"sidebar-progress-fill week-navigator-progress-bar",style:{width:`${k>0?Math.min(m/k*100,100):0}%`},children:k>0&&m>0&&e.jsx("div",{className:"week-navigator-progress-shimmer"})})}),e.jsxs("div",{className:"sidebar-progress-numbers",children:[e.jsx("span",{children:ge(m)}),e.jsx("span",{children:ge(k)})]})]})}),s&&e.jsxs("div",{className:"sidebar-historical-section",children:[e.jsxs("div",{className:"sidebar-historical-title",children:["Week ",j.split("-").slice(1).join("-")]}),e.jsx("div",{className:"sidebar-historical-subtitle",children:"Historical Data"})]}),e.jsxs("div",{className:"sidebar-character-list-container",children:[e.jsx("div",{className:"sidebar-character-list",ref:Z,children:l.length===0?e.jsx("div",{className:"sidebar-empty-state",children:u?"No characters with bosses left to clear.":"No characters found."}):l.map(y=>e.jsxs("div",{onClick:()=>E(y.idx),onContextMenu:$=>H($,y),className:`sidebar-character-card ${h===y.idx?`selected ${s?"historical-week":"current-week"}`:"default"}`,children:[e.jsxs("div",{className:"sidebar-character-header",children:[e.jsx("span",{className:`sidebar-character-name ${h===y.idx?"selected":"default"}`,children:y.name}),e.jsxs("div",{className:"sidebar-character-actions",children:[y.allCleared&&e.jsxs("svg",{className:"sidebar-character-checkmark",width:"16",height:"16",viewBox:"0 0 22 22",children:[e.jsx("circle",{cx:"11",cy:"11",r:"11",fill:"#38a169"}),e.jsx("polyline",{points:"6,12 10,16 16,7",fill:"none",stroke:"#fff",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})]}),e.jsx("button",{className:"sidebar-character-pitched-btn",onClick:$=>B($,y),title:"View pitched items",children:e.jsxs("div",{className:"pitched-btn-content",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7.75735 13.2574L2 9.27L8.91 8.26L12 2Z",fill:"url(#starGradient)",stroke:"url(#starStrokeGradient)",strokeWidth:"1.5"}),e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"starGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#a259f7"}),e.jsx("stop",{offset:"1",stopColor:"#805ad5"})]}),e.jsxs("linearGradient",{id:"starStrokeGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#d6b4ff"}),e.jsx("stop",{offset:"1",stopColor:"#a259f7"})]})]})]}),e.jsx("span",{className:"pitched-btn-glow"})]})})]})]}),e.jsx("div",{className:"sidebar-character-stats",children:y.total===0?e.jsx("div",{className:"sidebar-character-no-bosses",children:"No bosses configured"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sidebar-character-completion",children:[y.cleared," / ",y.total," bosses cleared"]}),e.jsxs("div",{className:"sidebar-character-meso",children:[ge(y.totalMeso)," meso"]})]})})]},y.name+"-"+y.idx))}),d&&e.jsx("div",{className:"sidebar-scroll-indicator",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M11.0001 3.67157L13.0001 3.67157L13.0001 16.4999L16.2426 13.2574L17.6568 14.6716L12 20.3284L6.34314 14.6716L7.75735 13.2574L11.0001 16.5001L11.0001 3.67157Z",fill:"currentColor"})})})]})]})})]})});function pt({sidebarVisible:t,setSidebarVisible:a}){const[r,s]=o.useState(!1),[m,k]=o.useState(!1);return o.useEffect(()=>{const j=()=>{const u=window.innerWidth;s(u<=768),k(u<=480)};return j(),window.addEventListener("resize",j),()=>window.removeEventListener("resize",j)},[]),m?null:e.jsx("div",{className:`sidebar-toggle ${t?"visible":"hidden"} ${r?"mobile":"desktop"}`,onClick:()=>a(!t),title:t?"Hide sidebar":"Show sidebar",children:t?e.jsxs("svg",{className:"sidebar-toggle-close-icon",width:r?"20":"24",height:r?"20":"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"crossGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#ffffff"}),e.jsx("stop",{offset:"50%",stopColor:"#e6e0ff"}),e.jsx("stop",{offset:"100%",stopColor:"#d6b4ff"})]})}),e.jsx("path",{d:"M6.2253 4.81108C5.83477 4.42056 5.20161 4.42056 4.81108 4.81108C4.42056 5.20161 4.42056 5.83477 4.81108 6.2253L10.5858 12L4.81114 17.7747C4.42062 18.1652 4.42062 18.7984 4.81114 19.1889C5.20167 19.5794 5.83483 19.5794 6.22535 19.1889L12 13.4142L17.7747 19.1889C18.1652 19.5794 18.7984 19.5794 19.1889 19.1889C19.5794 18.7984 19.5794 18.1652 19.1889 17.7747L13.4142 12L19.189 6.2253C19.5795 5.83477 19.5795 5.20161 19.189 4.81108C18.7985 4.42056 18.1653 4.42056 17.7748 4.81108L12 10.5858L6.2253 4.81108Z",fill:"url(#crossGradient)"})]}):e.jsx("div",{className:"sidebar-toggle-hamburger",children:[0,1,2].map(j=>e.jsx("span",{className:"sidebar-toggle-hamburger-line",style:{width:r?"18px":"22px",height:r?"2px":"3px"}},j))})})}function we(t,a,r,s){return`${t}__${a}__${r}__${s}`}function kt({bosses:t=[],bossData:a=[],checked:r={},characterKey:s="",onBossCheck:m=()=>{},getBossPrice:k=()=>0,showTickAll:j=!1,onTickAll:u=()=>{},allTicked:b=!1,pitchedChecked:l={},onPitchedItemClick:h=()=>{},isHistoricalWeek:w=!1,userCode:S="",selectedWeekKey:C="",selectedCharIdx:L=0,userInteractionRef:_=null,cloudPitchedItems:D=[],characterBossSelections:d=[]}){const[i,c]=o.useState(new Set),v=W=>a.find(B=>B.name===W)||{},g=W=>new Intl.NumberFormat().format(W),n=o.useMemo(()=>s.split("-").slice(0,-1).join("-"),[s]),x=(W,B)=>(je(W)||[]).filter(H=>H.difficulty?H.difficulty===B:!B),p=(W,B,E)=>{if(!n)return!1;const H=we(n,W,B,E);return!!l[H]},N=(W,B,E,H)=>{var $;const te=(($=d[L])==null?void 0:$.name)||W,y=we(te,B,E,H);return i.has(y)},R=async(W,B,E,H)=>{var K;W.stopPropagation(),_&&(_.current=!0);const te=((K=d[L])==null?void 0:K.name)||H,y=we(te,B.name,E.name,C),$=p(B.name,E.name,C);if(!i.has(y)){if(w){if($){c(P=>new Set([...P,y]));try{await h({bossName:B.name,itemName:E.name,characterName:te,weekKey:C,isChecked:$,isHistorical:!0})}finally{c(P=>{const I=new Set(P);return I.delete(y),I})}}return}c(P=>new Set([...P,y]));try{await h({bossName:B.name,itemName:E.name,characterName:te,weekKey:C,isChecked:$,isHistorical:!1,itemImage:E.image})}finally{c(P=>{const I=new Set(P);return I.delete(y),I})}}},Z=(W,B,E)=>{E.target.closest(".boss-pitched-items")||m(W,!B,E)};return e.jsx("div",{className:"boss-table-container",children:e.jsxs("div",{className:"boss-table-grid",children:[e.jsxs("div",{className:"boss-table-header",children:[e.jsx("div",{className:"header-boss",children:"Boss"}),e.jsx("div",{className:"header-difficulty",children:"Difficulty"}),e.jsx("div",{className:"header-mesos",children:"Mesos"}),e.jsxs("div",{className:"header-cleared",children:[j&&e.jsx("button",{onClick:u,className:"header-tick-all-button",title:b?"Clear all boss completions":"Mark all bosses as completed",children:b?"Clear All":"Complete All"}),!j&&"Cleared"]})]}),t.map((W,B)=>{var P;const E=v(W.name),H=`${W.name}-${W.difficulty}`,te=!!((P=r[s])!=null&&P[H]),y=k(W.name,W.difficulty)/(W.partySize||1),$=x(W.name,W.difficulty),K=n;return e.jsxs("div",{className:`boss-table-row ${B%2===0?"even":"odd"}`,onClick:I=>Z(W,te,I),children:[e.jsxs("div",{className:"cell-boss",children:[e.jsxs("div",{className:"boss-info-section",children:[E.image&&e.jsx("img",{src:E.image,alt:W.name,className:"boss-image"}),e.jsxs("div",{className:"boss-details",children:[e.jsx("span",{className:"boss-name",children:W.name}),W.partySize&&W.partySize>1&&e.jsxs("span",{className:"boss-party-size",children:["Party: ",W.partySize]})]})]}),$.length>0&&e.jsx("div",{className:"boss-pitched-items",onClick:I=>I.stopPropagation(),children:$.map((I,re)=>{const A=p(W.name,I.name,C),ee=N(K,W.name,I.name,C);return e.jsx("div",{className:`pitched-item-icon ${A?"checked":"unchecked"} ${w?"historical":""} ${ee?"loading":""}`,onClick:M=>!ee&&R(M,W,I,K),title:ee?"Processing...":`${I.name} ${A?"(Obtained)":"(Click to mark as obtained)"}`,style:{cursor:ee?"not-allowed":"pointer",opacity:ee?.7:1},children:ee?e.jsx("div",{className:"pitched-item-loading",children:e.jsx("div",{className:"loading-spinner-small"})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:I.image,alt:I.name,className:"pitched-item-image"}),A&&e.jsx("div",{className:"pitched-item-checkmark",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M20 6L9 17L4 12",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round"})})})]})},`${I.name}-${re}`)})})]}),e.jsx("div",{className:"cell-difficulty",children:W.difficulty}),e.jsx("div",{className:"cell-mesos",children:g(Math.ceil(y))}),e.jsx("div",{className:"cell-cleared",onClick:I=>I.stopPropagation(),children:e.jsx(Xe,{checked:te,onChange:I=>m(W,I.target.checked,I)})})]},H)})]})})}function xt({bossData:t=[],characterKey:a="",selectedWeekKey:r="",selectedCharIdx:s=0,pitchedChecked:m={},onPitchedItemClick:k=()=>{},userCode:j="",cloudPitchedItems:u=[],characterBossSelections:b=[]}){const[l,h]=o.useState([]),w=o.useMemo(()=>a.split("-").slice(0,-1).join("-"),[a]),S=_=>t.find(D=>D.name===_)||{};o.useEffect(()=>{(async()=>{f.info("HistoricalWeekCards: Loading all bosses with pitched items from registry");const D=[],d=[{boss_name:"Lotus",difficulty:"Hard",drops_pitched:["Black Heart","Berserked"]},{boss_name:"Lotus",difficulty:"Extreme",drops_pitched:["Total Control","Black Heart","Berserked"]},{boss_name:"Damien",difficulty:"Hard",drops_pitched:["Magic Eyepatch"]},{boss_name:"Lucid",difficulty:"Hard",drops_pitched:["Dreamy Belt"]},{boss_name:"Will",difficulty:"Hard",drops_pitched:["Cursed Spellbook"]},{boss_name:"Gloom",difficulty:"Chaos",drops_pitched:["Endless Terror"]},{boss_name:"Darknell",difficulty:"Hard",drops_pitched:["Commanding Force Earring"]},{boss_name:"Verus Hilla",difficulty:"Hard",drops_pitched:["Source of Suffering"]},{boss_name:"Chosen Seren",difficulty:"Hard",drops_pitched:["Mitra's Rage"]},{boss_name:"Chosen Seren",difficulty:"Extreme",drops_pitched:["Mitra's Rage","Gravity Module"]},{boss_name:"Watcher Kalos",difficulty:"Easy",drops_pitched:["Grindstone of Life"]},{boss_name:"Watcher Kalos",difficulty:"Normal",drops_pitched:["Grindstone of Life"]},{boss_name:"Watcher Kalos",difficulty:"Chaos",drops_pitched:["Grindstone of Life"]},{boss_name:"Watcher Kalos",difficulty:"Extreme",drops_pitched:["Grindstone of Life","Mark of Destruction"]},{boss_name:"Kaling",difficulty:"Easy",drops_pitched:["Grindstone of Life"]},{boss_name:"Kaling",difficulty:"Normal",drops_pitched:["Grindstone of Life"]},{boss_name:"Kaling",difficulty:"Hard",drops_pitched:["Grindstone of Life"]},{boss_name:"Kaling",difficulty:"Extreme",drops_pitched:["Grindstone of Life","Helmet of Loyalty"]},{boss_name:"Limbo",difficulty:"Hard",drops_pitched:["Whisper of the Source"]}],i={};for(const c of d)if(c.drops_pitched.length>0){i[c.boss_name]||(i[c.boss_name]={name:c.boss_name,difficulties:[],itemMap:{}}),i[c.boss_name].difficulties.push(c.difficulty);for(const v of c.drops_pitched)i[c.boss_name].itemMap[v]||(i[c.boss_name].itemMap[v]=[]),i[c.boss_name].itemMap[v].push(c.difficulty)}for(const[c,v]of Object.entries(i)){const g=[...new Set(v.difficulties)].sort(),n=[];for(const[x,p]of Object.entries(v.itemMap)){const R=(je(c)||[]).find(Z=>Z.name===x)||{};n.push({name:x,image:R.image||"/images/items/default.png",droppingDifficulties:p.sort()})}n.length>0&&(D.push({name:c,items:n,difficultiesThatDropItems:g}),f.info("HistoricalWeekCards: Added boss with registry items",{bossName:c,itemCount:n.length,difficultiesThatDropItems:g,items:n.map(x=>`${x.name} (${x.droppingDifficulties.join(", ")})`)}))}h(D),f.info("HistoricalWeekCards: Total bosses with pitched items loaded from registry:",D.length)})()},[]);const C=(_,D,d)=>{if(!w)return!1;const i=we(w,_,D,d);return!!m[i]},L=async(_,D,d)=>{var v;_.stopPropagation();const i=((v=b[s])==null?void 0:v.name)||w,c=C(D.name,d.name,r);f.debug("HistoricalWeekCards: Pitched item clicked",{bossName:D.name,itemName:d.name,character:i,weekKey:r,isChecked:c}),await k({bossName:D.name,itemName:d.name,characterName:i,weekKey:r,isChecked:c,isHistorical:!0,itemImage:d.image})};return f.info("HistoricalWeekCards: Rendering with data",{bossesWithItemsCount:l.length,weekKey:r,characterName:w}),l.length?e.jsxs("div",{className:"historical-week-cards",children:[e.jsxs("div",{className:"historical-cards-header",children:[e.jsx("h3",{children:"Historical Week Overview"}),e.jsx("p",{children:"All bosses with droppable items - click on pitched items to add/remove historical drops"})]}),e.jsx("div",{className:"historical-cards-grid",children:l.map((_,D)=>{const d=S(_.name),i=_.name;return e.jsxs("div",{className:"historical-boss-card",children:[e.jsxs("div",{className:"historical-boss-header",children:[d.image&&e.jsx("img",{src:d.image,alt:_.name,className:"historical-boss-image"}),e.jsxs("div",{className:"historical-boss-details",children:[e.jsx("h4",{className:"historical-boss-name",children:_.name}),e.jsxs("span",{className:"historical-boss-difficulties",children:["Available in: ",_.difficultiesThatDropItems.join(", ")]})]})]}),e.jsxs("div",{className:"historical-pitched-section",children:[e.jsxs("div",{className:"historical-pitched-header",children:[e.jsx("span",{children:"Dropped Items"}),e.jsxs("span",{className:"historical-pitched-count",children:[_.items.filter(c=>C(_.name,c.name,r)).length," / ",_.items.length]})]}),e.jsx("div",{className:"historical-pitched-grid",children:_.items.map((c,v)=>{const g=C(_.name,c.name,r);return e.jsxs("div",{className:`historical-pitched-item ${g?"checked":"unchecked"}`,onClick:n=>L(n,_,c),title:`${c.name} - Drops from: ${c.droppingDifficulties.join(", ")} ${g?"(Obtained)":"(Click to mark as obtained)"}`,children:[e.jsx("img",{src:c.image,alt:c.name,className:"historical-pitched-image"}),e.jsxs("div",{className:"historical-pitched-info",children:[e.jsx("span",{className:"historical-pitched-name",children:c.name}),e.jsx("span",{className:"historical-pitched-difficulties",children:c.droppingDifficulties.join(", ")})]}),g&&e.jsx("div",{className:"historical-pitched-checkmark",children:"✓"})]},`${c.name}-${v}`)})})]})]},i)})})]}):e.jsxs("div",{className:"historical-cards-empty",children:[e.jsx("div",{className:"historical-cards-empty-icon",children:"🎁"}),e.jsx("h3",{children:"No Droppable Items"}),e.jsx("p",{children:"No bosses with droppable pitched items found."})]})}function wt({showStats:t,setShowStats:a,allYears:r,selectedYear:s,setSelectedYear:m,groupedYearlyPitchedItems:k,isLoadingCloudStats:j,setShowStatsResetConfirm:u,handleItemDetailClick:b}){if(!t)return null;const l=k.reduce((h,w)=>h+w.count,0);return e.jsx("div",{className:"modal-backdrop stats-modal-backdrop",onClick:()=>a(!1),children:e.jsxs("div",{className:"modern-stats-modal",onClick:h=>h.stopPropagation(),children:[e.jsxs("div",{className:"modern-stats-header",children:[e.jsxs("div",{className:"modern-stats-title-section",children:[e.jsx("h2",{className:"modern-stats-title",children:"Pitched Items Statistics"}),e.jsx("div",{className:"modern-stats-subtitle",children:s})]}),e.jsx("button",{onClick:()=>a(!1),className:"modern-stats-close",title:"Close",children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6 6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"modern-stats-controls",children:[e.jsxs("div",{className:"modern-year-selector",children:[e.jsx("label",{className:"modern-year-label",children:"Year:"}),e.jsx("select",{value:s,onChange:h=>m(h.target.value),className:"modern-year-select",children:r.map(h=>e.jsx("option",{value:h,children:h},h))})]}),e.jsxs("div",{className:"modern-stats-summary",children:[e.jsxs("div",{className:"modern-stat-card",children:[e.jsx("div",{className:"modern-stat-number",children:k.length}),e.jsx("div",{className:"modern-stat-label",children:"Unique Items"})]}),e.jsxs("div",{className:"modern-stat-card",children:[e.jsx("div",{className:"modern-stat-number",children:l}),e.jsx("div",{className:"modern-stat-label",children:"Total Obtained"})]})]})]}),e.jsx("div",{className:"modern-stats-content",children:j?e.jsxs("div",{className:"modern-stats-loading",children:[e.jsx("div",{className:"modern-loading-spinner"}),e.jsx("span",{children:"Loading statistics..."})]}):k.length===0?e.jsxs("div",{className:"modern-stats-empty",children:[e.jsx("div",{className:"modern-empty-icon",children:"📊"}),e.jsx("div",{className:"modern-empty-title",children:"No Data Yet"}),e.jsx("div",{className:"modern-empty-text",children:"Start clearing bosses to see your pitched item statistics!"})]}):e.jsx("div",{className:"modern-items-grid",children:k.map((h,w)=>e.jsxs("div",{className:"modern-item-card",onClick:()=>b(h),children:[e.jsxs("div",{className:"modern-item-image-container",children:[e.jsx("img",{src:h.itemImage,alt:h.itemName,className:"modern-item-image"}),e.jsx("div",{className:"modern-item-count-badge",children:h.count})]}),e.jsxs("div",{className:"modern-item-info",children:[e.jsx("div",{className:"modern-item-name",children:h.itemName}),e.jsx("div",{className:"modern-item-meta",children:h.count===1?"1 time":`${h.count} times`})]}),e.jsx("div",{className:"modern-item-arrow",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M9 18l6-6-6-6"})})})]},`${h.itemName}-${w}`))})}),e.jsx("div",{className:"modern-stats-footer",children:e.jsxs("button",{className:"modern-reset-button",onClick:()=>u(!0),children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c0-1 1-2 2-2v2"})}),"Reset All Statistics"]})})]})})}function vt({showItemDetailModal:t,setShowItemDetailModal:a,selectedItemDetail:r}){if(!t||!r)return null;const{itemName:s,itemImage:m,count:k,instances:j}=r,u=j.reduce((l,h)=>(l[h.charId]||(l[h.charId]=[]),l[h.charId].push(h),l),{}),b=Object.keys(u).sort();return e.jsx("div",{className:"modal-backdrop item-detail-backdrop",onClick:()=>a(!1),children:e.jsxs("div",{className:"modern-item-detail-modal",onClick:l=>l.stopPropagation(),children:[e.jsxs("div",{className:"modern-item-detail-header",children:[e.jsxs("div",{className:"modern-item-detail-title-section",children:[e.jsx("div",{className:"modern-item-detail-icon",children:e.jsx("img",{src:m,alt:s,className:"modern-item-detail-image"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"modern-item-detail-title",children:s}),e.jsxs("div",{className:"modern-item-detail-subtitle",children:["Obtained ",k," time",k!==1?"s":""]})]})]}),e.jsx("button",{onClick:()=>a(!1),className:"modern-item-detail-close",title:"Close",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6 6 18M6 6l12 12"})})})]}),e.jsx("div",{className:"modern-item-detail-content",children:b.map(l=>e.jsxs("div",{className:"modern-character-section",children:[e.jsxs("div",{className:"modern-character-header",children:[e.jsx("div",{className:"modern-character-name",children:l}),e.jsxs("div",{className:"modern-character-count",children:[u[l].length," time",u[l].length!==1?"s":""]})]}),e.jsx("div",{className:"modern-dates-grid",children:u[l].map((h,w)=>e.jsxs("div",{className:"modern-date-chip",children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"modern-date-icon",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),h.displayDate]},`${l}-${h.fullDate}-${w}`))})]},l))}),e.jsx("div",{className:"modern-item-detail-footer",children:e.jsxs("div",{className:"modern-detail-stats",children:[e.jsxs("div",{className:"modern-detail-stat",children:[e.jsx("span",{className:"modern-detail-stat-number",children:b.length}),e.jsxs("span",{className:"modern-detail-stat-label",children:["Character",b.length!==1?"s":""]})]}),e.jsxs("div",{className:"modern-detail-stat",children:[e.jsx("span",{className:"modern-detail-stat-number",children:k}),e.jsxs("span",{className:"modern-detail-stat-label",children:["Total Drop",k!==1?"s":""]})]})]})})]})})}function jt({data:t,characterBossSelections:a,onClose:r,onConfirm:s,pitchedChecked:m}){const[k,j]=o.useState(""),[u,b]=o.useState(!1),[l,h]=o.useState(""),w=o.useMemo(()=>t.weekKey?Pe(t.weekKey):{start:null,end:null},[t.weekKey]),S=o.useCallback(d=>d.toISOString().split("T")[0],[]),C=o.useMemo(()=>{var d;return t.character||((d=a[0])==null?void 0:d.name)||""},[t.character,a]);o.useEffect(()=>{w.start&&!k&&j(S(w.start))},[w,k,S]);const L=async()=>{if(!k||!C){h("Please select a valid date and character.");return}b(!0),h("");try{const d=new Date(k+"T12:00:00.000Z").toISOString();f.info("HistoricalPitchedModal: Confirming historical drop",{bossName:t.bossName,itemName:t.itemName,character:C,weekKey:t.weekKey,date:d}),await s(d,C),b(!1)}catch(d){f.error("HistoricalPitchedModal: Error confirming historical drop",d),h("Failed to add historical drop. Please try again."),b(!1)}},_=o.useMemo(()=>{if(!w.start||!w.end)return"";const d=w.start.toLocaleDateString("en-US",{month:"short"}),i=w.end.toLocaleDateString("en-US",{month:"short"}),c=w.start.getDate(),v=w.end.getDate(),g=w.start.getFullYear();return d===i?`${d} ${c}-${v}, ${g}`:`${d} ${c} - ${i} ${v}, ${g}`},[w]),D=o.useMemo(()=>{if(!w.start||!w.end)return[];const d=[],i=new Date(w.start);for(;i<=w.end;){const c=S(i),v=i.toLocaleDateString("en-US",{weekday:"long"}),g=i.toLocaleDateString("en-US",{month:"short",day:"numeric"});d.push({value:c,label:`${v}, ${g}`,date:new Date(i)}),i.setDate(i.getDate()+1)}return d},[w,S]);return e.jsx("div",{className:"historical-modal-overlay",onClick:r,children:e.jsxs("div",{className:"historical-modal-container",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"historical-modal-header",children:[e.jsx("div",{className:"historical-modal-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M12 2v20l-7-7h14l-7 7z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}),e.jsx("h2",{className:"historical-modal-title",children:"Add Historical Drop"}),e.jsx("button",{className:"historical-modal-close",onClick:r,children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),e.jsxs("div",{className:"historical-modal-showcase",children:[e.jsxs("div",{className:"historical-modal-item-container",children:[e.jsx("div",{className:"historical-modal-item-glow"}),e.jsx("img",{src:t.itemImage,alt:t.itemName,className:"historical-modal-item-image"})]}),e.jsxs("div",{className:"historical-modal-item-details",children:[e.jsx("h3",{className:"historical-modal-item-name",children:t.itemName}),e.jsxs("p",{className:"historical-modal-boss-name",children:["from ",t.bossName]})]})]}),e.jsx("div",{className:"historical-modal-details",children:e.jsxs("div",{className:"historical-modal-detail-group",children:[e.jsxs("div",{className:"historical-modal-detail-row",children:[e.jsx("span",{className:"detail-label",children:"Character:"}),e.jsx("span",{className:"detail-value character-name",children:C})]}),e.jsxs("div",{className:"historical-modal-detail-row",children:[e.jsx("span",{className:"detail-label",children:"Week Range:"}),e.jsx("span",{className:"detail-value",children:_})]})]})}),e.jsxs("div",{className:"historical-modal-date-section",children:[e.jsx("label",{className:"historical-modal-section-title",children:"Select the day you obtained this item:"}),e.jsx("div",{className:"historical-modal-date-options",children:D.map(d=>e.jsxs("button",{className:`historical-modal-date-option ${k===d.value?"selected":""}`,onClick:()=>j(d.value),disabled:u,children:[e.jsx("span",{className:"date-option-day",children:d.label.split(",")[0]}),e.jsx("span",{className:"date-option-date",children:d.label.split(",")[1]})]},d.value))}),e.jsxs("div",{className:"historical-modal-date-input-wrapper",children:[e.jsx("label",{className:"historical-modal-date-input-label",children:"Or select date manually:"}),e.jsx("input",{type:"date",value:k,onChange:d=>j(d.target.value),min:w.start?S(w.start):"",max:w.end?S(w.end):"",className:"historical-modal-date-input",disabled:u})]})]}),l&&e.jsxs("div",{className:"historical-modal-error",children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"2"}),e.jsx("path",{d:"M12 8v4M12 16h.01",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),l]}),e.jsxs("div",{className:"historical-modal-actions",children:[e.jsx("button",{onClick:r,disabled:u,className:"historical-modal-btn historical-modal-btn-cancel",children:"Cancel"}),e.jsxs("button",{onClick:L,disabled:u||!k||!C,className:"historical-modal-btn historical-modal-btn-confirm",children:[u&&e.jsx("div",{className:"historical-modal-spinner"}),u?"Adding Drop...":"Confirm Drop"]})]})]})})}function yt({isOpen:t,onClose:a,characterName:r,cloudPitchedItems:s=[],setPitchedModalItem:m,setShowPitchedModal:k}){const[j,u]=o.useState([]);o.useEffect(()=>{if(!t||!r)return;const l=s.filter(S=>S.charId===r),h=new Map;l.forEach(S=>{const C=S.item;if(!h.has(C)){let _="/items/crystal.png";const D=["Lotus","Damien","Lucid","Will","Gloom","Darknell","Verus Hilla","Chosen Seren","Watcher Kalos","Kaling"];for(const d of D){const c=je(d).find(v=>v.name===S.item);if(c){_=c.image;break}}h.set(C,{name:S.item,image:_,count:0,history:[]})}const L=h.get(C);L.count+=1,L.history.push({date:S.date})});const w=Array.from(h.values()).sort((S,C)=>C.count-S.count);u(w)},[t,r,s]);const b=l=>{if(!m||!k)return;const h=l.history.map(w=>({char:r,date:new Date(w.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})}));m({name:l.name,image:l.image,history:h}),k(!0)};return t?e.jsx("div",{className:"pitched-modal-backdrop",onClick:a,children:e.jsxs("div",{className:`pitched-modal ${j.length===0?"pitched-modal-no-scroll":""}`,onClick:l=>l.stopPropagation(),children:[e.jsx("button",{className:"pitched-modal-close",onClick:a,"aria-label":"Close modal",children:e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"closeGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#a259f7"}),e.jsx("stop",{offset:"1",stopColor:"#805ad5"})]})}),e.jsx("path",{d:"M6.2253 4.81108C5.83477 4.42056 5.20161 4.42056 4.81108 4.81108C4.42056 5.20161 4.42056 5.83477 4.81108 6.2253L10.5858 12L4.81114 17.7747C4.42062 18.1652 4.42062 18.7984 4.81114 19.1889C5.20167 19.5794 5.83483 19.5794 6.22535 19.1889L12 13.4142L17.7747 19.1889C18.1652 19.5794 18.7984 19.5794 19.1889 19.1889C19.5794 18.7984 19.5794 18.1652 19.1889 17.7747L13.4142 12L19.189 6.2253C19.5795 5.83477 19.5795 5.20161 19.189 4.81108C18.7985 4.42056 18.1653 4.42056 17.7748 4.81108L12 10.5858L6.2253 4.81108Z",fill:"url(#closeGradient)"})]})}),e.jsx("h2",{className:"pitched-modal-title",children:r?`${r}'s Pitched Items`:"Pitched Items"}),j.length>0?e.jsx("div",{className:"pitched-modal-list-container",children:e.jsx("div",{className:"pitched-modal-list",children:j.map(l=>e.jsxs("div",{className:"pitched-modal-item",onClick:()=>b(l),style:{cursor:"pointer"},children:[e.jsx("div",{className:"pitched-modal-item-glow"}),e.jsx("img",{src:l.image,alt:l.name,className:"pitched-modal-item-img"}),e.jsx("div",{className:"pitched-modal-item-name",children:l.name}),e.jsx("div",{className:"pitched-modal-item-count",children:l.count})]},l.name))})}):e.jsxs("div",{className:"pitched-modal-empty",children:[e.jsx("div",{className:"empty-star-container",children:e.jsxs("svg",{width:"72",height:"72",viewBox:"0 0 24 24",fill:"none",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"emptyStarGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#a259f7"}),e.jsx("stop",{offset:"1",stopColor:"#6a11cb"})]}),e.jsxs("filter",{id:"starGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"1.5",result:"blur"}),e.jsx("feFlood",{floodColor:"#a259f7",floodOpacity:"0.5",result:"color"}),e.jsx("feComposite",{in:"color",in2:"blur",operator:"in",result:"glow"}),e.jsx("feComposite",{in:"SourceGraphic",in2:"glow",operator:"over"})]})]}),e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z",fill:"url(#emptyStarGradient)",stroke:"#e6e0ff",strokeWidth:"1.5",filter:"url(#starGlow)",className:"empty-star-path"})]})}),e.jsx("h3",{className:"empty-title",children:"No pitched items yet"}),e.jsxs("p",{className:"empty-desc",children:[r?`${r} hasn't`:"You haven't"," obtained any pitched items yet"]})]})]})}):null}function Nt({showStatsResetConfirm:t,setShowStatsResetConfirm:a,onConfirm:r}){return t?e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-container modal-container-small",children:[e.jsx("h3",{className:"stats-reset-title",children:"Are you sure?"}),e.jsx("p",{className:"stats-reset-message",children:"This will permanently erase all stats. This cannot be undone."}),e.jsxs("div",{className:"stats-reset-buttons",children:[e.jsx("button",{onClick:()=>a(!1),className:"stats-reset-button stats-reset-button-cancel",children:"Cancel"}),e.jsx("button",{onClick:r,className:"stats-reset-button stats-reset-button-confirm",children:"Reset"})]})]})}):null}function bt({showCharacterPurgeConfirm:t,setShowCharacterPurgeConfirm:a,purgeTargetCharacter:r,purgeInProgress:s,onConfirm:m}){return t?e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-container modal-container-medium character-purge-container",children:[e.jsx("div",{className:"character-purge-icon",children:e.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z",stroke:"#fff",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})})}),e.jsx("h2",{className:"character-purge-title",children:"Purge Character Data"}),e.jsxs("div",{className:"character-purge-warning",children:[e.jsx("p",{className:"character-purge-warning-title",children:e.jsx("strong",{children:"This will permanently delete all pitched items and boss runs for:"})}),e.jsx("p",{className:"character-purge-character-name",children:r==null?void 0:r.name}),e.jsx("p",{className:"character-purge-warning-note",children:"This action cannot be undone."})]}),e.jsxs("div",{className:"character-purge-buttons",children:[e.jsx("button",{onClick:()=>a(!1),disabled:s,className:"character-purge-button character-purge-button-cancel",children:"Cancel"}),e.jsxs("button",{onClick:m,disabled:s,className:"character-purge-button character-purge-button-confirm",children:[s&&e.jsx("div",{className:"character-purge-spinner"}),s?"Purging...":"Purge Data"]})]})]})}):null}function Ct({resetSuccessVisible:t,closeResetSuccess:a,purgeSuccess:r,setPurgeSuccess:s}){return!t&&!r?null:e.jsx("div",{className:"modal-backdrop modal-backdrop-high",children:e.jsxs("div",{className:"modal-container modal-container-small",onClick:m=>m.stopPropagation(),children:[e.jsx("h3",{className:"success-title",children:t?"Stats reset!":"Character purged!"}),e.jsx("p",{className:"success-message",children:t?"Your stats have been cleared.":"Character data has been purged."}),e.jsx("button",{onClick:t?a:()=>s(!1),className:"success-button",children:"Close"})]})})}function Lt({showPitchedModal:t,setShowPitchedModal:a,pitchedModalItem:r,pitchedModalDetails:s}){return!t||!r?null:e.jsx("div",{className:"pitched-details-modal-backdrop",onClick:()=>a(!1),style:{zIndex:9999},children:e.jsxs("div",{className:"pitched-details-modal pitched-details-modal-visible",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"pitched-details-modal-header",children:[e.jsx("button",{className:"pitched-details-modal-close",onClick:()=>a(!1),title:"Close",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M6.2253 4.81108C5.83477 4.42056 5.20161 4.42056 4.81108 4.81108C4.42056 5.20161 4.42056 5.83477 4.81108 6.2253L10.5858 12L4.81114 17.7747C4.42062 18.1652 4.42062 18.7984 4.81114 19.1889C5.20167 19.5794 5.83483 19.5794 6.22535 19.1889L12 13.4142L17.7747 19.1889C18.1652 19.5794 18.7984 19.5794 19.1889 19.1889C19.5794 18.7984 19.5794 18.1652 19.1889 17.7747L13.4142 12L19.189 6.2253C19.5795 5.83477 19.5795 5.20161 19.189 4.81108C18.7985 4.42056 18.1653 4.42056 17.7748 4.81108L12 10.5858L6.2253 4.81108Z",fill:"currentColor"})})}),e.jsxs("div",{className:"pitched-details-modal-item-showcase",children:[e.jsx("img",{src:r.image,alt:r.name,className:"pitched-details-modal-item-img"}),e.jsxs("div",{className:"pitched-details-modal-item-info",children:[e.jsx("h2",{className:"pitched-details-modal-title",children:r.name}),e.jsxs("div",{className:"pitched-details-modal-subtitle",children:[e.jsx("span",{className:"pitched-details-modal-count",children:s.length}),e.jsx("span",{className:"pitched-details-modal-acquired",children:s.length===1?"time obtained":"times obtained"})]})]})]})]}),e.jsxs("div",{className:"pitched-details-modal-content",children:[e.jsxs("div",{className:"pitched-details-section-header",children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"})}),e.jsx("h3",{children:"Acquisition History"})]}),e.jsx("div",{className:"pitched-details-acquisition",children:s.length===0?e.jsx("div",{className:"empty-state",children:"None this year."}):e.jsx("div",{className:"pitched-details-table-container",children:e.jsxs("table",{className:"pitched-details-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Character"}),e.jsx("th",{children:"Date"})]})}),e.jsx("tbody",{children:s.map((m,k)=>e.jsxs("tr",{className:`pitched-details-row ${k%2===0?"even-row":"odd-row"}`,children:[e.jsx("td",{children:m.char}),e.jsx("td",{children:e.jsx("span",{className:"date-value",children:m.date})})]},k))})]})})})]})]})})}function St({statsManagement:t,weekNavigation:a,pitchedChecked:r,setPitchedChecked:s,userInteractionRef:m,setError:k,characterBossSelections:j,selectedCharIdx:u,cloudPitchedItems:b}){var l;return e.jsxs(e.Fragment,{children:[e.jsx(wt,{showStats:t.showStats,setShowStats:t.setShowStats,allYears:t.allYears,selectedYear:t.selectedYear,setSelectedYear:t.setSelectedYear,groupedYearlyPitchedItems:t.groupedYearlyPitchedItems,isLoadingCloudStats:t.isLoadingCloudStats,setShowStatsResetConfirm:t.setShowStatsResetConfirm,handleItemDetailClick:t.handleItemDetailClick}),e.jsx(vt,{showItemDetailModal:t.showItemDetailModal,setShowItemDetailModal:t.setShowItemDetailModal,selectedItemDetail:t.selectedItemDetail}),e.jsx(Nt,{showStatsResetConfirm:t.showStatsResetConfirm,setShowStatsResetConfirm:t.setShowStatsResetConfirm,onConfirm:()=>t.handleStatsReset(k)}),e.jsx(bt,{showCharacterPurgeConfirm:t.showCharacterPurgeConfirm,setShowCharacterPurgeConfirm:t.setShowCharacterPurgeConfirm,purgeTargetCharacter:t.purgeTargetCharacter,purgeInProgress:t.purgeInProgress,onConfirm:()=>t.handleCharacterPurge(r,s,a.selectedWeekKey,m,k)}),e.jsx(Ct,{resetSuccessVisible:t.resetSuccessVisible,closeResetSuccess:t.closeResetSuccess,purgeSuccess:t.purgeSuccess,setPurgeSuccess:t.setPurgeSuccess}),t.showHistoricalPitchedModal&&e.jsx("div",{className:"modal-backdrop",onClick:()=>t.setShowHistoricalPitchedModal(!1),children:e.jsx(jt,{data:t.historicalPitchedData,characterBossSelections:j,onClose:()=>t.setShowHistoricalPitchedModal(!1),onConfirm:t.handleHistoricalPitchedConfirm,pitchedChecked:r})}),e.jsx(yt,{isOpen:t.showCharacterPitchedModal,onClose:()=>t.setShowCharacterPitchedModal(!1),characterName:((l=j[u])==null?void 0:l.name)||"",cloudPitchedItems:b,setPitchedModalItem:t.setPitchedModalItem,setShowPitchedModal:t.setShowPitchedModal}),e.jsx(Lt,{showPitchedModal:t.showPitchedModal,setShowPitchedModal:t.setShowPitchedModal,pitchedModalItem:t.pitchedModalItem,pitchedModalDetails:t.pitchedModalDetails})]})}function Dt(t,a,r=null){const[s,m]=o.useState(a||Ce()),[k,j]=o.useState({hasHistoricalData:!1,oldestHistoricalWeek:null,userType:"new",adaptiveWeekLimit:8,historicalWeeks:[],analysis:null}),[u,b]=o.useState(!1);o.useEffect(()=>{a&&a!==s&&(f.info("useWeekNavigation: App week key differs from selected, updating",{appWeekKey:a,selectedWeekKey:s}),m(a))},[a]);const l=s!==(a||Ce()),h=o.useCallback(async()=>{var C;if(!t||u)return;const S=Ce();try{b(!0),f.debug("useWeekNavigation: Refreshing historical analysis",{userCode:t,realCurrentWeek:S,selectedCharacterName:r});const L=r?await Qe(t,r):await et(t);L.success?(j({hasHistoricalData:L.hasHistoricalData,oldestHistoricalWeek:L.oldestHistoricalWeek,userType:L.userType,adaptiveWeekLimit:L.adaptiveWeekLimit,historicalWeeks:L.historicalWeeks,analysis:L.analysis}),f.debug("useWeekNavigation: Historical analysis refreshed",{userType:L.userType,hasData:L.hasHistoricalData,oldestWeek:L.oldestHistoricalWeek,adaptiveLimit:L.adaptiveWeekLimit,historicalWeeksCount:((C=L.historicalWeeks)==null?void 0:C.length)||0,characterSpecific:!!r})):f.error("useWeekNavigation: Error in historical analysis result",L.error)}catch(L){f.error("useWeekNavigation: Error refreshing historical analysis",L)}finally{b(!1)}},[t,u,r]),w=o.useCallback(S=>{S!==s&&(f.info("useWeekNavigation: Week changed",{from:s,to:S}),m(S),t&&setTimeout(()=>{h()},100))},[s,t,h]);return o.useEffect(()=>{if(t){const S=setTimeout(()=>{h()},150);return()=>clearTimeout(S)}},[t,r]),{selectedWeekKey:s,isHistoricalWeek:l,handleWeekChange:w,historicalAnalysis:k,refreshHistoricalAnalysis:h,isLoadingAnalysis:u}}function It(t){const[a,r]=o.useState({}),[s,m]=o.useState([]),[k,j]=o.useState({}),[u,b]=o.useState(!1),l=o.useRef(!1),h=o.useCallback(async()=>{if(t)try{b(!0);const d=await ye(t,{});if(d.success){m(d.items);const{getCurrentWeekKey:i}=await oe(async()=>{const{getCurrentWeekKey:g}=await import("./index-ChAGxcO2.js").then(n=>n.w);return{getCurrentWeekKey:g}},__vite__mapDeps([0,1,2,3,4,5])),c=i();f.debug("usePitchedItems: Current week info",{currentWeek:c,totalItems:d.items.length});const v={};d.items.forEach(g=>{const n=de(g.date),x=`${g.charId}__${g.bossName}__${g.item}__${n}`;v[x]=!0}),f.debug("usePitchedItems: Loaded pitched items from database",{itemCount:d.items.length,checkedKeys:Object.keys(v).length,sampleKeys:Object.keys(v).slice(0,3),sampleItems:d.items.slice(0,3).map(g=>({charId:g.charId,bossName:g.bossName,item:g.item,date:g.date,weekKey:de(g.date)})),currentWeekItems:d.items.filter(g=>de(g.date)===c).length}),r(v)}else f.error("usePitchedItems: Failed to refresh pitched items",d.error)}catch(d){f.error("usePitchedItems: Error refreshing pitched items",d)}finally{b(!1)}},[t]),w=o.useCallback(async(d,i,c,v=null)=>{if(!t)return f.warn("usePitchedItems: No user ID available, user may not be authenticated yet"),{success:!1,error:"User not authenticated"};const g=v||new Date().toISOString().split("T")[0],n=de(g),x=`${d}__${i}__${c}__${n}`;if(a[x])return f.info("usePitchedItems: Item already exists, skipping add",{key:x,existingChecked:!!a[x],charId:d,bossName:i,item:c,itemWeekKey:n}),{success:!0,message:"Item already exists"};f.debug("usePitchedItems: Adding new pitched item",{key:x,charId:d,bossName:i,item:c,itemWeekKey:n,pitchedCheckedKeys:Object.keys(a).length});const N=await $e(t,{charId:d,bossName:i,item:c,date:g});if(N.success){const R=N.pitchedItem;return m(Z=>[...Z,R]),r(Z=>({...Z,[x]:!0})),{success:!0}}else throw new Error(N.error)},[t,a]),S=o.useCallback(async(d,i,c,v=null)=>{if(!t)return f.warn("usePitchedItems: No user ID available, user may not be authenticated yet"),{success:!1,error:"User not authenticated"};f.debug("usePitchedItems: Attempting to remove pitched item",{charId:d,bossName:i,item:c,providedDate:v,cloudItemsCount:s.length});let g=v;if(g){if(!s.find(p=>p.charId===d&&p.bossName===i&&p.item===c&&p.date===v)){f.warn("usePitchedItems: Exact date match not found",{charId:d,bossName:i,item:c,targetDate:v,availableItemsForCharacter:s.filter(N=>N.charId===d).map(N=>({bossName:N.bossName,item:N.item,date:N.date}))});const p=s.filter(N=>N.charId===d&&N.bossName===i&&N.item===c);if(p.length>0)f.info("usePitchedItems: Found alternative matches, using most recent",{alternativeCount:p.length,alternatives:p.map(N=>N.date)}),p.sort((N,R)=>new Date(R.date)-new Date(N.date)),g=p[0].date;else throw f.error("usePitchedItems: No alternative matches found"),new Error("Pitched item not found")}}else{const x=s.filter(p=>p.charId===d&&p.bossName===i&&p.item===c);if(f.debug("usePitchedItems: Searching for matching items without date",{matchingItemsCount:x.length,matchingItems:x.map(p=>({charId:p.charId,bossName:p.bossName,item:p.item,date:p.date}))}),x.length>0)x.sort((p,N)=>new Date(N.date)-new Date(p.date)),g=x[0].date,f.debug("usePitchedItems: Found most recent item",{targetDate:g});else return f.info("usePitchedItems: No matching items found to remove",{charId:d,bossName:i,item:c,availableItems:s.map(p=>({charId:p.charId,bossName:p.bossName,item:p.item,date:p.date})).slice(0,5)}),{success:!0,message:"No items to remove"}}f.debug("usePitchedItems: Proceeding with removal",{charId:d,bossName:i,item:c,targetDate:g});const n=await He(t,d,i,c,g);if(n.success){m(N=>N.filter(R=>!(R.charId===d&&R.bossName===i&&R.item===c&&R.date===g)));const x=de(g),p=`${d}__${i}__${c}__${x}`;return r(N=>{const R={...N};return delete R[p],R}),f.info("usePitchedItems: Successfully removed pitched item",{charId:d,bossName:i,item:c,targetDate:g,removedKey:p}),{success:!0}}else throw new Error(n.error)},[t,s]),C=o.useCallback(async d=>{if(!t)throw new Error("No user ID provided");const i=await Me(t,d);if(i.success)return m(c=>{let v=[...c];return d.forEach(({charId:g,bossName:n,item:x,date:p})=>{if(p)v=v.filter(N=>!(N.charId===g&&N.bossName===n&&N.item===x&&N.date===p));else{const N=v.findLastIndex(R=>R.charId===g&&R.bossName===n&&R.item===x);N!==-1&&v.splice(N,1)}}),v}),r(c=>{const v={...c};return d.forEach(({charId:g,bossName:n,item:x,date:p})=>{if(p){const N=de(p),R=`${g}__${n}__${x}__${N}`;delete v[R]}else Object.keys(v).forEach(N=>{N.startsWith(`${g}__${n}__${x}__`)&&delete v[N]})}),v}),{success:!0,removedCount:i.removedCount};throw new Error(i.error)},[t]),L=o.useCallback(async d=>{if(!t)throw new Error("No user ID provided");const i=await Te(t,d);if(i.success)return m(c=>c.filter(v=>de(v.date)!==d)),r(c=>{const v={...c};return Object.keys(v).forEach(g=>{g.endsWith(`__${d}`)&&delete v[g]}),v}),{success:!0,removedCount:i.removedCount};throw new Error(i.error)},[t]),_=o.useCallback(async(d=null)=>{if(!t)throw new Error("No user ID provided");const i=await ve(t,d);if(i.success)return{success:!0,stats:i.stats};throw new Error(i.error)},[t]),D=o.useCallback(async()=>{if(!t)throw new Error("No user ID provided");const d=await Be(t);if(d.success)return m([]),r({}),{success:!0,removedCount:d.removedCount};throw new Error(d.error)},[t]);return o.useEffect(()=>{t&&h()},[t]),{pitchedChecked:a,setPitchedChecked:r,cloudPitchedItems:s,setCloudPitchedItems:m,userInteractionRef:l,refreshPitchedItems:h,loadingPitchedItems:k,setLoadingPitchedItems:j,isRefreshingPitchedItems:u,addNewPitchedItem:w,removePitchedItemByDetails:S,removeManyPitchedItemsByDetails:C,clearWeekPitchedItems:L,getYearlyStats:_,purgeAllItems:D}}function _t({userId:t=null,characterBossSelections:a=[],selectedCharIdx:r=0,checked:s={},setChecked:m=()=>{},setCrystalAnimation:k=()=>{},setError:j=()=>{},onDataChange:u=()=>{},isHistoricalWeek:b=!1,onBossUncheckStart:l=()=>{},onBossUncheckEnd:h=()=>{}}){const[w,S]=o.useState(!1),C=o.useRef(!1),L=o.useRef(0),_=o.useCallback(async(i,c,v)=>{if(w||!t){f.info("useBossActions: Boss check skipped",{isUpdating:w,hasUserId:!!t});return}if(r==null){f.debug("useBossActions: Boss check skipped",{reason:"No character selected",characterIdx:r,bossName:i.name,difficulty:i.difficulty});return}if(b){f.debug("useBossActions: Boss check skipped for historical week");return}S(!0),C.current=!0;try{f.debug("useBossActions: Boss check initiated",{bossName:i.name,difficulty:i.difficulty,isChecked:c,characterIdx:r});const g=a[r];if(!g)throw new Error("No character selected");const n=`${g.name}-${r}`,x=`${i.name}-${i.difficulty}`;m(E=>{const H={...E};return H[n]||(H[n]={}),H[n]={...H[n]},c?H[n][x]=!0:delete H[n][x],H}),f.debug("useBossActions: Boss check details",{charName:g.name,charIdx:r,bossName:i.name,difficulty:i.difficulty}),f.debug("useBossActions: Converting boss to registry ID",{bossName:i.name,difficulty:i.difficulty});const p=await it(i.name,i.difficulty);f.debug("useBossActions: Boss registry ID obtained",p);const{toggleBossClearStatus:N}=await oe(async()=>{const{toggleBossClearStatus:E}=await import("./userWeeklyDataService-CzU74Ypw.js");return{toggleBossClearStatus:E}},__vite__mapDeps([6,4,3,7,0,1,2,5])),{getCurrentMapleWeekStartDate:R}=await oe(async()=>{const{getCurrentMapleWeekStartDate:E}=await import("./mapleWeekUtils-Bm65Nri8.js");return{getCurrentMapleWeekStartDate:E}},[]),Z=R(),W={userId:t,characterName:g.name,characterIndex:g.index.toString(),bossRegistryId:p,isCompleted:c,weekKey:Z};f.debug("useBossActions: Updating database",{userId:t,characterName:g.name,characterIndex:g.index.toString(),bossRegistryId:p,isCompleted:c,weekKey:Z});const B=await N(t,Z,g.index.toString(),p,c);if(f.debug("useBossActions: Database update result",B),!B.success)throw new Error(B.error||"Failed to update boss completion");if(!c){l();try{f.info("useBossActions: Boss unchecked - removing associated pitched items",{characterName:g.name,bossName:i.name,difficulty:i.difficulty});const{removeManyPitchedItems:E}=await oe(async()=>{const{removeManyPitchedItems:ee}=await Promise.resolve().then(()=>pe);return{removeManyPitchedItems:ee}},void 0),{getCurrentWeekKey:H,convertWeekKeyToDate:te,getWeekDateRange:y}=await oe(async()=>{const{getCurrentWeekKey:ee,convertWeekKeyToDate:M,getWeekDateRange:ce}=await import("./index-ChAGxcO2.js").then(ne=>ne.w);return{getCurrentWeekKey:ee,convertWeekKeyToDate:M,getWeekDateRange:ce}},__vite__mapDeps([0,1,2,3,4,5])),$=H(),K=te($),P=y($);f.info("useBossActions: Week date analysis",{currentWeek:$,currentWeekDate:K,currentWeekRange:{start:P.start,end:P.end}});const I=[],{getPitchedItems:re}=await oe(async()=>{const{getPitchedItems:ee}=await Promise.resolve().then(()=>pe);return{getPitchedItems:ee}},void 0),A=await re(t,{});if(f.info("useBossActions: Retrieved pitched items for removal check",{success:A.success,totalItems:A.success?A.items.length:0,userId:t,currentWeekDate:K}),A.success){A.items.forEach((M,ce)=>{const ne=M.date?new Date(M.date):null,T=M.date===null||ne&&ne>=P.start&&ne<=P.end;f.info(`useBossActions: Item ${ce} - Character comparison: "${M.charId}" === "${g.name}" = ${M.charId===g.name}`),f.info(`useBossActions: Item ${ce} - Boss comparison: "${M.bossName}" === "${i.name}" = ${M.bossName===i.name}`),f.info(`useBossActions: Item ${ce} - Date analysis: ${M.date} (as Date: ${ne}) in range ${P.start} to ${P.end} OR null = ${T}`),f.info(`useBossActions: Item ${ce} - Overall match: ${M.charId===g.name&&M.bossName===i.name&&T}`)});const ee=A.items.filter(M=>{const ce=M.date?new Date(M.date):null,ne=M.date===null||ce&&ce>=P.start&&ce<=P.end;return M.charId===g.name&&M.bossName===i.name&&ne});if(f.info("useBossActions: Filtered items for removal",{totalItemsFromDB:A.items.length,filteredItems:ee.length,filterCriteria:{charId:g.name,bossName:i.name,date:K,alsoMatchingNull:!0},allItemsFromDB:A.items.map(M=>({charId:M.charId,bossName:M.bossName,item:M.item,date:M.date})),filteredItemDetails:ee.map(M=>({charId:M.charId,bossName:M.bossName,item:M.item,date:M.date}))}),ee.forEach(M=>{I.push({charId:M.charId,bossName:M.bossName,item:M.item,date:M.date})}),I.length>0){f.info("useBossActions: Removing pitched items for unchecked boss",{characterName:g.name,bossName:i.name,itemsToRemove:I.length,itemDetails:I});const M=await E(t,I);f.info("useBossActions: Pitched items removal result",{success:M.success,error:M.error,removedCount:M.removedCount,attemptedRemovalCount:I.length}),M.success?(f.info("useBossActions: Successfully removed pitched items",{removedCount:M.removedCount,originalCount:I.length}),u&&u()):f.warn("useBossActions: Failed to remove some pitched items",{error:M.error,itemsToRemove:I})}else f.info("useBossActions: No pitched items found to remove",{characterName:g.name,bossName:i.name,currentWeekDate:K,totalItemsInDB:A.items.length})}}catch(E){f.warn("useBossActions: Failed to remove pitched items for unchecked boss",{error:E,characterName:g.name,bossName:i.name})}finally{h()}}m(E=>{const H={...E};return H[n]||(H[n]={}),H[n]={...H[n]},c?H[n][x]=!0:delete H[n][x],H}),f.debug("useBossActions: Boss check completed successfully"),L.current=Date.now()}catch(g){f.error("useBossActions: Error handling boss check",g),j(g.message),m(n=>{const x={...n},p=a[r];if(p){const N=`${p.name}-${r}`,R=`${i.name}-${i.difficulty}`;x[N]||(x[N]={}),x[N]={...x[N]},c?delete x[N][R]:x[N][R]=!0}return x})}finally{S(!1)}},[t,a,r,s,m,k,j,u,w,b,l,h]),D=o.useCallback(async()=>{if(!(!t||b||w)){S(!0),C.current=!0;try{const i=a[r];if(!i)throw new Error("No character selected");const c=`${i.name}-${r}`,v=i.bosses||[],n=!v.every(B=>{var E;return(E=s[c])==null?void 0:E[`${B.name}-${B.difficulty}`]}),x={...s};m(B=>{const E={...B};E[c]||(E[c]={}),E[c]={...E[c]};for(const H of v){const te=`${H.name}-${H.difficulty}`;n?E[c][te]=!0:delete E[c][te]}return E});const{clearAllBossesForCharacter:p,markAllBossesForCharacter:N}=await oe(async()=>{const{clearAllBossesForCharacter:B,markAllBossesForCharacter:E}=await import("./userWeeklyDataService-CzU74Ypw.js");return{clearAllBossesForCharacter:B,markAllBossesForCharacter:E}},__vite__mapDeps([6,4,3,7,0,1,2,5])),{getCurrentMapleWeekStartDate:R}=await oe(async()=>{const{getCurrentMapleWeekStartDate:B}=await import("./mapleWeekUtils-Bm65Nri8.js");return{getCurrentMapleWeekStartDate:B}},[]),Z=R();let W;if(n?(f.debug("useBossActions: Marking all bosses as cleared",{characterIdx:i.index,bossCount:v.length,weekKey:Z}),W=await N(t,Z,i.index.toString())):(f.debug("useBossActions: Clearing all bosses",{characterIdx:i.index,bossCount:v.length,weekKey:Z}),W=await p(t,Z,i.index.toString())),!W.success)f.error("useBossActions: Bulk operation failed",{action:n?"markAll":"clearAll",error:W.error}),m(x),j(`Failed to ${n?"mark all bosses as completed":"clear all boss completions"}. Please try again.`);else{if(!n){l();try{f.info("useBossActions: All bosses cleared - removing all pitched items for character",{characterName:i.name,bossCount:v.length});const{getPitchedItems:B,removeManyPitchedItems:E}=await oe(async()=>{const{getPitchedItems:P,removeManyPitchedItems:I}=await Promise.resolve().then(()=>pe);return{getPitchedItems:P,removeManyPitchedItems:I}},void 0),{getCurrentWeekKey:H}=await oe(async()=>{const{getCurrentWeekKey:P}=await import("./index-ChAGxcO2.js").then(I=>I.w);return{getCurrentWeekKey:P}},__vite__mapDeps([0,1,2,3,4,5])),{convertWeekKeyToDate:te}=await oe(async()=>{const{convertWeekKeyToDate:P}=await import("./index-ChAGxcO2.js").then(I=>I.w);return{convertWeekKeyToDate:P}},__vite__mapDeps([0,1,2,3,4,5])),y=H(),$=te(y),K=await B(t,{});if(K.success){const P=K.items.filter(I=>I.charId===i.name&&I.date===$);if(P.length>0){const I=P.map(A=>({charId:A.charId,bossName:A.bossName,item:A.item,date:A.date}));f.info("useBossActions: Removing all pitched items for character",{characterName:i.name,itemsToRemove:I.length});const re=await E(t,I);re.success?f.info("useBossActions: Successfully removed all pitched items for character",{removedCount:re.removedCount}):f.warn("useBossActions: Failed to remove some pitched items during clear all",{error:re.error})}}}catch(B){f.warn("useBossActions: Failed to remove pitched items during clear all",{error:B,characterName:i.name})}finally{h()}}await u(),f.debug("useBossActions: Tick all completed successfully",{characterIdx:i.index,allTicked:n,processedBosses:v.length})}}catch(i){f.error("useBossActions: Error handling tick all",i),j(i.message),m(c=>{const v=a[r];if(!v)return c;const g=`${v.name}-${r}`,n=c[g]||{};return{...c,[g]:{...n}}})}finally{S(!1)}}},[t,a,r,s,m,j,u,w,b,l,h]);return{handleCheck:_,handleTickAll:D,refreshCheckedStateFromDatabase:async()=>{try{return t?(u&&u(),!0):null}catch(i){return console.error("Error refreshing checked state:",i),null}},isUpdating:w,userInteractionRef:C,lastUpdate:L.current}}const Pt=t=>{const a=["Lotus","Damien","Lucid","Will","Gloom","Darknell","Verus Hilla","Chosen Seren","Watcher Kalos","Kaling","Limbo"];for(const r of a){const m=je(r).find(k=>k.name===t);if(m)return m.image}return"/items/crystal.png"};function Wt(t,a){const[r,s]=o.useState(!1),[m,k]=o.useState(!1),[j,u]=o.useState({monthly:[],yearly:[]}),[b,l]=o.useState(!1),[h,w]=o.useState(null),[S,C]=o.useState(!1),[L,_]=o.useState(!1),[D,d]=o.useState([]),[i,c]=o.useState(!1),[v,g]=o.useState({}),[n,x]=o.useState(!1),[p,N]=o.useState(null),[R,Z]=o.useState(!1),[W,B]=o.useState(!1),[E,H]=o.useState(!1),[te,y]=o.useState(null),[$,K]=o.useState(!1),[P,I]=o.useState(null),re=o.useMemo(()=>{const q=xe(),G=new Set([q]);return j!=null&&j.yearly&&Array.isArray(j.yearly)&&j.yearly.forEach(F=>G.add(F.yearKey)),v&&Object.keys(v).forEach(F=>G.add(F)),Array.from(G).sort((F,O)=>O.localeCompare(F))},[j==null?void 0:j.yearly,v]),[A,ee]=o.useState(()=>xe());o.useEffect(()=>{(re==null?void 0:re.length)>0&&!re.includes(A)&&ee(re[0])},[re,A]),o.useEffect(()=>{if(!r||!t)return;(async()=>{try{x(!0);const G=parseInt(A,10),F=await ve(t,G);F.success&&g(O=>({...O,[A]:F.stats}))}catch(G){console.error("Error fetching cloud pitched stats:",G)}finally{x(!1)}})()},[r,t,A]);const M=o.useMemo(()=>{if(!A||!v)return[];const q=v[A];if(!(q!=null&&q.items)||!Array.isArray(q.items))return[];const G=new Map;return q.items.filter(O=>(O==null?void 0:O.item)&&(O==null?void 0:O.charId)&&(O==null?void 0:O.date)).forEach(O=>{const Q=O.item;G.has(Q)||G.set(Q,{itemName:Q,itemImage:Pt(Q),count:0,instances:[]});const z=G.get(Q);z.count+=1;const ie=new Date(O.date),Y=Ye[ie.getUTCMonth()],X=ie.getUTCDate();z.instances.push({charId:O.charId,fullDate:O.date,displayDate:`${Y} ${X}`,sortDate:ie.getTime()})}),Array.from(G.values()).map(O=>({...O,instances:O.instances.sort((Q,z)=>z.sortDate-Q.sortDate)})).sort((O,Q)=>Q.count!==O.count?Q.count-O.count:O.itemName.localeCompare(Q.itemName))},[A,v]),ce=async(q,G,F,O,Q)=>{if(h)try{C(!0);const{name:z,idx:ie}=h;O.current=!0;const Y=st(q,z,ie,F);if(G(Y),(await rt(t,z,ie)).success){g({}),await a(t);const ue=await ve(t);if(ue.success){const Ne=xe();g({[Ne]:ue.stats})}_(!0),l(!1);const he=await at(t);he.success&&d(he.history),setTimeout(()=>{_(!1)},3e3)}else Q("Failed to purge character data. Please try again.")}catch(z){console.error("Error in handleCharacterPurge:",z),Q("Failed to purge character data. Please try again.")}finally{C(!1),setTimeout(()=>{O.current=!1},1e3)}},ne=async q=>{try{if(u({monthly:[],yearly:[]}),ee(xe()),t)if((await tt(t)).success)g({}),await a(t);else{q("Failed to reset stats data. Please try again.");return}k(!1),c(!0),setTimeout(()=>{c(!1),s(!1)},3400)}catch(G){console.error("Error in stats reset:",G),q("Failed to reset stats data. Please try again.")}},T=()=>{c(!1),s(!1)},J=o.useMemo(()=>p?p.history||[]:[],[p]);function se(){f.silence("Stats tracking is now cloud-based - no action needed")}return{showStats:r,setShowStats:s,showStatsResetConfirm:m,setShowStatsResetConfirm:k,statsPanel:j,setStatsPanel:u,showCharacterPurgeConfirm:b,setShowCharacterPurgeConfirm:l,purgeTargetCharacter:h,setPurgeTargetCharacter:w,purgeInProgress:S,purgeSuccess:L,setPurgeSuccess:_,auditHistory:D,resetSuccessVisible:i,closeResetSuccess:T,cloudPitchedStats:v,setCloudPitchedStats:g,isLoadingCloudStats:n,pitchedModalItem:p,setPitchedModalItem:N,showPitchedModal:R,setShowPitchedModal:Z,showCharacterPitchedModal:W,setShowCharacterPitchedModal:B,pitchedModalDetails:J,showItemDetailModal:E,setShowItemDetailModal:H,selectedItemDetail:te,setSelectedItemDetail:y,showHistoricalPitchedModal:$,setShowHistoricalPitchedModal:K,historicalPitchedData:P,setHistoricalPitchedData:I,allYears:re,selectedYear:A,setSelectedYear:ee,groupedYearlyPitchedItems:M,handleCharacterPurge:ce,handleStatsReset:ne,startStatsTrackingIfNeeded:se,handleHistoricalPitchedConfirm:async(q,G)=>{try{if(!P)throw new Error("No historical pitched data available");const{itemName:F,bossName:O,weekKey:Q}=P;f.userAction("Adding historical pitched item",`${F} for ${O} by ${G}`);const{addPitchedItem:z}=await oe(async()=>{const{addPitchedItem:X}=await Promise.resolve().then(()=>pe);return{addPitchedItem:X}},void 0),ie={charId:G,bossName:O,item:F,date:q.split("T")[0]},Y=await z(t,ie);if(Y.success)return f.silence("Historical pitched item added successfully"),K(!1),I(null),a&&await a(),{success:!0};throw new Error(Y.error||"Failed to add historical pitched item")}catch(F){throw f.error("Error handling historical pitched confirmation:",F),F}},handleHistoricalPitchedRemove:async(q,G,F,O=null)=>{try{let Q=O,z=G;if(!Q&&P&&(Q=P.weekKey,z||(z=P.bossName)),!Q)throw new Error("Week key not available for historical pitched item removal");if(!z)throw new Error("Boss name not available for historical pitched item removal");f.userAction("Removing historical pitched item",`${F} from ${z} by ${q}`);const{removePitchedItem:ie}=await oe(async()=>{const{removePitchedItem:X}=await Promise.resolve().then(()=>pe);return{removePitchedItem:X}},void 0),Y=await ie(t,q,z,F,null);if(Y.success)return f.silence("Historical pitched item removed successfully"),P&&(K(!1),I(null)),a&&await a(),{success:!0};throw new Error(Y.error||"Failed to remove historical pitched item")}catch(Q){throw f.error("Error handling historical pitched removal:",Q),Q}},handleItemDetailClick:q=>{y(q),H(!0)}}}function Et(){const{userCode:t,isLoggedIn:a}=We(),[r,s]=o.useState(null),[m,k]=o.useState(()=>ot()),[j,u]=o.useState(!1),[b,l]=o.useState(""),[h,w]=o.useState(null),[S,C]=o.useState("");o.useEffect(()=>{if(!t||!a){s(null),l("");return}let n=!0;return(async()=>{try{u(!0),l("");const p=await _e(t);if(!n)return;p.success?s(p.data):l(p.error||"Failed to load weekly data.")}catch(p){n&&(console.error("Failed to load weekly data:",p),l("Failed to load weekly data. Please try again."))}finally{n&&u(!1)}})(),()=>{n=!1}},[t,a,m]);const L=o.useCallback(async()=>{if(!(!t||!a))try{u(!0);const n=await _e(t);n.success?(s(n.data),l("")):l(n.error||"Failed to refresh data.")}catch(n){console.error("Failed to refresh weekly data:",n),l("Failed to refresh data.")}finally{u(!1)}},[t,a]),_=o.useCallback(()=>!r||!r.char_map?[]:Object.entries(r.char_map).map(([n,x])=>{var p,N;return{index:parseInt(n),name:x,bossConfig:((p=r.boss_config)==null?void 0:p[n])||"",weeklyClears:((N=r.weekly_clears)==null?void 0:N[n])||""}}).sort((n,x)=>n.index-x.index),[r]),D=o.useCallback(async n=>{if(!t||!a)return l("Not logged in."),{success:!1,error:"Not logged in."};if(!(n!=null&&n.trim()))return l("Character name cannot be empty."),{success:!1,error:"Character name cannot be empty."};try{u(!0),l("");const x=await ct(t,m,n.trim());return x.success?(await L(),C(""),{success:!0,characterIndex:x.characterIndex}):(l(x.error||"Failed to add character."),x)}catch(x){console.error("Failed to add character:",x);const p="Failed to add character.";return l(p),{success:!1,error:p}}finally{u(!1)}},[t,a,m,L]),d=o.useCallback(async n=>{if(!t||!a)return l("Not logged in."),{success:!1,error:"Not logged in."};try{u(!0),l("");const x=await nt(t,m,n);return x.success?(await L(),h===n&&w(null),{success:!0}):(l(x.error||"Failed to remove character."),x)}catch(x){console.error("Failed to remove character:",x);const p="Failed to remove character.";return l(p),{success:!1,error:p}}finally{u(!1)}},[t,a,m,h,L]),i=o.useCallback(async(n,x)=>{if(!t||!a)return l("Not logged in."),{success:!1,error:"Not logged in."};try{u(!0),l("");const p=await lt(t,m,n,x);return p.success?(await L(),{success:!0}):(l(p.error||"Failed to update character name."),p)}catch(p){console.error("Failed to update character name:",p);const N="Failed to update character name.";return l(N),{success:!1,error:N}}finally{u(!1)}},[t,a,m,L]),c=o.useCallback(async(n,x)=>{if(!t||!a)return l("Not logged in."),{success:!1,error:"Not logged in."};try{u(!0),l("");const p=await dt(t,m,n,x);return p.success?(await L(),{success:!0}):(l(p.error||"Failed to update boss configuration."),p)}catch(p){console.error("Failed to update boss configuration:",p);const N="Failed to update boss configuration.";return l(N),{success:!1,error:N}}finally{u(!1)}},[t,a,m,L]),v=o.useCallback(n=>_().find(p=>p.index===n)||null,[_]),g=o.useCallback((n,x=null)=>_().some(N=>N.name.toLowerCase()===n.toLowerCase()&&N.index!==x),[_]);return{weeklyData:r,currentWeekStart:m,isLoading:j,error:b,setError:l,characters:_(),selectedCharacterIndex:h,setSelectedCharacterIndex:w,newCharacterName:S,setNewCharacterName:C,refreshWeeklyData:L,addCharacter:D,removeCharacter:d,updateCharacterName:i,updateCharacterBossConfig:c,getCharacterByIndex:v,characterNameExists:g,fetchWeeklyData:(n,x)=>ut(n,x),saveWeeklyData:(n,x,p)=>mt(n,x,p)}}function $t({characterBossSelections:t,bossData:a,checked:r,setChecked:s,userCode:m,appWeekKey:k}){var ne;const{lastWeeklyResetTimestamp:j}=Ee(),{refreshWeeklyData:u}=Et();function b(T,J){const se=a.find(ae=>ae.name===T);if(!se)return 0;const U=se.difficulties.find(ae=>ae.difficulty===J);return U?U.price:0}const[l,h]=o.useState(!0),[w,S]=o.useState([]),[C,L]=o.useState(0),[_,D]=o.useState(null),[d,i]=o.useState(!1),c=o.useRef(!1),[v,g]=o.useState(()=>{const T=localStorage.getItem(Se.WEEKLY_HIDE_COMPLETED);return T?JSON.parse(T):!1});o.useEffect(()=>{localStorage.setItem(Se.WEEKLY_HIDE_COMPLETED,JSON.stringify(v))},[v]),o.useEffect(()=>{if(t.length)i(!1);else{i(!1);const T=setTimeout(()=>{i(!0)},2e3);return()=>clearTimeout(T)}},[t.length]);const n=Dt(m,k,(ne=t[C])==null?void 0:ne.name),{pitchedChecked:x,setPitchedChecked:p,cloudPitchedItems:N,refreshPitchedItems:R,userInteractionRef:Z,addNewPitchedItem:W,removePitchedItemByDetails:B}=It(m||null),E=_t({userId:m,characterBossSelections:t,selectedCharIdx:C,checked:r,setChecked:s,setCrystalAnimations:S,setError:D,onDataChange:()=>{u(),R()},isHistoricalWeek:n.isHistoricalWeek,onBossUncheckStart:()=>{c.current=!0},onBossUncheckEnd:()=>{setTimeout(()=>{c.current=!1},500)}}),H=Wt(m,R);o.useEffect(()=>{m&&(f.debug("WeeklyTracker: Refreshing data on mount/user change"),R(),u())},[m,R,u]),o.useEffect(()=>{if(j>0&&m){f.debug("WeeklyTracker: Detected weekly reset, refreshing pitched items.");const T=setTimeout(()=>{R()},500);return()=>clearTimeout(T)}},[j]);const te=T=>{f.debug("WeeklyTracker: Week changed",{from:n.selectedWeekKey,to:T,isHistorical:n.isHistoricalWeek}),n.handleWeekChange(T),n.refreshHistoricalAnalysis&&n.refreshHistoricalAnalysis(),R()};o.useEffect(()=>{C>=t.length&&L(Math.max(0,t.length-1))},[t.length,C]);const y=t[C],$=`${(y==null?void 0:y.name)||""}-${C}`,K=(y==null?void 0:y.bosses)||[],P=[...K].sort((T,J)=>{try{const se=b(T.name,T.difficulty)/(T.partySize||1);return b(J.name,J.difficulty)/(J.partySize||1)-se}catch(se){return f.error("WeeklyTracker: Error sorting bosses",se),D(`Error sorting bosses: ${se.message}`),0}}),I=t.reduce((T,J,se)=>{const U=`${(J==null?void 0:J.name)||""}-${se}`;return T+(J.bosses||[]).reduce((ae,V)=>{var q;return(q=r[U])!=null&&q[V.name+"-"+V.difficulty]?ae+b(V.name,V.difficulty)/(V.partySize||1):ae},0)},0),re=t.reduce((T,J)=>T+(J.bosses||[]).reduce((se,U)=>se+b(U.name,U.difficulty)/(U.partySize||1),0),0),A=t.map((T,J)=>{const se=`${(T==null?void 0:T.name)||""}-${J}`,U=(T==null?void 0:T.bosses)||[],ae=U.filter(G=>{var F;return(F=r[se])==null?void 0:F[G.name+"-"+G.difficulty]}).length,V=U.length,q=U.reduce((G,F)=>{var O;return(O=r[se])!=null&&O[F.name+"-"+F.difficulty]?G+Math.ceil(b(F.name,F.difficulty)/(F.partySize||1)):G},0);return{name:T.name,cleared:ae,total:V,allCleared:V>0&&ae===V,left:V-ae,idx:J,totalMeso:q}}),ee=v?A.filter(T=>!T.allCleared):A,M=K.length>0,ce=async T=>{var J,se;if(!m){f.error("WeeklyTracker: No userCode available for pitched item interaction");return}if(!t.length){f.error("WeeklyTracker: No characters available");return}f.debug("WeeklyTracker: Pitched item clicked",T);try{const{bossName:U,itemName:ae,characterName:V,weekKey:q,isChecked:G,isHistorical:F,itemImage:O}=T;if(!V){f.error("WeeklyTracker: No character name provided");return}if(!t.some(z=>z.name===V)){f.error("WeeklyTracker: Character not found in character list",{characterName:V});return}if(G)await B(V,U,ae,F?De(q):null),f.info("WeeklyTracker: Pitched item removed",{characterName:V,bossName:U,itemName:ae});else{if(F){const z=(await oe(async()=>{const{getBossPitchedItems:X}=await import("./bossRegistryService-B-8C88KZ.js");return{getBossPitchedItems:X}},__vite__mapDeps([8,4,3]))).getBossPitchedItems,Y=(z(U)||[]).find(X=>X.name===ae);if(Y){const X={bossName:U,itemName:ae,itemImage:O||Y.image,weekKey:q,character:V};H.setHistoricalPitchedData(X),H.setShowHistoricalPitchedModal(!0)}return}if(await W(V,U,ae,F?De(q):null),f.info("WeeklyTracker: Pitched item added",{characterName:V,bossName:U,itemName:ae}),!F){if(c.current){f.info("WeeklyTracker: Skipping auto-check because boss unchecking is in progress");return}try{f.info("WeeklyTracker: Starting automatic boss check process",{characterName:V,bossName:U,totalCharacters:t.length,characterNames:t.map(Y=>Y.name)});const z=t.findIndex(Y=>Y.name===V),ie=t[z];if(ie&&z!==-1){const Y=ie.bosses.find(X=>X.name===U);if(Y){const X=`${ie.name}-${z}`,ue=`${Y.name}-${Y.difficulty}`,he=(J=r[X])==null?void 0:J[ue];if(f.info("WeeklyTracker: Boss check status verification",{charKey:X,bossKey:ue,isAlreadyCleared:he,shouldAutoCheck:!he}),he)f.info("WeeklyTracker: Boss already cleared, skipping auto-check",{characterName:V,bossName:Y.name});else{f.info("WeeklyTracker: Auto-checking boss since pitched item was obtained",{characterName:V,characterIndex:z,bossName:Y.name,difficulty:Y.difficulty});const{getBossRegistryId:Ne}=await oe(async()=>{const{getBossRegistryId:me}=await import("./bossCodeMapping-8KKKnROO.js");return{getBossRegistryId:me}},__vite__mapDeps([9,4,3])),{toggleBossClearStatus:Re}=await oe(async()=>{const{toggleBossClearStatus:me}=await import("./userWeeklyDataService-CzU74Ypw.js");return{toggleBossClearStatus:me}},__vite__mapDeps([6,4,3,7,0,1,2,5])),{getCurrentMapleWeekStartDate:Oe}=await oe(async()=>{const{getCurrentMapleWeekStartDate:me}=await import("./mapleWeekUtils-Bm65Nri8.js");return{getCurrentMapleWeekStartDate:me}},[]),Fe=await Ne(Y.name,Y.difficulty),Ke=Oe(),Le=await Re(m,Ke,ie.index.toString(),Fe,!0);Le.success?(s(me=>{const fe={...me};return fe[X]||(fe[X]={}),fe[X]={...fe[X]},fe[X][ue]=!0,fe}),f.info("WeeklyTracker: Auto-check boss completed successfully",{bossName:Y.name,difficulty:Y.difficulty})):f.error("WeeklyTracker: Auto-check boss failed",{error:Le.error,bossName:Y.name})}}else f.warn("WeeklyTracker: Boss not found in character configuration",{characterName:V,bossName:U,characterBosses:((se=ie.bosses)==null?void 0:se.map(X=>X.name))||[]})}else f.warn("WeeklyTracker: Character not found in character selections",{characterName:V,availableCharacters:t.map(Y=>Y.name)})}catch(z){f.error("WeeklyTracker: Failed to auto-check boss after pitched item",{error:z.message,characterName:V,bossName:U})}}S(z=>[...z,{id:Date.now()+Math.random(),image:O||"/images/pitched-items/test-crystal.png",bossName:U,itemName:ae,characterName:V,startPosition:{x:50,y:50},endPosition:{x:window.innerWidth-100,y:100}}])}}catch(U){f.error("WeeklyTracker: Error handling pitched item click",U)}};return _?e.jsxs("div",{className:"weekly-tracker-error",children:[e.jsx("div",{className:"weekly-tracker-error-message",children:_}),e.jsx("button",{onClick:()=>D(null),children:"Try Again"})]}):t.length?e.jsxs("div",{className:"weekly-tracker",children:[w.length>0&&w.map(T=>e.jsx(ft,{startPosition:T.startPosition,endPosition:T.endPosition,onComplete:()=>S(J=>J.filter(se=>se.id!==T.id))},T.id)),e.jsxs("div",{className:"weekly-tracker-container",children:[e.jsx(gt,{sidebarVisible:l,setSidebarVisible:h,isHistoricalWeek:n.isHistoricalWeek,totalMeso:I,obtainableMeso:re,selectedWeekKey:n.selectedWeekKey,hideCompleted:v,setHideCompleted:g,visibleCharSummaries:ee,selectedCharIdx:C,setSelectedCharIdx:L,setPurgeTargetCharacter:H.setPurgeTargetCharacter,setShowCharacterPurgeConfirm:H.setShowCharacterPurgeConfirm,setShowCharacterPitchedModal:H.setShowCharacterPitchedModal,onShowTreasureAnalytics:()=>H.setShowStats(!0),characterBossSelections:t}),e.jsx(pt,{sidebarVisible:l,setSidebarVisible:h}),e.jsx("div",{className:"weekly-tracker-main fade-in",children:e.jsxs("div",{className:"weekly-tracker-content",children:[e.jsx("div",{className:"weekly-tracker-header",children:e.jsx("h2",{className:"weekly-tracker-title",children:n.isHistoricalWeek?"Historical Week View":"Weekly Boss Tracker"})}),e.jsx("div",{className:"weekly-tracker-navigator-wrapper",children:e.jsx(ht,{appWeekKey:k,selectedWeekKey:n.selectedWeekKey,onWeekChange:te,isHistoricalWeek:n.isHistoricalWeek,historicalAnalysis:n.historicalAnalysis})}),M&&e.jsx(e.Fragment,{children:n.isHistoricalWeek?e.jsx(xt,{bossData:a,characterKey:$,selectedWeekKey:n.selectedWeekKey,selectedCharIdx:C,pitchedChecked:x,onPitchedItemClick:ce,userCode:m,cloudPitchedItems:N,characterBossSelections:t}):e.jsx(kt,{bosses:P,bossData:a,checked:r,characterKey:$,onBossCheck:E.handleCheck,getBossPrice:b,showTickAll:!0,onTickAll:E.handleTickAll,allTicked:K.every(T=>{var J;return(J=r[$])==null?void 0:J[T.name+"-"+T.difficulty]})&&K.length>0,pitchedChecked:x,onPitchedItemClick:ce,isHistoricalWeek:!1,userCode:m,selectedWeekKey:n.selectedWeekKey,selectedCharIdx:C,userInteractionRef:Z,cloudPitchedItems:N,characterBossSelections:t})})]})}),e.jsx(St,{statsManagement:H,weekNavigation:n,pitchedChecked:x,setPitchedChecked:p,userInteractionRef:Z,setError:D,characterBossSelections:t,selectedCharIdx:C,cloudPitchedItems:N})]})]}):e.jsx("div",{className:"weekly-tracker-no-characters",children:e.jsx("div",{className:`weekly-tracker-no-characters-message ${d?"visible":""}`,children:"No characters found. Go back and add a character first."})})}function Yt(){const{navigate:t}=qe(),{userCode:a,isLoggedIn:r,handleDeleteAccount:s}=We(),{characterBossSelections:m,checked:k,setChecked:j,fullUserData:u,weekKey:b,preservingCheckedStateRef:l,sortedBossData:h,isLoading:w,hasDataLoaded:S}=Ee(),[C,L]=o.useState(!1),[_,D]=o.useState(!1),[d,i]=o.useState(""),[c,v]=o.useState(!1);if(!r)return t("/login",{replace:!0}),null;const g=async()=>{v(!0),i("");try{const n=await s();n.success?(D(!1),t("/login",{replace:!0})):i(n.error)}catch(n){i("Failed to delete account. Try again."),console.error("Delete error:",n)}finally{v(!1)}};return w||!S?e.jsxs("div",{className:"page-container",children:[e.jsx(Ie,{currentPage:"weeklytracker",onShowHelp:()=>L(!0),onShowDeleteConfirm:()=>D(!0)}),e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh",color:"#e6e0ff",fontSize:"1.2rem"},children:"Loading data..."})]}):e.jsxs("div",{className:"page-container",children:[e.jsx(Ie,{currentPage:"weeklytracker",onShowHelp:()=>L(!0),onShowDeleteConfirm:()=>D(!0)}),e.jsx(Ue,{children:e.jsx($t,{characterBossSelections:m,bossData:h,checked:k,setChecked:j,userCode:a,fullUserData:u,appWeekKey:b,preservingCheckedStateRef:l})}),e.jsx(Ve,{showHelp:C,onClose:()=>L(!1),children:e.jsx(Ze,{})}),e.jsx(Je,{showDeleteConfirm:_,onClose:()=>D(!1),onConfirm:g,showDeleteLoading:c,deleteError:d})]})}export{Yt as default};
