const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DUEHxnI6.js","assets/vendor-ui-aK89YfOw.js","assets/vendor-router-Cg8TMqY4.js","assets/vendor-react-eWEExxYH.js","assets/vendor-supabase-B7S7y5aO.js","assets/index-RHCjBdfQ.css"])))=>i.map(i=>d[i]);
import{_ as v}from"./vendor-supabase-B7S7y5aO.js";import{s as p,c as A,l as S}from"./index-DUEHxnI6.js";import"./vendor-react-eWEExxYH.js";import"./vendor-ui-aK89YfOw.js";import"./vendor-router-Cg8TMqY4.js";async function U(t){try{if(!t)return console.log("No user code provided for getHistoricalWeekAnalysis"),{success:!1,error:"No user code provided"};const{getCurrentWeekKey:e}=await v(async()=>{const{getCurrentWeekKey:d}=await import("./index-DUEHxnI6.js").then(u=>u.w);return{getCurrentWeekKey:d}},__vite__mapDeps([0,1,2,3,4,5])),i=e(),c=new Set,{data:a,error:o}=await p.from("user_boss_data").select("maple_week_start, weekly_clears").eq("user_id",t);if(o&&o.code!=="PGRST116")return console.error("Error fetching user_boss_data for historical analysis:",o),{success:!1,error:o.message};const{data:s,error:n}=await p.from("user_data").select("pitched_items").eq("id",t).single();n&&n.code!=="PGRST116"&&console.error("Error fetching user_data for historical analysis:",n),s!=null&&s.pitched_items&&Array.isArray(s.pitched_items)&&s.pitched_items.forEach(d=>{if(d.date){const u=A(d.date);u&&u!==i&&c.add(u)}}),a&&Array.isArray(a)&&a.forEach(d=>{if(d.maple_week_start&&d.weekly_clears&&Object.keys(d.weekly_clears).length>0){const u=A(d.maple_week_start);u&&u!==i&&c.add(u)}});const r=Array.from(c).sort((d,u)=>{const w=g=>{const h=g.split("-");return h.length===2?{year:parseInt(h[0]),week:parseInt(h[1])}:h.length===3?{year:parseInt(h[0]),week:parseInt(h[1])}:{year:0,week:0}},k=w(d),l=w(u);return k.year!==l.year?k.year-l.year:k.week-l.week}),_=r.length>0;let f=null,y="new",m=8;if(_){f=r[0];const{getWeekOffset:d}=await v(async()=>{const{getWeekOffset:k}=await import("./index-DUEHxnI6.js").then(l=>l.w);return{getWeekOffset:k}},__vite__mapDeps([0,1,2,3,4,5])),u=d(f),w=Math.abs(u);w>8&&(y="existing",m=w)}return{success:!0,hasHistoricalData:_,oldestHistoricalWeek:f,historicalWeeks:r,totalHistoricalWeeks:r.length,userType:y,adaptiveWeekLimit:m,currentWeek:i,analysis:{pitchedItemsCount:s!=null&&s.pitched_items?s.pitched_items.length:0,userBossDataCount:a?a.length:0,weeksWithData:r.length+1}}}catch(e){return console.error("Error in getHistoricalWeekAnalysis:",e),{success:!1,error:e.message}}}async function V(t,e){var i;try{if(!t||!e)return console.log("No user code or character name provided for character-specific getHistoricalWeekAnalysis"),{success:!1,error:"No user code or character name provided"};const{getCurrentWeekKey:c}=await v(async()=>{const{getCurrentWeekKey:l}=await import("./index-DUEHxnI6.js").then(g=>g.w);return{getCurrentWeekKey:l}},__vite__mapDeps([0,1,2,3,4,5])),a=c(),o=new Set,{data:s,error:n}=await p.from("user_boss_data").select("maple_week_start, weekly_clears").eq("user_id",t);if(n&&n.code!=="PGRST116")return console.error("Error fetching user_boss_data for character historical analysis:",n),{success:!1,error:n.message};const{data:r,error:_}=await p.from("user_data").select("pitched_items").eq("id",t).single();_&&_.code!=="PGRST116"&&console.error("Error fetching user_data for character historical analysis:",_),r!=null&&r.pitched_items&&Array.isArray(r.pitched_items)&&r.pitched_items.filter(l=>l.charId===e).forEach(l=>{if(l.date){const g=A(l.date);g&&g!==a&&o.add(g)}}),s&&Array.isArray(s)&&s.forEach(l=>{if(l.maple_week_start&&l.weekly_clears&&Object.keys(l.weekly_clears).length>0&&Object.keys(l.weekly_clears).some(h=>h.includes(e))){const h=A(l.maple_week_start);h&&h!==a&&o.add(h)}});const f=Array.from(o).sort((l,g)=>{const h=b=>{const E=b.split("-");return E.length===2?{year:parseInt(E[0]),week:parseInt(E[1])}:E.length===3?{year:parseInt(E[0]),week:parseInt(E[1])}:{year:0,week:0}},I=h(l),W=h(g);return I.year!==W.year?I.year-W.year:I.week-W.week}),y=f.length>0;let m=null,d="new",u=8;if(y){m=f[0];const{getWeekOffset:l}=await v(async()=>{const{getWeekOffset:I}=await import("./index-DUEHxnI6.js").then(W=>W.w);return{getWeekOffset:I}},__vite__mapDeps([0,1,2,3,4,5])),g=l(m),h=Math.abs(g);h>8&&(d="existing",u=h)}const w=((i=r==null?void 0:r.pitched_items)==null?void 0:i.filter(l=>l.charId===e))||[],k=(s==null?void 0:s.filter(l=>l.weekly_clears&&Object.keys(l.weekly_clears).some(g=>g.includes(e))))||[];return{success:!0,hasHistoricalData:y,oldestHistoricalWeek:m,historicalWeeks:f,totalHistoricalWeeks:f.length,userType:d,adaptiveWeekLimit:u,currentWeek:a,characterName:e,analysis:{pitchedItemsCount:w.length,userBossDataCount:k.length,weeksWithData:f.length+1}}}catch(c){return console.error("Error in getCharacterHistoricalWeekAnalysis:",c),{success:!1,error:c.message}}}function L(t,e,i,c){const a={...t};return Object.keys(a).forEach(o=>{o.startsWith(`${e}-${i}__`)&&o.endsWith(`__${c}`)&&delete a[o]}),a}async function B(t){var e;try{if(!t)return{success:!1,error:"User code is required"};const{data:i,error:c}=await p.from("user_data").select("data").eq("id",t).single();if(c)throw console.error("Error fetching audit history:",c),c;const o=(((e=i.data)==null?void 0:e.pitched_reset_history)||[]).sort((s,n)=>new Date(n.timestamp)-new Date(s.timestamp));return{success:!0,history:o,totalResets:o.length}}catch(i){return console.error("Error getting pitched reset audit history:",i),{success:!1,error:i.message||"Unknown error occurred"}}}async function F(t){try{if(!t)return console.error("Missing required field: userCode"),{success:!1,error:"Missing required field: userCode"};let e=0,i=0;const{data:c,error:a}=await p.from("user_data").select("data, pitched_items").eq("id",t).single();if(a&&a.code!=="PGRST116")throw console.error("Error fetching user data:",a),a;if(c){const n=c.data||{};e=(c.pitched_items||[]).length;const _=new Date().toISOString(),f={timestamp:_,action:"complete_stats_reset",itemsRemoved:e,userAgent:typeof navigator<"u"?navigator.userAgent:"Server"},y={...n,lastUpdated:_,pitched_reset_history:[...n.pitched_reset_history||[],f].slice(-50)};await p.from("user_data").update({pitched_items:[],data:y}).eq("id",t)}const{data:o,error:s}=await p.from("user_boss_data").select("id").eq("user_id",t);if(s&&s.code!=="PGRST116")console.warn("Error fetching user_boss_data:",s);else if(o&&o.length>0){i=o.length;const{error:n}=await p.from("user_boss_data").delete().eq("user_id",t);if(n)throw console.error("Error clearing user_boss_data:",n),n}return{success:!0,itemsRemoved:e,userBossDataRemoved:i,totalEntriesRemoved:e+i}}catch(e){return console.error("Error in complete stats reset:",e),{success:!1,error:e.message||"Unknown error occurred"}}}async function G(t,e,i){try{if(!t||!e)return{success:!1,error:"Missing required parameters"};const c=await P(),{data:a,error:o}=await c.from("user_data").select("pitched_items").eq("id",t).single();if(o&&o.code!=="PGRST116")throw o;const s=(a==null?void 0:a.pitched_items)||[],n=s.filter(_=>_.charId!==e),r=s.length-n.length;return await c.from("user_data").update({pitched_items:n}).eq("id",t),{success:!0,removedCount:r,message:`Removed ${r} pitched items for character ${e}`}}catch(c){return S.error("Error purging pitched records:",c),{success:!1,error:c.message||"Unknown error occurred"}}}async function K(t){var e,i,c,a,o;try{console.log(`[Export] Starting export for user '${t}'`);const{data:s,error:n}=await p.from("user_boss_data").select("user_id, maple_week_start, char_map, boss_config, weekly_clears, created_at").eq("user_id",t).order("maple_week_start",{ascending:!1});if(n&&n.code!=="PGRST116")throw console.error("[Export] Error fetching user_boss_data:",n),n;console.log(`[Export] Found ${(s==null?void 0:s.length)||0} user_boss_data records`),console.log("[Export] Fetching user_data for pitched items...");const{data:r,error:_}=await p.from("user_data").select("pitched_items, data").eq("id",t).single();_?(console.error("[Export] Error fetching user_data:",_),_.code!=="PGRST116"?console.warn("[Export] Could not fetch user data:",_):console.warn("[Export] No user_data record found for user:",t)):(console.log("[Export] Found user_data record"),console.log("[Export] Pitched items found:",((e=r==null?void 0:r.pitched_items)==null?void 0:e.length)||0),console.log("[Export] Sample pitched items:",(i=r==null?void 0:r.pitched_items)==null?void 0:i.slice(0,3)));const f=(s||[]).map(u=>({maple_week_start:u.maple_week_start,char_map:u.char_map||{},boss_config:u.boss_config||{},weekly_clears:{},created_at:u.created_at})),y=((c=r==null?void 0:r.data)==null?void 0:c.characters)||[],m=(r==null?void 0:r.pitched_items)||[];console.log(`[Export] Final pitched items count: ${m.length}`);const d={user_boss_data:f,pitched_items:m,exportDate:new Date().toISOString(),dataVersion:"4.0",originalUserCode:t,characterCount:y.length,stats:{totalWeeksOfData:f.length,totalPitchedItems:m.length,weekRange:f.length>0?{earliest:(a=f[f.length-1])==null?void 0:a.maple_week_start,latest:(o=f[0])==null?void 0:o.maple_week_start}:null}};return console.log(`[Export] Successfully exported complete backup for user '${t}'`,{characterCount:d.characterCount,weeksOfData:d.stats.totalWeeksOfData,pitchedItems:d.stats.totalPitchedItems,note:"Data can be imported to any account"}),{success:!0,data:d}}catch(s){return console.error("Error exporting user data:",s),{success:!1,error:s.message||"Export failed"}}}async function M(t,e){try{if(!e||typeof e!="object")throw new Error("Invalid import object");if(console.log(`[Import] Starting data restoration for user '${t}'`,{dataVersion:e.dataVersion,hasUserBossData:!!e.user_boss_data,hasPitchedItems:!!e.pitched_items}),e.dataVersion==="4.0")return await D(t,e);if(e.dataVersion==="3.0")return await R(t,e);throw new Error(`Unsupported data format version: ${e.dataVersion||"unknown"}. Please export from a newer version.`)}catch(i){return console.error("Error importing user data:",i),{success:!1,error:i.message||"Import failed"}}}async function D(t,e){var i,c;try{const a=e.originalUserCode||"unknown",o=a!==t;if(console.log("[Import v4.0] Starting data restoration",{importingToUser:t,originalUser:a,transferringAccounts:o,weeksOfData:((i=e.user_boss_data)==null?void 0:i.length)||0,pitchedItems:((c=e.pitched_items)==null?void 0:c.length)||0}),!e.user_boss_data||!Array.isArray(e.user_boss_data))throw new Error("Invalid backup format: Missing or invalid user_boss_data");const s=e.user_boss_data.map(r=>({user_id:t,maple_week_start:r.maple_week_start,char_map:r.char_map||{},boss_config:r.boss_config||{},weekly_clears:{},created_at:r.created_at||new Date().toISOString()}));if(s.length>0){const{error:r}=await p.from("user_boss_data").delete().eq("user_id",t);if(r)throw new Error(`Failed to clear existing data: ${r.message}`);const{error:_}=await p.from("user_boss_data").insert(s);if(_)throw new Error(`Failed to restore boss data: ${_.message}`);console.log(`[Import v4.0] Restored ${s.length} weeks of boss data to user '${t}'`)}if(e.pitched_items&&Array.isArray(e.pitched_items)){const{error:r}=await p.from("user_data").upsert({id:t,pitched_items:e.pitched_items,updated_at:new Date().toISOString()});r?console.warn("Failed to restore pitched items:",r):console.log(`[Import v4.0] Restored ${e.pitched_items.length} pitched items to user '${t}'`)}const n=o?` (transferred from account '${a}')`:"";return console.log(`[Import v4.0] Successfully completed full data restoration for user '${t}'${n}`),{success:!0,message:o?`Successfully transferred ${s.length} weeks of data and ${(e.pitched_items||[]).length} pitched items from account '${a}' to '${t}'`:`Successfully restored ${s.length} weeks of data and ${(e.pitched_items||[]).length} pitched items`}}catch(a){throw console.error("[Import v4.0] Error during import:",a),a}}async function R(t,e){const{user_boss_data:i,pitched_items:c}=e;if(console.log("[Import v3.0] Importing legacy format"),await p.from("user_boss_data").delete().eq("user_id",t),i&&Array.isArray(i)&&i.length>0){const a=i.map(o=>({...o,user_id:t,weekly_clears:{}}));await p.from("user_boss_data").insert(a)}if(c&&Array.isArray(c)){const a=c.filter(o=>o&&typeof o=="object"&&o.charId&&o.item&&o.date);await p.from("user_data").upsert({id:t,pitched_items:a})}return console.log(`[Import v3.0] Successfully imported legacy data for user '${t}'`),{success:!0,message:"Legacy data imported successfully"}}async function P(){const{supabase:t}=await v(async()=>{const{supabase:e}=await import("./index-DUEHxnI6.js").then(i=>i.m);return{supabase:e}},__vite__mapDeps([0,1,2,3,4,5]));return t}export{L as clearCharacterPitchedUI,K as exportUserData,V as getCharacterHistoricalWeekAnalysis,U as getHistoricalWeekAnalysis,B as getPitchedResetAuditHistory,M as importUserData,F as purgeAllStatsData,G as purgePitchedRecords};
