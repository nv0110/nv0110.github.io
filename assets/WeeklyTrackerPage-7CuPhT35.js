const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/supabaseClient-DawR2l69.js","assets/vendor-supabase-_v2quReu.js","assets/vendor-react-D5d5vywP.js","assets/pitched-data-service-DmmTGQCG.js","assets/weekUtils-BAOLi04i.js","assets/index-ChaJcBVv.js","assets/vendor-ui-Dn8u3Dbm.js","assets/vendor-router-CSXoLnNI.js","assets/index-BwTbnssP.css"])))=>i.map(i=>d[i]);
import{j as e}from"./vendor-ui-Dn8u3Dbm.js";import{r as o,c as fe,d as pe}from"./vendor-router-CSXoLnNI.js";import{u as he,M as ge,S as oe,a as xe,V as ke,b as je}from"./index-ChaJcBVv.js";import{u as ye,N as be}from"./Navbar-DvaP8SwN.js";import{_ as A}from"./vendor-supabase-_v2quReu.js";import{getAllPitchedItems as ve,getHistoricalWeekAnalysis as ce,getAvailableWeeks as we,removeManyPitchedItems as ae,getYearlyPitchedStats as le,purgeAllStatsData as Ne,clearCharacterPitchedUI as Se,purgePitchedRecords as Ce,getPitchedResetAuditHistory as Le,savePitchedItem as de}from"./pitched-data-service-DmmTGQCG.js";import{getCurrentWeekKey as Q,getWeekOffset as We,getWeekKeyOffset as te,parseWeekKey as De,getWeekDateRange as me,getWeekLabel as Pe,getCurrentYearKey as se}from"./weekUtils-BAOLi04i.js";import{C as Te}from"./CustomCheckbox-DjnElLTC.js";import"./vendor-react-D5d5vywP.js";function X(t){if(t===0)return"0";if(t<1e9){const r=t/1e6;if(r<1){const c=t/1e3;return c<1?t.toString():`${c.toFixed(1)}K`}return`${r.toFixed(1)}M`}return`${(t/1e9).toFixed(1)}B`}function Ie({selectedWeekKey:t,onWeekChange:a,characterBossSelections:r=[],checked:c={},selectedCharIdx:l=0,totalMeso:L=0,obtainableMeso:T=0,historicalAnalysis:d={hasHistoricalData:!1,oldestHistoricalWeek:null,userType:"new",adaptiveWeekLimit:8},charSummaries:$}){const y=Q(),h=o.useMemo(()=>{const b=(d==null?void 0:d.adaptiveWeekLimit)||8;return{min:-b,max:0,current:0,adaptiveLimit:b}},[d]),w=We(t),W=o.useCallback(i=>{i!==t&&a(i)},[t,a]),N=()=>{const i=w-1;if(i>=h.min){const b=te(i);W(b)}},g=()=>{const i=w+1;if(i<=h.max){const b=te(i);W(b)}},S=o.useCallback(()=>{if(console.log("ðŸ” goToOldestOrFallback called with analysis:",{hasHistoricalData:d==null?void 0:d.hasHistoricalData,oldestHistoricalWeek:d==null?void 0:d.oldestHistoricalWeek,userType:d==null?void 0:d.userType,adaptiveLimit:h.adaptiveLimit}),d!=null&&d.hasHistoricalData&&(d!=null&&d.oldestHistoricalWeek))console.log(`ðŸŽ¯ Jumping to oldest historical data: ${d.oldestHistoricalWeek} (${d.userType} user)`),W(d.oldestHistoricalWeek);else{const i=te(-h.adaptiveLimit);console.log(`ðŸŽ¯ No historical data found, jumping to ${h.adaptiveLimit} weeks back: ${i}`),W(i)}},[d,h.adaptiveLimit,W]),_=()=>{W(y)},I=()=>{d!=null&&d.hasHistoricalData&&(d!=null&&d.oldestHistoricalWeek)&&W(d.oldestHistoricalWeek)},B=w>h.min,k=w<h.max,P=(d==null?void 0:d.hasHistoricalData)||w>-h.adaptiveLimit,f=t===y,j=d==null?void 0:d.hasHistoricalData,n=o.useMemo(()=>{const i=De(t),b=me(t);return{label:Pe(t),parsed:i,dateRange:b,isCurrentWeek:f,offset:w}},[t,f,w]),s=r[l],x=(s==null?void 0:s.bosses)||[],v=`${(s==null?void 0:s.name)||""}-${l}`;x.filter(i=>{var b;return(b=c[v])==null?void 0:b[`${i.name}-${i.difficulty}`]}).length,x.length;let m=0;s&&(m=x.reduce((i,b)=>{const K=b.price||0,u=b.partySize||1;return i+Math.ceil(K/u)},0));let C=0;return s&&(C=x.reduce((i,b)=>{var u;const K=`${b.name}-${b.difficulty}`;if((u=c[v])!=null&&u[K]){const M=b.price||0,H=b.partySize||1;return i+Math.ceil(M/H)}return i},0)),e.jsxs("div",{className:"week-navigator-container",children:[e.jsx("div",{className:"week-navigator-header",children:e.jsxs("div",{className:`week-navigator-title ${f?"current-week":"historical-week"}`,children:[e.jsx("span",{className:"week-title-text",children:n.label.replace(/\s*\(Current\)/i,"")}),f&&e.jsx("span",{className:"week-navigator-current-dot",children:e.jsx("span",{className:"week-navigator-current-dot-inner"})})]})}),e.jsxs("div",{className:"week-navigator-navigation",children:[e.jsx("div",{className:"week-navigator-arrow-container",children:e.jsx("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",onClick:B?N:void 0,className:`week-navigator-arrow arrow-left ${B?"enabled":"disabled"}`,title:B?"Previous Week":`Already at oldest week (${h.adaptiveLimit} weeks back)`,children:e.jsx("path",{d:"M20.3284 11.0001V13.0001L7.50011 13.0001L10.7426 16.2426L9.32842 17.6568L3.67157 12L9.32842 6.34314L10.7426 7.75735L7.49988 11.0001L20.3284 11.0001Z",fill:"currentColor"})})}),n.dateRange&&e.jsxs("div",{className:"week-navigator-date-range",children:[n.dateRange.start.toLocaleDateString()," - ",n.dateRange.end.toLocaleDateString()]}),e.jsx("div",{className:"week-navigator-arrow-container",children:e.jsx("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",onClick:f?P?S:void 0:k?g:void 0,className:`week-navigator-arrow arrow-right ${(f?P:k)?"enabled":"disabled"}`,title:f?P?d!=null&&d.hasHistoricalData?`Jump to oldest data (${d==null?void 0:d.oldestHistoricalWeek})`:`Jump to ${h.adaptiveLimit} weeks back`:"No historical data available":k?"Next Week":"Already at current week",children:e.jsx("path",{d:"M15.0378 6.34317L13.6269 7.76069L16.8972 11.0157L3.29211 11.0293L3.29413 13.0293L16.8619 13.0157L13.6467 16.2459L15.0643 17.6568L20.7079 11.9868L15.0378 6.34317Z",fill:"currentColor"})})})]}),e.jsx("div",{className:"week-navigator-content",children:f&&e.jsx("div",{className:"week-navigator-progress",children:e.jsxs("div",{className:"week-navigator-progress-meso",children:[e.jsx("div",{className:"sidebar-progress-track week-navigator-progress-bar-container",children:e.jsx("div",{className:"sidebar-progress-fill week-navigator-progress-bar",style:{width:`${m>0?Math.min(C/m*100,100):0}%`},children:m>0&&C>0&&e.jsx("div",{className:"week-navigator-progress-shimmer"})})}),e.jsxs("div",{className:"sidebar-progress-numbers",children:[e.jsx("span",{children:X(C)}),e.jsx("span",{children:X(m)})]})]})})}),e.jsx("div",{className:"week-navigator-buttons",children:f?e.jsx("div",{className:"week-navigator-spacer"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:_,className:"week-navigator-button current-week-btn",title:"Jump to current week",children:"Current Week"}),j&&e.jsx("button",{onClick:I,className:"week-navigator-button oldest-data-btn",title:`Jump to oldest data (${d.oldestHistoricalWeek})`,children:"Oldest Data"})]})})]},t)}function Me({data:t,characterBossSelections:a,onClose:r,onConfirm:c}){const[l,L]=o.useState(""),[T,d]=o.useState(""),[$,y]=o.useState(!1),h=o.useMemo(()=>t.weekKey?me(t.weekKey):{start:null,end:null},[t.weekKey]),w=o.useCallback(g=>g.toISOString().split("T")[0],[]),W=o.useMemo(()=>{if(!h.start||!h.end)return[];const g=[],S=new Date(h.start),_=new Date(h.end);for(;S<=_;)g.push(new Date(S)),S.setDate(S.getDate()+1);return g},[h]);o.useEffect(()=>{W.length>0&&!l&&L(w(W[0])),a.length>0&&!T&&d(a[0].name)},[W,l,a,T,w]);const N=async()=>{if(!l||!T)return;y(!0);const g=new Date(l+"T12:00:00.000Z").toISOString();await c(g,T),y(!1)};return e.jsxs("div",{className:"historical-modal-container",onClick:g=>g.stopPropagation(),children:[e.jsx("div",{className:"historical-modal-header",children:e.jsx("img",{src:t.itemImage,alt:t.itemName,className:"historical-modal-header-image"})}),e.jsx("h2",{className:"historical-modal-title",children:"Log Historical Pitched Item"}),e.jsxs("div",{className:"historical-modal-info-box",children:[e.jsxs("div",{className:"historical-modal-info-item",children:[e.jsx("span",{className:"historical-modal-info-label",children:"Character:"})," ",T||t.character]}),e.jsxs("div",{className:"historical-modal-info-item",children:[e.jsx("span",{className:"historical-modal-info-label",children:"Boss:"})," ",t.bossName]}),e.jsxs("div",{className:"historical-modal-info-item",children:[e.jsx("span",{className:"historical-modal-info-label",children:"Item:"})," ",t.itemName]}),e.jsxs("div",{className:"historical-modal-info-item",children:[e.jsx("span",{className:"historical-modal-info-label",children:"Week:"})," ",t.weekKey]})]}),e.jsxs("div",{className:"historical-modal-form-section",children:[e.jsx("label",{className:"historical-modal-label",children:"Select Character:"}),e.jsx("select",{value:T,onChange:g=>d(g.target.value),className:"historical-modal-select",children:a.map(g=>e.jsx("option",{value:g.name,children:g.name},g.name))})]}),e.jsxs("div",{className:"historical-modal-form-section",children:[e.jsx("label",{className:"historical-modal-label",children:"Select Date:"}),e.jsx("input",{type:"date",value:l,onChange:g=>L(g.target.value),min:h.start?w(h.start):"",max:h.end?w(h.end):"",className:"historical-modal-date-input"}),h.start&&h.end&&e.jsxs("div",{className:"historical-modal-helper-text",children:["Valid range: ",w(h.start)," to ",w(h.end)]})]}),e.jsxs("div",{className:"historical-modal-buttons",children:[e.jsx("button",{onClick:r,disabled:$,className:"historical-modal-button historical-modal-button-cancel",children:"Cancel"}),e.jsxs("button",{onClick:N,disabled:$||!l||!T,className:"historical-modal-button historical-modal-button-confirm",children:[$&&e.jsx("div",{className:"historical-modal-spinner"}),$?"Logging...":"Log Item"]})]})]})}function $e({startPosition:t,endPosition:a,onComplete:r}){const[c,l]=o.useState(t),[L,T]=o.useState(1);return o.useEffect(()=>{const d=Date.now(),$=1e3,y=()=>{const h=Date.now()-d,w=Math.min(h/$,1),W=1-Math.pow(1-w,3),N=t.x+(a.x-t.x)*W,g=t.y+(a.y-t.y)*W;l({x:N,y:g}),T(1-w),w<1?requestAnimationFrame(y):r()};requestAnimationFrame(y)},[t,a,r]),e.jsx("div",{style:{position:"fixed",left:c.x,top:c.y,transform:"translate(-50%, -50%)",opacity:L,pointerEvents:"none",zIndex:1e3,transition:"transform 0.1s ease"},children:e.jsx("img",{src:"/bosses/crystal.png",alt:"Crystal",style:{width:24,height:24,transform:`rotate(${c.x*.1}deg)`,filter:"drop-shadow(0 0 4px rgba(162, 89, 247, 0.6))"}})})}function Re(t){const a=new Map;return t.forEach(r=>{const c=r.item+"|"+r.image;if(!a.has(c))a.set(c,{...r,count:1,history:[r]});else{const l=a.get(c);l.count+=1,l.history.push(r)}}),Array.from(a.values()).sort((r,c)=>c.count-r.count||r.item.localeCompare(c.item))}function He(t){const a=new Date(t),r=a.getFullYear(),l=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a.getMonth()],L=a.getDate();return{year:r,month:l,day:L,fullDate:`${l} ${L}, ${r}`}}function Ee({item:t,onClose:a}){const r=o.useRef(null);return o.useEffect(()=>{function c(l){r.current&&!r.current.contains(l.target)&&a()}return document.addEventListener("mousedown",c),()=>{document.removeEventListener("mousedown",c)}},[a]),o.useEffect(()=>{const c=setTimeout(()=>{r.current&&r.current.classList.add("pitched-details-modal-visible")},10);return()=>clearTimeout(c)},[]),fe.createPortal(e.jsx("div",{className:"pitched-details-modal-backdrop",children:e.jsxs("div",{className:"pitched-details-modal",ref:r,children:[e.jsxs("div",{className:"pitched-details-modal-header",children:[e.jsxs("div",{className:"pitched-details-modal-item-showcase",children:[e.jsx("img",{src:t.image,alt:t.item,className:"pitched-details-modal-item-img"}),e.jsxs("div",{className:"pitched-details-modal-item-info",children:[e.jsx("h2",{className:"pitched-details-modal-title",children:t.item}),e.jsxs("div",{className:"pitched-details-modal-subtitle",children:[e.jsxs("span",{className:"pitched-details-modal-count",children:[t.count,"x"]}),e.jsx("span",{className:"pitched-details-modal-acquired",children:"Acquired"})]})]})]}),e.jsx("button",{className:"pitched-details-modal-close",onClick:a,"aria-label":"Close details",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"detailsCloseGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#a259f7"}),e.jsx("stop",{offset:"1",stopColor:"#805ad5"})]})}),e.jsx("path",{d:"M6.2253 4.81108C5.83477 4.42056 5.20161 4.42056 4.81108 4.81108C4.42056 5.20161 4.42056 5.83477 4.81108 6.2253L10.5858 12L4.81114 17.7747C4.42062 18.1652 4.42062 18.7984 4.81114 19.1889C5.20167 19.5794 5.83483 19.5794 6.22535 19.1889L12 13.4142L17.7747 19.1889C18.1652 19.5794 18.7984 19.5794 19.1889 19.1889C19.5794 18.7984 19.5794 18.1652 19.1889 17.7747L13.4142 12L19.189 6.2253C19.5795 5.83477 19.5795 5.20161 19.189 4.81108C18.7985 4.42056 18.1653 4.42056 17.7748 4.81108L12 10.5858L6.2253 4.81108Z",fill:"url(#detailsCloseGradient)"})]})})]}),e.jsx("div",{className:"pitched-details-modal-content",children:e.jsxs("div",{className:"pitched-details-acquisition",children:[e.jsxs("div",{className:"pitched-details-section-header",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M12 2V6",stroke:"#a259f7",strokeWidth:"2",strokeLinecap:"round"}),e.jsx("path",{d:"M12 18V22",stroke:"#a259f7",strokeWidth:"2",strokeLinecap:"round"}),e.jsx("path",{d:"M4.92999 4.93L7.75999 7.76",stroke:"#a259f7",strokeWidth:"2",strokeLinecap:"round"}),e.jsx("path",{d:"M16.24 16.24L19.07 19.07",stroke:"#a259f7",strokeWidth:"2",strokeLinecap:"round"}),e.jsx("path",{d:"M2 12H6",stroke:"#a259f7",strokeWidth:"2",strokeLinecap:"round"}),e.jsx("path",{d:"M18 12H22",stroke:"#a259f7",strokeWidth:"2",strokeLinecap:"round"}),e.jsx("path",{d:"M4.92999 19.07L7.75999 16.24",stroke:"#a259f7",strokeWidth:"2",strokeLinecap:"round"}),e.jsx("path",{d:"M16.24 7.76L19.07 4.93",stroke:"#a259f7",strokeWidth:"2",strokeLinecap:"round"})]}),e.jsx("h3",{children:"Acquisition History"})]}),e.jsx("div",{className:"pitched-details-table-container",children:e.jsxs("table",{className:"pitched-details-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Year"}),e.jsx("th",{children:"Month"}),e.jsx("th",{children:"Day"})]})}),e.jsx("tbody",{children:t.history.sort((c,l)=>new Date(l.date)-new Date(c.date)).map((c,l)=>{const L=He(c.date);return e.jsxs("tr",{className:`pitched-details-row ${l%2===0?"even-row":"odd-row"}`,children:[e.jsx("td",{className:"pitched-details-year",title:L.fullDate,children:e.jsx("div",{className:"date-value",children:L.year})}),e.jsx("td",{className:"pitched-details-month",children:e.jsx("div",{className:"date-value",children:L.month})}),e.jsx("td",{className:"pitched-details-day",children:e.jsx("div",{className:"date-value",children:L.day})})]},l)})})]})})]})})]})}),document.body)}function _e({isOpen:t,onClose:a,characterName:r,pitchedItems:c}){const[l,L]=o.useState(null),[T,d]=o.useState(!1),[$,y]=o.useState(!1),[h,w]=o.useState(!1),W=o.useRef(null),N=o.useRef(null);o.useRef(null),o.useRef(null),o.useRef(!1);const g=()=>{const I=W.current;if(I){const B=I.scrollWidth>I.clientWidth,k=I.scrollLeft<=5,P=I.scrollLeft+I.clientWidth>=I.scrollWidth-5;d(B&&!k&&!h),y(B&&!P&&!h)}},S=()=>{w(!0),d(!1),y(!1),N.current&&clearTimeout(N.current),N.current=setTimeout(()=>{w(!1),g()},1e3)};if(o.useEffect(()=>{if(t){const I=W.current;if(I)return I.addEventListener("scroll",S),setTimeout(g,300),()=>{I.removeEventListener("scroll",S),N.current&&clearTimeout(N.current)}}},[t]),o.useEffect(()=>{if(t){const I=window.getComputedStyle(document.body).overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=I}}},[t]),!t)return null;const _=Re(c||[]);return e.jsx("div",{className:"pitched-modal-backdrop",onClick:a,children:e.jsxs("div",{className:`pitched-modal ${_.length===0?"pitched-modal-no-scroll":""}`,onClick:I=>I.stopPropagation(),children:[l&&e.jsx(Ee,{item:l,onClose:()=>L(null)}),e.jsx("button",{className:"pitched-modal-close",onClick:a,"aria-label":"Close modal",children:e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"closeGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#a259f7"}),e.jsx("stop",{offset:"1",stopColor:"#805ad5"})]})}),e.jsx("path",{d:"M6.2253 4.81108C5.83477 4.42056 5.20161 4.42056 4.81108 4.81108C4.42056 5.20161 4.42056 5.83477 4.81108 6.2253L10.5858 12L4.81114 17.7747C4.42062 18.1652 4.42062 18.7984 4.81114 19.1889C5.20167 19.5794 5.83483 19.5794 6.22535 19.1889L12 13.4142L17.7747 19.1889C18.1652 19.5794 18.7984 19.5794 19.1889 19.1889C19.5794 18.7984 19.5794 18.1652 19.1889 17.7747L13.4142 12L19.189 6.2253C19.5795 5.83477 19.5795 5.20161 19.189 4.81108C18.7985 4.42056 18.1653 4.42056 17.7748 4.81108L12 10.5858L6.2253 4.81108Z",fill:"url(#closeGradient)"})]})}),e.jsx("h2",{className:"pitched-modal-title",children:r?`${r}'s Pitched Items`:"Pitched Items"}),_.length===0?e.jsxs("div",{className:"pitched-modal-empty",children:[e.jsx("div",{className:"empty-star-container",children:e.jsxs("svg",{width:"72",height:"72",viewBox:"0 0 24 24",fill:"none",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"emptyStarGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#a259f7"}),e.jsx("stop",{offset:"1",stopColor:"#6a11cb"})]}),e.jsxs("filter",{id:"starGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"1.5",result:"blur"}),e.jsx("feFlood",{floodColor:"#a259f7",floodOpacity:"0.5",result:"color"}),e.jsx("feComposite",{in:"color",in2:"blur",operator:"in",result:"glow"}),e.jsx("feComposite",{in:"SourceGraphic",in2:"glow",operator:"over"})]})]}),e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z",fill:"url(#emptyStarGradient)",stroke:"#e6e0ff",strokeWidth:"1.5",filter:"url(#starGlow)",className:"empty-star-path"})]})}),e.jsx("h3",{className:"empty-title",children:"No pitched items tracked yet"}),e.jsx("p",{className:"empty-desc",children:"Track your pitched items to see them here"})]}):e.jsx("div",{className:"pitched-modal-list-container",children:e.jsx("div",{className:"pitched-modal-list",ref:W,children:_.map(I=>{const B=I.item+"|"+I.image;return e.jsxs("div",{className:"pitched-modal-item",tabIndex:0,onClick:()=>L(I),title:`View ${I.item} acquisition history`,children:[e.jsx("div",{className:"pitched-modal-item-glow"}),e.jsx("img",{src:I.image,alt:I.item,className:"pitched-modal-item-img",draggable:"false"}),e.jsx("div",{className:"pitched-modal-item-name",children:I.item}),e.jsxs("div",{className:"pitched-modal-item-count",children:[I.count,"x"]})]},B)})})})]})})}function J(t,a,r,c,l){return`${t}-${a}__${r}__${c}__${l}`}const ze=Object.freeze(Object.defineProperty({__proto__:null,getPitchedKey:J},Symbol.toStringTag,{value:"Module"}));function Fe(t){return JSON.stringify((t||[]).map(a=>({name:a.name,idx:a.idx??a.index??0,bosses:(a.bosses||[]).map(r=>`${r.name}-${r.difficulty}`)})))}function ue(t,a,r,c,l,L=null){const[T,d]=o.useState({}),[$,y]=o.useState([]),[h,w]=o.useState(!1),[W,N]=o.useState({}),g=o.useRef(!1),S=o.useRef(null),_=o.useRef(null),I=o.useMemo(()=>Fe(a),[a]),B=a.length,k=o.useCallback(f=>{if(!f)return f;const j=f.split("-");if(j.length===3){const n=j[0],s=parseInt(j[1]).toString(),x=parseInt(j[2]).toString();return`${n}-${s}-${x}`}return f},[]),P=o.useCallback(async f=>{if(!h)try{w(!0);const j=f||t;if(!j)return;const n=await ve(j);if(n.success){if(y(n.items||[]),!g.current){const s=k(l),x=(n.items||[]).filter(m=>k(m.weekKey)===s),v={};x.forEach(m=>{const C=m.characterIdx!==void 0?m.characterIdx:a.findIndex(b=>b.name===m.character),i=a[C];if(i&&i.name===m.character){const b=J(m.character,C,m.boss,m.item,l);v[b]=!0}}),d(v)}}else console.error("Error refreshing pitched items:",n.error)}catch(j){console.error("Error in refreshPitchedItems:",j)}finally{w(!1)}},[h,t,l,k]);return o.useEffect(()=>{if(!t)return;let f=!0;return(async()=>{try{const{supabase:n}=await A(async()=>{const{supabase:v}=await import("./supabaseClient-DawR2l69.js");return{supabase:v}},__vite__mapDeps([0,1,2])),{data:s,error:x}=await n.from("user_data").select("pitched_items").eq("id",t).single();if(x){console.error("Error fetching pitched items:",x);return}f&&(s&&s.pitched_items&&Array.isArray(s.pitched_items)?y(s.pitched_items):y([]))}catch(n){console.error("Error in fetchPitchedItemsFromDatabase:",n)}})(),S.current=null,()=>{f=!1}},[t]),o.useEffect(()=>{if(!$.length||!l)return;const f=k(l),j=Q(),n=k(j);if(f===n&&S.current!==f&&!g.current)return _.current&&clearTimeout(_.current),_.current=setTimeout(()=>{const s=$.filter(x=>k(x.weekKey)===f);s.length>0&&(d(x=>{const v={...x};return s.forEach(m=>{const C=m.characterIdx!==void 0?m.characterIdx:a.findIndex(b=>b.name===m.character),i=a[C];if(i&&i.name===m.character){const b=J(m.character,C,m.boss,m.item,l);v[b]=!0}}),v}),c(x=>{let v=!1;const m={...x};return s.forEach(C=>{const i=C.characterIdx!==void 0?C.characterIdx:a.findIndex(u=>u.name===C.character),b=a[i];if(!b||b.name!==C.character)return;const K=`${C.character}-${i}`;m[K]||(m[K]={}),C.boss&&!m[K][`${C.boss}-${C.difficulty}`]&&(m[K][`${C.boss}-${C.difficulty}`]=!0,v=!0)}),v&&(!L||!L.current)?m:x}),S.current=f)},50),()=>{_.current&&clearTimeout(_.current)}},[$,l,I,B,r,c,L]),o.useEffect(()=>{if(!l||!$.length)return;const f=k(l),j=$.filter(n=>k(n.weekKey)===f);d(()=>{const n={};return j.forEach(s=>{const x=s.characterIdx!==void 0?s.characterIdx:a.findIndex(m=>m.name===s.character),v=a[x];if(v&&v.name===s.character){const m=J(s.character,x,s.boss,s.item,l);n[m]=!0}}),n}),S.current=null},[l,$,I,B]),{pitchedChecked:T,setPitchedChecked:d,cloudPitchedItems:$,setCloudPitchedItems:y,userInteractionRef:g,refreshPitchedItems:P,loadingPitchedItems:W,setLoadingPitchedItems:N,isRefreshingPitchedItems:h}}function Oe(t){return JSON.stringify((t||[]).map(a=>({name:a.name,idx:a.idx??a.index??0,bosses:(a.bosses||[]).map(r=>`${r.name}-${r.difficulty}`)})))}const Ke=pe.memo(function({sidebarVisible:a,isHistoricalWeek:r,totalMeso:c,obtainableMeso:l,selectedWeekKey:L,hideCompleted:T,setHideCompleted:d,visibleCharSummaries:$,selectedCharIdx:y,setSelectedCharIdx:h,setPurgeTargetCharacter:w,setShowCharacterPurgeConfirm:W,characterBossSelections:N=[]}){const[g,S]=o.useState(!1),[_,I]=o.useState(!1),[B,k]=o.useState(!1),[P,f]=o.useState(null),j=o.useRef(null),n=o.useRef(null),{userCode:s}=he(),x=o.useMemo(()=>Oe(N),[N]),v=N.length,m=o.useMemo(()=>N.map(u=>({...u,bosses:u.bosses||[]})),[x,v]),{cloudPitchedItems:C}=ue(s,m,{},()=>{},L),i=P==null?void 0:P.idx,b=o.useMemo(()=>i==null?[]:C.filter(u=>u.characterIdx===i),[C,i]);o.useEffect(()=>{const u=()=>{const p=j.current;if(p){const D=p.scrollHeight>p.clientHeight,R=p.scrollTop+p.clientHeight>=p.scrollHeight-5;S(D&&!R&&!_)}},M=()=>{I(!0),S(!1),n.current&&clearTimeout(n.current),n.current=setTimeout(()=>{I(!1),u()},1e3)};u();const H=j.current;if(H)return H.addEventListener("scroll",M),()=>{H.removeEventListener("scroll",M),n.current&&clearTimeout(n.current)}},[$,_]),o.useEffect(()=>{a&&setTimeout(()=>{const u=j.current;if(u){const M=u.scrollHeight>u.clientHeight,H=u.scrollTop+u.clientHeight>=u.scrollHeight-5;S(M&&!H&&!_)}},100)},[a,_]);const K=o.useCallback((u,M)=>{u.stopPropagation(),f(M),k(!0)},[]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`sidebar-scroll fade-in-no-slide ${a?"visible":"hidden"}`,children:e.jsxs("div",{className:"sidebar-content",children:[e.jsx("div",{className:"sidebar-header",children:e.jsx("h3",{className:"sidebar-title",children:"Characters"})}),!r&&e.jsxs("div",{className:"sidebar-progress-section",children:[e.jsx("div",{className:"sidebar-progress-title",children:"Weekly Progress"}),e.jsx("div",{className:"sidebar-progress-track week-navigator-progress-bar-container",children:e.jsx("div",{className:"sidebar-progress-fill week-navigator-progress-bar",style:{width:`${l>0?Math.min(c/l*100,100):0}%`},children:l>0&&c>0&&e.jsx("div",{className:"week-navigator-progress-shimmer"})})}),e.jsxs("div",{className:"sidebar-progress-numbers",children:[e.jsx("span",{children:X(c)}),e.jsx("span",{children:X(l)})]})]}),r&&e.jsxs("div",{className:"sidebar-historical-section",children:[e.jsxs("div",{className:"sidebar-historical-title",children:["Week ",L.split("-").slice(1).join("-")]}),e.jsx("div",{className:"sidebar-historical-subtitle",children:"Historical Data"})]}),e.jsxs("div",{className:"sidebar-character-list-container",children:[e.jsx("div",{className:"sidebar-character-list",ref:j,children:$.length===0?e.jsx("div",{className:"sidebar-empty-state",children:T?"No characters with bosses left to clear.":"No characters found."}):$.map(u=>e.jsxs("div",{onClick:()=>h(u.idx),onContextMenu:M=>{M.preventDefault(),w({name:u.name,idx:u.idx}),W(!0)},className:`sidebar-character-card ${y===u.idx?`selected ${r?"historical-week":"current-week"}`:"default"}`,children:[e.jsxs("div",{className:"sidebar-character-header",children:[e.jsx("span",{className:`sidebar-character-name ${y===u.idx?"selected":"default"}`,children:u.name}),e.jsxs("div",{className:"sidebar-character-actions",children:[u.allCleared&&e.jsxs("svg",{className:"sidebar-character-checkmark",width:"16",height:"16",viewBox:"0 0 22 22",children:[e.jsx("circle",{cx:"11",cy:"11",r:"11",fill:"#38a169"}),e.jsx("polyline",{points:"6,12 10,16 16,7",fill:"none",stroke:"#fff",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})]}),e.jsx("button",{className:"sidebar-character-pitched-btn",onClick:M=>K(M,u),title:"View pitched items",children:e.jsxs("div",{className:"pitched-btn-content",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z",fill:"url(#starGradient)",stroke:"url(#starStrokeGradient)",strokeWidth:"1.5"}),e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"starGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#a259f7"}),e.jsx("stop",{offset:"1",stopColor:"#805ad5"})]}),e.jsxs("linearGradient",{id:"starStrokeGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#d6b4ff"}),e.jsx("stop",{offset:"1",stopColor:"#a259f7"})]})]})]}),e.jsx("span",{className:"pitched-btn-glow"})]})})]})]}),e.jsx("div",{className:"sidebar-character-stats",children:u.total===0?e.jsx("div",{className:"sidebar-character-no-bosses",children:"No bosses configured"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sidebar-character-completion",children:[u.cleared," / ",u.total," bosses cleared"]}),e.jsxs("div",{className:"sidebar-character-meso",children:[X(u.totalMeso)," meso"]})]})})]},u.name+"-"+u.idx))}),g&&e.jsx("div",{className:"sidebar-scroll-indicator",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M11.0001 3.67157L13.0001 3.67157L13.0001 16.4999L16.2426 13.2574L17.6568 14.6716L12 20.3284L6.34314 14.6716L7.75735 13.2574L11.0001 16.5001L11.0001 3.67157Z",fill:"currentColor"})})})]})]})}),e.jsx(_e,{isOpen:B,onClose:()=>k(!1),characterName:P==null?void 0:P.name,pitchedItems:b})]})});function Ge({sidebarVisible:t,setSidebarVisible:a}){return e.jsx("div",{className:`sidebar-toggle ${t?"visible":"hidden"}`,onClick:()=>a(!t),title:t?"Hide sidebar":"Show sidebar",children:t?e.jsxs("svg",{className:"sidebar-toggle-close-icon",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"crossGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#ffffff"}),e.jsx("stop",{offset:"50%",stopColor:"#e6e0ff"}),e.jsx("stop",{offset:"100%",stopColor:"#d6b4ff"})]})}),e.jsx("path",{d:"M6.2253 4.81108C5.83477 4.42056 5.20161 4.42056 4.81108 4.81108C4.42056 5.20161 4.42056 5.83477 4.81108 6.2253L10.5858 12L4.81114 17.7747C4.42062 18.1652 4.42062 18.7984 4.81114 19.1889C5.20167 19.5794 5.83483 19.5794 6.22535 19.1889L12 13.4142L17.7747 19.1889C18.1652 19.5794 18.7984 19.5794 19.1889 19.1889C19.5794 18.7984 19.5794 18.1652 19.1889 17.7747L13.4142 12L19.189 6.2253C19.5795 5.83477 19.5795 5.20161 19.189 4.81108C18.7985 4.42056 18.1653 4.42056 17.7748 4.81108L12 10.5858L6.2253 4.81108Z",fill:"url(#crossGradient)"})]}):e.jsx("div",{className:"sidebar-toggle-hamburger",children:[0,1,2].map(r=>e.jsx("span",{className:"sidebar-toggle-hamburger-line"},r))})})}function Ye({selectedWeekKey:t,showTickAll:a,onTickAll:r,allTicked:c}){const l=Q(),L=t===l;return e.jsxs("div",{className:"mode-indicator-container purple",children:[e.jsx("div",{className:"mode-indicator-content",children:e.jsxs("div",{className:"mode-indicator-text",children:[e.jsx("div",{className:"mode-indicator-title",children:L?"Active Week Tracking":"Historical Week Review"}),e.jsx("div",{className:"mode-indicator-description",children:L?"Track your boss clears and pitched item  for the current week":"Track you pitched items you have collected this week"})]})}),a&&L&&e.jsx("button",{onClick:r,className:"mode-indicator-tick-all-button",title:c?"Clear all boss completions":"Mark all bosses as completed",children:c?"Clear All":"Complete All"})]})}function Be({isHistoricalWeek:t,characterBossSelections:a,selectedCharIdx:r,sortedBosses:c,bossData:l,checked:L,charKey:T,getBossPrice:d,pitchedChecked:$,weekKey:y,handleCheck:h,userInteractionRef:w,userCode:W,savePitchedItem:N,setPitchedChecked:g,setError:S,startStatsTrackingIfNeeded:_,setHistoricalPitchedData:I,setShowHistoricalPitchedModal:B,loadingPitchedItems:k,setLoadingPitchedItems:P,refreshPitchedItems:f,refreshHistoricalAnalysis:j}){if(t){const n=new Map;return a.forEach(s=>{var x;(x=s.bosses)==null||x.forEach(v=>{const m=l.find(C=>C.name===v.name);m&&m.pitchedItems&&m.pitchedItems.length>0&&n.set(v.name,m)})}),e.jsx("div",{className:"historical-week-cards-container",children:Array.from(n.values()).map(s=>e.jsxs("div",{className:"historical-boss-card",children:[e.jsxs("div",{className:"historical-boss-header",children:[e.jsx("img",{src:s.image,alt:s.name,className:"historical-boss-image"}),e.jsx("div",{className:"historical-boss-info",children:e.jsx("div",{className:"historical-boss-name",children:s.name})})]}),e.jsxs("div",{className:"historical-pitched-section",children:[e.jsx("div",{className:"historical-pitched-label",children:"Pitched Items"}),(s.pitchedItems||[]).length>0?e.jsx("div",{className:"historical-pitched-grid",children:(s.pitchedItems||[]).map(x=>{const v=J(a[r].name,r,s.name,x.name,y),m=!!$[v],C=m?a[r].name:null;return e.jsxs("div",{className:`historical-pitched-item ${m?"obtained":""}`,title:m?`Click to remove: ${x.name} (obtained by ${C})`:`Click to track: ${x.name}`,onClick:async i=>{if(i.stopPropagation(),m)try{const b=await N(W,{character:C,characterIdx:a.findIndex(K=>K.name===C),bossName:s.name,bossDifficulty:"Unknown",itemName:x.name,itemImage:x.image,date:new Date().toISOString()},!0,y);b.success?(await f(W),j&&await j()):S("Failed to remove historical pitched item: "+(b.error||"Unknown error"))}catch(b){S("Error removing historical pitched item: "+b.message)}else I({character:"",characterIdx:-1,bossName:s.name,itemName:x.name,itemImage:x.image,weekKey:y}),B(!0)},children:[e.jsx("img",{src:x.image,alt:x.name,className:`historical-pitched-item-image ${m?"obtained":"not-obtained"}`}),m&&e.jsx("span",{className:"historical-pitched-checkmark",children:"âœ“"})]},x.name)})}):e.jsx("div",{className:"historical-no-pitched",children:"No pitched items available"})]})]},s.name))})}return e.jsx("div",{className:"boss-table-scroll",children:e.jsxs("table",{className:`boss-table ${t?"historical-week":""}`,children:[e.jsx("thead",{children:e.jsxs("tr",{className:"boss-table-header-row",children:[e.jsx("th",{className:"boss-table-header-cell",children:"Boss"}),e.jsx("th",{className:"boss-table-header-cell-difficulty",children:"Difficulty"}),e.jsx("th",{className:"boss-table-header-cell-mesos",children:"Mesos"}),e.jsx("th",{className:"boss-table-header-cell-cleared",children:"Cleared"})]})}),e.jsx("tbody",{children:c.map((n,s)=>{var C;const x=l.find(i=>i.name===n.name),v=!!((C=L[T])!=null&&C[n.name+"-"+n.difficulty]),m=(x==null?void 0:x.pitchedItems)||[];return e.jsxs("tr",{className:`boss-table-row ${s%2===0?"even":"odd"}`,onClick:i=>{!i.target.closest(".checkbox-wrapper")&&!i.target.closest(".pitched-item-icon")&&h(n,!v,i)},children:[e.jsxs("td",{className:"boss-table-cell-boss",children:[(x==null?void 0:x.image)&&e.jsx("img",{src:x.image,alt:n.name,className:"boss-table-boss-image"}),e.jsx("span",{className:"boss-table-boss-name",children:n.name}),m.length>0&&e.jsx("div",{className:"boss-table-pitched-container inline",children:m.map(i=>{if((n.name==="Watcher Kalos"||n.name==="Kaling")&&i.name==="Grindstone of Life"){const u=J(a[r].name,r,n.name,i.name,y),M=!!$[u];return e.jsxs("span",{className:`pitched-item-icon inline ${M?"obtained":""}`,title:M?`Click to remove: ${i.name}`:`Click to track: ${i.name}`,onClick:async H=>{var F;if(H.stopPropagation(),t){I({character:"",characterIdx:-1,bossName:n.name,itemName:i.name,itemImage:i.image,weekKey:y}),B(!0);return}const p=`${a[r].name}-${r}`,D=J(a[r].name,r,n.name,i.name,y),R=!!$[D];w.current=!0,t||(F=L[p])!=null&&F[n.name+"-"+n.difficulty]||h(n,!0,H),P(E=>({...E,[D]:!0}));try{if(!W){S("Please log in to save pitched items to cloud.");return}const E=!R;g(O=>{const z={...O};return E?z[D]=!0:delete z[D],z}),(await N(W,{character:a[r].name,characterIdx:r,bossName:n.name,bossDifficulty:n.difficulty,itemName:i.name,itemImage:i.image,date:new Date().toISOString()},R,y)).success?j&&j().catch(O=>{console.error("Error refreshing historical analysis:",O)}):(S("Failed to save to cloud. Reverting changes."),g(O=>{const z={...O};return R?z[D]=!0:delete z[D],z}))}catch{S("Failed to update pitched item. Please try again."),g(G=>{const O={...G};return R?O[D]=!0:delete O[D],O})}finally{P(E=>{const G={...E};return delete G[D],G}),setTimeout(()=>{w.current=!1},1e3)}_()},children:[k[u]?e.jsx("div",{className:"pitched-item-loading inline",children:e.jsx("div",{className:"pitched-item-spinner inline"})}):e.jsx("img",{src:i.image,alt:i.name,className:`pitched-item-image inline ${M?"obtained":"not-obtained"}`}),M&&!k[u]&&e.jsx("span",{className:"pitched-item-checkmark inline",children:"âœ“"})]},i.name)}if(n.name==="Lotus"&&(i.name==="Total Control"&&n.difficulty!=="Extreme"||(i.name==="Berserked"||i.name==="Black Heart")&&!["Hard","Extreme"].includes(n.difficulty))||n.name==="Chosen Seren"&&i.name==="Gravity Module"&&n.difficulty!=="Extreme"||n.name==="Watcher Kalos"&&i.name==="Mark of Destruction"&&n.difficulty!=="Extreme"||n.name==="Kaling"&&i.name==="Helmet of Loyalty"&&n.difficulty!=="Extreme"||n.name!=="Lotus"&&n.name!=="Watcher Kalos"&&n.name!=="Kaling"&&!["Hard","Chaos","Extreme","Hell"].includes(n.difficulty))return null;const b=J(a[r].name,r,n.name,i.name,y),K=!!$[b];return e.jsxs("span",{className:`pitched-item-icon inline ${K?"obtained":""}`,title:K?`Click to remove: ${i.name}`:`Click to track: ${i.name}`,onClick:async u=>{var D;if(u.stopPropagation(),t){I({character:"",characterIdx:-1,bossName:n.name,itemName:i.name,itemImage:i.image,weekKey:y}),B(!0);return}const M=`${a[r].name}-${r}`,H=J(a[r].name,r,n.name,i.name,y),p=!!$[H];w.current=!0,t||(D=L[M])!=null&&D[n.name+"-"+n.difficulty]||h(n,!0,u),P(R=>({...R,[H]:!0}));try{if(!W){S("Please log in to save pitched items to cloud.");return}const R=!p;g(E=>{const G={...E};return R?G[H]=!0:delete G[H],G}),(await N(W,{character:a[r].name,characterIdx:r,bossName:n.name,bossDifficulty:n.difficulty,itemName:i.name,itemImage:i.image,date:new Date().toISOString()},p,y)).success?j&&j().catch(E=>{console.error("Error refreshing historical analysis:",E)}):(S("Failed to save to cloud. Reverting changes."),g(E=>{const G={...E};return p?G[H]=!0:delete G[H],G}))}catch{S("Failed to update pitched item. Please try again."),g(F=>{const E={...F};return p?E[H]=!0:delete E[H],E})}finally{P(R=>{const F={...R};return delete F[H],F}),setTimeout(()=>{w.current=!1},1e3)}_()},children:[k[b]?e.jsx("div",{className:"pitched-item-loading inline",children:e.jsx("div",{className:"pitched-item-spinner inline"})}):e.jsx("img",{src:i.image,alt:i.name,className:`pitched-item-image inline ${K?"obtained":"not-obtained"}`}),K&&!k[b]&&e.jsx("span",{className:"pitched-item-checkmark inline",children:"âœ“"})]},i.name)})})]}),e.jsx("td",{className:"boss-table-cell-difficulty",children:e.jsx("span",{children:n.difficulty})}),e.jsx("td",{className:"boss-table-cell-mesos",children:e.jsx("span",{children:Math.floor(d(n.name,n.difficulty)/(n.partySize||1)).toLocaleString()})}),e.jsx("td",{className:"boss-table-cell-cleared",children:e.jsx("span",{onClick:i=>i.stopPropagation(),children:e.jsx(Te,{checked:v,onChange:i=>h(n,i.target.checked,i)})})})]},n.name+"-"+n.difficulty)})})]})})}function Ve({showStats:t,setShowStats:a,allYears:r,selectedYear:c,setSelectedYear:l,yearlyPitchedSummary:L,isLoadingCloudStats:T,setPitchedModalItem:d,setShowPitchedModal:$,setShowStatsResetConfirm:y}){return t?e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(40,32,74,0.92)",zIndex:5e3,display:"flex",alignItems:"center",justifyContent:"center"},onClick:()=>a(!1),children:e.jsxs("div",{className:"modal-fade",style:{background:"#2d2540",borderRadius:14,padding:"2.5rem 2rem",maxWidth:600,color:"#e6e0ff",boxShadow:"0 4px 24px #0006",position:"relative",minWidth:320,maxHeight:"90vh",overflowY:"auto"},onClick:h=>h.stopPropagation(),children:[e.jsx("button",{onClick:()=>a(!1),style:{position:"absolute",top:16,right:16,background:"transparent",color:"#fff",border:"none",fontSize:"1.5rem",cursor:"pointer"},title:"Close",children:"Ã—"}),e.jsx("h2",{style:{color:"#a259f7",fontWeight:700,marginBottom:18,textAlign:"center"},children:"Yearly Stats"}),e.jsx("div",{style:{marginBottom:18,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsx("select",{value:c,onChange:h=>l(h.target.value),style:{background:"#3a335a",color:"#e6e0ff",border:"1px solid #805ad5",borderRadius:6,padding:"6px 18px",fontWeight:600,fontSize:"1.08em",minWidth:120,textAlign:"center"},children:r.map(h=>e.jsx("option",{value:h,children:h},h))})}),e.jsx("div",{style:{marginBottom:8,textAlign:"center"},children:L.length===0?`No pitched items were found for ${c}`:"Pitched Items Obtained:"}),T?e.jsx("div",{style:{textAlign:"center",padding:"15px",color:"#b39ddb"},children:"Loading cloud stats..."}):L.length===0?e.jsx("div",{style:{textAlign:"center",padding:"2rem",color:"#888",fontSize:"1.1rem"}}):e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:10,marginBottom:8,justifyContent:"center"},children:L.map((h,w)=>e.jsxs("span",{className:"pitched-count-white pitched-hover",style:{display:"inline-flex",alignItems:"center",gap:4,background:"#3a335a",borderRadius:6,padding:"2px 10px",fontSize:"1em",fontWeight:600,cursor:"pointer",boxShadow:"0 0 8px #805ad5",border:"1px solid #805ad5",transition:"transform 0.18s cubic-bezier(.4,2,.6,1), box-shadow 0.18s cubic-bezier(.4,2,.6,1)",position:"relative"},onClick:()=>{d(h),$(!0)},title:"Click for details",onMouseOver:W=>{W.currentTarget.style.transform="scale(1.08)",W.currentTarget.style.boxShadow="0 4px 16px #a259f7cc"},onMouseOut:W=>{W.currentTarget.style.transform="scale(1)",W.currentTarget.style.boxShadow="0 0 8px #805ad5"},children:[e.jsx("img",{src:h.image,alt:h.name,style:{width:22,borderRadius:4,marginRight:2,transition:"box-shadow 0.18s cubic-bezier(.4,2,.6,1)"}}),h.name,e.jsxs("span",{className:"pitched-count-white",style:{color:"#fff",marginLeft:6,fontWeight:700,fontSize:"1.1em"},children:["Ã—",h.count]})]},w))}),e.jsx("div",{style:{textAlign:"center",marginTop:24},children:e.jsx("button",{style:{background:"#e53e3e",color:"#fff",border:"none",borderRadius:8,padding:"0.6rem 1.5rem",fontWeight:700,fontSize:"1.1rem",cursor:"pointer"},onClick:()=>y(!0),children:"Reset Stats"})})]})}):null}function Ue({showStatsResetConfirm:t,setShowStatsResetConfirm:a,onConfirm:r}){return t?e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(40,32,74,0.92)",zIndex:6e3,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{className:"modal-fade",style:{background:"#2d2540",borderRadius:14,padding:"2rem 1.5rem",maxWidth:340,color:"#e6e0ff",boxShadow:"0 4px 24px #0006",position:"relative",minWidth:220,textAlign:"center"},children:[e.jsx("h3",{style:{color:"#ffbaba",marginBottom:16},children:"Are you sure?"}),e.jsx("p",{style:{marginBottom:18},children:"This will permanently erase all stats. This cannot be undone."}),e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:[e.jsx("button",{onClick:()=>a(!1),style:{background:"#3a335a",color:"#e6e0ff",border:"none",borderRadius:8,padding:"0.7rem 1.5rem",fontWeight:700,fontSize:"1.1rem",cursor:"pointer",minWidth:100},children:"Cancel"}),e.jsx("button",{onClick:r,style:{background:"#e53e3e",color:"#fff",border:"none",borderRadius:8,padding:"0.7rem 1.5rem",fontWeight:700,fontSize:"1.1rem",cursor:"pointer",minWidth:100},children:"Reset"})]})]})}):null}function Je({showCharacterPurgeConfirm:t,setShowCharacterPurgeConfirm:a,purgeTargetCharacter:r,purgeInProgress:c,onConfirm:l}){return t?e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(40,32,74,0.96)",zIndex:6e3,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{className:"modal-fade",style:{background:"#2d2540",borderRadius:16,padding:"2.5rem",maxWidth:480,color:"#e6e0ff",boxShadow:"0 8px 32px rgba(0,0,0,0.5)",position:"relative",minWidth:360,textAlign:"center",border:"2px solid #ff6b6b"},children:[e.jsx("div",{style:{width:80,height:80,background:"linear-gradient(135deg, #ff6b6b, #ff8e8e)",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 24px",boxShadow:"0 4px 20px rgba(255, 107, 107, 0.4)"},children:e.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z",stroke:"#fff",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})})}),e.jsx("h2",{style:{color:"#ff6b6b",fontWeight:700,marginBottom:20,fontSize:"1.5rem"},children:"Purge Character Data"}),e.jsxs("div",{style:{background:"rgba(255, 107, 107, 0.1)",border:"1px solid rgba(255, 107, 107, 0.3)",borderRadius:12,padding:"20px",marginBottom:28},children:[e.jsx("p",{style:{marginBottom:12,fontSize:"1.1rem",lineHeight:"1.5",color:"#ffbaba"},children:e.jsx("strong",{children:"This will permanently delete all pitched items and boss runs for:"})}),e.jsx("p",{style:{fontSize:"1.2rem",fontWeight:700,color:"#fff",marginBottom:12},children:r==null?void 0:r.name}),e.jsx("p",{style:{fontSize:"0.9rem",color:"#ffbaba",marginBottom:0},children:"This action cannot be undone."})]}),e.jsxs("div",{style:{display:"flex",gap:16,justifyContent:"center"},children:[e.jsx("button",{onClick:()=>a(!1),disabled:c,style:{background:c?"#2a2540":"#3a335a",color:c?"#888":"#e6e0ff",border:c?"1px solid #2a2540":"2px solid #4a4370",borderRadius:12,padding:"0.8rem 2rem",fontWeight:700,fontSize:"1.1rem",cursor:c?"not-allowed":"pointer",minWidth:140,transition:"all 0.2s ease",opacity:c?.5:1},children:"Cancel"}),e.jsxs("button",{onClick:l,disabled:c,style:{background:c?"#cc5555":"linear-gradient(135deg, #ff6b6b, #ff4757)",color:"#fff",border:"2px solid #ff6b6b",borderRadius:12,padding:"0.8rem 2rem",fontWeight:700,fontSize:"1.1rem",cursor:c?"not-allowed":"pointer",opacity:c?.7:1,minWidth:140,transition:"all 0.2s ease",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",boxShadow:c?"none":"0 4px 16px rgba(255, 107, 107, 0.3)"},children:[c&&e.jsx("div",{style:{width:20,height:20,border:"2px solid rgba(255, 255, 255, 0.3)",borderTopColor:"#fff",borderRadius:"50%",animation:"spin 1s linear infinite"}}),c?"Purging...":"Purge Data"]})]})]})}):null}function qe({resetSuccessVisible:t,closeResetSuccess:a,purgeSuccess:r,setPurgeSuccess:c}){return!t&&!r?null:e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.7)",zIndex:7e3,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{className:"modal-fade",style:{background:"#2d2540",borderRadius:14,padding:"2rem 1.5rem",maxWidth:340,color:"#e6e0ff",boxShadow:"0 4px 24px #0006",position:"relative",minWidth:220,textAlign:"center"},onClick:l=>l.stopPropagation(),children:[e.jsx("h3",{style:{color:"#38a169",marginBottom:16,fontSize:"1.5rem"},children:t?"Stats reset!":"Character purged!"}),e.jsx("p",{style:{marginBottom:24,fontSize:"1.1rem"},children:t?"Your stats have been cleared.":"Character data has been purged."}),e.jsx("button",{onClick:t?a:()=>c(!1),style:{background:"#3a335a",color:"#e6e0ff",border:"none",borderRadius:8,padding:"0.6rem 1.5rem",fontWeight:600,fontSize:"1.1rem",cursor:"pointer",marginTop:10,boxShadow:"0 2px 8px rgba(0,0,0,0.3)"},children:"Close"})]})})}function Ze({showPitchedModal:t,setShowPitchedModal:a,pitchedModalItem:r,pitchedModalDetails:c}){return!t||!r?null:e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(40,32,74,0.92)",zIndex:6e3,display:"flex",alignItems:"center",justifyContent:"center"},onClick:()=>a(!1),children:e.jsxs("div",{className:"modal-fade",style:{background:"#2d2540",borderRadius:14,padding:"2rem 1.5rem",maxWidth:400,color:"#e6e0ff",boxShadow:"0 4px 24px #0006",position:"relative",minWidth:220,textAlign:"center"},onClick:l=>l.stopPropagation(),children:[e.jsx("button",{onClick:()=>a(!1),style:{position:"absolute",top:12,right:12,background:"transparent",color:"#fff",border:"none",fontSize:"1.3rem",cursor:"pointer"},title:"Close",children:"Ã—"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:10,marginBottom:16},children:[e.jsx("img",{src:r.image,alt:r.name,style:{width:32,borderRadius:6}}),e.jsx("span",{style:{fontWeight:700,fontSize:"1.1em",color:"#a259f7"},children:r.name})]}),e.jsx("div",{style:{marginBottom:10,color:"#b39ddb",fontWeight:600},children:"Obtained by:"}),c.length===0?e.jsx("div",{style:{color:"#888",marginBottom:8},children:"None this year."}):e.jsx("div",{style:{maxHeight:220,overflowY:"auto",marginBottom:8},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:"1em",background:"none"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{color:"#b39ddb",background:"none"},children:[e.jsx("th",{style:{padding:"4px 8px",fontWeight:700},children:"Character"}),e.jsx("th",{style:{padding:"4px 8px",fontWeight:700},children:"Date"})]})}),e.jsx("tbody",{children:c.map((l,L)=>e.jsxs("tr",{style:{background:L%2===0?"#23203a":"#201c32"},children:[e.jsx("td",{style:{padding:"4px 8px",fontWeight:600},children:l.char}),e.jsx("td",{style:{padding:"4px 8px",color:"#b39ddb"},children:l.date})]},L))})]})})]})})}function Ae(t){const a=Q(),[r,c]=o.useState(a),[l,L]=o.useState([]),[T,d]=o.useState({}),[$,y]=o.useState({hasHistoricalData:!1,oldestHistoricalWeek:null,userType:"new",adaptiveWeekLimit:8,historicalWeeks:[]}),h=r!==a,w=o.useCallback(async()=>{if(t)try{console.log("ðŸ”„ Refreshing historical analysis...");const N=await ce(t);N.success&&(y({hasHistoricalData:N.hasHistoricalData,oldestHistoricalWeek:N.oldestHistoricalWeek,userType:N.userType,adaptiveWeekLimit:N.adaptiveWeekLimit,historicalWeeks:N.historicalWeeks,analysis:N.analysis}),console.log("âœ… Historical analysis refreshed:",{userType:N.userType,hasData:N.hasHistoricalData,oldestWeek:N.oldestHistoricalWeek,adaptiveLimit:N.adaptiveWeekLimit}))}catch(N){console.error("Error refreshing historical analysis:",N)}},[t,y]),W=o.useCallback(N=>{N!==r&&c(N)},[r]);return o.useEffect(()=>{(async()=>{if(t)try{const[g,S]=await Promise.all([we(t),ce(t)]);g.success&&L(g.weeks),S.success&&(y({hasHistoricalData:S.hasHistoricalData,oldestHistoricalWeek:S.oldestHistoricalWeek,userType:S.userType,adaptiveWeekLimit:S.adaptiveWeekLimit,historicalWeeks:S.historicalWeeks,analysis:S.analysis}),console.log("ðŸ“Š Week navigation updated with historical analysis:",{userType:S.userType,hasData:S.hasHistoricalData,oldestWeek:S.oldestHistoricalWeek,adaptiveLimit:S.adaptiveWeekLimit}))}catch(g){console.error("Error fetching week navigation data:",g)}})()},[t]),{selectedWeekKey:r,availableWeeks:l,weekDataCache:T,setWeekDataCache:d,isHistoricalWeek:h,handleWeekChange:W,historicalAnalysis:$,refreshHistoricalAnalysis:w}}function Xe({characterBossSelections:t,selectedCharIdx:a,checked:r,setChecked:c,bossData:l,pitchedChecked:L,setPitchedChecked:T,weekKey:d,selectedWeekKey:$,userCode:y,userInteractionRef:h,setCrystalAnimation:w,setError:W,startStatsTrackingIfNeeded:N,refreshHistoricalAnalysis:g}){const S=Q();return{handleCheck:async(k,P,f=null)=>{var j;try{h.current=!0;let n,s,x;if(k&&k.name)n=k,s=P,x=f;else if(k&&k.target)x=k,n=P,s=x.target.checked;else{console.error("Invalid parameters to handleCheck");return}if(x&&x.clientX&&w){const M={x:x.clientX,y:x.clientY},H=document.querySelector(".progress-bar");if(H){const p=H.getBoundingClientRect(),D={x:p.left+p.width/2,y:p.top+p.height/2};w({startPosition:M,endPosition:D})}}const v=((j=t[a])==null?void 0:j.name)||"",m=a,C=`${v}-${m}`,i=n.name,b=n.difficulty,K=`${i}-${b}`,u={...r,[C]:{...r[C]||{},[K]:s}};if(c(u),y&&$===S)try{const{saveBossRun:M}=await A(async()=>{const{saveBossRun:D}=await import("./pitched-data-service-DmmTGQCG.js");return{saveBossRun:D}},__vite__mapDeps([3,1,2,4,5,6,7,8])),H={character:v,characterIdx:m,bossName:i,bossDifficulty:b,isCleared:s,date:new Date().toISOString()},p=await M(y,H);p.success?console.log("âœ… Boss run saved successfully"):console.error("Error saving boss run:",p.error)}catch(M){console.error("Error saving boss state to database:",M)}if(!s&&$===S){const M=l.find(H=>H.name===i);if(M&&M.pitchedItems){T(p=>{const D={...p};return M.pitchedItems.forEach(R=>{const F=J(v,m,i,R.name,d);D[F]&&delete D[F]}),D});const H=M.pitchedItems.map(p=>({character:v,bossName:i,itemName:p.name,weekKey:d}));H.length>0&&y&&ae(y,H).then(async()=>{g&&await g()}).catch(p=>{console.error("Error removing pitched items:",p)})}}N()}catch(n){console.error("Error in handleCheck:",n),W("Failed to update boss status. Please try again.")}finally{setTimeout(()=>{h.current=!1,console.log("ðŸ–±ï¸ USER: Boss interaction flag cleared, sync can resume")},1e3)}},handleTickAll:async()=>{try{const k=t[a],P=(k==null?void 0:k.bosses)||[],f=`${(k==null?void 0:k.name)||""}-${a}`,j=r[f]||{},s=!P.every(v=>j[v.name+"-"+v.difficulty]);h.current=!0;const x={...r,[f]:Object.fromEntries(P.map(v=>[v.name+"-"+v.difficulty,s]))};if(c(x),!s){const v={...L};P.forEach(m=>{const C=l.find(i=>i.name===m.name);C!=null&&C.pitchedItems&&C.pitchedItems.forEach(i=>{const b=J(t[a].name,a,m.name,i.name,d);v[b]&&delete v[b]})}),T(v)}if(y)try{console.log(`ðŸ”„ Batch updating ${P.length} bosses to ${s?"checked":"unchecked"}`);const{saveBatchBossRuns:v}=await A(async()=>{const{saveBatchBossRuns:i}=await import("./pitched-data-service-DmmTGQCG.js");return{saveBatchBossRuns:i}},__vite__mapDeps([3,1,2,4,5,6,7,8])),m=P.map(i=>({character:t[a].name,characterIdx:a,bossName:i.name,bossDifficulty:i.difficulty,isCleared:s,date:new Date().toISOString()})),C=await v(y,m);if(C.success?console.log(`âœ… Batch update successful: ${P.length} bosses updated`):(console.error("Batch update failed:",C.error),W("Failed to save all boss updates. Please try again.")),!s){const i=[];P.forEach(b=>{const K=l.find(u=>u.name===b.name);K!=null&&K.pitchedItems&&K.pitchedItems.forEach(u=>{const M=J(t[a].name,a,b.name,u.name,d);L[M]&&i.push({character:t[a].name,bossName:b.name,itemName:u.name,weekKey:d})})}),i.length>0&&(await ae(y,i),g&&await g())}}catch(v){console.error("Error in batch boss update:",v),W("Failed to update all bosses. Please try again.")}}catch(k){console.error("Error in handleTickAll:",k),W("Failed to update all bosses. Please try again.")}finally{setTimeout(()=>{h.current=!1},1e3)}},refreshCheckedStateFromDatabase:async()=>{if(y){try{console.log("ðŸ”„ Refreshing checked state from boss runs...");const{supabase:k}=await A(async()=>{const{supabase:j}=await import("./supabaseClient-DawR2l69.js");return{supabase:j}},__vite__mapDeps([0,1,2])),{data:P,error:f}=await k.from("user_data").select("data").eq("id",y).single();if(!f&&P&&P.data&&P.data.boss_runs){const j={};return P.data.boss_runs.forEach(n=>{if(n.cleared){const s=`${n.character}-${n.characterIdx||0}`,x=`${n.boss}-${n.difficulty}`;j[s]||(j[s]={}),j[s][x]=!0}}),console.log("âœ… Refreshed checked state from boss_runs after boss action"),c(j),j}}catch(k){console.error("Error refreshing checked state from boss runs:",k)}return null}}}}function Qe(t,a){const[r,c]=o.useState(!1),[l,L]=o.useState(!1),[T,d]=o.useState({monthly:[],yearly:[]}),[$,y]=o.useState(!1),[h,w]=o.useState(null),[W,N]=o.useState(!1),[g,S]=o.useState(!1),[_,I]=o.useState([]),[B,k]=o.useState(!1),[P,f]=o.useState({}),[j,n]=o.useState(!1),[s,x]=o.useState(null),[v,m]=o.useState(!1),[C,i]=o.useState(!1),[b,K]=o.useState(null),u=o.useMemo(()=>{const O=se(),z=new Set([O]);return T!=null&&T.yearly&&Array.isArray(T.yearly)&&T.yearly.forEach(V=>z.add(V.yearKey)),P&&Object.keys(P).forEach(V=>z.add(V)),Array.from(z).sort((V,Y)=>Y.localeCompare(V))},[T==null?void 0:T.yearly,P]),[M,H]=o.useState(()=>se());o.useEffect(()=>{(u==null?void 0:u.length)>0&&!u.includes(M)&&H(u[0])},[u,M]),o.useEffect(()=>{if(!r||!t)return;(async()=>{try{n(!0);const z=await le(t);z.success&&f(z.data)}catch(z){console.error("Error fetching cloud pitched stats:",z)}finally{n(!1)}})()},[r,t]);const p=o.useMemo(()=>{if(!M||!P)return[];const O=new Map,z=P[M];z!=null&&z.items&&Array.isArray(z.items)&&z.items.forEach(Y=>{if(!(Y!=null&&Y.item)||!(Y!=null&&Y.image))return;const U=Y.item+"|"+Y.image;O.has(U)||O.set(U,{name:Y.item,image:Y.image,count:0,history:[],source:"cloud"});const q=O.get(U);if(q.count+=1,Y.date){const Z=new Date(Y.date),ee=Z.getUTCMonth(),re=Z.getUTCDate();q.history.push({char:Y.character,date:`${ge[ee]} ${re}`,cloud:!0,fullDate:Y.date})}});const V=Array.from(O.values());return V.forEach(Y=>{var U;((U=Y.history)==null?void 0:U.length)>0&&Y.history.sort((q,Z)=>q.fullDate&&Z.fullDate?new Date(Z.fullDate)-new Date(q.fullDate):0)}),V.sort((Y,U)=>U.count-Y.count||Y.name.localeCompare(U.name))},[M,P]),D=async(O,z,V,Y,U)=>{if(h)try{N(!0);const{name:q,idx:Z}=h;Y.current=!0;const ee=Se(O,q,Z,V);if(z(ee),(await Ce(t,q,Z)).success){f({}),await a(t);const ie=await le(t);ie.success&&f(ie.data),S(!0),y(!1);const ne=await Le(t);ne.success&&I(ne.history),setTimeout(()=>{S(!1)},3e3)}else U("Failed to purge character data. Please try again.")}catch(q){console.error("Error in handleCharacterPurge:",q),U("Failed to purge character data. Please try again.")}finally{N(!1),setTimeout(()=>{Y.current=!1},1e3)}},R=async O=>{try{if(d({monthly:[],yearly:[]}),H(se()),t)if((await Ne(t)).success)f({}),await a(t);else{O("Failed to reset stats data. Please try again.");return}L(!1),k(!0),setTimeout(()=>{k(!1),c(!1)},3400)}catch(z){console.error("Error in stats reset:",z),O("Failed to reset stats data. Please try again.")}},F=()=>{k(!1),c(!1)},E=o.useMemo(()=>s?s.history||[]:[],[s]);function G(){console.log("Stats tracking is now cloud-based - no action needed")}return{showStats:r,setShowStats:c,showStatsResetConfirm:l,setShowStatsResetConfirm:L,statsPanel:T,setStatsPanel:d,showCharacterPurgeConfirm:$,setShowCharacterPurgeConfirm:y,purgeTargetCharacter:h,setPurgeTargetCharacter:w,purgeInProgress:W,purgeSuccess:g,setPurgeSuccess:S,auditHistory:_,resetSuccessVisible:B,closeResetSuccess:F,cloudPitchedStats:P,setCloudPitchedStats:f,isLoadingCloudStats:j,pitchedModalItem:s,setPitchedModalItem:x,showPitchedModal:v,setShowPitchedModal:m,pitchedModalDetails:E,showHistoricalPitchedModal:C,setShowHistoricalPitchedModal:i,historicalPitchedData:b,setHistoricalPitchedData:K,allYears:u,selectedYear:M,setSelectedYear:H,yearlyPitchedSummary:p,handleCharacterPurge:D,handleStatsReset:R,startStatsTrackingIfNeeded:G}}function et({characterBossSelections:t,bossData:a,checked:r,setChecked:c,userCode:l,preservingCheckedStateRef:L}){function T(p,D){const R=a.find(E=>E.name===p);if(!R)return 0;const F=R.difficulties.find(E=>E.difficulty===D);return F?F.price:0}const[d,$]=o.useState(!0),[y,h]=o.useState(null),[w,W]=o.useState(0),[N,g]=o.useState(null),[S,_]=o.useState(!1),[I,B]=o.useState({weeklyTotal:0,lastReset:new Date().toISOString(),history:[]}),[k,P]=o.useState(()=>{const p=localStorage.getItem(oe.WEEKLY_HIDE_COMPLETED);return p?JSON.parse(p):!1});o.useEffect(()=>{localStorage.setItem(oe.WEEKLY_HIDE_COMPLETED,JSON.stringify(k))},[k]),o.useEffect(()=>{if(t.length)_(!1);else{_(!1);const p=setTimeout(()=>{_(!0)},2e3);return()=>clearTimeout(p)}},[t.length]);const f=Ae(l),j=ue(l,t,r,c,f.selectedWeekKey,L),n=Xe({characterBossSelections:t,selectedCharIdx:w,checked:r,setChecked:c,bossData:a,pitchedChecked:j.pitchedChecked,setPitchedChecked:j.setPitchedChecked,weekKey:f.selectedWeekKey,selectedWeekKey:f.selectedWeekKey,isHistoricalWeek:f.isHistoricalWeek,userCode:l,userInteractionRef:j.userInteractionRef,setCrystalAnimation:h,setError:g,startStatsTrackingIfNeeded:()=>{},refreshHistoricalAnalysis:f.refreshHistoricalAnalysis}),s=Qe(l,j.refreshPitchedItems),x=p=>{f.handleWeekChange(p)};o.useEffect(()=>{w>=t.length&&W(Math.max(0,t.length-1))},[t.length,w]);const v=t[w],m=`${(v==null?void 0:v.name)||""}-${w}`,C=(v==null?void 0:v.bosses)||[],i=[...C].sort((p,D)=>{try{const R=T(p.name,p.difficulty)/(p.partySize||1);return T(D.name,D.difficulty)/(D.partySize||1)-R}catch(R){return g(`Error sorting bosses: ${R.message}`),0}}),b=t.reduce((p,D,R)=>{const F=`${(D==null?void 0:D.name)||""}-${R}`;return p+(D.bosses||[]).reduce((E,G)=>{var O;return(O=r[F])!=null&&O[G.name+"-"+G.difficulty]?E+T(G.name,G.difficulty)/(G.partySize||1):E},0)},0),K=t.reduce((p,D)=>p+(D.bosses||[]).reduce((R,F)=>R+T(F.name,F.difficulty)/(F.partySize||1),0),0),u=t.map((p,D)=>{const R=`${(p==null?void 0:p.name)||""}-${D}`,F=(p==null?void 0:p.bosses)||[],E=F.filter(z=>{var V;return(V=r[R])==null?void 0:V[z.name+"-"+z.difficulty]}).length,G=F.length,O=F.reduce((z,V)=>{var Y;return(Y=r[R])!=null&&Y[V.name+"-"+V.difficulty]?z+Math.ceil(T(V.name,V.difficulty)/(V.partySize||1)):z},0);return{name:p.name,cleared:E,total:G,allCleared:G>0&&E===G,left:G-E,idx:D,totalMeso:O}}),M=k?u.filter(p=>!p.allCleared):u,H=C.length>0;return N?e.jsxs("div",{className:"weekly-tracker-error",children:[e.jsx("div",{className:"weekly-tracker-error-message",children:N}),e.jsx("button",{onClick:()=>g(null),children:"Try Again"})]}):t.length?e.jsxs("div",{className:"weekly-tracker",children:[y&&e.jsx($e,{startPosition:y.startPosition,endPosition:y.endPosition,onComplete:()=>h(null)}),e.jsxs("div",{className:"weekly-tracker-container",children:[e.jsx(Ke,{sidebarVisible:d,isHistoricalWeek:f.isHistoricalWeek,totalMeso:b,obtainableMeso:K,selectedWeekKey:f.selectedWeekKey,hideCompleted:k,setHideCompleted:P,visibleCharSummaries:M,selectedCharIdx:w,setSelectedCharIdx:W,setPurgeTargetCharacter:s.setPurgeTargetCharacter,setShowCharacterPurgeConfirm:s.setShowCharacterPurgeConfirm,characterBossSelections:t}),e.jsx(Ge,{sidebarVisible:d,setSidebarVisible:$}),e.jsx("div",{className:"weekly-tracker-main fade-in",children:e.jsxs("div",{className:"weekly-tracker-content",children:[e.jsx("div",{className:"weekly-tracker-header",children:e.jsx("h2",{className:"weekly-tracker-title",children:"Weekly Boss Tracker"})}),e.jsx("div",{className:"weekly-tracker-navigator-wrapper",children:e.jsx(Ie,{selectedWeekKey:f.selectedWeekKey,onWeekChange:x,availableWeeks:f.availableWeeks,isHistoricalWeek:f.isHistoricalWeek,historicalAnalysis:f.historicalAnalysis,characterBossSelections:t,checked:r,selectedCharIdx:w,totalMeso:b,obtainableMeso:K,charSummaries:u})}),e.jsx(Ye,{selectedWeekKey:f.selectedWeekKey,showTickAll:H&&!f.isHistoricalWeek,onTickAll:n.handleTickAll,allTicked:C.every(p=>{var D;return(D=r[m])==null?void 0:D[p.name+"-"+p.difficulty]})&&C.length>0}),H&&e.jsx("div",{children:e.jsx(Be,{isHistoricalWeek:f.isHistoricalWeek,characterBossSelections:t,selectedCharIdx:w,charBosses:C,sortedBosses:i,bossData:a,checked:r,setChecked:c,charKey:m,getBossPrice:T,pitchedChecked:j.pitchedChecked,setPitchedChecked:j.setPitchedChecked,weekKey:f.selectedWeekKey,handleCheck:n.handleCheck,refreshCheckedStateFromDatabase:n.refreshCheckedStateFromDatabase,userInteractionRef:j.userInteractionRef,userCode:l,savePitchedItem:de,removeManyPitchedItems:ae,setError:g,startStatsTrackingIfNeeded:s.startStatsTrackingIfNeeded,setHistoricalPitchedData:s.setHistoricalPitchedData,setShowHistoricalPitchedModal:s.setShowHistoricalPitchedModal,loadingPitchedItems:j.loadingPitchedItems,setLoadingPitchedItems:j.setLoadingPitchedItems,refreshPitchedItems:j.refreshPitchedItems,refreshHistoricalAnalysis:f.refreshHistoricalAnalysis})}),e.jsx("div",{className:"weekly-tracker-stats-button-container",children:e.jsx("button",{className:"weekly-tracker-stats-button",onClick:()=>s.setShowStats(!0),children:"View Stats"})})]})}),e.jsx(Ve,{showStats:s.showStats,setShowStats:s.setShowStats,allYears:s.allYears,selectedYear:s.selectedYear,setSelectedYear:s.setSelectedYear,yearlyPitchedSummary:s.yearlyPitchedSummary,isLoadingCloudStats:s.isLoadingCloudStats,setPitchedModalItem:s.setPitchedModalItem,setShowPitchedModal:s.setShowPitchedModal,setShowStatsResetConfirm:s.setShowStatsResetConfirm}),e.jsx(Ue,{showStatsResetConfirm:s.showStatsResetConfirm,setShowStatsResetConfirm:s.setShowStatsResetConfirm,onConfirm:()=>s.handleStatsReset(g)}),e.jsx(Je,{showCharacterPurgeConfirm:s.showCharacterPurgeConfirm,setShowCharacterPurgeConfirm:s.setShowCharacterPurgeConfirm,purgeTargetCharacter:s.purgeTargetCharacter,purgeInProgress:s.purgeInProgress,onConfirm:()=>s.handleCharacterPurge(j.pitchedChecked,j.setPitchedChecked,f.selectedWeekKey,j.userInteractionRef,g)}),e.jsx(qe,{resetSuccessVisible:s.resetSuccessVisible,closeResetSuccess:s.closeResetSuccess,purgeSuccess:s.purgeSuccess,setPurgeSuccess:s.setPurgeSuccess}),e.jsx(Ze,{showPitchedModal:s.showPitchedModal,setShowPitchedModal:s.setShowPitchedModal,pitchedModalItem:s.pitchedModalItem,pitchedModalDetails:s.pitchedModalDetails}),s.showHistoricalPitchedModal&&s.historicalPitchedData&&e.jsx("div",{className:"weekly-tracker-modal-backdrop",onClick:()=>s.setShowHistoricalPitchedModal(!1),children:e.jsx(Me,{data:s.historicalPitchedData,characterBossSelections:t,onClose:()=>s.setShowHistoricalPitchedModal(!1),onConfirm:async(p,D)=>{try{console.log("ðŸ›ï¸ Historical pitched item logging:",{character:D,boss:s.historicalPitchedData.bossName,item:s.historicalPitchedData.itemName,date:p,weekKey:s.historicalPitchedData.weekKey});const R=t.findIndex(E=>E.name===D);if(R===-1){g("Selected character not found");return}const F=await de(l,{character:D,characterIdx:R,bossName:s.historicalPitchedData.bossName,bossDifficulty:"Unknown",itemName:s.historicalPitchedData.itemName,itemImage:s.historicalPitchedData.itemImage,date:p},!1,s.historicalPitchedData.weekKey);if(F.success){console.log("âœ… Historical pitched item saved successfully");const{getPitchedKey:E}=await A(async()=>{const{getPitchedKey:O}=await Promise.resolve().then(()=>ze);return{getPitchedKey:O}},void 0),G=E(D,R,s.historicalPitchedData.bossName,s.historicalPitchedData.itemName,s.historicalPitchedData.weekKey);j.setPitchedChecked(O=>({...O,[G]:!0})),await j.refreshPitchedItems(l),await f.refreshHistoricalAnalysis(),s.setShowHistoricalPitchedModal(!1)}else console.error("âŒ Failed to save historical pitched item:",F.error),g("Failed to save historical pitched item: "+(F.error||"Unknown error"))}catch(R){console.error("âŒ Error in historical pitched item save:",R),g("Error saving historical pitched item: "+R.message)}}})})]})]}):e.jsx("div",{className:"weekly-tracker-no-characters",children:e.jsx("div",{className:`weekly-tracker-no-characters-message ${S?"visible":""}`,children:"No characters found. Go back and add a character first."})})}function dt(){const{navigate:t}=ye(),{userCode:a,isLoggedIn:r,handleDeleteAccount:c}=he(),{characterBossSelections:l,checked:L,setChecked:T,fullUserData:d,weekKey:$,preservingCheckedStateRef:y}=xe(),[h,w]=o.useState(!1),[W,N]=o.useState(!1),[g,S]=o.useState(""),[_,I]=o.useState(!1);if(!r)return t("/login",{replace:!0}),null;const B=async()=>{I(!0),S("");try{const k=await c();k.success?(N(!1),t("/login",{replace:!0})):S(k.error)}catch(k){S("Failed to delete account. Try again."),console.error("Delete error:",k)}finally{I(!1)}};return e.jsxs("div",{className:"page-container",children:[e.jsx(be,{currentPage:"weeklytracker",onShowHelp:()=>w(!0),onShowDeleteConfirm:()=>N(!0)}),e.jsx(ke,{children:e.jsx(et,{characterBossSelections:l,bossData:je,checked:L,setChecked:T,userCode:a,fullUserData:d,weekKey:$,preservingCheckedStateRef:y})}),h&&e.jsx("div",{className:"modal-backdrop",onClick:()=>w(!1),children:e.jsxs("div",{className:"modal-fade modal-content",onClick:k=>k.stopPropagation(),children:[e.jsx("button",{onClick:()=>w(!1),className:"modal-close-btn",title:"Close",children:"Ã—"}),e.jsx("h2",{className:"modal-title",children:"Help & FAQ"}),e.jsxs("div",{className:"modal-section-content",style:{marginBottom:24},children:[e.jsx("h3",{className:"modal-section-title",children:"Weekly Tracking"}),e.jsx("p",{children:"Track your boss completions and see your weekly mesos progress"}),e.jsx("p",{children:"Check off bosses as you complete them throughout the week"}),e.jsx("p",{children:"Click on pitched item icons to track rare drops from bosses"})]}),e.jsxs("div",{className:"modal-section-content",style:{marginBottom:24},children:[e.jsx("h3",{className:"modal-section-title",children:"Pitched Items & Stats"}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Pitched tracking:"})," Click item icons to track rare boss drops"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Historical data:"})," Navigate between weeks to view past progress"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Stats overview:"})," View detailed statistics of all your pitched items"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Character management:"})," Purge data for specific characters if needed"]})]}),e.jsxs("div",{className:"modal-section-content",style:{marginBottom:24},children:[e.jsx("h3",{className:"modal-section-title",children:"Week Navigation"}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Current week:"})," Full editing capabilities for this week's progress"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Historical weeks:"})," View-only mode for past weeks (toggle edit mode if needed)"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Smart navigation:"})," Only shows weeks where you have data"]})]}),e.jsxs("div",{className:"modal-section-content",children:[e.jsx("h3",{className:"modal-section-title",children:"Quick Tips"}),e.jsx("p",{children:'â€¢ Use "Tick All" to quickly mark all bosses completed for a character'}),e.jsx("p",{children:"â€¢ Hide completed characters to focus on remaining work"}),e.jsx("p",{children:"â€¢ Weekly reset happens every Thursday at 00:00 UTC"}),e.jsx("p",{children:"â€¢ Pitched items are automatically linked to boss completions"})]})]})}),W&&e.jsx("div",{className:"modal-backdrop modal-backdrop-critical",onClick:()=>N(!1),children:e.jsxs("div",{className:"modal-fade modal-content-critical",onClick:k=>k.stopPropagation(),children:[e.jsx("div",{className:"critical-modal-icon",children:e.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z",stroke:"#fff",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})})}),e.jsx("h2",{className:"critical-modal-title",children:"Delete Account"}),e.jsx("div",{className:"critical-modal-warning",children:e.jsxs("p",{children:[e.jsx("strong",{children:"This will permanently delete your account and all associated data."}),e.jsx("br",{}),"This action cannot be undone."]})}),e.jsxs("div",{className:"modal-button-container",children:[e.jsx("button",{onClick:()=>N(!1),disabled:_,className:"modal-btn-cancel",children:"Cancel"}),e.jsxs("button",{onClick:B,disabled:_,className:"modal-btn-critical",children:[_&&e.jsx("div",{className:"loading-spinner"}),_?"Deleting...":"Delete Forever"]})]}),g&&e.jsx("div",{className:"modal-error-message",children:g})]})})]})}export{dt as default};
