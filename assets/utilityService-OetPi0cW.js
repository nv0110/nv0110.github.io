const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-ChAGxcO2.js","assets/vendor-ui-aK89YfOw.js","assets/vendor-router-Cg8TMqY4.js","assets/vendor-react-eWEExxYH.js","assets/vendor-supabase-B7S7y5aO.js","assets/index-cPECv1Lb.css"])))=>i.map(i=>d[i]);
import{_ as A}from"./vendor-supabase-B7S7y5aO.js";import{s as _,c as b,l as D}from"./index-ChAGxcO2.js";import"./vendor-react-eWEExxYH.js";import"./vendor-ui-aK89YfOw.js";import"./vendor-router-Cg8TMqY4.js";async function O(r){try{if(!r)return console.log("No user code provided for getHistoricalWeekAnalysis"),{success:!1,error:"No user code provided"};const{getCurrentWeekKey:e}=await A(async()=>{const{getCurrentWeekKey:u}=await import("./index-ChAGxcO2.js").then(f=>f.w);return{getCurrentWeekKey:u}},__vite__mapDeps([0,1,2,3,4,5])),t=e(),s=new Set,{data:o,error:a}=await _.from("user_boss_data").select("maple_week_start, weekly_clears").eq("user_id",r);if(a&&a.code!=="PGRST116")return console.error("Error fetching user_boss_data for historical analysis:",a),{success:!1,error:a.message};const{data:c,error:n}=await _.from("user_data").select("pitched_items").eq("id",r).single();n&&n.code!=="PGRST116"&&console.error("Error fetching user_data for historical analysis:",n),c!=null&&c.pitched_items&&Array.isArray(c.pitched_items)&&c.pitched_items.forEach(u=>{if(u.date){const f=b(u.date);f&&f!==t&&s.add(f)}}),o&&Array.isArray(o)&&o.forEach(u=>{if(u.maple_week_start&&u.weekly_clears&&Object.keys(u.weekly_clears).length>0){const f=b(u.maple_week_start);f&&f!==t&&s.add(f)}});const d=Array.from(s).sort((u,f)=>{const g=h=>{const l=h.split("-");return l.length===2?{year:parseInt(l[0]),week:parseInt(l[1])}:l.length===3?{year:parseInt(l[0]),week:parseInt(l[1])}:{year:0,week:0}},w=g(u),i=g(f);return w.year!==i.year?w.year-i.year:w.week-i.week}),p=d.length>0;let m=null,y="new",k=8;if(p){m=d[0];const{getWeekOffset:u}=await A(async()=>{const{getWeekOffset:w}=await import("./index-ChAGxcO2.js").then(i=>i.w);return{getWeekOffset:w}},__vite__mapDeps([0,1,2,3,4,5])),f=u(m),g=Math.abs(f);g>8&&(y="existing",k=g)}return{success:!0,hasHistoricalData:p,oldestHistoricalWeek:m,historicalWeeks:d,totalHistoricalWeeks:d.length,userType:y,adaptiveWeekLimit:k,currentWeek:t,analysis:{pitchedItemsCount:c!=null&&c.pitched_items?c.pitched_items.length:0,userBossDataCount:o?o.length:0,weeksWithData:d.length+1}}}catch(e){return console.error("Error in getHistoricalWeekAnalysis:",e),{success:!1,error:e.message}}}async function x(r,e){var t;try{if(!r||!e)return console.log("No user code or character name provided for character-specific getHistoricalWeekAnalysis"),{success:!1,error:"No user code or character name provided"};const{getCurrentWeekKey:s}=await A(async()=>{const{getCurrentWeekKey:i}=await import("./index-ChAGxcO2.js").then(h=>h.w);return{getCurrentWeekKey:i}},__vite__mapDeps([0,1,2,3,4,5])),o=s(),a=new Set,{data:c,error:n}=await _.from("user_boss_data").select("maple_week_start, weekly_clears").eq("user_id",r);if(n&&n.code!=="PGRST116")return console.error("Error fetching user_boss_data for character historical analysis:",n),{success:!1,error:n.message};const{data:d,error:p}=await _.from("user_data").select("pitched_items").eq("id",r).single();p&&p.code!=="PGRST116"&&console.error("Error fetching user_data for character historical analysis:",p),d!=null&&d.pitched_items&&Array.isArray(d.pitched_items)&&d.pitched_items.filter(i=>i.charId===e).forEach(i=>{if(i.date){const h=b(i.date);h&&h!==o&&a.add(h)}}),c&&Array.isArray(c)&&c.forEach(i=>{if(i.maple_week_start&&i.weekly_clears&&Object.keys(i.weekly_clears).length>0&&Object.keys(i.weekly_clears).some(l=>l.includes(e))){const l=b(i.maple_week_start);l&&l!==o&&a.add(l)}});const m=Array.from(a).sort((i,h)=>{const l=v=>{const E=v.split("-");return E.length===2?{year:parseInt(E[0]),week:parseInt(E[1])}:E.length===3?{year:parseInt(E[0]),week:parseInt(E[1])}:{year:0,week:0}},W=l(i),I=l(h);return W.year!==I.year?W.year-I.year:W.week-I.week}),y=m.length>0;let k=null,u="new",f=8;if(y){k=m[0];const{getWeekOffset:i}=await A(async()=>{const{getWeekOffset:W}=await import("./index-ChAGxcO2.js").then(I=>I.w);return{getWeekOffset:W}},__vite__mapDeps([0,1,2,3,4,5])),h=i(k),l=Math.abs(h);l>8&&(u="existing",f=l)}const g=((t=d==null?void 0:d.pitched_items)==null?void 0:t.filter(i=>i.charId===e))||[],w=(c==null?void 0:c.filter(i=>i.weekly_clears&&Object.keys(i.weekly_clears).some(h=>h.includes(e))))||[];return{success:!0,hasHistoricalData:y,oldestHistoricalWeek:k,historicalWeeks:m,totalHistoricalWeeks:m.length,userType:u,adaptiveWeekLimit:f,currentWeek:o,characterName:e,analysis:{pitchedItemsCount:g.length,userBossDataCount:w.length,weeksWithData:m.length+1}}}catch(s){return console.error("Error in getCharacterHistoricalWeekAnalysis:",s),{success:!1,error:s.message}}}function U(r,e,t,s){const o={...r};return Object.keys(o).forEach(a=>{a.startsWith(`${e}-${t}__`)&&a.endsWith(`__${s}`)&&delete o[a]}),o}async function B(r){var e;try{if(!r)return{success:!1,error:"User code is required"};const{data:t,error:s}=await _.from("user_data").select("data").eq("id",r).single();if(s)throw console.error("Error fetching audit history:",s),s;const a=(((e=t.data)==null?void 0:e.pitched_reset_history)||[]).sort((c,n)=>new Date(n.timestamp)-new Date(c.timestamp));return{success:!0,history:a,totalResets:a.length}}catch(t){return console.error("Error getting pitched reset audit history:",t),{success:!1,error:t.message||"Unknown error occurred"}}}async function G(r){try{if(!r)return console.error("Missing required field: userCode"),{success:!1,error:"Missing required field: userCode"};let e=0,t=0;const{data:s,error:o}=await _.from("user_data").select("data, pitched_items").eq("id",r).single();if(o&&o.code!=="PGRST116")throw console.error("Error fetching user data:",o),o;if(s){const n=s.data||{};e=(s.pitched_items||[]).length;const p=new Date().toISOString(),m={timestamp:p,action:"complete_stats_reset",itemsRemoved:e,userAgent:typeof navigator<"u"?navigator.userAgent:"Server"},y={...n,lastUpdated:p,pitched_reset_history:[...n.pitched_reset_history||[],m].slice(-50)};await _.from("user_data").update({pitched_items:[],data:y}).eq("id",r)}const{data:a,error:c}=await _.from("user_boss_data").select("id").eq("user_id",r);if(c&&c.code!=="PGRST116")console.warn("Error fetching user_boss_data:",c);else if(a&&a.length>0){t=a.length;const{error:n}=await _.from("user_boss_data").delete().eq("user_id",r);if(n)throw console.error("Error clearing user_boss_data:",n),n}return{success:!0,itemsRemoved:e,userBossDataRemoved:t,totalEntriesRemoved:e+t}}catch(e){return console.error("Error in complete stats reset:",e),{success:!1,error:e.message||"Unknown error occurred"}}}async function K(r,e,t){try{if(!r||!e)return{success:!1,error:"Missing required parameters"};const s=await R(),{data:o,error:a}=await s.from("user_data").select("pitched_items").eq("id",r).single();if(a&&a.code!=="PGRST116")throw a;const c=(o==null?void 0:o.pitched_items)||[],n=c.filter(p=>p.charId!==e),d=c.length-n.length;return await s.from("user_data").update({pitched_items:n}).eq("id",r),{success:!0,removedCount:d,message:`Removed ${d} pitched items for character ${e}`}}catch(s){return D.error("Error purging pitched records:",s),{success:!1,error:s.message||"Unknown error occurred"}}}async function L(r){try{const{data:e,error:t}=await _.from("user_boss_data").select("*").eq("user_id",r);if(t&&t.code!=="PGRST116")throw t;const{data:s,error:o}=await _.from("user_data").select("pitched_items").eq("id",r).single();return o&&o.code!=="PGRST116"&&console.warn("Could not fetch pitched items:",o),{success:!0,data:{user_boss_data:e||[],pitched_items:(s==null?void 0:s.pitched_items)||[],exportDate:new Date().toISOString(),dataVersion:"3.0"}}}catch(e){return console.error("Error exporting user data:",e),{success:!1,error:e}}}async function V(r,e){try{if(!e||typeof e!="object")throw new Error("Invalid import object");if(e.dataVersion!=="3.0")throw new Error("Unsupported data format. Please export from a newer version.");const{user_boss_data:t,pitched_items:s}=e;if(await _.from("user_boss_data").delete().eq("user_id",r),t&&Array.isArray(t)&&t.length>0){const o=t.map(a=>({...a,user_id:r}));await _.from("user_boss_data").insert(o)}if(s&&Array.isArray(s)){const o=s.filter(a=>a&&typeof a=="object"&&a.charId&&a.item&&a.date);await _.from("user_data").upsert({id:r,pitched_items:o})}return console.log(`[Import] Successfully imported v3.0 data for user '${r}'`),{success:!0,message:"Data imported successfully"}}catch(t){return console.error("Error importing user data:",t),{success:!1,error:t.message||"Import failed"}}}async function R(){const{supabase:r}=await A(async()=>{const{supabase:e}=await import("./index-ChAGxcO2.js").then(t=>t.k);return{supabase:e}},__vite__mapDeps([0,1,2,3,4,5]));return r}export{U as clearCharacterPitchedUI,L as exportUserData,x as getCharacterHistoricalWeekAnalysis,O as getHistoricalWeekAnalysis,B as getPitchedResetAuditHistory,V as importUserData,G as purgeAllStatsData,K as purgePitchedRecords};
