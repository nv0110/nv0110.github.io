const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Bn-fR1GA.js","assets/vendor-ui-aK89YfOw.js","assets/vendor-router-Cg8TMqY4.js","assets/vendor-react-eWEExxYH.js","assets/vendor-supabase-B7S7y5aO.js","assets/index-RHCjBdfQ.css","assets/userWeeklyDataService-C8wIP6so.js","assets/mapleWeekUtils-Bm65Nri8.js","assets/bossRegistryService-D2AJ6cD9.js","assets/bossCodeMapping-BogtXRsN.js"])))=>i.map(i=>d[i]);
import{j as e}from"./vendor-ui-aK89YfOw.js";import{r as o,c as Fe}from"./vendor-router-Cg8TMqY4.js";import{s as ce,c as de,g as Ke,d as Ce,p as Ge,e as De,f as xe,l as m,h as Se,i as we,M as Ye,u as Pe,b as We,S as me,j as Ee,a as Ue,N as Le,V as Ve,H as ze,W as qe,D as Ze}from"./index-Bn-fR1GA.js";import{_ as se}from"./vendor-supabase-B7S7y5aO.js";import{C as Je}from"./CustomCheckbox-C2-rm8qf.js";import{getBossPitchedItems as ye}from"./bossRegistryService-D2AJ6cD9.js";import{getCharacterHistoricalWeekAnalysis as Xe,getHistoricalWeekAnalysis as Qe,purgeAllStatsData as et,clearCharacterPitchedUI as tt,purgePitchedRecords as st,getPitchedResetAuditHistory as rt}from"./utilityService-BV3fzLKv.js";import{getBossRegistryId as at}from"./bossCodeMapping-BogtXRsN.js";import{getCurrentMapleWeekStartDate as it}from"./mapleWeekUtils-Bm65Nri8.js";import{fetchCurrentWeekData as Ie,addCharacterToWeeklySetup as ot,removeCharacterFromWeeklySetup as nt,updateCharacterNameInWeeklySetup as ct,updateCharacterBossConfigInWeeklySetup as lt,saveOrUpdateUserWeeklyData as dt,fetchUserWeeklyData as ht}from"./userWeeklyDataService-C8wIP6so.js";import"./vendor-react-eWEExxYH.js";async function Te(t,i){try{if(!t||!i)return{success:!1,error:"Missing required parameters: userId and pitchedItemData"};const{charId:r,bossName:s,item:d}=i;if(!r||!s||!d)return{success:!1,error:"Missing required fields: charId, bossName, item"};const{data:g,error:v}=await ce.from("user_data").select("pitched_items").eq("id",t).single();if(v)return console.error("Error fetching user data for pitched items:",v),{success:!1,error:"Failed to fetch user data"};if(!g)return{success:!1,error:"User not found"};const k={charId:r.trim(),bossName:s.trim(),item:d.trim(),date:i.date||new Date().toISOString().split("T")[0]},l=[...g.pitched_items||[],k],{error:p}=await ce.from("user_data").update({pitched_items:l}).eq("id",t);return p?(console.error("Error adding pitched item:",p),{success:!1,error:"Failed to add pitched item"}):{success:!0,pitchedItem:k}}catch(r){return console.error("Error in addPitchedItem:",r),{success:!1,error:r.message}}}async function $e(t,i,r,s,d=null){try{if(!t||!i||!r||!s)return{success:!1,error:"Missing required parameters: userId, charId, bossName, and item"};const{data:g,error:v}=await ce.from("user_data").select("pitched_items").eq("id",t).single();if(v)return console.error("Error fetching user data for pitched item removal:",v),{success:!1,error:"Failed to fetch user data"};if(!g)return{success:!1,error:"User not found"};const k=g.pitched_items||[];let N;if(d)N=k.filter(p=>!(p.charId===i&&p.bossName===r&&p.item===s&&p.date===d));else{const p=k.findLastIndex(w=>w.charId===i&&w.bossName===r&&w.item===s);if(p===-1)return{success:!1,error:"Pitched item not found"};N=k.filter((w,_)=>_!==p)}if(N.length===k.length)return{success:!1,error:"Pitched item not found"};const{error:l}=await ce.from("user_data").update({pitched_items:N}).eq("id",t);return l?(console.error("Error removing pitched item:",l),{success:!1,error:"Failed to remove pitched item"}):{success:!0}}catch(g){return console.error("Error in removePitchedItem:",g),{success:!1,error:g.message}}}async function Me(t,i){try{if(!t||!Array.isArray(i)||i.length===0)return{success:!1,error:"Missing required parameters or empty items array"};const{data:r,error:s}=await ce.from("user_data").select("pitched_items").eq("id",t).single();if(s)return console.error("Error fetching user data for bulk removal:",s),{success:!1,error:"Failed to fetch user data"};if(!r)return{success:!1,error:"User not found"};const d=r.pitched_items||[];let g=[...d];i.forEach(({charId:N,item:l,date:p})=>{if(p)g=g.filter(w=>!(w.charId===N&&w.item===l&&w.date===p));else{const w=g.findLastIndex(_=>_.charId===N&&_.item===l);w!==-1&&g.splice(w,1)}});const v=d.length-g.length;if(v===0)return{success:!1,error:"No matching pitched items found"};const{error:k}=await ce.from("user_data").update({pitched_items:g}).eq("id",t);return k?(console.error("Error removing multiple pitched items:",k),{success:!1,error:"Failed to remove pitched items"}):{success:!0,removedCount:v}}catch(r){return console.error("Error in removeManyPitchedItems:",r),{success:!1,error:r.message}}}async function be(t,i={}){try{if(!t)return{success:!1,error:"Missing required parameter: userId"};const{weekKey:r,charId:s,year:d}=i,{data:g,error:v}=await ce.from("user_data").select("pitched_items").eq("id",t).single();if(v)return console.error("Error fetching pitched items:",v),{success:!1,error:"Failed to fetch pitched items"};if(!g)return{success:!1,error:"User not found"};let k=g.pitched_items||[];return r&&(k=k.filter(N=>de(N.date)===r)),s&&(k=k.filter(N=>N.charId===s)),d&&(k=k.filter(N=>new Date(N.date).getFullYear()===d)),{success:!0,items:k}}catch(r){return console.error("Error in getPitchedItems:",r),{success:!1,error:r.message}}}async function Re(t,i){try{if(!t||!i)return{success:!1,error:"Missing required parameters: userId and weekKey"};const{data:r,error:s}=await ce.from("user_data").select("pitched_items").eq("id",t).single();if(s)return console.error("Error fetching user data for week clear:",s),{success:!1,error:"Failed to fetch user data"};if(!r)return{success:!1,error:"User not found"};const d=r.pitched_items||[],g=d.filter(N=>de(N.date)!==i),v=d.length-g.length;if(v===0)return{success:!0,removedCount:0};const{error:k}=await ce.from("user_data").update({pitched_items:g}).eq("id",t);return k?(console.error("Error clearing week pitched items:",k),{success:!1,error:"Failed to clear week pitched items"}):{success:!0,removedCount:v}}catch(r){return console.error("Error in clearPitchedItemsForWeek:",r),{success:!1,error:r.message}}}async function je(t,i=null){try{if(!t)return{success:!1,error:"Missing required parameter: userId"};const r=i?parseInt(i,10):new Date().getFullYear(),s=await be(t,{year:r});if(!s.success)return s;const d=s.items,g={total:d.length,characters:new Set,items:[]};return d.forEach(k=>{g.characters.add(k.charId),g.items.push({charId:k.charId,item:k.item,date:k.date})}),{success:!0,stats:{year:r,total:g.total,characters:Array.from(g.characters),items:g.items}}}catch(r){return console.error("Error in getYearlyPitchedStats:",r),{success:!1,error:r.message}}}async function He(t){try{if(!t)return{success:!1,error:"Missing required parameter: userId"};const i=await be(t,{});if(!i.success)return i;const r=i.items.length;if(r===0)return{success:!0,removedCount:0};const{error:s}=await ce.from("user_data").update({pitched_items:[]}).eq("id",t);return s?(console.error("Error purging all pitched items:",s),{success:!1,error:"Failed to purge pitched items"}):{success:!0,removedCount:r}}catch(i){return console.error("Error in purgeAllPitchedItems:",i),{success:!1,error:i.message}}}const pe=Object.freeze(Object.defineProperty({__proto__:null,addPitchedItem:Te,clearPitchedItemsForWeek:Re,getPitchedItems:be,getYearlyPitchedStats:je,purgeAllPitchedItems:He,removeManyPitchedItems:Me,removePitchedItem:$e},Symbol.toStringTag,{value:"Module"}));function mt({appWeekKey:t,selectedWeekKey:i,onWeekChange:r,historicalAnalysis:s={hasHistoricalData:!1,oldestHistoricalWeek:null,userType:"new",adaptiveWeekLimit:8,historicalWeeks:[]}}){const[d,g]=o.useState(!1);o.useEffect(()=>{const a=()=>{g(window.innerWidth<=768)};return a(),window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]);const v=o.useMemo(()=>{const n=(s==null?void 0:s.adaptiveWeekLimit)||8;return{min:-n,max:0,current:0,adaptiveLimit:n}},[s,t]),k=o.useMemo(()=>Ke(i,t),[i,t]),N=o.useCallback(a=>{a!==i&&r(a)},[i,r]),l=()=>{const a=k-1;if(a>=v.min){const n=Ce(a,t);N(n)}},p=()=>{const a=k+1;if(a<=v.max){const n=Ce(a,t);N(n)}},w=o.useCallback(()=>{if(s!=null&&s.hasHistoricalData&&(s!=null&&s.oldestHistoricalWeek))N(s.oldestHistoricalWeek);else{const a=Ce(-v.adaptiveLimit,t);N(a)}},[s,v.adaptiveLimit,t,N]),_=()=>{N(t)},L=k>v.min,S=k<v.max,C=(s==null?void 0:s.hasHistoricalData)||k>-v.adaptiveLimit,I=i===t,c=o.useMemo(()=>{const a=Ge(i),n=De(i);return{label:xe(i,t),parsed:a,dateRange:n,isSelectedWeekTheCurrentAppWeek:I,offset:k}},[i,t,I,k]);return o.useEffect(()=>{const a=!I,n=(s==null?void 0:s.hasHistoricalData)&&(s==null?void 0:s.oldestHistoricalWeek)&&i!==s.oldestHistoricalWeek&&!I;m.debug("WeekNavigator: Button visibility debug",{selectedWeekKey:i,appWeekKey:t,isSelectedWeekTheCurrentAppWeek:I,currentBtnVisible:a,oldestBtnVisible:n,historicalAnalysis:{hasHistoricalData:s==null?void 0:s.hasHistoricalData,oldestHistoricalWeek:s==null?void 0:s.oldestHistoricalWeek,userType:s==null?void 0:s.userType,adaptiveWeekLimit:s==null?void 0:s.adaptiveWeekLimit}})},[i,t,I,s]),e.jsx("div",{className:"week-navigator-wrapper",children:e.jsxs("div",{className:"week-navigator-container",children:[e.jsx("div",{className:"week-navigator-header",children:e.jsxs("div",{className:`week-navigator-title ${I?"current-week":"historical-week"}`,children:[e.jsx("span",{className:"week-title-text",children:c.label.replace(/\s*\(Current\)/i,"")}),I&&e.jsx("span",{className:"week-navigator-current-dot",children:e.jsx("span",{className:"week-navigator-current-dot-inner"})})]})}),e.jsxs("div",{className:"week-navigator-navigation",children:[e.jsx("div",{className:`week-navigator-arrow-container ${L?"enabled arrow-left":"disabled"}`,onClick:L?l:void 0,title:L?"Previous Week":`Already at oldest allowed week (${v.adaptiveLimit} weeks back from current)`,children:e.jsx("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:`week-navigator-arrow arrow-left ${L?"enabled":"disabled"}`,children:e.jsx("path",{d:"M20.3284 11.0001V13.0001L7.50011 13.0001L10.7426 16.2426L9.32842 17.6568L3.67157 12L9.32842 6.34314L10.7426 7.75735L7.49988 11.0001L20.3284 11.0001Z",fill:"currentColor"})})}),e.jsxs("div",{className:"week-navigator-center-content",children:[c.dateRange&&e.jsxs("div",{className:"week-navigator-date-range",children:[c.dateRange.start.toLocaleDateString()," - ",c.dateRange.end.toLocaleDateString()]}),e.jsxs("div",{className:"week-navigator-integrated-buttons",children:[e.jsxs("button",{onClick:_,className:`week-navigator-integrated-btn current-week-btn ${I?"hidden":"visible"}`,title:"Jump to current application week",disabled:I,children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z",fill:"currentColor"})}),"Current"]}),e.jsxs("button",{onClick:w,className:`week-navigator-integrated-btn oldest-data-btn ${s!=null&&s.hasHistoricalData&&(s!=null&&s.oldestHistoricalWeek)&&i!==s.oldestHistoricalWeek&&!I?"visible":"hidden"}`,title:`Jump to oldest recorded data (${s!=null&&s.oldestHistoricalWeek?xe(s.oldestHistoricalWeek,t):"oldest data"})`,disabled:!(s!=null&&s.hasHistoricalData&&(s!=null&&s.oldestHistoricalWeek)&&i!==s.oldestHistoricalWeek&&!I),children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M3 12H21M3 6H21M3 18H21",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})}),"Oldest"]})]})]}),e.jsx("div",{className:`week-navigator-arrow-container ${I?C?"enabled arrow-right":"disabled":S?"enabled arrow-right":"disabled"}`,onClick:I?C?w:void 0:S?p:void 0,title:I?C?s!=null&&s.hasHistoricalData&&(s!=null&&s.oldestHistoricalWeek)?`Jump to oldest data (${xe(s.oldestHistoricalWeek,t)})`:`Jump to ${v.adaptiveLimit} weeks back`:"No older data available to jump to":S?"Next Week":"Already at current application week",children:e.jsx("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:`week-navigator-arrow arrow-right ${I?C?"enabled":"disabled":S?"enabled":"disabled"}`,children:e.jsx("path",{d:"M15.0378 6.34317L13.6269 7.76069L16.8972 11.0157L3.29211 11.0293L3.29413 13.0293L16.8619 13.0157L13.6467 16.2459L15.0643 17.6568L20.7079 11.9868L15.0378 6.34317Z",fill:"currentColor"})})})]}),!I&&e.jsx("div",{className:"week-navigator-floating-actions week-navigator-floating-left",children:e.jsx("button",{onClick:_,className:"week-navigator-floating-btn",title:"Jump to current week",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z",fill:"currentColor"})})})}),(s==null?void 0:s.hasHistoricalData)&&(s==null?void 0:s.oldestHistoricalWeek)&&i!==s.oldestHistoricalWeek&&e.jsx("div",{className:"week-navigator-floating-actions week-navigator-floating-right",children:e.jsx("button",{onClick:w,className:"week-navigator-floating-btn",title:`Jump to oldest data (${xe(s.oldestHistoricalWeek,t)})`,children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M3 12H21M3 6H21M3 18H21",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})})})]},i)})}function ge(t){if(t===0)return"0";if(t<1e9){const r=t/1e6;if(r<1){const s=t/1e3;return s<1?t.toString():`${s.toFixed(1)}K`}return`${r.toFixed(1)}M`}return`${(t/1e9).toFixed(1)}B`}const ut=(t=[])=>{const[i,r]=o.useState(!1),s=o.useRef(null);return o.useEffect(()=>{const d=s.current;if(!d)return;const g=()=>{const k=d.scrollHeight>d.clientHeight,N=d.scrollTop<=5;r(k&&N)},v=()=>{g()};return g(),d.addEventListener("scroll",v),()=>{d.removeEventListener("scroll",v)}},t),{showIndicator:i,elementRef:s}},ft=({show:t,className:i=""})=>e.jsx("div",{className:`scroll-indicator ${t?"visible":"hidden"} ${i}`,children:e.jsx("svg",{width:"30",height:"30",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M7 10L12 15L17 10",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}),gt=Fe.memo(function({sidebarVisible:i,setSidebarVisible:r,isHistoricalWeek:s,totalMeso:d,obtainableMeso:g,selectedWeekKey:v,hideCompleted:k,setHideCompleted:N,visibleCharSummaries:l,selectedCharIdx:p,setSelectedCharIdx:w,setPurgeTargetCharacter:_,setShowCharacterPurgeConfirm:L,setShowCharacterPitchedModal:S,onShowTreasureAnalytics:C,characterBossSelections:I,showOnboardingIndicators:c}){const[a,n]=o.useState(!1),[h,f]=o.useState(!1),[u,y]=o.useState(!1),{showIndicator:x,elementRef:b}=ut([l,i]);o.useEffect(()=>{const j=()=>{const $=window.innerWidth;n($<=768),f($<=480)};return j(),window.addEventListener("resize",j),()=>window.removeEventListener("resize",j)},[]),o.useEffect(()=>{if(!a)return;const j=$=>{i&&!$.target.closest(".sidebar-scroll")&&!$.target.closest(".sidebar-toggle")&&!$.target.closest(".sidebar-mobile-fab")&&r&&r(!1)};return document.addEventListener("click",j),()=>document.removeEventListener("click",j)},[a,i,r]);const D=o.useCallback((j,$)=>{j.stopPropagation(),w($.idx),S&&S(!0)},[w,S]),B=o.useCallback(j=>{w(j),h&&i&&r&&setTimeout(()=>r(!1),300)},[w,h,i,r]),E=o.useCallback((j,$)=>{j.preventDefault(),_({name:$.name,idx:$.idx}),L(!0)},[_,L]),W=o.useCallback(()=>{y(j=>!j)},[]);return e.jsxs(e.Fragment,{children:[a&&i&&e.jsx("div",{className:"sidebar-mobile-overlay",onClick:()=>r&&r(!1)}),h&&!i&&e.jsxs("button",{className:"sidebar-mobile-fab",onClick:()=>r&&r(!0),title:"Open character sidebar",children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7.75735 13.2574L2 9.27L8.91 8.26L12 2Z",fill:"currentColor"})}),e.jsx("span",{className:"sidebar-mobile-fab-badge",children:l.length})]}),e.jsx("div",{className:`sidebar-scroll fade-in-no-slide ${i?"visible":"hidden"} ${a?"mobile":"desktop"} ${h?"very-small":""}`,children:e.jsxs("div",{className:"sidebar-content",children:[a&&e.jsx("button",{className:"sidebar-mobile-close",onClick:()=>r&&r(!1),title:"Close sidebar",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M6 18L18 6M6 6L18 18",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})}),e.jsx("div",{className:"sidebar-header",children:e.jsx("h3",{className:`sidebar-title ${c?"onboarding-highlight":""}`,onClick:C,title:"View logged item analytics across all characters",children:"Characters"})}),!s&&e.jsx("div",{className:`sidebar-progress-section premium-progress ${c?"onboarding-highlight":""}`,onClick:W,children:u?l[p]&&e.jsxs("div",{className:"sidebar-progress-container sidebar-progress-character",children:[e.jsxs("div",{className:"sidebar-progress-title",children:[l[p].name,"'s Weekly"]}),e.jsx("div",{className:"sidebar-progress-track week-navigator-progress-bar-container",children:e.jsx("div",{className:"sidebar-progress-fill week-navigator-progress-bar",style:{width:`${(()=>{const j=l[p];if(!j)return 0;`${j.name}${j.idx}`;const $=I[j.idx];if(!$)return 0;const Q=$.bosses.reduce((z,q)=>z+Math.ceil((q.price||0)/(q.partySize||1)),0);return Q>0?Math.min(j.totalMeso/Q*100,100):0})()}%`},children:l[p].totalMeso>0&&e.jsx("div",{className:"week-navigator-progress-shimmer"})})}),e.jsxs("div",{className:"sidebar-progress-numbers",children:[e.jsx("span",{children:ge(l[p].totalMeso)}),e.jsx("span",{children:ge((()=>{const j=l[p];if(!j)return 0;const $=I[j.idx];return $?$.bosses.reduce((Q,z)=>Q+Math.ceil((z.price||0)/(z.partySize||1)),0):0})())})]})]}):e.jsxs("div",{className:"sidebar-progress-container sidebar-progress-weekly",children:[e.jsx("div",{className:"sidebar-progress-title",children:"Weekly Progress"}),e.jsx("div",{className:"sidebar-progress-track week-navigator-progress-bar-container",children:e.jsx("div",{className:"sidebar-progress-fill week-navigator-progress-bar",style:{width:`${g>0?Math.min(d/g*100,100):0}%`},children:g>0&&d>0&&e.jsx("div",{className:"week-navigator-progress-shimmer"})})}),e.jsxs("div",{className:"sidebar-progress-numbers",children:[e.jsx("span",{children:ge(d)}),e.jsx("span",{children:ge(g)})]})]})}),s&&e.jsxs("div",{className:"sidebar-historical-section",children:[e.jsxs("div",{className:"sidebar-historical-title",children:["Week ",v.split("-").slice(1).join("-")]}),e.jsx("div",{className:"sidebar-historical-subtitle",children:"Historical Data"})]}),e.jsxs("div",{className:"sidebar-character-list-container",children:[e.jsx("div",{className:"sidebar-character-list",ref:b,children:l.length===0?e.jsx("div",{className:"sidebar-empty-state",children:k?"No characters with bosses left to clear.":"No characters found."}):l.map(j=>e.jsxs("div",{onClick:()=>B(j.idx),onContextMenu:$=>E($,j),className:`sidebar-character-card ${p===j.idx?`selected ${s?"historical-week":"current-week"}`:"default"}`,children:[e.jsxs("div",{className:"sidebar-character-header",children:[e.jsx("span",{className:`sidebar-character-name ${p===j.idx?"selected":"default"}`,children:j.name}),e.jsxs("div",{className:"sidebar-character-actions",children:[j.allCleared&&e.jsxs("svg",{className:"sidebar-character-checkmark",width:"16",height:"16",viewBox:"0 0 22 22",children:[e.jsx("circle",{cx:"11",cy:"11",r:"11",fill:"#38a169"}),e.jsx("polyline",{points:"6,12 10,16 16,7",fill:"none",stroke:"#fff",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})]}),e.jsx("button",{className:"sidebar-character-pitched-btn",onClick:$=>D($,j),title:"View pitched items",children:e.jsxs("div",{className:"pitched-btn-content",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7.75735 13.2574L2 9.27L8.91 8.26L12 2Z",fill:"url(#starGradient)",stroke:"url(#starStrokeGradient)",strokeWidth:"1.5"}),e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"starGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#a259f7"}),e.jsx("stop",{offset:"1",stopColor:"#805ad5"})]}),e.jsxs("linearGradient",{id:"starStrokeGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#d6b4ff"}),e.jsx("stop",{offset:"1",stopColor:"#a259f7"})]})]})]}),e.jsx("span",{className:"pitched-btn-glow"})]})})]})]}),e.jsx("div",{className:"sidebar-character-stats",children:j.total===0?e.jsx("div",{className:"sidebar-character-no-bosses",children:"No bosses configured"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sidebar-character-completion",children:[j.cleared," / ",j.total," bosses cleared"]}),e.jsxs("div",{className:"sidebar-character-meso",children:[ge(j.totalMeso)," meso"]})]})})]},j.name+"-"+j.idx))}),e.jsx(ft,{show:x})]})]})})]})});function pt({sidebarVisible:t,setSidebarVisible:i}){const[r,s]=o.useState(!1),[d,g]=o.useState(!1);return o.useEffect(()=>{const v=()=>{const k=window.innerWidth;s(k<=768),g(k<=480)};return v(),window.addEventListener("resize",v),()=>window.removeEventListener("resize",v)},[]),d?null:e.jsx("div",{className:`sidebar-toggle ${t?"visible":"hidden"} ${r?"mobile":"desktop"}`,onClick:()=>i(!t),title:t?"Hide sidebar":"Show sidebar",children:t?e.jsxs("svg",{className:"sidebar-toggle-close-icon",width:r?"20":"24",height:r?"20":"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"crossGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#ffffff"}),e.jsx("stop",{offset:"50%",stopColor:"#e6e0ff"}),e.jsx("stop",{offset:"100%",stopColor:"#d6b4ff"})]})}),e.jsx("path",{d:"M6.2253 4.81108C5.83477 4.42056 5.20161 4.42056 4.81108 4.81108C4.42056 5.20161 4.42056 5.83477 4.81108 6.2253L10.5858 12L4.81114 17.7747C4.42062 18.1652 4.42062 18.7984 4.81114 19.1889C5.20167 19.5794 5.83483 19.5794 6.22535 19.1889L12 13.4142L17.7747 19.1889C18.1652 19.5794 18.7984 19.5794 19.1889 19.1889C19.5794 18.7984 19.5794 18.1652 19.1889 17.7747L13.4142 12L19.189 6.2253C19.5795 5.83477 19.5795 5.20161 19.189 4.81108C18.7985 4.42056 18.1653 4.42056 17.7748 4.81108L12 10.5858L6.2253 4.81108Z",fill:"url(#crossGradient)"})]}):e.jsx("div",{className:"sidebar-toggle-hamburger",children:[0,1,2].map(v=>e.jsx("span",{className:"sidebar-toggle-hamburger-line",style:{width:r?"18px":"22px",height:r?"2px":"3px"}},v))})})}function ve(t,i,r,s){return`${t}__${i}__${r}__${s}`}function kt({bosses:t=[],bossData:i=[],checked:r={},characterKey:s="",onBossCheck:d=()=>{},getBossPrice:g=()=>0,showTickAll:v=!1,onTickAll:k=()=>{},allTicked:N=!1,pitchedChecked:l={},onPitchedItemClick:p=()=>{},isHistoricalWeek:w=!1,userCode:_="",selectedWeekKey:L="",selectedCharIdx:S=0,userInteractionRef:C=null,cloudPitchedItems:I=[],characterBossSelections:c=[]}){const[a,n]=o.useState(new Set);if(!t.length||!i.length)return e.jsx("div",{className:"boss-table-container",children:e.jsx("div",{className:"boss-table-loading",children:e.jsx("div",{style:{textAlign:"center",padding:"2rem",color:"#e6e0ff"},children:"Loading boss data..."})})});const h=E=>i.find(W=>W.name===E)||{},f=E=>new Intl.NumberFormat().format(E),u=o.useMemo(()=>s.split("-").slice(0,-1).join("-"),[s]),y=(E,W)=>ye(E,W),x=(E,W,j)=>{if(!u)return!1;const $=ve(u,E,W,j);return!!l[$]},b=(E,W,j,$)=>{var q;const Q=((q=c[S])==null?void 0:q.name)||E,z=ve(Q,W,j,$);return a.has(z)},D=async(E,W,j,$)=>{var G;E.stopPropagation(),C&&(C.current=!0);const Q=((G=c[S])==null?void 0:G.name)||$,z=ve(Q,W.name,j.name,L),q=x(W.name,j.name,L);if(!a.has(z)){if(w){if(q){n(R=>new Set([...R,z]));try{await p({bossName:W.name,itemName:j.name,characterName:Q,weekKey:L,isChecked:q,isHistorical:!0})}finally{n(R=>{const A=new Set(R);return A.delete(z),A})}}return}n(R=>new Set([...R,z]));try{await p({bossName:W.name,itemName:j.name,characterName:Q,weekKey:L,isChecked:q,isHistorical:!1,itemImage:j.image})}finally{n(R=>{const A=new Set(R);return A.delete(z),A})}}},B=(E,W,j)=>{j.target.closest(".boss-pitched-items")||d(E,!W,j)};return e.jsx("div",{className:"boss-table-container",children:e.jsxs("div",{className:"boss-table-grid",children:[e.jsxs("div",{className:"boss-table-header",children:[e.jsx("div",{className:"header-boss",children:"Boss"}),e.jsx("div",{className:"header-difficulty",children:"Difficulty"}),e.jsx("div",{className:"header-mesos",children:"Mesos"}),e.jsxs("div",{className:"header-cleared",children:[v&&e.jsx("button",{onClick:k,className:"header-tick-all-button",title:N?"Clear all boss completions":"Mark all bosses as completed",children:N?"Clear All":"Complete All"}),!v&&"Cleared"]})]}),t.map((E,W)=>{var R;const j=h(E.name),$=`${E.name}-${E.difficulty}`,Q=!!((R=r[s])!=null&&R[$]),z=g(E.name,E.difficulty)/(E.partySize||1),q=y(E.name,E.difficulty),G=u;return e.jsxs("div",{className:`boss-table-row ${W%2===0?"even":"odd"}`,onClick:A=>B(E,Q,A),children:[e.jsxs("div",{className:"cell-boss",children:[e.jsxs("div",{className:"boss-info-section",children:[j.image&&e.jsx("img",{src:j.image,alt:E.name,className:"boss-image"}),e.jsxs("div",{className:"boss-details",children:[e.jsx("span",{className:"boss-name",children:E.name}),E.partySize&&E.partySize>1&&e.jsxs("span",{className:"boss-party-size",children:["Party: ",E.partySize]})]})]}),q.length>0&&e.jsx("div",{className:"boss-pitched-items",onClick:A=>A.stopPropagation(),children:q.map((A,Z)=>{const ee=x(E.name,A.name,L),P=b(G,E.name,A.name,L);return e.jsx("div",{className:`pitched-item-icon ${ee?"checked":"unchecked"} ${w?"historical":""} ${P?"loading":""}`,onClick:ie=>!P&&D(ie,E,A,G),title:P?"Processing...":`${A.name} ${ee?"(Obtained)":"(Click to mark as obtained)"}`,style:{cursor:P?"not-allowed":"pointer",opacity:P?.7:1},children:P?e.jsx("div",{className:"pitched-item-loading",children:e.jsx("div",{className:"loading-spinner-small"})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:A.image,alt:A.name,className:"pitched-item-image"}),ee&&e.jsx("div",{className:"pitched-item-checkmark",children:e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M20 6L9 17L4 12",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round"})})})]})},`${A.name}-${Z}`)})})]}),e.jsx("div",{className:"cell-difficulty",children:E.difficulty}),e.jsx("div",{className:"cell-mesos",children:f(Math.ceil(z))}),e.jsx("div",{className:"cell-cleared",children:e.jsx(Je,{checked:Q,onChange:A=>{A.stopPropagation(),d(E,A.target.checked,A)}})})]},$)})]})})}function xt({bossData:t=[],characterKey:i="",selectedWeekKey:r="",selectedCharIdx:s=0,pitchedChecked:d={},onPitchedItemClick:g=()=>{},userCode:v="",cloudPitchedItems:k=[],characterBossSelections:N=[]}){const[l,p]=o.useState([]),w=o.useMemo(()=>i.split("-").slice(0,-1).join("-"),[i]),_=C=>t.find(I=>I.name===C)||{};o.useEffect(()=>{(async()=>{m.info("HistoricalWeekCards: Loading all bosses with pitched items from registry");const I=[],c=[{boss_name:"Lotus",difficulty:"Hard",drops_pitched:["Black Heart","Berserked"]},{boss_name:"Lotus",difficulty:"Extreme",drops_pitched:["Total Control","Black Heart","Berserked"]},{boss_name:"Damien",difficulty:"Hard",drops_pitched:["Magic Eyepatch"]},{boss_name:"Lucid",difficulty:"Hard",drops_pitched:["Dreamy Belt"]},{boss_name:"Will",difficulty:"Hard",drops_pitched:["Cursed Spellbook"]},{boss_name:"Gloom",difficulty:"Chaos",drops_pitched:["Endless Terror"]},{boss_name:"Darknell",difficulty:"Hard",drops_pitched:["Commanding Force Earring"]},{boss_name:"Verus Hilla",difficulty:"Hard",drops_pitched:["Source of Suffering"]},{boss_name:"Chosen Seren",difficulty:"Hard",drops_pitched:["Mitra's Rage"]},{boss_name:"Chosen Seren",difficulty:"Extreme",drops_pitched:["Mitra's Rage","Gravity Module"]},{boss_name:"Watcher Kalos",difficulty:"Easy",drops_pitched:["Grindstone of Life"]},{boss_name:"Watcher Kalos",difficulty:"Normal",drops_pitched:["Grindstone of Life"]},{boss_name:"Watcher Kalos",difficulty:"Chaos",drops_pitched:["Grindstone of Life"]},{boss_name:"Watcher Kalos",difficulty:"Extreme",drops_pitched:["Grindstone of Life","Mark of Destruction"]},{boss_name:"Kaling",difficulty:"Easy",drops_pitched:["Grindstone of Life"]},{boss_name:"Kaling",difficulty:"Normal",drops_pitched:["Grindstone of Life"]},{boss_name:"Kaling",difficulty:"Hard",drops_pitched:["Grindstone of Life"]},{boss_name:"Kaling",difficulty:"Extreme",drops_pitched:["Grindstone of Life","Helmet of Loyalty"]},{boss_name:"Limbo",difficulty:"Hard",drops_pitched:["Whisper of the Source"]}],a={};for(const n of c)if(n.drops_pitched.length>0){a[n.boss_name]||(a[n.boss_name]={name:n.boss_name,difficulties:[],itemMap:{}}),a[n.boss_name].difficulties.push(n.difficulty);for(const h of n.drops_pitched)a[n.boss_name].itemMap[h]||(a[n.boss_name].itemMap[h]=[]),a[n.boss_name].itemMap[h].push(n.difficulty)}for(const[n,h]of Object.entries(a)){const f=[...new Set(h.difficulties)].sort(),u=[];for(const[y,x]of Object.entries(h.itemMap)){const D=(ye(n)||[]).find(B=>B.name===y)||{};u.push({name:y,image:D.image||"/images/items/default.png",droppingDifficulties:x.sort()})}u.length>0&&(I.push({name:n,items:u,difficultiesThatDropItems:f}),m.info("HistoricalWeekCards: Added boss with registry items",{bossName:n,itemCount:u.length,difficultiesThatDropItems:f,items:u.map(y=>`${y.name} (${y.droppingDifficulties.join(", ")})`)}))}p(I),m.info("HistoricalWeekCards: Total bosses with pitched items loaded from registry:",I.length)})()},[]);const L=(C,I,c)=>{if(!w)return!1;const a=ve(w,C,I,c);return!!d[a]},S=async(C,I,c)=>{var h;C.stopPropagation();const a=((h=N[s])==null?void 0:h.name)||w,n=L(I.name,c.name,r);m.debug("HistoricalWeekCards: Pitched item clicked",{bossName:I.name,itemName:c.name,character:a,weekKey:r,isChecked:n}),await g({bossName:I.name,itemName:c.name,characterName:a,weekKey:r,isChecked:n,isHistorical:!0,itemImage:c.image})};return m.info("HistoricalWeekCards: Rendering with data",{bossesWithItemsCount:l.length,weekKey:r,characterName:w}),l.length?e.jsxs("div",{className:"historical-week-cards",children:[e.jsxs("div",{className:"historical-cards-header",children:[e.jsx("h3",{children:"Historical Week Overview"}),e.jsx("p",{children:"All bosses with droppable items - click on pitched items to add/remove historical drops"})]}),e.jsx("div",{className:"historical-cards-grid",children:l.map((C,I)=>{const c=_(C.name),a=C.name;return e.jsxs("div",{className:"historical-boss-card",children:[e.jsxs("div",{className:"historical-boss-header",children:[c.image&&e.jsx("img",{src:c.image,alt:C.name,className:"historical-boss-image"}),e.jsxs("div",{className:"historical-boss-details",children:[e.jsx("h4",{className:"historical-boss-name",children:C.name}),e.jsxs("span",{className:"historical-boss-difficulties",children:["Available in: ",C.difficultiesThatDropItems.join(", ")]})]})]}),e.jsxs("div",{className:"historical-pitched-section",children:[e.jsxs("div",{className:"historical-pitched-header",children:[e.jsx("span",{children:"Dropped Items"}),e.jsxs("span",{className:"historical-pitched-count",children:[C.items.filter(n=>L(C.name,n.name,r)).length," / ",C.items.length]})]}),e.jsx("div",{className:"historical-pitched-grid",children:C.items.map((n,h)=>{const f=L(C.name,n.name,r);return e.jsxs("div",{className:`historical-pitched-item ${f?"checked":"unchecked"}`,onClick:u=>S(u,C,n),title:`${n.name} - Drops from: ${n.droppingDifficulties.join(", ")} ${f?"(Obtained)":"(Click to mark as obtained)"}`,children:[e.jsx("img",{src:n.image,alt:n.name,className:"historical-pitched-image"}),e.jsxs("div",{className:"historical-pitched-info",children:[e.jsx("span",{className:"historical-pitched-name",children:n.name}),e.jsx("span",{className:"historical-pitched-difficulties",children:n.droppingDifficulties.join(", ")})]}),f&&e.jsx("div",{className:"historical-pitched-checkmark",children:"✓"})]},`${n.name}-${h}`)})})]})]},a)})})]}):e.jsxs("div",{className:"historical-cards-empty",children:[e.jsx("div",{className:"historical-cards-empty-icon",children:"🎁"}),e.jsx("h3",{children:"No Droppable Items"}),e.jsx("p",{children:"No bosses with droppable pitched items found."})]})}function wt({showStats:t,setShowStats:i,allYears:r,selectedYear:s,setSelectedYear:d,groupedYearlyPitchedItems:g,isLoadingCloudStats:v,setShowStatsResetConfirm:k,handleItemDetailClick:N}){if(!t)return null;const l=g.reduce((p,w)=>p+w.count,0);return e.jsx("div",{className:"modal-backdrop stats-modal-backdrop",onClick:()=>i(!1),children:e.jsxs("div",{className:"modern-stats-modal",onClick:p=>p.stopPropagation(),children:[e.jsxs("div",{className:"modern-stats-header",children:[e.jsxs("div",{className:"modern-stats-title-section",children:[e.jsx("h2",{className:"modern-stats-title",children:"Pitched Items Statistics"}),e.jsx("div",{className:"modern-stats-subtitle",children:s})]}),e.jsx("button",{onClick:()=>i(!1),className:"modern-stats-close",title:"Close",children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6 6 18M6 6l12 12"})})})]}),e.jsxs("div",{className:"modern-stats-controls",children:[e.jsxs("div",{className:"modern-year-selector",children:[e.jsx("label",{className:"modern-year-label",children:"Year:"}),e.jsx("select",{value:s,onChange:p=>d(p.target.value),className:"modern-year-select",children:r.map(p=>e.jsx("option",{value:p,children:p},p))})]}),e.jsxs("div",{className:"modern-stats-summary",children:[e.jsxs("div",{className:"modern-stat-card",children:[e.jsx("div",{className:"modern-stat-number",children:g.length}),e.jsx("div",{className:"modern-stat-label",children:"Unique Items"})]}),e.jsxs("div",{className:"modern-stat-card",children:[e.jsx("div",{className:"modern-stat-number",children:l}),e.jsx("div",{className:"modern-stat-label",children:"Total Obtained"})]})]})]}),e.jsx("div",{className:"modern-stats-content",children:v?e.jsxs("div",{className:"modern-stats-loading",children:[e.jsx("div",{className:"modern-loading-spinner"}),e.jsx("span",{children:"Loading statistics..."})]}):g.length===0?e.jsxs("div",{className:"modern-stats-empty",children:[e.jsx("div",{className:"modern-empty-icon",children:"📊"}),e.jsx("div",{className:"modern-empty-title",children:"No Data Yet"}),e.jsx("div",{className:"modern-empty-text",children:"Start clearing bosses to see your pitched item statistics!"})]}):e.jsx("div",{className:"modern-items-grid",children:g.map((p,w)=>e.jsxs("div",{className:"modern-item-card",onClick:()=>N(p),children:[e.jsxs("div",{className:"modern-item-image-container",children:[e.jsx("img",{src:p.itemImage,alt:p.itemName,className:"modern-item-image"}),e.jsx("div",{className:"modern-item-count-badge",children:p.count})]}),e.jsxs("div",{className:"modern-item-info",children:[e.jsx("div",{className:"modern-item-name",children:p.itemName}),e.jsx("div",{className:"modern-item-meta",children:p.count===1?"1 time":`${p.count} times`})]}),e.jsx("div",{className:"modern-item-arrow",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M9 18l6-6-6-6"})})})]},`${p.itemName}-${w}`))})}),e.jsx("div",{className:"modern-stats-footer",children:e.jsxs("button",{className:"modern-reset-button",onClick:()=>k(!0),children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c0-1 1-2 2-2v2"})}),"Reset All Statistics"]})})]})})}function vt({showItemDetailModal:t,setShowItemDetailModal:i,selectedItemDetail:r}){if(!t||!r)return null;const{itemName:s,itemImage:d,count:g,instances:v}=r,k=v.reduce((l,p)=>(l[p.charId]||(l[p.charId]=[]),l[p.charId].push(p),l),{}),N=Object.keys(k).sort();return e.jsx("div",{className:"modal-backdrop item-detail-backdrop",onClick:()=>i(!1),children:e.jsxs("div",{className:"modern-item-detail-modal",onClick:l=>l.stopPropagation(),children:[e.jsxs("div",{className:"modern-item-detail-header",children:[e.jsxs("div",{className:"modern-item-detail-title-section",children:[e.jsx("div",{className:"modern-item-detail-icon",children:e.jsx("img",{src:d,alt:s,className:"modern-item-detail-image"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"modern-item-detail-title",children:s}),e.jsxs("div",{className:"modern-item-detail-subtitle",children:["Obtained ",g," time",g!==1?"s":""]})]})]}),e.jsx("button",{onClick:()=>i(!1),className:"modern-item-detail-close",title:"Close",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6 6 18M6 6l12 12"})})})]}),e.jsx("div",{className:"modern-item-detail-content",children:N.map(l=>e.jsxs("div",{className:"modern-character-section",children:[e.jsxs("div",{className:"modern-character-header",children:[e.jsx("div",{className:"modern-character-name",children:l}),e.jsxs("div",{className:"modern-character-count",children:[k[l].length," time",k[l].length!==1?"s":""]})]}),e.jsx("div",{className:"modern-dates-grid",children:k[l].map((p,w)=>e.jsxs("div",{className:"modern-date-chip",children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"modern-date-icon",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]}),p.displayDate]},`${l}-${p.fullDate}-${w}`))})]},l))}),e.jsx("div",{className:"modern-item-detail-footer",children:e.jsxs("div",{className:"modern-detail-stats",children:[e.jsxs("div",{className:"modern-detail-stat",children:[e.jsx("span",{className:"modern-detail-stat-number",children:N.length}),e.jsxs("span",{className:"modern-detail-stat-label",children:["Character",N.length!==1?"s":""]})]}),e.jsxs("div",{className:"modern-detail-stat",children:[e.jsx("span",{className:"modern-detail-stat-number",children:g}),e.jsxs("span",{className:"modern-detail-stat-label",children:["Total Drop",g!==1?"s":""]})]})]})})]})})}function jt({data:t,characterBossSelections:i,onClose:r,onConfirm:s,pitchedChecked:d}){const[g,v]=o.useState(""),[k,N]=o.useState(!1),[l,p]=o.useState(""),w=o.useMemo(()=>t.weekKey?De(t.weekKey):{start:null,end:null},[t.weekKey]),_=o.useCallback(c=>c.toISOString().split("T")[0],[]),L=o.useMemo(()=>{var c;return t.character||((c=i[0])==null?void 0:c.name)||""},[t.character,i]);o.useEffect(()=>{w.start&&!g&&v(_(w.start))},[w,g,_]);const S=async()=>{if(!g||!L){p("Please select a valid date and character.");return}N(!0),p("");try{const c=new Date(g+"T12:00:00.000Z").toISOString();m.info("HistoricalPitchedModal: Confirming historical drop",{bossName:t.bossName,itemName:t.itemName,character:L,weekKey:t.weekKey,date:c}),await s(c,L),N(!1)}catch(c){m.error("HistoricalPitchedModal: Error confirming historical drop",c),p("Failed to add historical drop. Please try again."),N(!1)}},C=o.useMemo(()=>{if(!w.start||!w.end)return"";const c=w.start.toLocaleDateString("en-US",{month:"short"}),a=w.end.toLocaleDateString("en-US",{month:"short"}),n=w.start.getDate(),h=w.end.getDate(),f=w.start.getFullYear();return c===a?`${c} ${n}-${h}, ${f}`:`${c} ${n} - ${a} ${h}, ${f}`},[w]),I=o.useMemo(()=>{if(!w.start||!w.end)return[];const c=[],a=new Date(w.start);for(;a<=w.end;){const n=_(a),h=a.toLocaleDateString("en-US",{weekday:"long"}),f=a.toLocaleDateString("en-US",{month:"short",day:"numeric"});c.push({value:n,label:`${h}, ${f}`,date:new Date(a)}),a.setDate(a.getDate()+1)}return c},[w,_]);return e.jsx("div",{className:"historical-modal-overlay",onClick:r,children:e.jsxs("div",{className:"historical-modal-container",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"historical-modal-header",children:[e.jsx("div",{className:"historical-modal-icon",children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M12 2v20l-7-7h14l-7 7z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}),e.jsx("h2",{className:"historical-modal-title",children:"Add Historical Drop"}),e.jsx("button",{className:"historical-modal-close",onClick:r,children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),e.jsxs("div",{className:"historical-modal-showcase",children:[e.jsxs("div",{className:"historical-modal-item-container",children:[e.jsx("div",{className:"historical-modal-item-glow"}),e.jsx("img",{src:t.itemImage,alt:t.itemName,className:"historical-modal-item-image"})]}),e.jsxs("div",{className:"historical-modal-item-details",children:[e.jsx("h3",{className:"historical-modal-item-name",children:t.itemName}),e.jsxs("p",{className:"historical-modal-boss-name",children:["from ",t.bossName]})]})]}),e.jsx("div",{className:"historical-modal-details",children:e.jsxs("div",{className:"historical-modal-detail-group",children:[e.jsxs("div",{className:"historical-modal-detail-row",children:[e.jsx("span",{className:"detail-label",children:"Character:"}),e.jsx("span",{className:"detail-value character-name",children:L})]}),e.jsxs("div",{className:"historical-modal-detail-row",children:[e.jsx("span",{className:"detail-label",children:"Week Range:"}),e.jsx("span",{className:"detail-value",children:C})]})]})}),e.jsxs("div",{className:"historical-modal-date-section",children:[e.jsx("label",{className:"historical-modal-section-title",children:"Select the day you obtained this item:"}),e.jsx("div",{className:"historical-modal-date-options",children:I.map(c=>e.jsxs("button",{className:`historical-modal-date-option ${g===c.value?"selected":""}`,onClick:()=>v(c.value),disabled:k,children:[e.jsx("span",{className:"date-option-day",children:c.label.split(",")[0]}),e.jsx("span",{className:"date-option-date",children:c.label.split(",")[1]})]},c.value))}),e.jsxs("div",{className:"historical-modal-date-input-wrapper",children:[e.jsx("label",{className:"historical-modal-date-input-label",children:"Or select date manually:"}),e.jsx("input",{type:"date",value:g,onChange:c=>v(c.target.value),min:w.start?_(w.start):"",max:w.end?_(w.end):"",className:"historical-modal-date-input",disabled:k})]})]}),l&&e.jsxs("div",{className:"historical-modal-error",children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"2"}),e.jsx("path",{d:"M12 8v4M12 16h.01",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),l]}),e.jsxs("div",{className:"historical-modal-actions",children:[e.jsx("button",{onClick:r,disabled:k,className:"historical-modal-btn historical-modal-btn-cancel",children:"Cancel"}),e.jsxs("button",{onClick:S,disabled:k||!g||!L,className:"historical-modal-btn historical-modal-btn-confirm",children:[k&&e.jsx("div",{className:"historical-modal-spinner"}),k?"Adding Drop...":"Confirm Drop"]})]})]})})}function yt({isOpen:t,onClose:i,characterName:r,cloudPitchedItems:s=[],setPitchedModalItem:d,setShowPitchedModal:g}){const[v,k]=o.useState([]);o.useEffect(()=>{if(!t||!r)return;const l=s.filter(_=>_.charId===r),p=new Map;l.forEach(_=>{const L=_.item;if(!p.has(L)){let C="/items/crystal.png";const I=["Lotus","Damien","Lucid","Will","Gloom","Darknell","Verus Hilla","Chosen Seren","Watcher Kalos","Kaling","Limbo"];for(const c of I){const n=ye(c).find(h=>h.name===_.item);if(n){C=n.image;break}}p.set(L,{name:_.item,image:C,count:0,history:[]})}const S=p.get(L);S.count+=1,S.history.push({date:_.date})});const w=Array.from(p.values()).sort((_,L)=>L.count-_.count);k(w)},[t,r,s]);const N=l=>{if(!d||!g)return;const p=l.history.map(w=>({char:r,date:new Date(w.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})}));d({name:l.name,image:l.image,history:p}),g(!0)};return t?e.jsx("div",{className:"pitched-modal-backdrop",onClick:i,children:e.jsxs("div",{className:`pitched-modal ${v.length===0?"pitched-modal-no-scroll":""}`,onClick:l=>l.stopPropagation(),children:[e.jsx("button",{className:"pitched-modal-close",onClick:i,"aria-label":"Close modal",children:e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"closeGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#a259f7"}),e.jsx("stop",{offset:"1",stopColor:"#805ad5"})]})}),e.jsx("path",{d:"M6.2253 4.81108C5.83477 4.42056 5.20161 4.42056 4.81108 4.81108C4.42056 5.20161 4.42056 5.83477 4.81108 6.2253L10.5858 12L4.81114 17.7747C4.42062 18.1652 4.42062 18.7984 4.81114 19.1889C5.20167 19.5794 5.83483 19.5794 6.22535 19.1889L12 13.4142L17.7747 19.1889C18.1652 19.5794 18.7984 19.5794 19.1889 19.1889C19.5794 18.7984 19.5794 18.1652 19.1889 17.7747L13.4142 12L19.189 6.2253C19.5795 5.83477 19.5795 5.20161 19.189 4.81108C18.7985 4.42056 18.1653 4.42056 17.7748 4.81108L12 10.5858L6.2253 4.81108Z",fill:"url(#closeGradient)"})]})}),e.jsx("h2",{className:"pitched-modal-title",children:r?`${r}'s Pitched Items`:"Pitched Items"}),v.length>0?e.jsx("div",{className:"pitched-modal-list-container",children:e.jsx("div",{className:"pitched-modal-list",children:v.map(l=>e.jsxs("div",{className:"pitched-modal-item",onClick:()=>N(l),style:{cursor:"pointer"},children:[e.jsx("div",{className:"pitched-modal-item-glow"}),e.jsx("img",{src:l.image,alt:l.name,className:"pitched-modal-item-img"}),e.jsx("div",{className:"pitched-modal-item-name",children:l.name}),e.jsx("div",{className:"pitched-modal-item-count",children:l.count})]},l.name))})}):e.jsxs("div",{className:"pitched-modal-empty",children:[e.jsx("div",{className:"empty-star-container",children:e.jsxs("svg",{width:"72",height:"72",viewBox:"0 0 24 24",fill:"none",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"emptyStarGradient",x1:"0",y1:"0",x2:"24",y2:"24",children:[e.jsx("stop",{stopColor:"#a259f7"}),e.jsx("stop",{offset:"1",stopColor:"#6a11cb"})]}),e.jsxs("filter",{id:"starGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"1.5",result:"blur"}),e.jsx("feFlood",{floodColor:"#a259f7",floodOpacity:"0.5",result:"color"}),e.jsx("feComposite",{in:"color",in2:"blur",operator:"in",result:"glow"}),e.jsx("feComposite",{in:"SourceGraphic",in2:"glow",operator:"over"})]})]}),e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z",fill:"url(#emptyStarGradient)",stroke:"#e6e0ff",strokeWidth:"1.5",filter:"url(#starGlow)",className:"empty-star-path"})]})}),e.jsx("h3",{className:"empty-title",children:"No pitched items yet"}),e.jsxs("p",{className:"empty-desc",children:[r?`${r} hasn't`:"You haven't"," obtained any pitched items yet"]})]})]})}):null}function bt({showStatsResetConfirm:t,setShowStatsResetConfirm:i,onConfirm:r}){return t?e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-container modal-container-small",children:[e.jsx("h3",{className:"stats-reset-title",children:"Are you sure?"}),e.jsx("p",{className:"stats-reset-message",children:"This will permanently erase all stats. This cannot be undone."}),e.jsxs("div",{className:"stats-reset-buttons",children:[e.jsx("button",{onClick:()=>i(!1),className:"stats-reset-button stats-reset-button-cancel",children:"Cancel"}),e.jsx("button",{onClick:r,className:"stats-reset-button stats-reset-button-confirm",children:"Reset"})]})]})}):null}function Nt({showCharacterPurgeConfirm:t,setShowCharacterPurgeConfirm:i,purgeTargetCharacter:r,purgeInProgress:s,onConfirm:d}){return t?e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-container modal-container-medium character-purge-container",children:[e.jsx("div",{className:"character-purge-icon",children:e.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z",stroke:"#fff",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round"})})}),e.jsx("h2",{className:"character-purge-title",children:"Purge Character Data"}),e.jsxs("div",{className:"character-purge-warning",children:[e.jsx("p",{className:"character-purge-warning-title",children:e.jsx("strong",{children:"This will permanently delete all pitched items and boss runs for:"})}),e.jsx("p",{className:"character-purge-character-name",children:r==null?void 0:r.name}),e.jsx("p",{className:"character-purge-warning-note",children:"This action cannot be undone."})]}),e.jsxs("div",{className:"character-purge-buttons",children:[e.jsx("button",{onClick:()=>i(!1),disabled:s,className:"character-purge-button character-purge-button-cancel",children:"Cancel"}),e.jsxs("button",{onClick:d,disabled:s,className:"character-purge-button character-purge-button-confirm",children:[s&&e.jsx("div",{className:"character-purge-spinner"}),s?"Purging...":"Purge Data"]})]})]})}):null}function Ct({resetSuccessVisible:t,closeResetSuccess:i,purgeSuccess:r,setPurgeSuccess:s}){return!t&&!r?null:e.jsx("div",{className:"modal-backdrop modal-backdrop-high",children:e.jsxs("div",{className:"modal-container modal-container-small",onClick:d=>d.stopPropagation(),children:[e.jsx("h3",{className:"success-title",children:t?"Stats reset!":"Character purged!"}),e.jsx("p",{className:"success-message",children:t?"Your stats have been cleared.":"Character data has been purged."}),e.jsx("button",{onClick:t?i:()=>s(!1),className:"success-button",children:"Close"})]})})}function St({showPitchedModal:t,setShowPitchedModal:i,pitchedModalItem:r,pitchedModalDetails:s}){return!t||!r?null:e.jsx("div",{className:"pitched-details-modal-backdrop",onClick:()=>i(!1),style:{zIndex:9999},children:e.jsxs("div",{className:"pitched-details-modal pitched-details-modal-visible",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"pitched-details-modal-header",children:[e.jsx("button",{className:"pitched-details-modal-close",onClick:()=>i(!1),title:"Close",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M6.2253 4.81108C5.83477 4.42056 5.20161 4.42056 4.81108 4.81108C4.42056 5.20161 4.42056 5.83477 4.81108 6.2253L10.5858 12L4.81114 17.7747C4.42062 18.1652 4.42062 18.7984 4.81114 19.1889C5.20167 19.5794 5.83483 19.5794 6.22535 19.1889L12 13.4142L17.7747 19.1889C18.1652 19.5794 18.7984 19.5794 19.1889 19.1889C19.5794 18.7984 19.5794 18.1652 19.1889 17.7747L13.4142 12L19.189 6.2253C19.5795 5.83477 19.5795 5.20161 19.189 4.81108C18.7985 4.42056 18.1653 4.42056 17.7748 4.81108L12 10.5858L6.2253 4.81108Z",fill:"currentColor"})})}),e.jsxs("div",{className:"pitched-details-modal-item-showcase",children:[e.jsx("img",{src:r.image,alt:r.name,className:"pitched-details-modal-item-img"}),e.jsxs("div",{className:"pitched-details-modal-item-info",children:[e.jsx("h2",{className:"pitched-details-modal-title",children:r.name}),e.jsxs("div",{className:"pitched-details-modal-subtitle",children:[e.jsx("span",{className:"pitched-details-modal-count",children:s.length}),e.jsx("span",{className:"pitched-details-modal-acquired",children:s.length===1?"time obtained":"times obtained"})]})]})]})]}),e.jsxs("div",{className:"pitched-details-modal-content",children:[e.jsxs("div",{className:"pitched-details-section-header",children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"})}),e.jsx("h3",{children:"Acquisition History"})]}),e.jsx("div",{className:"pitched-details-acquisition",children:s.length===0?e.jsx("div",{className:"empty-state",children:"None this year."}):e.jsx("div",{className:"pitched-details-table-container",children:e.jsxs("table",{className:"pitched-details-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Character"}),e.jsx("th",{children:"Date"})]})}),e.jsx("tbody",{children:s.map((d,g)=>e.jsxs("tr",{className:`pitched-details-row ${g%2===0?"even-row":"odd-row"}`,children:[e.jsx("td",{children:d.char}),e.jsx("td",{children:e.jsx("span",{className:"date-value",children:d.date})})]},g))})]})})})]})]})})}function _t({statsManagement:t,weekNavigation:i,pitchedChecked:r,setPitchedChecked:s,userInteractionRef:d,setError:g,characterBossSelections:v,selectedCharIdx:k,cloudPitchedItems:N}){var l;return e.jsxs(e.Fragment,{children:[e.jsx(wt,{showStats:t.showStats,setShowStats:t.setShowStats,allYears:t.allYears,selectedYear:t.selectedYear,setSelectedYear:t.setSelectedYear,groupedYearlyPitchedItems:t.groupedYearlyPitchedItems,isLoadingCloudStats:t.isLoadingCloudStats,setShowStatsResetConfirm:t.setShowStatsResetConfirm,handleItemDetailClick:t.handleItemDetailClick}),e.jsx(vt,{showItemDetailModal:t.showItemDetailModal,setShowItemDetailModal:t.setShowItemDetailModal,selectedItemDetail:t.selectedItemDetail}),e.jsx(bt,{showStatsResetConfirm:t.showStatsResetConfirm,setShowStatsResetConfirm:t.setShowStatsResetConfirm,onConfirm:()=>t.handleStatsReset(g)}),e.jsx(Nt,{showCharacterPurgeConfirm:t.showCharacterPurgeConfirm,setShowCharacterPurgeConfirm:t.setShowCharacterPurgeConfirm,purgeTargetCharacter:t.purgeTargetCharacter,purgeInProgress:t.purgeInProgress,onConfirm:()=>t.handleCharacterPurge(r,s,i.selectedWeekKey,d,g)}),e.jsx(Ct,{resetSuccessVisible:t.resetSuccessVisible,closeResetSuccess:t.closeResetSuccess,purgeSuccess:t.purgeSuccess,setPurgeSuccess:t.setPurgeSuccess}),t.showHistoricalPitchedModal&&e.jsx("div",{className:"modal-backdrop",onClick:()=>t.setShowHistoricalPitchedModal(!1),children:e.jsx(jt,{data:t.historicalPitchedData,characterBossSelections:v,onClose:()=>t.setShowHistoricalPitchedModal(!1),onConfirm:t.handleHistoricalPitchedConfirm,pitchedChecked:r})}),e.jsx(yt,{isOpen:t.showCharacterPitchedModal,onClose:()=>t.setShowCharacterPitchedModal(!1),characterName:((l=v[k])==null?void 0:l.name)||"",cloudPitchedItems:N,setPitchedModalItem:t.setPitchedModalItem,setShowPitchedModal:t.setShowPitchedModal}),e.jsx(St,{showPitchedModal:t.showPitchedModal,setShowPitchedModal:t.setShowPitchedModal,pitchedModalItem:t.pitchedModalItem,pitchedModalDetails:t.pitchedModalDetails})]})}function Et(t,i,r=null){const[s,d]=o.useState(i||Se()),[g,v]=o.useState({hasHistoricalData:!1,oldestHistoricalWeek:null,userType:"new",adaptiveWeekLimit:8,historicalWeeks:[],analysis:null}),[k,N]=o.useState(!1);o.useEffect(()=>{i&&i!==s&&(m.info("useWeekNavigation: App week key differs from selected, updating",{appWeekKey:i,selectedWeekKey:s}),d(i))},[i]);const l=s!==(i||Se()),p=o.useCallback(async()=>{var L;if(!t||k)return;try{const{STORAGE_KEYS:S}=await se(async()=>{const{STORAGE_KEYS:I}=await import("./index-Bn-fR1GA.js").then(c=>c.k);return{STORAGE_KEYS:I}},__vite__mapDeps([0,1,2,3,4,5])),C=localStorage.getItem(S.USER_CODE);if(!C||C!==t){m.debug("useWeekNavigation: Skipping analysis refresh - logout in progress",{userCode:t,storedCode:C});return}}catch(S){m.error("useWeekNavigation: Error checking auth state for analysis",{error:S});return}const _=Se();try{N(!0),m.debug("useWeekNavigation: Refreshing historical analysis",{userCode:t,realCurrentWeek:_,selectedCharacterName:r});const S=r?await Xe(t,r):await Qe(t);S.success?(v({hasHistoricalData:S.hasHistoricalData,oldestHistoricalWeek:S.oldestHistoricalWeek,userType:S.userType,adaptiveWeekLimit:S.adaptiveWeekLimit,historicalWeeks:S.historicalWeeks,analysis:S.analysis}),m.debug("useWeekNavigation: Historical analysis refreshed",{userType:S.userType,hasData:S.hasHistoricalData,oldestWeek:S.oldestHistoricalWeek,adaptiveLimit:S.adaptiveWeekLimit,historicalWeeksCount:((L=S.historicalWeeks)==null?void 0:L.length)||0,characterSpecific:!!r})):m.error("useWeekNavigation: Error in historical analysis result",S.error)}catch(S){m.error("useWeekNavigation: Error refreshing historical analysis",S)}finally{N(!1)}},[t,k,r]),w=o.useCallback(_=>{_!==s&&(m.info("useWeekNavigation: Week changed",{from:s,to:_}),d(_),t&&(async()=>{try{const{STORAGE_KEYS:S}=await se(async()=>{const{STORAGE_KEYS:I}=await import("./index-Bn-fR1GA.js").then(c=>c.k);return{STORAGE_KEYS:I}},__vite__mapDeps([0,1,2,3,4,5])),C=localStorage.getItem(S.USER_CODE);C&&C===t?setTimeout(()=>{p()},100):m.debug("useWeekNavigation: Skipping week change analysis - logout in progress")}catch(S){m.error("useWeekNavigation: Error checking auth for week change",{error:S})}})())},[s,t,p]);return o.useEffect(()=>{t?(async()=>{try{const{STORAGE_KEYS:L}=await se(async()=>{const{STORAGE_KEYS:C}=await import("./index-Bn-fR1GA.js").then(I=>I.k);return{STORAGE_KEYS:C}},__vite__mapDeps([0,1,2,3,4,5])),S=localStorage.getItem(L.USER_CODE);if(S&&S===t){m.debug("useWeekNavigation: Loading historical analysis for user",{userCode:t});const C=setTimeout(()=>{t&&localStorage.getItem(L.USER_CODE)===t&&p()},150);return()=>clearTimeout(C)}else m.debug("useWeekNavigation: Skipping load - logout in progress or userCode mismatch",{userCode:t,storedCode:S})}catch(L){m.error("useWeekNavigation: Error checking auth state",{error:L})}})():(m.debug("useWeekNavigation: Clearing analysis state for logout"),v({hasHistoricalData:!1,oldestHistoricalWeek:null,userType:"new",adaptiveWeekLimit:8,historicalWeeks:[],analysis:null}),N(!1))},[t,r,p]),{selectedWeekKey:s,isHistoricalWeek:l,handleWeekChange:w,historicalAnalysis:g,refreshHistoricalAnalysis:p,isLoadingAnalysis:k}}function Lt(t,i=null){const[r,s]=o.useState({}),[d,g]=o.useState([]),[v,k]=o.useState({}),[N,l]=o.useState(!1),p=o.useRef(!1),w=o.useCallback(async()=>{if(t)try{l(!0);const a=await be(t,{});if(a.success){g(a.items);const{getCurrentWeekKey:n}=await se(async()=>{const{getCurrentWeekKey:y}=await import("./index-Bn-fR1GA.js").then(x=>x.w);return{getCurrentWeekKey:y}},__vite__mapDeps([0,1,2,3,4,5])),h=n(),f=i||h;m.debug("usePitchedItems: Current week info",{currentAppWeekKey:h,currentViewingWeekKey:f,selectedWeekKey:i,totalItems:a.items.length});const u={};a.items.forEach(y=>{const x=de(y.date);if(x===f){const b=`${y.charId}__${y.bossName}__${y.item}__${x}`;u[b]=!0}}),m.debug("usePitchedItems: Loaded pitched items with week filtering",{totalItemsInDatabase:a.items.length,checkedKeysForCurrentWeek:Object.keys(u).length,currentViewingWeekKey:f,sampleCheckedKeys:Object.keys(u).slice(0,3),itemsInCurrentWeek:a.items.filter(y=>de(y.date)===f).length,itemsInOtherWeeks:a.items.filter(y=>de(y.date)!==f).length}),s(u)}else m.error("usePitchedItems: Failed to refresh pitched items",a.error)}catch(a){m.error("usePitchedItems: Error refreshing pitched items",a)}finally{l(!1)}},[t,i]),_=o.useCallback(async(a,n,h,f=null)=>{if(!t)return m.warn("usePitchedItems: No user ID available, user may not be authenticated yet"),{success:!1,error:"User not authenticated"};const u=f||new Date().toISOString().split("T")[0],y=de(u),x=`${a}__${n}__${h}__${y}`;if(r[x])return m.info("usePitchedItems: Item already exists, skipping add",{key:x,existingChecked:!!r[x],charId:a,bossName:n,item:h,itemWeekKey:y}),{success:!0,message:"Item already exists"};m.debug("usePitchedItems: Adding new pitched item",{key:x,charId:a,bossName:n,item:h,itemWeekKey:y,pitchedCheckedKeys:Object.keys(r).length});const D=await Te(t,{charId:a,bossName:n,item:h,date:u});if(D.success){const B=D.pitchedItem;return g(E=>[...E,B]),s(E=>({...E,[x]:!0})),{success:!0}}else throw new Error(D.error)},[t,r]),L=o.useCallback(async(a,n,h,f=null)=>{if(!t)return m.warn("usePitchedItems: No user ID available, user may not be authenticated yet"),{success:!1,error:"User not authenticated"};m.debug("usePitchedItems: Attempting to remove pitched item",{charId:a,bossName:n,item:h,providedDate:f,cloudItemsCount:d.length});let u=f;if(u){if(!d.find(b=>b.charId===a&&b.bossName===n&&b.item===h&&b.date===f)){m.warn("usePitchedItems: Exact date match not found",{charId:a,bossName:n,item:h,targetDate:f,availableItemsForCharacter:d.filter(D=>D.charId===a).map(D=>({bossName:D.bossName,item:D.item,date:D.date}))});const b=d.filter(D=>D.charId===a&&D.bossName===n&&D.item===h);if(b.length>0)m.info("usePitchedItems: Found alternative matches, using most recent",{alternativeCount:b.length,alternatives:b.map(D=>D.date)}),b.sort((D,B)=>new Date(B.date)-new Date(D.date)),u=b[0].date;else throw m.error("usePitchedItems: No alternative matches found"),new Error("Pitched item not found")}}else{const x=d.filter(b=>b.charId===a&&b.bossName===n&&b.item===h);if(m.debug("usePitchedItems: Searching for matching items without date",{matchingItemsCount:x.length,matchingItems:x.map(b=>({charId:b.charId,bossName:b.bossName,item:b.item,date:b.date}))}),x.length>0)x.sort((b,D)=>new Date(D.date)-new Date(b.date)),u=x[0].date,m.debug("usePitchedItems: Found most recent item",{targetDate:u});else return m.info("usePitchedItems: No matching items found to remove",{charId:a,bossName:n,item:h,availableItems:d.map(b=>({charId:b.charId,bossName:b.bossName,item:b.item,date:b.date})).slice(0,5)}),{success:!0,message:"No items to remove"}}m.debug("usePitchedItems: Proceeding with removal",{charId:a,bossName:n,item:h,targetDate:u});const y=await $e(t,a,n,h,u);if(y.success){g(D=>D.filter(B=>!(B.charId===a&&B.bossName===n&&B.item===h&&B.date===u)));const x=de(u),b=`${a}__${n}__${h}__${x}`;return s(D=>{const B={...D};return delete B[b],B}),m.info("usePitchedItems: Successfully removed pitched item",{charId:a,bossName:n,item:h,targetDate:u,removedKey:b}),{success:!0}}else throw new Error(y.error)},[t,d]),S=o.useCallback(async a=>{if(!t)throw new Error("No user ID provided");const n=await Me(t,a);if(n.success)return g(h=>{let f=[...h];return a.forEach(({charId:u,bossName:y,item:x,date:b})=>{if(b)f=f.filter(D=>!(D.charId===u&&D.bossName===y&&D.item===x&&D.date===b));else{const D=f.findLastIndex(B=>B.charId===u&&B.bossName===y&&B.item===x);D!==-1&&f.splice(D,1)}}),f}),s(h=>{const f={...h};return a.forEach(({charId:u,bossName:y,item:x,date:b})=>{if(b){const D=de(b),B=`${u}__${y}__${x}__${D}`;delete f[B]}else Object.keys(f).forEach(D=>{D.startsWith(`${u}__${y}__${x}__`)&&delete f[D]})}),f}),{success:!0,removedCount:n.removedCount};throw new Error(n.error)},[t]),C=o.useCallback(async a=>{if(!t)throw new Error("No user ID provided");const n=await Re(t,a);if(n.success)return g(h=>h.filter(f=>de(f.date)!==a)),s(h=>{const f={...h};return Object.keys(f).forEach(u=>{u.endsWith(`__${a}`)&&delete f[u]}),f}),{success:!0,removedCount:n.removedCount};throw new Error(n.error)},[t]),I=o.useCallback(async(a=null)=>{if(!t)throw new Error("No user ID provided");const n=await je(t,a);if(n.success)return{success:!0,stats:n.stats};throw new Error(n.error)},[t]),c=o.useCallback(async()=>{if(!t)throw new Error("No user ID provided");const a=await He(t);if(a.success)return g([]),s({}),{success:!0,removedCount:a.removedCount};throw new Error(a.error)},[t]);return o.useEffect(()=>{t?(async()=>{try{const{STORAGE_KEYS:n}=await se(async()=>{const{STORAGE_KEYS:f}=await import("./index-Bn-fR1GA.js").then(u=>u.k);return{STORAGE_KEYS:f}},__vite__mapDeps([0,1,2,3,4,5])),h=localStorage.getItem(n.USER_CODE);h&&h===t?(m.debug("usePitchedItems: Loading pitched items for user",{userId:t}),w()):m.debug("usePitchedItems: Skipping load - logout in progress or userId mismatch",{userId:t,storedCode:h})}catch(n){m.error("usePitchedItems: Error checking auth state",{error:n})}})():(m.debug("usePitchedItems: Clearing state for logout"),g([]),s({}),l(!1))},[t,w]),{pitchedChecked:r,setPitchedChecked:s,cloudPitchedItems:d,setCloudPitchedItems:g,userInteractionRef:p,refreshPitchedItems:w,loadingPitchedItems:v,setLoadingPitchedItems:k,isRefreshingPitchedItems:N,addNewPitchedItem:_,removePitchedItemByDetails:L,removeManyPitchedItemsByDetails:S,clearWeekPitchedItems:C,getYearlyStats:I,purgeAllItems:c}}function It({userId:t=null,characterBossSelections:i=[],selectedCharIdx:r=0,checked:s={},setChecked:d=()=>{},setError:g=()=>{},onDataChange:v=()=>{},isHistoricalWeek:k=!1,onBossUncheckStart:N=()=>{},onBossUncheckEnd:l=()=>{}}){const[p,w]=o.useState(!1),_=o.useRef(!1),L=o.useRef(0),S=o.useCallback(async(c,a,n)=>{if(p||!t){m.info("useBossActions: Boss check skipped",{isUpdating:p,hasUserId:!!t});return}if(r==null){m.debug("useBossActions: Boss check skipped",{reason:"No character selected",characterIdx:r,bossName:c.name,difficulty:c.difficulty});return}if(k){m.debug("useBossActions: Boss check skipped for historical week");return}w(!0),_.current=!0;try{m.debug("useBossActions: Boss check initiated",{bossName:c.name,difficulty:c.difficulty,isChecked:a,characterIdx:r});const h=i[r];if(!h)throw new Error("No character selected");const f=`${h.name}-${r}`,u=`${c.name}-${c.difficulty}`;d(W=>{const j={...W};return j[f]||(j[f]={}),j[f]={...j[f]},a?j[f][u]=!0:delete j[f][u],j}),m.debug("useBossActions: Boss check details",{charName:h.name,charIdx:r,bossName:c.name,difficulty:c.difficulty}),m.debug("useBossActions: Converting boss to registry ID",{bossName:c.name,difficulty:c.difficulty});const y=await at(c.name,c.difficulty);m.debug("useBossActions: Boss registry ID obtained",y);const{toggleBossClearStatus:x}=await se(async()=>{const{toggleBossClearStatus:W}=await import("./userWeeklyDataService-C8wIP6so.js");return{toggleBossClearStatus:W}},__vite__mapDeps([6,4,3,7,0,1,2,5])),{getCurrentMapleWeekStartDate:b}=await se(async()=>{const{getCurrentMapleWeekStartDate:W}=await import("./mapleWeekUtils-Bm65Nri8.js");return{getCurrentMapleWeekStartDate:W}},[]),D=b(),B={userId:t,characterName:h.name,characterIndex:h.index.toString(),bossRegistryId:y,isCompleted:a,weekKey:D};m.debug("useBossActions: Updating database",{userId:t,characterName:h.name,characterIndex:h.index.toString(),bossRegistryId:y,isCompleted:a,weekKey:D});const E=await x(t,D,h.index.toString(),y,a);if(m.debug("useBossActions: Database update result",E),!E.success)throw new Error(E.error||"Failed to update boss completion");if(!a){N();try{m.info("useBossActions: Boss unchecked - removing associated pitched items",{characterName:h.name,bossName:c.name,difficulty:c.difficulty});const{removeManyPitchedItems:W}=await se(async()=>{const{removeManyPitchedItems:ee}=await Promise.resolve().then(()=>pe);return{removeManyPitchedItems:ee}},void 0),{getCurrentWeekKey:j,convertWeekKeyToDate:$,getWeekDateRange:Q}=await se(async()=>{const{getCurrentWeekKey:ee,convertWeekKeyToDate:P,getWeekDateRange:ie}=await import("./index-Bn-fR1GA.js").then(oe=>oe.w);return{getCurrentWeekKey:ee,convertWeekKeyToDate:P,getWeekDateRange:ie}},__vite__mapDeps([0,1,2,3,4,5])),z=j(),q=$(z),G=Q(z);m.info("useBossActions: Week date analysis",{currentWeek:z,currentWeekDate:q,currentWeekRange:{start:G.start,end:G.end}});const R=[],{getPitchedItems:A}=await se(async()=>{const{getPitchedItems:ee}=await Promise.resolve().then(()=>pe);return{getPitchedItems:ee}},void 0),Z=await A(t,{});if(m.info("useBossActions: Retrieved pitched items for removal check",{success:Z.success,totalItems:Z.success?Z.items.length:0,userId:t,currentWeekDate:q}),Z.success){Z.items.forEach((P,ie)=>{const oe=P.date?new Date(P.date):null,T=P.date===null||oe&&oe>=G.start&&oe<=G.end;m.info(`useBossActions: Item ${ie} - Character comparison: "${P.charId}" === "${h.name}" = ${P.charId===h.name}`),m.info(`useBossActions: Item ${ie} - Boss comparison: "${P.bossName}" === "${c.name}" = ${P.bossName===c.name}`),m.info(`useBossActions: Item ${ie} - Date analysis: ${P.date} (as Date: ${oe}) in range ${G.start} to ${G.end} OR null = ${T}`),m.info(`useBossActions: Item ${ie} - Overall match: ${P.charId===h.name&&P.bossName===c.name&&T}`)});const ee=Z.items.filter(P=>{const ie=P.date?new Date(P.date):null,oe=P.date===null||ie&&ie>=G.start&&ie<=G.end;return P.charId===h.name&&P.bossName===c.name&&oe});if(m.info("useBossActions: Filtered items for removal",{totalItemsFromDB:Z.items.length,filteredItems:ee.length,filterCriteria:{charId:h.name,bossName:c.name,date:q,alsoMatchingNull:!0},allItemsFromDB:Z.items.map(P=>({charId:P.charId,bossName:P.bossName,item:P.item,date:P.date})),filteredItemDetails:ee.map(P=>({charId:P.charId,bossName:P.bossName,item:P.item,date:P.date}))}),ee.forEach(P=>{R.push({charId:P.charId,bossName:P.bossName,item:P.item,date:P.date})}),R.length>0){m.info("useBossActions: Removing pitched items for unchecked boss",{characterName:h.name,bossName:c.name,itemsToRemove:R.length,itemDetails:R});const P=await W(t,R);m.info("useBossActions: Pitched items removal result",{success:P.success,error:P.error,removedCount:P.removedCount,attemptedRemovalCount:R.length}),P.success?(m.info("useBossActions: Successfully removed pitched items",{removedCount:P.removedCount,originalCount:R.length}),v&&v()):m.warn("useBossActions: Failed to remove some pitched items",{error:P.error,itemsToRemove:R})}else m.info("useBossActions: No pitched items found to remove",{characterName:h.name,bossName:c.name,currentWeekDate:q,totalItemsInDB:Z.items.length})}}catch(W){m.warn("useBossActions: Failed to remove pitched items for unchecked boss",{error:W,characterName:h.name,bossName:c.name})}finally{l()}}d(W=>{const j={...W};return j[f]||(j[f]={}),j[f]={...j[f]},a?j[f][u]=!0:delete j[f][u],j}),m.debug("useBossActions: Boss check completed successfully"),L.current=Date.now()}catch(h){m.error("useBossActions: Error handling boss check",h),g(h.message),d(f=>{const u={...f},y=i[r];if(y){const x=`${y.name}-${r}`,b=`${c.name}-${c.difficulty}`;u[x]||(u[x]={}),u[x]={...u[x]},a?delete u[x][b]:u[x][b]=!0}return u})}finally{w(!1)}},[t,i,r,s,d,g,v,p,k,N,l]),C=o.useCallback(async()=>{if(!(!t||k||p)){w(!0),_.current=!0;try{const c=i[r];if(!c)throw new Error("No character selected");const a=`${c.name}-${r}`,n=c.bosses||[],f=!n.every(E=>{var W;return(W=s[a])==null?void 0:W[`${E.name}-${E.difficulty}`]}),u={...s};d(E=>{const W={...E};W[a]||(W[a]={}),W[a]={...W[a]};for(const j of n){const $=`${j.name}-${j.difficulty}`;f?W[a][$]=!0:delete W[a][$]}return W});const{clearAllBossesForCharacter:y,markAllBossesForCharacter:x}=await se(async()=>{const{clearAllBossesForCharacter:E,markAllBossesForCharacter:W}=await import("./userWeeklyDataService-C8wIP6so.js");return{clearAllBossesForCharacter:E,markAllBossesForCharacter:W}},__vite__mapDeps([6,4,3,7,0,1,2,5])),{getCurrentMapleWeekStartDate:b}=await se(async()=>{const{getCurrentMapleWeekStartDate:E}=await import("./mapleWeekUtils-Bm65Nri8.js");return{getCurrentMapleWeekStartDate:E}},[]),D=b();let B;if(f?(m.debug("useBossActions: Marking all bosses as cleared",{characterIdx:c.index,bossCount:n.length,weekKey:D}),B=await x(t,D,c.index.toString())):(m.debug("useBossActions: Clearing all bosses",{characterIdx:c.index,bossCount:n.length,weekKey:D}),B=await y(t,D,c.index.toString())),!B.success)m.error("useBossActions: Bulk operation failed",{action:f?"markAll":"clearAll",error:B.error}),d(u),g(`Failed to ${f?"mark all bosses as completed":"clear all boss completions"}. Please try again.`);else{if(!f){N();try{m.info("useBossActions: All bosses cleared - removing all pitched items for character",{characterName:c.name,bossCount:n.length});const{getPitchedItems:E,removeManyPitchedItems:W}=await se(async()=>{const{getPitchedItems:G,removeManyPitchedItems:R}=await Promise.resolve().then(()=>pe);return{getPitchedItems:G,removeManyPitchedItems:R}},void 0),{getCurrentWeekKey:j}=await se(async()=>{const{getCurrentWeekKey:G}=await import("./index-Bn-fR1GA.js").then(R=>R.w);return{getCurrentWeekKey:G}},__vite__mapDeps([0,1,2,3,4,5])),{convertWeekKeyToDate:$}=await se(async()=>{const{convertWeekKeyToDate:G}=await import("./index-Bn-fR1GA.js").then(R=>R.w);return{convertWeekKeyToDate:G}},__vite__mapDeps([0,1,2,3,4,5])),Q=j(),z=$(Q),q=await E(t,{});if(q.success){const G=q.items.filter(R=>R.charId===c.name&&R.date===z);if(G.length>0){const R=G.map(Z=>({charId:Z.charId,bossName:Z.bossName,item:Z.item,date:Z.date}));m.info("useBossActions: Removing all pitched items for character",{characterName:c.name,itemsToRemove:R.length});const A=await W(t,R);A.success?m.info("useBossActions: Successfully removed all pitched items for character",{removedCount:A.removedCount}):m.warn("useBossActions: Failed to remove some pitched items during clear all",{error:A.error})}}}catch(E){m.warn("useBossActions: Failed to remove pitched items during clear all",{error:E,characterName:c.name})}finally{l()}}await v(),m.debug("useBossActions: Tick all completed successfully",{characterIdx:c.index,allTicked:f,processedBosses:n.length})}}catch(c){m.error("useBossActions: Error handling tick all",c),g(c.message),d(a=>{const n=i[r];if(!n)return a;const h=`${n.name}-${r}`,f=a[h]||{};return{...a,[h]:{...f}}})}finally{w(!1)}}},[t,i,r,s,d,g,v,p,k,N,l]);return{handleCheck:S,handleTickAll:C,refreshCheckedStateFromDatabase:async()=>{try{return t?(v&&v(),!0):null}catch(c){return console.error("Error refreshing checked state:",c),null}},isUpdating:p,userInteractionRef:_,lastUpdate:L.current}}const Dt=t=>{const i=["Lotus","Damien","Lucid","Will","Gloom","Darknell","Verus Hilla","Chosen Seren","Watcher Kalos","Kaling","Limbo"];for(const r of i){const d=ye(r).find(g=>g.name===t);if(d)return d.image}return"/items/crystal.png"};function Pt(t,i){const[r,s]=o.useState(!1),[d,g]=o.useState(!1),[v,k]=o.useState({monthly:[],yearly:[]}),[N,l]=o.useState(!1),[p,w]=o.useState(null),[_,L]=o.useState(!1),[S,C]=o.useState(!1),[I,c]=o.useState([]),[a,n]=o.useState(!1),[h,f]=o.useState({}),[u,y]=o.useState(!1),[x,b]=o.useState(null),[D,B]=o.useState(!1),[E,W]=o.useState(!1),[j,$]=o.useState(!1),[Q,z]=o.useState(null),[q,G]=o.useState(!1),[R,A]=o.useState(null),Z=o.useMemo(()=>{const U=we(),M=new Set([U]);return v!=null&&v.yearly&&Array.isArray(v.yearly)&&v.yearly.forEach(K=>M.add(K.yearKey)),h&&Object.keys(h).forEach(K=>M.add(K)),Array.from(M).sort((K,O)=>O.localeCompare(K))},[v==null?void 0:v.yearly,h]),[ee,P]=o.useState(()=>we());o.useEffect(()=>{(Z==null?void 0:Z.length)>0&&!Z.includes(ee)&&P(Z[0])},[Z,ee]),o.useEffect(()=>{if(!r||!t)return;(async()=>{try{const{STORAGE_KEYS:M}=await se(async()=>{const{STORAGE_KEYS:O}=await import("./index-Bn-fR1GA.js").then(H=>H.k);return{STORAGE_KEYS:O}},__vite__mapDeps([0,1,2,3,4,5])),K=localStorage.getItem(M.USER_CODE);if(!K||K!==t){m.debug("useStatsManagement: Skipping cloud stats fetch - logout in progress",{userCode:t,storedCode:K});return}}catch(M){console.error("useStatsManagement: Error checking auth state for stats fetch",{error:M});return}try{y(!0);const M=parseInt(ee,10),K=await je(t,M),{STORAGE_KEYS:O}=await se(async()=>{const{STORAGE_KEYS:V}=await import("./index-Bn-fR1GA.js").then(F=>F.k);return{STORAGE_KEYS:V}},__vite__mapDeps([0,1,2,3,4,5])),H=localStorage.getItem(O.USER_CODE);if(!H||H!==t){m.debug("useStatsManagement: Skipping result processing - logout occurred during fetch");return}K.success&&f(V=>({...V,[ee]:K.stats}))}catch(M){console.error("Error fetching cloud pitched stats:",M)}finally{const{STORAGE_KEYS:M}=await se(async()=>{const{STORAGE_KEYS:O}=await import("./index-Bn-fR1GA.js").then(H=>H.k);return{STORAGE_KEYS:O}},__vite__mapDeps([0,1,2,3,4,5])),K=localStorage.getItem(M.USER_CODE);K&&K===t&&y(!1)}})()},[r,t,ee]);const ie=o.useMemo(()=>{if(!ee||!h)return[];const U=h[ee];if(!(U!=null&&U.items)||!Array.isArray(U.items))return[];const M=new Map;return U.items.filter(O=>(O==null?void 0:O.item)&&(O==null?void 0:O.charId)&&(O==null?void 0:O.date)).forEach(O=>{const H=O.item;M.has(H)||M.set(H,{itemName:H,itemImage:Dt(H),count:0,instances:[]});const V=M.get(H);V.count+=1;const F=new Date(O.date),X=Ye[F.getUTCMonth()],ne=F.getUTCDate();V.instances.push({charId:O.charId,fullDate:O.date,displayDate:`${X} ${ne}`,sortDate:F.getTime()})}),Array.from(M.values()).map(O=>({...O,instances:O.instances.sort((H,V)=>V.sortDate-H.sortDate)})).sort((O,H)=>H.count!==O.count?H.count-O.count:O.itemName.localeCompare(H.itemName))},[ee,h]),oe=async(U,M,K,O,H)=>{if(p)try{L(!0);const{name:V,idx:F}=p;O.current=!0;const X=tt(U,V,F,K);if(M(X),(await st(t,V,F)).success){f({}),await i(t);const ue=await je(t);if(ue.success){const Ne=we();f({[Ne]:ue.stats})}C(!0),l(!1);const ke=await rt(t);ke.success&&c(ke.history),setTimeout(()=>{C(!1)},3e3)}else H("Failed to purge character data. Please try again.")}catch(V){console.error("Error in handleCharacterPurge:",V),H("Failed to purge character data. Please try again.")}finally{L(!1),setTimeout(()=>{O.current=!1},1e3)}},T=async U=>{try{if(k({monthly:[],yearly:[]}),P(we()),t)if((await et(t)).success)f({}),await i(t);else{U("Failed to reset stats data. Please try again.");return}g(!1),n(!0),setTimeout(()=>{n(!1),s(!1)},3400)}catch(M){console.error("Error in stats reset:",M),U("Failed to reset stats data. Please try again.")}},te=()=>{n(!1),s(!1)},re=o.useMemo(()=>x?x.history||[]:[],[x]);function Y(){m.silence("Stats tracking is now cloud-based - no action needed")}return{showStats:r,setShowStats:s,showStatsResetConfirm:d,setShowStatsResetConfirm:g,statsPanel:v,setStatsPanel:k,showCharacterPurgeConfirm:N,setShowCharacterPurgeConfirm:l,purgeTargetCharacter:p,setPurgeTargetCharacter:w,purgeInProgress:_,purgeSuccess:S,setPurgeSuccess:C,auditHistory:I,resetSuccessVisible:a,closeResetSuccess:te,cloudPitchedStats:h,setCloudPitchedStats:f,isLoadingCloudStats:u,pitchedModalItem:x,setPitchedModalItem:b,showPitchedModal:D,setShowPitchedModal:B,showCharacterPitchedModal:E,setShowCharacterPitchedModal:W,pitchedModalDetails:re,showItemDetailModal:j,setShowItemDetailModal:$,selectedItemDetail:Q,setSelectedItemDetail:z,showHistoricalPitchedModal:q,setShowHistoricalPitchedModal:G,historicalPitchedData:R,setHistoricalPitchedData:A,allYears:Z,selectedYear:ee,setSelectedYear:P,groupedYearlyPitchedItems:ie,handleCharacterPurge:oe,handleStatsReset:T,startStatsTrackingIfNeeded:Y,handleHistoricalPitchedConfirm:async(U,M)=>{try{if(!R)throw new Error("No historical pitched data available");const{itemName:K,bossName:O,weekKey:H}=R;m.userAction("Adding historical pitched item",`${K} for ${O} by ${M}`);const{addPitchedItem:V}=await se(async()=>{const{addPitchedItem:ne}=await Promise.resolve().then(()=>pe);return{addPitchedItem:ne}},void 0),F={charId:M,bossName:O,item:K,date:U.split("T")[0]},X=await V(t,F);if(X.success)return m.silence("Historical pitched item added successfully"),G(!1),A(null),i&&await i(),{success:!0};throw new Error(X.error||"Failed to add historical pitched item")}catch(K){throw m.error("Error handling historical pitched confirmation:",K),K}},handleHistoricalPitchedRemove:async(U,M,K,O=null)=>{try{let H=O,V=M;if(!H&&R&&(H=R.weekKey,V||(V=R.bossName)),!H)throw new Error("Week key not available for historical pitched item removal");if(!V)throw new Error("Boss name not available for historical pitched item removal");m.userAction("Removing historical pitched item",`${K} from ${V} by ${U}`);const{removePitchedItem:F}=await se(async()=>{const{removePitchedItem:ne}=await Promise.resolve().then(()=>pe);return{removePitchedItem:ne}},void 0),X=await F(t,U,V,K,null);if(X.success)return m.silence("Historical pitched item removed successfully"),R&&(G(!1),A(null)),i&&await i(),{success:!0};throw new Error(X.error||"Failed to remove historical pitched item")}catch(H){throw m.error("Error handling historical pitched removal:",H),H}},handleItemDetailClick:U=>{z(U),$(!0)}}}function Wt(){const{userCode:t,isLoggedIn:i}=Pe(),[r,s]=o.useState(null),[d,g]=o.useState(()=>it()),[v,k]=o.useState(!1),[N,l]=o.useState(""),[p,w]=o.useState(null),[_,L]=o.useState("");o.useEffect(()=>{if(!t||!i){s(null),l("");return}let u=!0;return(async()=>{try{k(!0),l("");const x=await Ie(t);if(!u)return;x.success?s(x.data):l(x.error||"Failed to load weekly data.")}catch(x){u&&(console.error("Failed to load weekly data:",x),l("Failed to load weekly data. Please try again."))}finally{u&&k(!1)}})(),()=>{u=!1}},[t,i,d]);const S=o.useCallback(async()=>{if(!(!t||!i))try{k(!0);const u=await Ie(t);u.success?(s(u.data),l("")):l(u.error||"Failed to refresh data.")}catch(u){console.error("Failed to refresh weekly data:",u),l("Failed to refresh data.")}finally{k(!1)}},[t,i]),C=o.useCallback(()=>!r||!r.char_map?[]:Object.entries(r.char_map).map(([u,y])=>{var x,b;return{index:parseInt(u),name:y,bossConfig:((x=r.boss_config)==null?void 0:x[u])||"",weeklyClears:((b=r.weekly_clears)==null?void 0:b[u])||""}}).sort((u,y)=>u.index-y.index),[r]),I=o.useCallback(async u=>{if(!t||!i)return l("Not logged in."),{success:!1,error:"Not logged in."};if(!(u!=null&&u.trim()))return l("Character name cannot be empty."),{success:!1,error:"Character name cannot be empty."};try{k(!0),l("");const y=await ot(t,d,u.trim());return y.success?(await S(),L(""),{success:!0,characterIndex:y.characterIndex}):(l(y.error||"Failed to add character."),y)}catch(y){console.error("Failed to add character:",y);const x="Failed to add character.";return l(x),{success:!1,error:x}}finally{k(!1)}},[t,i,d,S]),c=o.useCallback(async u=>{if(!t||!i)return l("Not logged in."),{success:!1,error:"Not logged in."};try{k(!0),l("");const y=await nt(t,d,u);return y.success?(await S(),p===u&&w(null),{success:!0}):(l(y.error||"Failed to remove character."),y)}catch(y){console.error("Failed to remove character:",y);const x="Failed to remove character.";return l(x),{success:!1,error:x}}finally{k(!1)}},[t,i,d,p,S]),a=o.useCallback(async(u,y)=>{if(!t||!i)return l("Not logged in."),{success:!1,error:"Not logged in."};try{k(!0),l("");const x=await ct(t,d,u,y);return x.success?(await S(),{success:!0}):(l(x.error||"Failed to update character name."),x)}catch(x){console.error("Failed to update character name:",x);const b="Failed to update character name.";return l(b),{success:!1,error:b}}finally{k(!1)}},[t,i,d,S]),n=o.useCallback(async(u,y)=>{if(!t||!i)return l("Not logged in."),{success:!1,error:"Not logged in."};try{k(!0),l("");const x=await lt(t,d,u,y);return x.success?(await S(),{success:!0}):(l(x.error||"Failed to update boss configuration."),x)}catch(x){console.error("Failed to update boss configuration:",x);const b="Failed to update boss configuration.";return l(b),{success:!1,error:b}}finally{k(!1)}},[t,i,d,S]),h=o.useCallback(u=>C().find(x=>x.index===u)||null,[C]),f=o.useCallback((u,y=null)=>C().some(b=>b.name.toLowerCase()===u.toLowerCase()&&b.index!==y),[C]);return{weeklyData:r,currentWeekStart:d,isLoading:v,error:N,setError:l,characters:C(),selectedCharacterIndex:p,setSelectedCharacterIndex:w,newCharacterName:_,setNewCharacterName:L,refreshWeeklyData:S,addCharacter:I,removeCharacter:c,updateCharacterName:a,updateCharacterBossConfig:n,getCharacterByIndex:h,characterNameExists:f,fetchWeeklyData:(u,y)=>ht(u,y),saveWeeklyData:(u,y,x)=>dt(u,y,x)}}function Tt({characterBossSelections:t,bossData:i,checked:r,setChecked:s,userCode:d,appWeekKey:g,showOnboardingIndicators:v}){var oe;const{lastWeeklyResetTimestamp:k}=We(),{refreshWeeklyData:N}=Wt();function l(T,te){const re=i.find(ae=>ae.name===T);if(!re)return 0;const Y=re.difficulties.find(ae=>ae.difficulty===te);return Y?Y.price:0}const[p,w]=o.useState(!0),[_,L]=o.useState(0),[S,C]=o.useState(null),[I,c]=o.useState(!1),a=o.useRef(!1),[n,h]=o.useState(()=>{const T=localStorage.getItem(me.WEEKLY_HIDE_COMPLETED);return T?JSON.parse(T):!1});o.useEffect(()=>{localStorage.setItem(me.WEEKLY_HIDE_COMPLETED,JSON.stringify(n))},[n]),o.useEffect(()=>{if(t.length)c(!1);else{c(!1);const T=setTimeout(()=>{c(!0)},2e3);return()=>clearTimeout(T)}},[t.length]);const f=Et(d,g,(oe=t[_])==null?void 0:oe.name),{pitchedChecked:u,setPitchedChecked:y,cloudPitchedItems:x,refreshPitchedItems:b,userInteractionRef:D,addNewPitchedItem:B,removePitchedItemByDetails:E}=Lt(d||null,f.selectedWeekKey),W=It({userId:d,characterBossSelections:t,selectedCharIdx:_,checked:r,setChecked:s,setError:C,onDataChange:()=>{N(),b()},isHistoricalWeek:f.isHistoricalWeek,onBossUncheckStart:()=>{a.current=!0},onBossUncheckEnd:()=>{setTimeout(()=>{a.current=!1},500)}}),j=Pt(d,b);o.useEffect(()=>{if(d){const T=localStorage.getItem(me.USER_CODE);if(!T||T!==d){m.debug("WeeklyTracker: Skipping data refresh - logout in progress");return}m.debug("WeeklyTracker: Refreshing data on mount/user change"),b(),N()}},[d,b,N]),o.useEffect(()=>{if(k>0&&d){const T=localStorage.getItem(me.USER_CODE);if(!T||T!==d){m.debug("WeeklyTracker: Skipping weekly reset refresh - logout in progress");return}m.debug("WeeklyTracker: Detected weekly reset, refreshing pitched items.");const te=setTimeout(()=>{d&&localStorage.getItem(me.USER_CODE)===d&&b()},500);return()=>clearTimeout(te)}},[k,d,b]);const $=T=>{m.debug("WeeklyTracker: Week changed",{from:f.selectedWeekKey,to:T,isHistorical:f.isHistoricalWeek}),f.handleWeekChange(T),f.refreshHistoricalAnalysis&&f.refreshHistoricalAnalysis(),b()};o.useEffect(()=>{_>=t.length&&L(Math.max(0,t.length-1))},[t.length,_]);const Q=t[_],z=`${(Q==null?void 0:Q.name)||""}-${_}`,q=(Q==null?void 0:Q.bosses)||[],G=[...q].sort((T,te)=>{try{const re=l(T.name,T.difficulty)/(T.partySize||1);return l(te.name,te.difficulty)/(te.partySize||1)-re}catch(re){return m.error("WeeklyTracker: Error sorting bosses",re),C(`Error sorting bosses: ${re.message}`),0}}),R=t.reduce((T,te,re)=>{const Y=`${(te==null?void 0:te.name)||""}-${re}`;return T+(te.bosses||[]).reduce((ae,J)=>{var le;return(le=r[Y])!=null&&le[J.name+"-"+J.difficulty]?ae+l(J.name,J.difficulty)/(J.partySize||1):ae},0)},0),A=t.reduce((T,te)=>T+(te.bosses||[]).reduce((re,Y)=>re+l(Y.name,Y.difficulty)/(Y.partySize||1),0),0),Z=t.map((T,te)=>{const re=`${(T==null?void 0:T.name)||""}-${te}`,Y=(T==null?void 0:T.bosses)||[],ae=Y.filter(U=>{var M;return(M=r[re])==null?void 0:M[U.name+"-"+U.difficulty]}).length,J=Y.length,le=Y.reduce((U,M)=>{var K;return(K=r[re])!=null&&K[M.name+"-"+M.difficulty]?U+Math.ceil(l(M.name,M.difficulty)/(M.partySize||1)):U},0);return{name:T.name,cleared:ae,total:J,allCleared:J>0&&ae===J,left:J-ae,idx:te,totalMeso:le}}),ee=n?Z.filter(T=>!T.allCleared):Z,P=q.length>0,ie=async T=>{var te,re;if(!d){m.error("WeeklyTracker: No userCode available for pitched item interaction");return}if(!t.length){m.error("WeeklyTracker: No characters available");return}m.debug("WeeklyTracker: Pitched item clicked",T);try{const{bossName:Y,itemName:ae,characterName:J,weekKey:le,isChecked:U,isHistorical:M,itemImage:K}=T;if(!J){m.error("WeeklyTracker: No character name provided");return}if(!t.some(H=>H.name===J)){m.error("WeeklyTracker: Character not found in character list",{characterName:J});return}if(U)await E(J,Y,ae,M?Ee(le):null),m.info("WeeklyTracker: Pitched item removed",{characterName:J,bossName:Y,itemName:ae});else{if(M){const H=(await se(async()=>{const{getBossPitchedItems:X}=await import("./bossRegistryService-D2AJ6cD9.js");return{getBossPitchedItems:X}},__vite__mapDeps([8,4,3,0,1,2,5]))).getBossPitchedItems,F=(H(Y)||[]).find(X=>X.name===ae);if(F){const X={bossName:Y,itemName:ae,itemImage:K||F.image,weekKey:le,character:J};j.setHistoricalPitchedData(X),j.setShowHistoricalPitchedModal(!0)}return}if(await B(J,Y,ae,M?Ee(le):null),m.info("WeeklyTracker: Pitched item added",{characterName:J,bossName:Y,itemName:ae}),!M){if(a.current){m.info("WeeklyTracker: Skipping auto-check because boss unchecking is in progress");return}try{m.info("WeeklyTracker: Starting automatic boss check process",{characterName:J,bossName:Y,totalCharacters:t.length,characterNames:t.map(F=>F.name)});const H=t.findIndex(F=>F.name===J),V=t[H];if(V&&H!==-1){const F=V.bosses.find(X=>X.name===Y);if(F){const X=`${V.name}-${H}`,ne=`${F.name}-${F.difficulty}`,ue=(te=r[X])==null?void 0:te[ne];if(m.info("WeeklyTracker: Boss check status verification",{charKey:X,bossKey:ne,isAlreadyCleared:ue,shouldAutoCheck:!ue}),ue)m.info("WeeklyTracker: Boss already cleared, skipping auto-check",{characterName:J,bossName:F.name});else{m.info("WeeklyTracker: Auto-checking boss since pitched item was obtained",{characterName:J,characterIndex:H,bossName:F.name,difficulty:F.difficulty});const{getBossRegistryId:ke}=await se(async()=>{const{getBossRegistryId:he}=await import("./bossCodeMapping-BogtXRsN.js");return{getBossRegistryId:he}},__vite__mapDeps([9,4,3])),{toggleBossClearStatus:Ne}=await se(async()=>{const{toggleBossClearStatus:he}=await import("./userWeeklyDataService-C8wIP6so.js");return{toggleBossClearStatus:he}},__vite__mapDeps([6,4,3,7,0,1,2,5])),{getCurrentMapleWeekStartDate:Oe}=await se(async()=>{const{getCurrentMapleWeekStartDate:he}=await import("./mapleWeekUtils-Bm65Nri8.js");return{getCurrentMapleWeekStartDate:he}},[]),Be=await ke(F.name,F.difficulty),Ae=Oe(),_e=await Ne(d,Ae,V.index.toString(),Be,!0);_e.success?(s(he=>{const fe={...he};return fe[X]||(fe[X]={}),fe[X]={...fe[X]},fe[X][ne]=!0,fe}),m.info("WeeklyTracker: Auto-check boss completed successfully",{bossName:F.name,difficulty:F.difficulty})):m.error("WeeklyTracker: Auto-check boss failed",{error:_e.error,bossName:F.name})}}else m.warn("WeeklyTracker: Boss not found in character configuration",{characterName:J,bossName:Y,characterBosses:((re=V.bosses)==null?void 0:re.map(X=>X.name))||[]})}else m.warn("WeeklyTracker: Character not found in character selections",{characterName:J,availableCharacters:t.map(F=>F.name)})}catch(H){m.error("WeeklyTracker: Failed to auto-check boss after pitched item",{error:H.message,characterName:J,bossName:Y})}}}}catch(Y){m.error("WeeklyTracker: Error handling pitched item click",Y)}};return S?e.jsxs("div",{className:"weekly-tracker-error",children:[e.jsx("div",{className:"weekly-tracker-error-message",children:S}),e.jsx("button",{onClick:()=>C(null),children:"Try Again"})]}):t.length?e.jsx("div",{className:"weekly-tracker",children:e.jsxs("div",{className:"weekly-tracker-container",children:[e.jsx(gt,{sidebarVisible:p,setSidebarVisible:w,isHistoricalWeek:f.isHistoricalWeek,totalMeso:R,obtainableMeso:A,selectedWeekKey:f.selectedWeekKey,hideCompleted:n,setHideCompleted:h,visibleCharSummaries:ee,selectedCharIdx:_,setSelectedCharIdx:L,setPurgeTargetCharacter:j.setPurgeTargetCharacter,setShowCharacterPurgeConfirm:j.setShowCharacterPurgeConfirm,setShowCharacterPitchedModal:j.setShowCharacterPitchedModal,onShowTreasureAnalytics:()=>j.setShowStats(!0),characterBossSelections:t,showOnboardingIndicators:v}),e.jsx(pt,{sidebarVisible:p,setSidebarVisible:w}),e.jsx("div",{className:"weekly-tracker-main fade-in",children:e.jsxs("div",{className:"weekly-tracker-content",children:[e.jsx("div",{className:"weekly-tracker-header",children:e.jsx("h2",{className:"weekly-tracker-title",children:f.isHistoricalWeek?"Historical Week View":"Weekly Boss Tracker"})}),e.jsx("div",{className:"weekly-tracker-navigator-wrapper",children:e.jsx(mt,{appWeekKey:g,selectedWeekKey:f.selectedWeekKey,onWeekChange:$,isHistoricalWeek:f.isHistoricalWeek,historicalAnalysis:f.historicalAnalysis})}),P&&e.jsx(e.Fragment,{children:f.isHistoricalWeek?e.jsx(xt,{bossData:i,characterKey:z,selectedWeekKey:f.selectedWeekKey,selectedCharIdx:_,pitchedChecked:u,onPitchedItemClick:ie,userCode:d,cloudPitchedItems:x,characterBossSelections:t}):e.jsx(kt,{bosses:G,bossData:i,checked:r,characterKey:z,onBossCheck:W.handleCheck,getBossPrice:l,showTickAll:!0,onTickAll:W.handleTickAll,allTicked:q.every(T=>{var te;return(te=r[z])==null?void 0:te[T.name+"-"+T.difficulty]})&&q.length>0,pitchedChecked:u,onPitchedItemClick:ie,isHistoricalWeek:!1,userCode:d,selectedWeekKey:f.selectedWeekKey,selectedCharIdx:_,userInteractionRef:D,cloudPitchedItems:x,characterBossSelections:t})})]})}),e.jsx(_t,{statsManagement:j,weekNavigation:f,pitchedChecked:u,setPitchedChecked:y,userInteractionRef:D,setError:C,characterBossSelections:t,selectedCharIdx:_,cloudPitchedItems:x})]})}):e.jsx("div",{className:"weekly-tracker-no-characters",children:e.jsx("div",{className:`weekly-tracker-no-characters-message ${I?"visible":""}`,children:"No characters found. Go back and add a character first."})})}function $t({show:t,onComplete:i,onSkip:r}){const[s,d]=o.useState(0),[g,v]=o.useState(!1),[k,N]=o.useState(!1),[l,p]=o.useState({}),w=[{id:"welcome",title:"Welcome to Weekly Tracker! 🎉",content:e.jsxs("div",{children:[e.jsx("p",{children:"Track weekly boss completions and rare item drops efficiently."}),e.jsx("p",{children:"Let me show you the key interactive features."})]}),highlight:null,position:"center",offset:{x:0,y:0}},{id:"characters-title",title:"Analytics Hub 📊",content:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:'Click "Characters"'})," to access account-wide analytics."]}),e.jsx("p",{children:"View all pitched items and drops across characters and years."})]}),highlight:".sidebar-title",position:"right",arrow:"left",offset:{x:24,y:0}},{id:"weekly-progress",title:"Progress Toggle 🔄",content:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Click progress bar"})," to toggle views:"]}),e.jsxs("p",{children:["• ",e.jsx("strong",{children:"Account Total:"})," Overall weekly progress",e.jsx("br",{}),"• ",e.jsx("strong",{children:"Selected Character:"})," Individual progress"]})]}),highlight:".sidebar-progress-section",position:"right",arrow:"left",offset:{x:24,y:0}},{id:"boss-table",title:"Boss Management 🗡️",content:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Check off bosses"})," as you complete them."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Click pitched item icons"})," to track rare drops."]})]}),highlight:".weekly-tracker-main .weekly-tracker-content",position:"left",arrow:"right",offset:{x:-24,y:0}},{id:"week-navigation",title:"Week Navigation 📅",content:e.jsx("div",{children:e.jsx("p",{children:"Navigate between weeks to view historical data and track progress patterns."})}),highlight:".weekly-tracker-navigator-wrapper",position:"bottom",arrow:"top",offset:{x:0,y:16}},{id:"final",title:"Ready to Boss! ✅",content:e.jsxs("div",{children:[e.jsx("p",{children:"You're all set! Start tracking your weekly progress."}),e.jsxs("div",{className:"onboarding-reset-tip",children:[e.jsx("strong",{children:"💡 Tip:"})," To replay this guide, clear localStorage key 'ms-weekly-onboarding-seen'"]})]}),highlight:null,position:"center",offset:{x:0,y:0}}],_=o.useCallback(a=>{if(!a.highlight)return{};const n=document.querySelector(a.highlight);if(!n)return console.warn(`Onboarding: Element not found for selector: ${a.highlight}`),{};const h=n.getBoundingClientRect(),f=420,{x:u=0,y=0}=a.offset||{},x={width:window.innerWidth,height:window.innerHeight};let b={};switch(a.position){case"right":b={position:"fixed",left:`${Math.min(h.right+u,x.width-f-16)}px`,top:`${Math.max(16,h.top+h.height/2-90)}px`,transform:"none"};break;case"left":b={position:"fixed",left:`${Math.max(16,h.left+u-f)}px`,top:`${Math.max(16,h.top+h.height/2-90)}px`,transform:"none"};break;case"bottom":b={position:"fixed",left:`${Math.max(16,Math.min(h.left+h.width/2+u-f/2,x.width-f-16))}px`,top:`${h.bottom+y}px`,transform:"none"};break;case"top":b={position:"fixed",left:`${Math.max(16,Math.min(h.left+h.width/2+u-f/2,x.width-f-16))}px`,bottom:`${x.height-h.top+y}px`,transform:"none"};break;default:return{}}return b},[]);o.useEffect(()=>{if(g&&s<w.length){const a=w[s],n=_(a);p(n)}},[s,g,_]),o.useEffect(()=>{const a=()=>{if(g&&s<w.length){const n=w[s],h=_(n);p(h)}};return window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[s,g,_]),o.useEffect(()=>(t?(v(!0),d(0),document.body.classList.add("onboarding-active")):(v(!1),document.body.classList.remove("onboarding-active")),()=>{document.body.classList.remove("onboarding-active")}),[t]);const L=()=>{s<w.length-1?(N(!0),setTimeout(()=>{d(s+1),setTimeout(()=>N(!1),50)},200)):C()},S=()=>{s>0&&(N(!0),setTimeout(()=>{d(s-1),setTimeout(()=>N(!1),50)},200))},C=()=>{v(!1),document.body.classList.remove("onboarding-active"),setTimeout(()=>{i()},300)},I=()=>{v(!1),document.body.classList.remove("onboarding-active"),setTimeout(()=>{r()},300)};if(!t)return null;const c=w[s];return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`onboarding-overlay ${g?"visible":""}`}),c.highlight&&e.jsx("div",{className:"onboarding-spotlight","data-highlight":c.highlight}),e.jsxs("div",{className:`onboarding-modal ${g?"visible":""} ${k?"transitioning":""} position-${c.position}`,style:l,"data-step":c.id,children:[c.arrow&&e.jsx("div",{className:`onboarding-arrow arrow-${c.arrow}`}),e.jsxs("div",{className:"onboarding-content",children:[e.jsxs("div",{className:"onboarding-header",children:[e.jsx("h2",{className:"onboarding-title",children:c.title}),e.jsx("button",{className:"onboarding-skip",onClick:I,title:"Skip tutorial",children:"Skip Tour"})]}),e.jsx("div",{className:"onboarding-body",children:c.content}),e.jsxs("div",{className:"onboarding-footer",children:[e.jsxs("div",{className:"onboarding-progress",children:[e.jsxs("span",{className:"onboarding-step-counter",children:[s+1," of ",w.length]}),e.jsx("div",{className:"onboarding-progress-bar",children:e.jsx("div",{className:"onboarding-progress-fill","data-progress":`${(s+1)/w.length*100}`})})]}),e.jsxs("div",{className:"onboarding-actions",children:[s>0&&e.jsx("button",{className:"onboarding-btn secondary",onClick:S,children:"Previous"}),e.jsx("button",{className:"onboarding-btn primary",onClick:L,children:s===w.length-1?"Get Started!":"Next"})]})]})]})]})]})}function Vt(){Ue();const{userCode:t,isLoggedIn:i,handleDeleteAccount:r}=Pe(),{characterBossSelections:s,checked:d,setChecked:g,fullUserData:v,weekKey:k,preservingCheckedStateRef:N,sortedBossData:l,isLoading:p,hasDataLoaded:w}=We(),[_,L]=o.useState(!1),[S,C]=o.useState(!1),[I,c]=o.useState(""),[a,n]=o.useState(!1),[h,f]=o.useState(!1);o.useEffect(()=>{if(w&&s.length>0&&!localStorage.getItem(me.WEEKLY_ONBOARDING_SEEN)){const b=setTimeout(()=>{f(!0)},500);return()=>clearTimeout(b)}},[w,s.length]);const u=()=>{localStorage.setItem(me.WEEKLY_ONBOARDING_SEEN,"true"),f(!1)};if(!i)return null;const y=async()=>{n(!0),c("");try{const x=await r();x.success?C(!1):c(x.error)}catch(x){c("Failed to delete account. Try again."),console.error("Delete error:",x)}finally{n(!1)}};return p||!w?e.jsxs("div",{className:"page-container",children:[e.jsx(Le,{currentPage:"weeklytracker",onShowHelp:()=>L(!0),onShowDeleteConfirm:()=>C(!0)}),e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh",color:"#e6e0ff",fontSize:"1.2rem"},children:"Loading data..."})]}):e.jsxs("div",{className:"page-container",children:[e.jsx(Le,{currentPage:"weeklytracker",onShowHelp:()=>L(!0),onShowDeleteConfirm:()=>C(!0)}),e.jsx(Ve,{children:e.jsx(Tt,{characterBossSelections:s,bossData:l,checked:d,setChecked:g,userCode:t,fullUserData:v,appWeekKey:k,preservingCheckedStateRef:N,showOnboardingIndicators:h})}),e.jsx($t,{show:h,onComplete:u,onSkip:u}),e.jsx(ze,{showHelp:_,onClose:()=>L(!1),children:e.jsx(qe,{})}),e.jsx(Ze,{showDeleteConfirm:S,onClose:()=>C(!1),onConfirm:y,showDeleteLoading:a,deleteError:I})]})}export{Vt as default};
